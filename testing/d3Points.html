<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="/testing/common/js/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="/testing/common/js/gl-matrix.js"></script>
    <script type="text/javascript" src="/testing/common/js/d3.v3.min.js"></script>
    <script type="text/javascript" src="/testing/common/js/proj4.js"></script>
    <script type="text/javascript" src="/web/lib/vgl.min.js"></script>
    <script type="text/javascript" src="/web/lib/geojs.min.js"></script>
    <style>
        html{
            height: 100%;
        }
    </style>

</head>
<body style="height: 100%;">
<script>
function processCSVData(csvdata) {
  var table = [];
  var lines = csvdata.split(/\r\n|\n/);

  for ( var i = 0; i < lines.length; i++) {
    var row = lines[i].split(',');
    table.push(row);
  }
  return table;
};

$(function() {
    var mapOptions = {
      node: 'map',
      zoom : 3,
      center : [40, 105]
    };

    var myMap = geo.map(mapOptions),
        table = [],
        citieslatlon = [],
        width, height;

    // Resize the canvas to fill browser window dynamically
    window.addEventListener('resize', resizeCanvas, false);

    function resizeCanvas() {
      $('#map').width('100%');
      $('#map').height('100%');
      width = $('#map').width();
      height = $('#map').height();
      updateAndDraw(width, height);
    }
    resizeCanvas();

    function updateAndDraw(width, height) {
      myMap.resize(0, 0, width, height);
      myMap.draw();
    }

    // Read city geo-coded data
    $.ajax({
      type : "GET",
      url : "/data/cities.csv",
      dataType : "text",
      success : function(data) {
        table = processCSVData(data);
        if (table.length > 0) {
          var i;
          for (i = 0; i < 1000; ++i) {//table.length; ++i) {
            if (table[i][2] != undefined) {
              var lat = table[i][2];
              lat = lat.replace(/(^\s+|\s+$|^\"|\"$)/g, '');
              lat = parseFloat(lat);

              var lon = table[i][3];
              lon = lon.replace(/(^\s+|\s+$|^\"|\"$)/g, '');
              lon = parseFloat(lon);
              citieslatlon.push(geo.latlng(lat, lon));
            }
          }
        }
        
        var mouseOverElement = 0;
        // Load image to be used for drawing dots
        var osm = geo.osmLayer({'renderer': 'vglRenderer'}).referenceLayer(true);
            layer = geo.featureLayer({
                'renderer' : 'd3Renderer'});
        var color = d3.scale.category10()
                      .domain(d3.range(10)),
            style = {
                style: {fill: function (d, i) { return color(i % 10); }}
            };
        var points = layer.create('pointFeature')
            .positions(citieslatlon)
            .style(style);
        
        myMap.addLayer(osm).addLayer(layer);
        resizeCanvas();
        myMap.draw();
        
        points.drawables()
          .on('mouseover', function (d) {
            d3.select(this).transition().attr('r', '15pt');
          })
          .on('mouseout', function (d) {
            d3.select(this).transition().attr('r', '3pt');
          })
          .on('click', function (d) {
            d3.select(this).transition().style('opacity', 0.0).remove();
          });
        
      }});
});
</script>

<div id='map'></div>
</body>
