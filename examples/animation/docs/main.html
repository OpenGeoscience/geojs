<!DOCTYPE html>

<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p>Run after the DOM loads</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
  <span class="hljs-string">&#x27;use strict&#x27;</span>;

  <span class="hljs-keyword">var</span> layer, pointFeature, points, datapoints,
      timeRecords = {<span class="hljs-attr">generate</span>: [], <span class="hljs-attr">update</span>: [], <span class="hljs-attr">frames</span>: []},
      animationState = {};

  <span class="hljs-keyword">var</span> map = geo.<span class="hljs-title function_">map</span>({
    <span class="hljs-attr">node</span>: <span class="hljs-string">&#x27;#map&#x27;</span>,
    <span class="hljs-attr">center</span>: {
      <span class="hljs-attr">x</span>: -<span class="hljs-number">98</span>,
      <span class="hljs-attr">y</span>: <span class="hljs-number">39</span>
    },
    <span class="hljs-attr">zoom</span>: <span class="hljs-number">3</span>
  });
  <span class="hljs-keyword">var</span> layerOptions = {
    <span class="hljs-attr">features</span>: [<span class="hljs-string">&#x27;point&#x27;</span>]
  };

  <span class="hljs-keyword">var</span> animationStyles = {
    <span class="hljs-attr">fill</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">fillColor</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">fillOpacity</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">stroke</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">strokeColor</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">strokeOpacity</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">strokeWidth</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">radius</span>: <span class="hljs-literal">true</span>
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>Parse query parameters into an object for ease of access</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> query = <span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(^\?)/</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">split</span>(
    <span class="hljs-string">&#x27;&amp;&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">n</span>) {
    n = n.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;=&#x27;</span>);
    <span class="hljs-keyword">if</span> (n[<span class="hljs-number">0</span>]) {
      <span class="hljs-variable language_">this</span>[<span class="hljs-built_in">decodeURIComponent</span>(n[<span class="hljs-number">0</span>])] = <span class="hljs-built_in">decodeURIComponent</span>(n[<span class="hljs-number">1</span>]);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }.<span class="hljs-title function_">bind</span>({}))[<span class="hljs-number">0</span>];
  $.<span class="hljs-title function_">each</span>(query, <span class="hljs-keyword">function</span> (<span class="hljs-params">key, value</span>) {
    <span class="hljs-keyword">var</span> ctlvalue, ctlkey = key, ctl;
    <span class="hljs-keyword">switch</span> (key) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;dataset&#x27;</span>:
        ctlvalue = value ? value : <span class="hljs-string">&#x27;adderall&#x27;</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;points&#x27;</span>:
        <span class="hljs-keyword">if</span> (value.<span class="hljs-property">length</span>) {
          points = ctlvalue = <span class="hljs-built_in">parseInt</span>(value, <span class="hljs-number">10</span>);
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">if</span> (animationStyles[key] !== <span class="hljs-literal">undefined</span>) {
          animationStyles[key] = ctlvalue = value === <span class="hljs-string">&#x27;true&#x27;</span>;
        }
    }
    <span class="hljs-keyword">if</span> (ctlvalue !== <span class="hljs-literal">undefined</span>) {
      ctl = $(<span class="hljs-string">&#x27;#&#x27;</span> + ctlkey);
      <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>)) {
        ctl.<span class="hljs-title function_">prop</span>(<span class="hljs-string">&#x27;checked&#x27;</span>, value === <span class="hljs-string">&#x27;true&#x27;</span> || value === <span class="hljs-literal">true</span>);
      } <span class="hljs-keyword">else</span> {
        ctl.<span class="hljs-title function_">val</span>(ctlvalue);
      }
    }
  });

  <span class="hljs-comment">/* Based on the current controls, fetch a data set and show it as a heatmap.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetch_data</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">var</span> dataset = $(<span class="hljs-string">&#x27;#dataset&#x27;</span>).<span class="hljs-title function_">val</span>(),
        url = <span class="hljs-string">&#x27;../../data/&#x27;</span> + $(<span class="hljs-string">&#x27;#dataset option:selected&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;url&#x27;</span>);
    $.<span class="hljs-title function_">ajax</span>(url, {
      <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">resp</span>) {
        <span class="hljs-keyword">var</span> wasPlaying = animationState.<span class="hljs-property">mode</span> === <span class="hljs-string">&#x27;play&#x27;</span>;
        <span class="hljs-title function_">animation_pause</span>();
        animationState = {};
        <span class="hljs-keyword">var</span> rows;
        <span class="hljs-keyword">switch</span> (dataset) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;adderall&#x27;</span>:
            rows = resp.<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\r\n|\n|\r/</span>);
            rows.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
            rows = rows.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">r</span>) {
              <span class="hljs-keyword">var</span> fields = r.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;,&#x27;</span>);
              <span class="hljs-keyword">return</span> [fields[<span class="hljs-number">12</span>], fields[<span class="hljs-number">24</span>], fields[<span class="hljs-number">25</span>]].<span class="hljs-title function_">map</span>(<span class="hljs-built_in">parseFloat</span>);
            });
            <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;cities&#x27;</span>:
            rows = resp.<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\r\n|\n|\r/</span>);
            rows.<span class="hljs-title function_">splice</span>(rows.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
            rows = rows.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">r</span>) {
              <span class="hljs-keyword">var</span> fields = r.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&quot;,&quot;&#x27;</span>);
              <span class="hljs-keyword">return</span> [<span class="hljs-string">&#x27;&#x27;</span> + fields[<span class="hljs-number">0</span>].<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(^\s+|\s+$|^&quot;|&quot;$)/g</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-property">length</span>, fields[<span class="hljs-number">2</span>].<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(^\s+|\s+$|^&quot;|&quot;$)/g</span>, <span class="hljs-string">&#x27;&#x27;</span>), fields[<span class="hljs-number">3</span>].<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(^\s+|\s+$|^&quot;|&quot;$)/g</span>, <span class="hljs-string">&#x27;&#x27;</span>)].<span class="hljs-title function_">map</span>(<span class="hljs-built_in">parseFloat</span>);
            });
            <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;earthquakes&#x27;</span>:
            animationState.<span class="hljs-property">orderedData</span> = <span class="hljs-literal">true</span>;
            rows = resp;
            <span class="hljs-keyword">break</span>;
        }
        datapoints = rows;
        <span class="hljs-keyword">var</span> text = <span class="hljs-string">&#x27;Loaded: &#x27;</span> + datapoints.<span class="hljs-property">length</span>;
        $(<span class="hljs-string">&#x27;#points-loaded&#x27;</span>).<span class="hljs-title function_">text</span>(text).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;title&#x27;</span>, text);
        <span class="hljs-title function_">show_points</span>(datapoints);
        <span class="hljs-title function_">reset_styles</span>();
        <span class="hljs-keyword">if</span> (wasPlaying) {
          <span class="hljs-title function_">animation_play</span>();
        }
      }
    });
  }

  <span class="hljs-comment">/* Given a set of datapoints, optionally truncate or expand it, then show it
   * as a heatmap.
   *
   * @param {array} datapoints: an array of points to show.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">show_points</span>(<span class="hljs-params">datapoints</span>) {
    <span class="hljs-keyword">var</span> rows = datapoints;
    <span class="hljs-keyword">var</span> maxrows = <span class="hljs-built_in">parseInt</span>(points, <span class="hljs-number">10</span>) || rows.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">if</span> (rows.<span class="hljs-property">length</span> &gt; maxrows) {
      rows = rows.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, maxrows);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rows.<span class="hljs-property">length</span> &lt; maxrows) {
      rows = rows.<span class="hljs-title function_">slice</span>();
      <span class="hljs-keyword">while</span> (rows.<span class="hljs-property">length</span> &lt; maxrows) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = rows.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span> &amp;&amp; rows.<span class="hljs-property">length</span> &lt; maxrows; i -= <span class="hljs-number">1</span>) {
          rows.<span class="hljs-title function_">push</span>([
            rows[i][<span class="hljs-number">0</span>] + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.1</span> - <span class="hljs-number">0.05</span>,
            rows[i][<span class="hljs-number">1</span>] + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.1</span> - <span class="hljs-number">0.05</span>,
            rows[i][<span class="hljs-number">2</span>] + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.1</span> - <span class="hljs-number">0.05</span>]);
        }
      }
    }
    pointFeature.<span class="hljs-title function_">data</span>(rows);
    pointFeature.<span class="hljs-title function_">draw</span>();
    <span class="hljs-keyword">var</span> text = <span class="hljs-string">&#x27;Shown: &#x27;</span> + rows.<span class="hljs-property">length</span>;
    $(<span class="hljs-string">&#x27;#points-shown&#x27;</span>).<span class="hljs-title function_">text</span>(text).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;title&#x27;</span>, text);
  }

  <span class="hljs-comment">/**
   * Handle changes to our controls.
   *
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} evt jquery evt that triggered this call.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">change_controls</span>(<span class="hljs-params">evt</span>) {
    <span class="hljs-keyword">var</span> ctl = $(evt.<span class="hljs-property">target</span>),
        param = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>),
        value = ctl.<span class="hljs-title function_">val</span>();
    <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>)) {
      value = ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;:checked&#x27;</span>) ? <span class="hljs-string">&#x27;true&#x27;</span> : <span class="hljs-string">&#x27;false&#x27;</span>;
    }
    <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;&#x27;</span> &amp;&amp; ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>)) {
      value = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>);
    }
    <span class="hljs-keyword">if</span> (!param || value === query[param]) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> processedValue = (
      ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>) ? (value === <span class="hljs-string">&#x27;true&#x27;</span>) : value);
    <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">closest</span>(<span class="hljs-string">&#x27;table.gradient&#x27;</span>).<span class="hljs-property">length</span>) {
      param = <span class="hljs-string">&#x27;gradient&#x27;</span>;
    }
    <span class="hljs-keyword">switch</span> (param) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;dataset&#x27;</span>:
        <span class="hljs-title function_">fetch_data</span>();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;points&#x27;</span>:
        points = <span class="hljs-built_in">parseInt</span>(value);
        <span class="hljs-keyword">var</span> wasPlaying = animationState.<span class="hljs-property">mode</span> === <span class="hljs-string">&#x27;play&#x27;</span>;
        <span class="hljs-title function_">animation_pause</span>();
        <span class="hljs-title function_">show_points</span>(datapoints);
        <span class="hljs-title function_">reset_styles</span>();
        <span class="hljs-keyword">if</span> (wasPlaying) {
          <span class="hljs-title function_">animation_play</span>();
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">if</span> (animationStyles[param] !== <span class="hljs-literal">undefined</span>) {
          animationStyles[param] = processedValue;
          <span class="hljs-title function_">reset_styles</span>();
        }
        <span class="hljs-keyword">break</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>update the url to reflect the changes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    query[param] = value;
    <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;&#x27;</span> || (ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>) &amp;&amp;
        value === ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>))) {
      <span class="hljs-keyword">delete</span> query[param];
    }
    <span class="hljs-keyword">var</span> newurl = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">protocol</span> + <span class="hljs-string">&#x27;//&#x27;</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">host</span> +
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span> + <span class="hljs-string">&#x27;?&#x27;</span> + $.<span class="hljs-title function_">param</span>(query);
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">replaceState</span>(query, <span class="hljs-string">&#x27;&#x27;</span>, newurl);
  }

  <span class="hljs-comment">/**
   * Render a frame of the animation and then request another frame as soon as
   * possible.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">animation_frame</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">var</span> datalen = animationState.<span class="hljs-property">order</span>.<span class="hljs-property">length</span>,
        styles = animationState.<span class="hljs-property">styleArrays</span>,
        curTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), genTime, updateTime,
        position, i, idx, p;
    timeRecords.<span class="hljs-property">frames</span>.<span class="hljs-title function_">push</span>(curTime);
    animationState.<span class="hljs-property">raf</span> = <span class="hljs-literal">null</span>;
    position = ((curTime - animationState.<span class="hljs-property">startTime</span>) / animationState.<span class="hljs-property">duration</span>) % <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (position &lt; <span class="hljs-number">0</span>) {
      position += <span class="hljs-number">1</span>;
    }
    animationState.<span class="hljs-property">position</span> = position;

    <span class="hljs-keyword">for</span> (idx = <span class="hljs-number">0</span>; idx &lt; datalen; idx += <span class="hljs-number">1</span>) {
      i = animationState.<span class="hljs-property">order</span>[idx];
      p = idx / datalen + position;
      <span class="hljs-keyword">if</span> (p &gt; <span class="hljs-number">1</span>) {
        p -= <span class="hljs-number">1</span>;
      }
      styles.<span class="hljs-property">p</span>[i] = p;
    }
    <span class="hljs-keyword">if</span> (animationStyles.<span class="hljs-property">fill</span>) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
        styles.<span class="hljs-property">fill</span>[i] = styles.<span class="hljs-property">p</span>[i] &gt;= <span class="hljs-number">0.1</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;
      }
    }
    <span class="hljs-keyword">if</span> (animationStyles.<span class="hljs-property">fillColor</span>) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
        p = styles.<span class="hljs-property">p</span>[i];
        <span class="hljs-keyword">if</span> (p &gt;= <span class="hljs-number">0.1</span>) {
          styles.<span class="hljs-property">fillColor</span>[i].<span class="hljs-property">r</span> = <span class="hljs-number">0</span>;
          styles.<span class="hljs-property">fillColor</span>[i].<span class="hljs-property">g</span> = <span class="hljs-number">0</span>;
          styles.<span class="hljs-property">fillColor</span>[i].<span class="hljs-property">b</span> = <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">else</span> {
          styles.<span class="hljs-property">fillColor</span>[i].<span class="hljs-property">r</span> = p * <span class="hljs-number">10</span>;
          styles.<span class="hljs-property">fillColor</span>[i].<span class="hljs-property">g</span> = p * <span class="hljs-number">8.39</span>;
          styles.<span class="hljs-property">fillColor</span>[i].<span class="hljs-property">b</span> = p * <span class="hljs-number">4.39</span>;
        }
      }
    }
    <span class="hljs-keyword">if</span> (animationStyles.<span class="hljs-property">fillOpacity</span>) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
        p = styles.<span class="hljs-property">p</span>[i];
        styles.<span class="hljs-property">fillOpacity</span>[i] = p &gt;= <span class="hljs-number">0.1</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1.0</span> - p * <span class="hljs-number">10</span>;  <span class="hljs-comment">// 1 - 0</span>
      }
    }
    <span class="hljs-keyword">if</span> (animationStyles.<span class="hljs-property">radius</span>) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
        p = styles.<span class="hljs-property">p</span>[i];
        styles.<span class="hljs-property">radius</span>[i] = p &gt;= <span class="hljs-number">0.1</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">2</span> + <span class="hljs-number">100</span> * p;  <span class="hljs-comment">// 2 - 12</span>
      }
    }
    <span class="hljs-keyword">if</span> (animationStyles.<span class="hljs-property">stroke</span>) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
        styles.<span class="hljs-property">stroke</span>[i] = styles.<span class="hljs-property">p</span>[i] &gt;= <span class="hljs-number">0.1</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;
      }
    }
    <span class="hljs-keyword">if</span> (animationStyles.<span class="hljs-property">strokeColor</span>) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
        p = styles.<span class="hljs-property">p</span>[i];
        <span class="hljs-keyword">if</span> (p &gt;= <span class="hljs-number">0.1</span>) {
          styles.<span class="hljs-property">strokeColor</span>[i].<span class="hljs-property">r</span> = <span class="hljs-number">0</span>;
          styles.<span class="hljs-property">strokeColor</span>[i].<span class="hljs-property">g</span> = <span class="hljs-number">0</span>;
          styles.<span class="hljs-property">strokeColor</span>[i].<span class="hljs-property">b</span> = <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">else</span> {
          styles.<span class="hljs-property">strokeColor</span>[i].<span class="hljs-property">r</span> = p * <span class="hljs-number">8.51</span>;
          styles.<span class="hljs-property">strokeColor</span>[i].<span class="hljs-property">g</span> = p * <span class="hljs-number">6.04</span>;
          styles.<span class="hljs-property">strokeColor</span>[i].<span class="hljs-property">b</span> = <span class="hljs-number">0</span>;
        }
      }
    }
    <span class="hljs-keyword">if</span> (animationStyles.<span class="hljs-property">strokeOpacity</span>) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
        p = styles.<span class="hljs-property">p</span>[i];
        styles.<span class="hljs-property">strokeOpacity</span>[i] = p &gt;= <span class="hljs-number">0.1</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1.0</span> - p * p * <span class="hljs-number">100</span>;  <span class="hljs-comment">// (1 - 0) ^ 2</span>
      }
    }
    <span class="hljs-keyword">if</span> (animationStyles.<span class="hljs-property">strokeWidth</span>) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
        p = styles.<span class="hljs-property">p</span>[i];
        styles.<span class="hljs-property">strokeWidth</span>[i] = p &gt;= <span class="hljs-number">0.1</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">3</span> - <span class="hljs-number">30</span> * p;  <span class="hljs-comment">// 3 - 0</span>
      }
    }
    <span class="hljs-keyword">var</span> updateStyles = {};
    $.<span class="hljs-title function_">each</span>(animationStyles, <span class="hljs-keyword">function</span> (<span class="hljs-params">key, use</span>) {
      <span class="hljs-keyword">if</span> (use) {
        updateStyles[key] = styles[key];
      }
    });
    genTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    pointFeature.<span class="hljs-title function_">updateStyleFromArray</span>(updateStyles, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);
    updateTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    timeRecords.<span class="hljs-property">generate</span>.<span class="hljs-title function_">push</span>(genTime - curTime);
    timeRecords.<span class="hljs-property">update</span>.<span class="hljs-title function_">push</span>(updateTime - genTime);
    <span class="hljs-title function_">show_framerate</span>();
    <span class="hljs-keyword">if</span> (animationState.<span class="hljs-property">mode</span> === <span class="hljs-string">&#x27;play&#x27;</span>) {
      animationState.<span class="hljs-property">raf</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">requestAnimationFrame</span>(animation_frame);
    }
  }

  <span class="hljs-comment">/**
   * Stop any animation timeout, but don&#x27;t do anything else.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">animation_pause</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (animationState.<span class="hljs-property">mode</span> &amp;&amp; animationState.<span class="hljs-property">mode</span> !== <span class="hljs-string">&#x27;pause&#x27;</span> &amp;&amp; animationState.<span class="hljs-property">mode</span> !== <span class="hljs-string">&#x27;stop&#x27;</span>) {
      <span class="hljs-keyword">if</span> (animationState.<span class="hljs-property">raf</span>) {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">cancelAnimationFrame</span>(animationState.<span class="hljs-property">raf</span>);
        animationState.<span class="hljs-property">raf</span> = <span class="hljs-literal">null</span>;
      }
      animationState.<span class="hljs-property">mode</span> = <span class="hljs-string">&#x27;pause&#x27;</span>;
    }
  }

  <span class="hljs-comment">/**
   * Start playing an animation.  If we haven&#x27;t played it yet, create some
   * arrays used for the animation.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">animation_play</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (animationState.<span class="hljs-property">mode</span> === <span class="hljs-string">&#x27;play&#x27;</span> || !pointFeature.<span class="hljs-title function_">data</span>()) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> data = pointFeature.<span class="hljs-title function_">data</span>(),
        datalen = data.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">if</span> (!datalen) {
      <span class="hljs-keyword">return</span>;
    }
    animationState.<span class="hljs-property">duration</span> = <span class="hljs-number">15000</span>;  <span class="hljs-comment">// in milliseconds</span>
    <span class="hljs-keyword">if</span> (animationState.<span class="hljs-property">position</span> === <span class="hljs-literal">undefined</span> || animationState.<span class="hljs-property">position</span> === <span class="hljs-literal">null</span>) {
      animationState.<span class="hljs-property">position</span> = <span class="hljs-number">0</span>;
    }
    animationState.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - animationState.<span class="hljs-property">duration</span> * animationState.<span class="hljs-property">position</span>;
    <span class="hljs-keyword">if</span> (!animationState.<span class="hljs-property">styleArrays</span> || datalen !== animationState.<span class="hljs-property">order</span>.<span class="hljs-property">length</span>) {
      animationState.<span class="hljs-property">order</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(datalen);
      <span class="hljs-keyword">if</span> (!animationState.<span class="hljs-property">orderedData</span>) {
        <span class="hljs-keyword">var</span> posFunc = pointFeature.<span class="hljs-title function_">position</span>(), posVal, i;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>sort our data by x so we get a visual ripple across it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
          posVal = <span class="hljs-title function_">posFunc</span>(data[i], i);
          animationState.<span class="hljs-property">order</span>[i] = {<span class="hljs-attr">i</span>: i, <span class="hljs-attr">x</span>: posVal.<span class="hljs-property">x</span>, <span class="hljs-attr">y</span>: posVal.<span class="hljs-property">y</span>};
        }
        animationState.<span class="hljs-property">order</span> = animationState.<span class="hljs-property">order</span>.<span class="hljs-title function_">sort</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) {
          <span class="hljs-keyword">if</span> (a.<span class="hljs-property">x</span> !== b.<span class="hljs-property">x</span>) { <span class="hljs-keyword">return</span> b.<span class="hljs-property">x</span> - a.<span class="hljs-property">x</span>; }
          <span class="hljs-keyword">if</span> (a.<span class="hljs-property">y</span> !== b.<span class="hljs-property">y</span>) { <span class="hljs-keyword">return</span> b.<span class="hljs-property">y</span> - a.<span class="hljs-property">y</span>; }
          <span class="hljs-keyword">return</span> b.<span class="hljs-property">i</span> - a.<span class="hljs-property">i</span>;
        }).<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) {
          <span class="hljs-keyword">return</span> val.<span class="hljs-property">i</span>;
        });
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
          animationState.<span class="hljs-property">order</span>[i] = i;
        }
      }
      animationState.<span class="hljs-property">styleArrays</span> = {
        <span class="hljs-attr">p</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(datalen),
        <span class="hljs-attr">radius</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(datalen),
        <span class="hljs-attr">fill</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(datalen),
        <span class="hljs-attr">fillColor</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(datalen),
        <span class="hljs-attr">fillOpacity</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(datalen),
        <span class="hljs-attr">stroke</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(datalen),
        <span class="hljs-attr">strokeColor</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(datalen),
        <span class="hljs-attr">strokeOpacity</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(datalen),
        <span class="hljs-attr">strokeWidth</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(datalen)
      };
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; datalen; i += <span class="hljs-number">1</span>) {
        animationState.<span class="hljs-property">styleArrays</span>.<span class="hljs-property">fillColor</span>[i] = {<span class="hljs-attr">r</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">g</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">0</span>};
        animationState.<span class="hljs-property">styleArrays</span>.<span class="hljs-property">strokeColor</span>[i] = {<span class="hljs-attr">r</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">g</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">0</span>};
      }
    }
    animationState.<span class="hljs-property">mode</span> = <span class="hljs-string">&#x27;play&#x27;</span>;
    <span class="hljs-title function_">animation_frame</span>();
  }

  <span class="hljs-comment">/**
   * Clear any animation timeout and reset the styles to the original values.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">animation_stop</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (animationState.<span class="hljs-property">mode</span> &amp;&amp; animationState.<span class="hljs-property">mode</span> !== <span class="hljs-string">&#x27;stop&#x27;</span>) {
      <span class="hljs-keyword">if</span> (animationState.<span class="hljs-property">raf</span>) {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">cancelAnimationFrame</span>(animationState.<span class="hljs-property">raf</span>);
        animationState.<span class="hljs-property">raf</span> = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-title function_">reset_styles</span>();
      animationState.<span class="hljs-property">position</span> = <span class="hljs-literal">null</span>;
      animationState.<span class="hljs-property">mode</span> = <span class="hljs-string">&#x27;stop&#x27;</span>;
    }
  }

  <span class="hljs-comment">/**
   * Reset all of the styles to the defaults and redraw the feature.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">reset_styles</span>(<span class="hljs-params"></span>) {
    pointFeature.<span class="hljs-title function_">style</span>({
      <span class="hljs-attr">fill</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">fillColor</span>: { <span class="hljs-attr">r</span>: <span class="hljs-number">1.0</span>, <span class="hljs-attr">g</span>: <span class="hljs-number">0.839</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">0.439</span> },
      <span class="hljs-attr">fillOpacity</span>: <span class="hljs-number">0.8</span>,
      <span class="hljs-attr">radius</span>: <span class="hljs-number">5.0</span>,
      <span class="hljs-attr">stroke</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">strokeColor</span>: { <span class="hljs-attr">r</span>: <span class="hljs-number">0.851</span>, <span class="hljs-attr">g</span>: <span class="hljs-number">0.604</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">0.0</span> },
      <span class="hljs-attr">strokeWidth</span>: <span class="hljs-number">1.25</span>,
      <span class="hljs-attr">strokeOpacity</span>: <span class="hljs-number">1.0</span>
    });
    pointFeature.<span class="hljs-title function_">draw</span>();
  }

  <span class="hljs-comment">/**
   * Show the framerate averaged over the last five seconds.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">show_framerate</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (timeRecords.<span class="hljs-property">frames</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> timeSpan = <span class="hljs-number">5000</span>,
        endPos = timeRecords.<span class="hljs-property">frames</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>,
        endTime = timeRecords.<span class="hljs-property">frames</span>[endPos],
        startPos, startTime, fps, generate = <span class="hljs-number">0</span>, update = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (startPos = endPos; startPos &gt; <span class="hljs-number">0</span>; startPos -= <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span> (endTime - timeRecords.<span class="hljs-property">frames</span>[startPos] &gt; timeSpan) {
        <span class="hljs-keyword">break</span>;
      }
      generate += timeRecords.<span class="hljs-property">generate</span>[startPos];
      update += timeRecords.<span class="hljs-property">update</span>[startPos];
    }
    startTime = timeRecords.<span class="hljs-property">frames</span>[startPos];
    timeSpan = endTime - startTime;
    fps = (endPos - startPos) * <span class="hljs-number">1000</span> / timeSpan;
    generate /= (endPos - startPos);
    update /= (endPos - startPos);
    $(<span class="hljs-string">&#x27;#timing-framerate&#x27;</span>).<span class="hljs-title function_">text</span>(fps.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>));
    $(<span class="hljs-string">&#x27;#timing-generate&#x27;</span>).<span class="hljs-title function_">text</span>(generate.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>));
    $(<span class="hljs-string">&#x27;#timing-update&#x27;</span>).<span class="hljs-title function_">text</span>(update.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (startPos &gt; <span class="hljs-number">1000</span>) {
      timeRecords.<span class="hljs-property">frames</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, startPos);
      timeRecords.<span class="hljs-property">generate</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, startPos);
      timeRecords.<span class="hljs-property">update</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, startPos);
    }
  }

  map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;osm&#x27;</span>);
  layer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;feature&#x27;</span>, layerOptions);
  pointFeature = layer.<span class="hljs-title function_">createFeature</span>(<span class="hljs-string">&#x27;point&#x27;</span>, {
    <span class="hljs-attr">primitiveShape</span>: query.<span class="hljs-property">primitive</span> ? query.<span class="hljs-property">primitive</span> : geo.<span class="hljs-property">pointFeature</span>.<span class="hljs-property">primitiveShapes</span>.<span class="hljs-property">auto</span>
  })
  .<span class="hljs-title function_">position</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) {
    <span class="hljs-keyword">return</span> {<span class="hljs-attr">x</span>: d[<span class="hljs-number">2</span>], <span class="hljs-attr">y</span>: d[<span class="hljs-number">1</span>]};
  });

  <span class="hljs-title function_">fetch_data</span>();
  $(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;change&#x27;</span>, change_controls);
  $(<span class="hljs-string">&#x27;button#play&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;click&#x27;</span>, animation_play);
  $(<span class="hljs-string">&#x27;button#pause&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;click&#x27;</span>, animation_pause);
  $(<span class="hljs-string">&#x27;button#stop&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;click&#x27;</span>, animation_stop);
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
