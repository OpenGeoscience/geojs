<!DOCTYPE html>

<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* globals utils */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>custom tileLayer for deepzoom</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> <span class="hljs-title class_">DeepZoom</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">arg</span>) {
  <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">DeepZoom</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeepZoom</span>(arg);
  }
  geo.<span class="hljs-property">tileLayer</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, arg);

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">_getTile</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">index, source</span>) {
    <span class="hljs-keyword">return</span> geo.<span class="hljs-title function_">imageTile</span>({
      <span class="hljs-attr">index</span>: index,
      <span class="hljs-attr">size</span>: {
        <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_options</span>.<span class="hljs-property">tileWidth</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_options</span>.<span class="hljs-property">tileHeight</span>
      },
      <span class="hljs-attr">queue</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_queue</span>,
      <span class="hljs-attr">url</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_options</span>.<span class="hljs-title function_">url</span>(source || index),
      <span class="hljs-attr">overlap</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_options</span>.<span class="hljs-property">tileOverlap</span>,
      <span class="hljs-attr">crossDomain</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_options</span>.<span class="hljs-property">crossDomain</span>
    });
  };
};
<span class="hljs-title class_">DeepZoom</span>.<span class="hljs-property">defaults</span> = $.<span class="hljs-title function_">extend</span>({}, geo.<span class="hljs-property">tileLayer</span>.<span class="hljs-property">defaults</span>);
geo.<span class="hljs-title function_">inherit</span>(<span class="hljs-title class_">DeepZoom</span>, geo.<span class="hljs-property">tileLayer</span>);
geo.<span class="hljs-title function_">registerLayer</span>(<span class="hljs-string">&#x27;deepzoom&#x27;</span>, <span class="hljs-title class_">DeepZoom</span>);

<span class="hljs-keyword">var</span> query = utils.<span class="hljs-title function_">getQuery</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>You can specify a different Deep Zoom image via ?url=(url to dzi or xml)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> dzi_url = query.<span class="hljs-property">url</span> || <span class="hljs-string">&#x27;https://mars.nasa.gov/msl/multimedia/deepzoom/images/PIA19818/dzc_output.xml&#x27;</span>;
<span class="hljs-keyword">var</span> dzi_base = dzi_url.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;.&#x27;</span>) + <span class="hljs-string">&#x27;_files&#x27;</span>;
<span class="hljs-keyword">var</span> dzi_query = dzi_url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;?&#x27;</span>) &gt;= <span class="hljs-number">0</span> ? dzi_url.<span class="hljs-title function_">substr</span>(dzi_url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;?&#x27;</span>)) : <span class="hljs-string">&#x27;&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Read the Deep Zoom image information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$.<span class="hljs-title function_">get</span>(dzi_url).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">dzi_info</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>Parse the Deep Zoom image information to get the tile size, format, and
image size.  The actual tile images are (TileSize + 2 * Overlap) pixels in
width and height.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> tileSize = +$(<span class="hljs-string">&#x27;Image&#x27;</span>, dzi_info).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;TileSize&#x27;</span>),
      tileOverlap = +$(<span class="hljs-string">&#x27;Image&#x27;</span>, dzi_info).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;Overlap&#x27;</span>) || <span class="hljs-number">0</span>,
      format = $(<span class="hljs-string">&#x27;Image&#x27;</span>, dzi_info).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;Format&#x27;</span>),
      sizeX = +$(<span class="hljs-string">&#x27;Image&gt;Size&#x27;</span>, dzi_info).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;Width&#x27;</span>),
      sizeY = +$(<span class="hljs-string">&#x27;Image&gt;Size&#x27;</span>, dzi_info).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;Height&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>get some standard parameters for map and level in pixel-coordinate space</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> defaultParams = geo.<span class="hljs-property">util</span>.<span class="hljs-title function_">pixelCoordinateParams</span>(
    <span class="hljs-string">&#x27;#map&#x27;</span>, sizeX, sizeY, tileSize, tileSize);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Create a map object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> map = geo.<span class="hljs-title function_">map</span>(defaultParams.<span class="hljs-property">map</span>);

  map.<span class="hljs-title function_">createLayer</span>(
    <span class="hljs-string">&#x27;deepzoom&#x27;</span>, $.<span class="hljs-title function_">extend</span>({}, defaultParams.<span class="hljs-property">layer</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>For testing, we can ask for a specific renderer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-attr">renderer</span>: query.<span class="hljs-property">renderer</span> ? (query.<span class="hljs-property">renderer</span> === <span class="hljs-string">&#x27;html&#x27;</span> ? <span class="hljs-literal">null</span> : query.<span class="hljs-property">renderer</span>) : <span class="hljs-literal">undefined</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>We ask to use the quad.imageFixedScale feature, since the Deep Zoom
server returns partial tiles at the right and bottom edges.  If the
tile server returned complete tiles that we need to crop, we would ask
for the quad.imageCrop feature instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-attr">features</span>: query.<span class="hljs-property">renderer</span> ? <span class="hljs-literal">undefined</span> : [<span class="hljs-string">&#x27;quad.imageFixedScale&#x27;</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>Specify a custom url for tiles.  Deep Zoom offsets the level by 8</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-attr">url</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">index</span>) {
        <span class="hljs-keyword">return</span> dzi_base + <span class="hljs-string">&#x27;/&#x27;</span> + (index.<span class="hljs-property">level</span> + <span class="hljs-number">8</span>) + <span class="hljs-string">&#x27;/&#x27;</span> + index.<span class="hljs-property">x</span> + <span class="hljs-string">&#x27;_&#x27;</span> + index.<span class="hljs-property">y</span> + <span class="hljs-string">&#x27;.&#x27;</span> + format + dzi_query;
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>Specify the tile overlap</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-attr">tileOverlap</span>: {
        <span class="hljs-attr">x</span>: tileOverlap,
        <span class="hljs-attr">y</span>: tileOverlap
      }
    })
  );
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
