<!DOCTYPE html>

<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* globals $, geo, utils */</span>

<span class="hljs-keyword">var</span> annotationDebug = {};

<span class="hljs-keyword">var</span> layer, fromButtonSelect, fromGeojsonUpdate;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>get the query parameters and set controls appropriately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> query = utils.<span class="hljs-title function_">getQuery</span>();
$(<span class="hljs-string">&#x27;#clickmode&#x27;</span>).<span class="hljs-title function_">val</span>(query.<span class="hljs-property">clickmode</span> || <span class="hljs-string">&#x27;edit&#x27;</span>);
$(<span class="hljs-string">&#x27;#keepadding&#x27;</span>).<span class="hljs-title function_">prop</span>(<span class="hljs-string">&#x27;checked&#x27;</span>, query.<span class="hljs-property">keepadding</span> === <span class="hljs-string">&#x27;true&#x27;</span>);
$(<span class="hljs-string">&#x27;#showLabels&#x27;</span>).<span class="hljs-title function_">prop</span>(<span class="hljs-string">&#x27;checked&#x27;</span>, query.<span class="hljs-property">labels</span> !== <span class="hljs-string">&#x27;false&#x27;</span>);
<span class="hljs-keyword">if</span> (query.<span class="hljs-property">lastannotation</span> &amp;&amp; query.<span class="hljs-property">clickmode</span> !== <span class="hljs-string">&#x27;brush&#x27;</span>) {
  $(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;lastused&#x27;</span>);
  $(<span class="hljs-string">&#x27;.annotationtype button#&#x27;</span> + query.<span class="hljs-property">lastannotation</span>).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&#x27;lastused&#x27;</span>);
}
$(<span class="hljs-string">&#x27;#brushshape&#x27;</span>).<span class="hljs-title function_">val</span>(query.<span class="hljs-property">brushshape</span> || <span class="hljs-string">&#x27;square&#x27;</span>);
<span class="hljs-keyword">if</span> (query.<span class="hljs-property">brushsize</span>) {
  $(<span class="hljs-string">&#x27;#brushsize&#x27;</span>).<span class="hljs-title function_">val</span>(query.<span class="hljs-property">brushsize</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>You can set the initial annotations via a query parameter.  If the query
parameter ‘save=true’ is specified, the query will be updated with the
geojson.  This can become too long for some browsers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> initialGeoJSON = query.<span class="hljs-property">geojson</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>respond to changes in our controls</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;change&#x27;</span>, change_controls);
$(<span class="hljs-string">&#x27;#geojson[type=textarea]&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;input propertychange&#x27;</span>, change_geojson);
$(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, select_control);
$(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;click&#x27;</span>, select_annotation);
$(<span class="hljs-string">&#x27;#editdialog&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;submit&#x27;</span>, edit_update);

$(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;no-controls&#x27;</span>, query.<span class="hljs-property">controls</span> === <span class="hljs-string">&#x27;false&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>start the map near Fresno unless the query parameters say to do otherwise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> map = geo.<span class="hljs-title function_">map</span>({
  <span class="hljs-attr">node</span>: <span class="hljs-string">&#x27;#map&#x27;</span>,
  <span class="hljs-attr">center</span>: {
    <span class="hljs-attr">x</span>: query.<span class="hljs-property">x</span> ? +query.<span class="hljs-property">x</span> : -<span class="hljs-number">119.150</span>,
    <span class="hljs-attr">y</span>: query.<span class="hljs-property">y</span> ? +query.<span class="hljs-property">y</span> : <span class="hljs-number">36.712</span>
  },
  <span class="hljs-attr">zoom</span>: query.<span class="hljs-property">zoom</span> ? +query.<span class="hljs-property">zoom</span> : <span class="hljs-number">10</span>,
  <span class="hljs-attr">rotation</span>: query.<span class="hljs-property">rotation</span> ? +query.<span class="hljs-property">rotation</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span> : <span class="hljs-number">0</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>allow some query parameters to specify what map we will show</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (query.<span class="hljs-property">map</span> !== <span class="hljs-string">&#x27;false&#x27;</span>) {
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">map</span> !== <span class="hljs-string">&#x27;satellite&#x27;</span>) {
    annotationDebug.<span class="hljs-property">mapLayer</span> = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;osm&#x27;</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">map</span> === <span class="hljs-string">&#x27;satellite&#x27;</span> || query.<span class="hljs-property">map</span> === <span class="hljs-string">&#x27;dual&#x27;</span>) {
    annotationDebug.<span class="hljs-property">satelliteLayer</span> = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;osm&#x27;</span>, {<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png&#x27;</span>, <span class="hljs-attr">opacity</span>: query.<span class="hljs-property">map</span> === <span class="hljs-string">&#x27;dual&#x27;</span> ? <span class="hljs-number">0.25</span> : <span class="hljs-number">1</span>});
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>create an annotation layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>layer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;annotation&#x27;</span>, {
  <span class="hljs-attr">renderer</span>: query.<span class="hljs-property">renderer</span> ? (query.<span class="hljs-property">renderer</span> === <span class="hljs-string">&#x27;html&#x27;</span> ? <span class="hljs-literal">null</span> : query.<span class="hljs-property">renderer</span>) : <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">annotations</span>: query.<span class="hljs-property">renderer</span> ? <span class="hljs-literal">undefined</span> : geo.<span class="hljs-title function_">listAnnotations</span>(),
  <span class="hljs-attr">showLabels</span>: query.<span class="hljs-property">labels</span> !== <span class="hljs-string">&#x27;false&#x27;</span>,
  <span class="hljs-attr">clickToEdit</span>: !query.<span class="hljs-property">clickmode</span> || query.<span class="hljs-property">clickmode</span> === <span class="hljs-string">&#x27;edit&#x27;</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>bind to the mouse click and annotation mode events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">mouseclick</span>, mouseClickToStart);
layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">mode</span>, handleModeChange);
layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">add</span>, handleAnnotationChange);
layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">update</span>, handleAnnotationChange);
layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">remove</span>, handleAnnotationChange);
layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">state</span>, handleAnnotationChange);

<span class="hljs-keyword">let</span> brushLayer;

map.<span class="hljs-title function_">draw</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>pick which button is initially highlighted based on query parameters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (query.<span class="hljs-property">lastused</span> || query.<span class="hljs-property">active</span>) {
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">active</span> &amp;&amp; query.<span class="hljs-property">clickmode</span> !== <span class="hljs-string">&#x27;brush&#x27;</span>) {
    layer.<span class="hljs-title function_">mode</span>(query.<span class="hljs-property">active</span>);
  } <span class="hljs-keyword">else</span> {
    $(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;lastused active&#x27;</span>);
    $(<span class="hljs-string">&#x27;.annotationtype button#&#x27;</span> + (query.<span class="hljs-property">lastused</span> || query.<span class="hljs-property">active</span>)).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&#x27;lastused&#x27;</span>);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>if we have geojson as a query parameter, populate our annotations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (initialGeoJSON) {
  layer.<span class="hljs-title function_">geojson</span>(initialGeoJSON, <span class="hljs-literal">true</span>);
}

<span class="hljs-keyword">if</span> (query.<span class="hljs-property">clickmode</span> === <span class="hljs-string">&#x27;brush&#x27;</span>) {
  <span class="hljs-title function_">setBrushMode</span>();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>expose some internal parameters so you can examine them from the console</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>annotationDebug.<span class="hljs-property">map</span> = map;
annotationDebug.<span class="hljs-property">layer</span> = layer;
annotationDebug.<span class="hljs-property">query</span> = query;

<span class="hljs-comment">/**
 * When the mouse is clicked, switch to adding an annotation if appropriate.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">geo.event</span>} evt geojs event.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">mouseClickToStart</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">if</span> (evt.<span class="hljs-property">handled</span> || query.<span class="hljs-property">clickmode</span> !== <span class="hljs-string">&#x27;add&#x27;</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (evt.<span class="hljs-property">buttonsDown</span>.<span class="hljs-property">left</span>) {
    <span class="hljs-keyword">if</span> ($(<span class="hljs-string">&#x27;.annotationtype button.lastused&#x27;</span>).<span class="hljs-title function_">hasClass</span>(<span class="hljs-string">&#x27;active&#x27;</span>) &amp;&amp; query.<span class="hljs-property">keepadding</span> === <span class="hljs-string">&#x27;true&#x27;</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-title function_">select_button</span>(<span class="hljs-string">&#x27;.annotationtype button.lastused&#x27;</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (evt.<span class="hljs-property">buttonsDown</span>.<span class="hljs-property">right</span>) {
    <span class="hljs-title function_">select_button</span>(<span class="hljs-string">&#x27;.annotationtype button#&#x27;</span> +
                  $(<span class="hljs-string">&#x27;.annotationtype button.lastused&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;next&#x27;</span>));
  }
}

<span class="hljs-comment">/**
 * Handle a click or drag with a brush.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} evt The event with the activity.
 * */</span>
<span class="hljs-keyword">let</span> lastState;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">brushAction</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">let</span> source;
  <span class="hljs-keyword">if</span> (evt.<span class="hljs-property">event</span> === geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">cursor_action</span>) {
    <span class="hljs-keyword">if</span> (evt.<span class="hljs-property">operation</span> &amp;&amp; evt.<span class="hljs-property">operation</span> !== <span class="hljs-string">&#x27;union&#x27;</span> &amp;&amp; evt.<span class="hljs-property">operation</span> !== <span class="hljs-string">&#x27;difference&#x27;</span>) {
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>if this is the same action as the previous one, “blur” the brush shapes
along the direction of travel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (lastState &amp;&amp; lastState.<span class="hljs-property">stateId</span> &amp;&amp; lastState.<span class="hljs-property">stateId</span> === evt.<span class="hljs-property">evt</span>.<span class="hljs-property">state</span>.<span class="hljs-property">stateId</span>) {
      <span class="hljs-keyword">const</span> shape = $(<span class="hljs-string">&#x27;#brushshape&#x27;</span>).<span class="hljs-title function_">val</span>();
      <span class="hljs-keyword">const</span> size = <span class="hljs-built_in">parseInt</span>($(<span class="hljs-string">&#x27;#brushsize&#x27;</span>).<span class="hljs-title function_">val</span>());
      source = brushLayer.<span class="hljs-title function_">toPolygonList</span>();
      <span class="hljs-keyword">const</span> bbox1 = brushLayer.<span class="hljs-title function_">annotations</span>()[<span class="hljs-number">0</span>].<span class="hljs-title function_">_coordinates</span>();
      <span class="hljs-keyword">const</span> bbox2 = lastState.<span class="hljs-property">bbox</span>;
      <span class="hljs-keyword">if</span> (bbox1[<span class="hljs-number">0</span>].<span class="hljs-property">x</span> !== bbox2[<span class="hljs-number">0</span>].<span class="hljs-property">x</span> || bbox1[<span class="hljs-number">0</span>].<span class="hljs-property">y</span> !== bbox2[<span class="hljs-number">0</span>].<span class="hljs-property">y</span>) {
        <span class="hljs-keyword">if</span> (shape === <span class="hljs-string">&#x27;square&#x27;</span>) {
          <span class="hljs-keyword">const</span> order = (bbox1[<span class="hljs-number">0</span>].<span class="hljs-property">x</span> - bbox2[<span class="hljs-number">0</span>].<span class="hljs-property">x</span>) * (bbox1[<span class="hljs-number">0</span>].<span class="hljs-property">y</span> - bbox2[<span class="hljs-number">0</span>].<span class="hljs-property">y</span>) &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>;
          source.<span class="hljs-title function_">push</span>([[
            [bbox1[order].<span class="hljs-property">x</span>, bbox1[order].<span class="hljs-property">y</span>],
            [bbox1[order + <span class="hljs-number">2</span>].<span class="hljs-property">x</span>, bbox1[order + <span class="hljs-number">2</span>].<span class="hljs-property">y</span>],
            [bbox2[order + <span class="hljs-number">2</span>].<span class="hljs-property">x</span>, bbox2[order + <span class="hljs-number">2</span>].<span class="hljs-property">y</span>],
            [bbox2[order].<span class="hljs-property">x</span>, bbox2[order].<span class="hljs-property">y</span>]
          ]]);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">const</span> c1x = (bbox1[<span class="hljs-number">0</span>].<span class="hljs-property">x</span> + bbox1[<span class="hljs-number">2</span>].<span class="hljs-property">x</span>) * <span class="hljs-number">0.5</span>;
          <span class="hljs-keyword">const</span> c1y = (bbox1[<span class="hljs-number">0</span>].<span class="hljs-property">y</span> + bbox1[<span class="hljs-number">2</span>].<span class="hljs-property">y</span>) * <span class="hljs-number">0.5</span>;
          <span class="hljs-keyword">const</span> c2x = (bbox2[<span class="hljs-number">0</span>].<span class="hljs-property">x</span> + bbox2[<span class="hljs-number">2</span>].<span class="hljs-property">x</span>) * <span class="hljs-number">0.5</span>;
          <span class="hljs-keyword">const</span> c2y = (bbox2[<span class="hljs-number">0</span>].<span class="hljs-property">y</span> + bbox2[<span class="hljs-number">2</span>].<span class="hljs-property">y</span>) * <span class="hljs-number">0.5</span>;
          <span class="hljs-keyword">const</span> ang = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">atan2</span>(c2y - c1y, c2x - c1x) + <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>;
          source.<span class="hljs-title function_">push</span>([[
            [c1x + size / <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(ang), c1y + size / <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(ang)],
            [c1x - size / <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(ang), c1y - size / <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(ang)],
            [c2x - size / <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(ang), c2y - size / <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(ang)],
            [c2x + size / <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(ang), c2y + size / <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(ang)]
          ]]);
        }
      }
    }
    lastState = evt.<span class="hljs-property">evt</span>.<span class="hljs-property">state</span>;
    lastState.<span class="hljs-property">bbox</span> = brushLayer.<span class="hljs-title function_">annotations</span>()[<span class="hljs-number">0</span>].<span class="hljs-title function_">_coordinates</span>();
  } <span class="hljs-keyword">else</span> {
    lastState = <span class="hljs-literal">null</span>;
  }
  geo.<span class="hljs-property">util</span>.<span class="hljs-property">polyops</span>[evt.<span class="hljs-property">operation</span> || <span class="hljs-string">&#x27;union&#x27;</span>](layer, source || brushLayer, {<span class="hljs-attr">correspond</span>: {}, <span class="hljs-attr">keepAnnotations</span>: <span class="hljs-string">&#x27;exact&#x27;</span>, <span class="hljs-attr">style</span>: layer});
}

<span class="hljs-comment">/**
 * If the brush mode ends but we are supposed to be in brush mode, reset it.
 */</span>
<span class="hljs-keyword">var</span> inUpdateBrushMode;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateBrushMode</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">clickmode</span> !== <span class="hljs-string">&#x27;brush&#x27;</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (!inUpdateBrushMode) {
    inUpdateBrushMode = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setBrushMode</span>();
      inUpdateBrushMode = <span class="hljs-literal">false</span>;
    }, <span class="hljs-number">1</span>);
  }
}

<span class="hljs-comment">/**
 * If we are switching to brush mode, create an annotation that will be used
 * and hook to annotation cursor events.  If switching away, remove such an
 * annotation.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setBrushMode</span>(<span class="hljs-params">mode</span>) {
  <span class="hljs-keyword">if</span> (brushLayer) {
    brushLayer.<span class="hljs-title function_">mode</span>(<span class="hljs-literal">null</span>);
    brushLayer.<span class="hljs-title function_">removeAllAnnotations</span>();
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">clickmode</span> !== <span class="hljs-string">&#x27;brush&#x27;</span>) {
    <span class="hljs-keyword">return</span>;
  }
  layer.<span class="hljs-title function_">mode</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">if</span> (!brushLayer) {
    brushLayer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;annotation&#x27;</span>, {
      <span class="hljs-attr">renderer</span>: query.<span class="hljs-property">renderer</span> ? (query.<span class="hljs-property">renderer</span> === <span class="hljs-string">&#x27;html&#x27;</span> ? <span class="hljs-literal">null</span> : query.<span class="hljs-property">renderer</span>) : <span class="hljs-literal">undefined</span>,
      <span class="hljs-attr">showLabels</span>: <span class="hljs-literal">false</span>
    });
    brushLayer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">cursor_click</span>, brushAction);
    brushLayer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">cursor_action</span>, brushAction);
    brushLayer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">mode</span>, updateBrushMode);
    brushLayer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">state</span>, updateBrushMode);
  }
  annotationDebug.<span class="hljs-property">brushLayer</span> = brushLayer;
  <span class="hljs-keyword">const</span> shape = $(<span class="hljs-string">&#x27;#brushshape&#x27;</span>).<span class="hljs-title function_">val</span>();
  <span class="hljs-keyword">const</span> size = <span class="hljs-built_in">parseInt</span>($(<span class="hljs-string">&#x27;#brushsize&#x27;</span>).<span class="hljs-title function_">val</span>());
  <span class="hljs-keyword">const</span> annot = geo.<span class="hljs-property">registries</span>.<span class="hljs-property">annotations</span>[shape].<span class="hljs-title function_">func</span>({<span class="hljs-attr">layer</span>: layer});
  brushLayer.<span class="hljs-title function_">addAnnotation</span>(annot);
  annot.<span class="hljs-title function_">_coordinates</span>([{<span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}, {<span class="hljs-attr">x</span>: size, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}, {<span class="hljs-attr">x</span>: size, <span class="hljs-attr">y</span>: size}, {<span class="hljs-attr">y</span>: size, <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>}]);
  brushLayer.<span class="hljs-title function_">mode</span>(brushLayer.<span class="hljs-property">modes</span>.<span class="hljs-property">cursor</span>, annot);
  map.<span class="hljs-title function_">draw</span>();
}

<span class="hljs-comment">/**
 * Handle changes to our controls.
 *
 * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">change_controls</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">var</span> ctl = $(evt.<span class="hljs-property">target</span>),
      param = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;param-name&#x27;</span>),
      value = ctl.<span class="hljs-title function_">val</span>();
  <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>)) {
    value = ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;:checked&#x27;</span>) ? <span class="hljs-string">&#x27;true&#x27;</span> : <span class="hljs-string">&#x27;false&#x27;</span>;
  }
  <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;&#x27;</span> &amp;&amp; ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>)) {
    value = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>);
  }
  <span class="hljs-keyword">if</span> (!param || value === query[param]) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">switch</span> (param) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;labels&#x27;</span>:
      layer.<span class="hljs-title function_">options</span>(<span class="hljs-string">&#x27;showLabels&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span> + value !== <span class="hljs-string">&#x27;false&#x27;</span>);
      layer.<span class="hljs-title function_">draw</span>();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;clickmode&#x27;</span>:
      layer.<span class="hljs-title function_">options</span>(<span class="hljs-string">&#x27;clickToEdit&#x27;</span>, value === <span class="hljs-string">&#x27;edit&#x27;</span>);
      layer.<span class="hljs-title function_">draw</span>();
      <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;brush&#x27;</span>) {
        $(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;lastused active&#x27;</span>);
        query.<span class="hljs-property">lastused</span> = query.<span class="hljs-property">active</span> ? query.<span class="hljs-property">active</span> : query.<span class="hljs-property">lastused</span>;
        query.<span class="hljs-property">active</span> = <span class="hljs-literal">undefined</span>;
      }
      <span class="hljs-keyword">break</span>;
  }
  query[param] = value;
  <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;&#x27;</span> || (ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>) &amp;&amp;
      value === ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>))) {
    <span class="hljs-keyword">delete</span> query[param];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>update our query parameters, os when you reload the page it is in the
same state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  utils.<span class="hljs-title function_">setQuery</span>(query);
  <span class="hljs-keyword">if</span> ([<span class="hljs-string">&#x27;clickmode&#x27;</span>, <span class="hljs-string">&#x27;brushshape&#x27;</span>, <span class="hljs-string">&#x27;brushsize&#x27;</span>].<span class="hljs-title function_">indexOf</span>(param) &gt;= <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">setBrushMode</span>();
  }
}

<span class="hljs-comment">/**
 * Handle changes to the geojson.
 *
 * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">change_geojson</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">var</span> ctl = $(evt.<span class="hljs-property">target</span>),
      value = ctl.<span class="hljs-title function_">val</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>when we update the geojson from the textarea control, raise a flag so we
(a) ignore bad geojson, and (b) don’t replace the user’s geojson with
the auto-generated geojson</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fromGeojsonUpdate = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> result = layer.<span class="hljs-title function_">geojson</span>(value, <span class="hljs-string">&#x27;update&#x27;</span>);
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">save</span> &amp;&amp; result !== <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">var</span> geojson = layer.<span class="hljs-title function_">geojson</span>();
    query.<span class="hljs-property">geojson</span> = geojson ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(geojson) : <span class="hljs-literal">undefined</span>;
    utils.<span class="hljs-title function_">setQuery</span>(query);
  }
  fromGeojsonUpdate = <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * Handle selecting an annotation button.
 *
 * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">select_annotation</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-title function_">select_button</span>(evt.<span class="hljs-property">target</span>);
}

<span class="hljs-comment">/**
 * Select an annotation button by jquery selector.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} ctl a jquery selector or element.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">select_button</span>(<span class="hljs-params">ctl</span>) {
  ctl = $(ctl);
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">clickmode</span> === <span class="hljs-string">&#x27;brush&#x27;</span>) {
    query.<span class="hljs-property">clickmode</span> = <span class="hljs-string">&#x27;edit&#x27;</span>;
    layer.<span class="hljs-title function_">options</span>(<span class="hljs-string">&#x27;clickToEdit&#x27;</span>, <span class="hljs-literal">true</span>);
    $(<span class="hljs-string">&#x27;#clickmode&#x27;</span>).<span class="hljs-title function_">val</span>(query.<span class="hljs-property">clickmode</span>);
    utils.<span class="hljs-title function_">setQuery</span>(query);
    <span class="hljs-title function_">setBrushMode</span>();
  }
  <span class="hljs-keyword">var</span> wasactive = ctl.<span class="hljs-title function_">hasClass</span>(<span class="hljs-string">&#x27;active&#x27;</span>),
      id = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>);
  fromButtonSelect = <span class="hljs-literal">true</span>;
  layer.<span class="hljs-title function_">mode</span>(wasactive ? <span class="hljs-literal">null</span> : id);
  fromButtonSelect = <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * When the annotation mode changes, update the controls to reflect it.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">geo.event</span>} evt a geojs mode change event.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleModeChange</span>(<span class="hljs-params">evt</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p>highlight the current buttons based on the current mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> mode = layer.<span class="hljs-title function_">mode</span>();
  $(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;active&#x27;</span>);
  <span class="hljs-keyword">if</span> (mode) {
    $(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;lastused active&#x27;</span>);
    $(<span class="hljs-string">&#x27;.annotationtype button#&#x27;</span> + mode).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&#x27;lastused active&#x27;</span>);
  }
  $(<span class="hljs-string">&#x27;#instructions&#x27;</span>).<span class="hljs-title function_">attr</span>(
    <span class="hljs-string">&#x27;annotation&#x27;</span>, $(<span class="hljs-string">&#x27;.annotationtype button.active&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>) || <span class="hljs-string">&#x27;none&#x27;</span>);
  query.<span class="hljs-property">active</span> = $(<span class="hljs-string">&#x27;.annotationtype button.active&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>) || <span class="hljs-literal">undefined</span>;
  query.<span class="hljs-property">lastused</span> = query.<span class="hljs-property">active</span> ? <span class="hljs-literal">undefined</span> : $(<span class="hljs-string">&#x27;.annotationtype button.lastused&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>);
  utils.<span class="hljs-title function_">setQuery</span>(query);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>if we are in keep-adding mode, and the mode changed to null, and that
wasn’t caused by clicking the button, reenable the annotation mode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!mode &amp;&amp; !fromButtonSelect &amp;&amp; query.<span class="hljs-property">keepadding</span> === <span class="hljs-string">&#x27;true&#x27;</span> &amp;&amp; query.<span class="hljs-property">clickmode</span> !== <span class="hljs-string">&#x27;brush&#x27;</span>) {
    layer.<span class="hljs-title function_">mode</span>($(<span class="hljs-string">&#x27;.annotationtype button.lastused&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>));
  }
}

<span class="hljs-comment">/**
 * When an annotation is created or removed, update our list of annotations.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">geo.event</span>} evt a geojs mode change event.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAnnotationChange</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">var</span> annotations = layer.<span class="hljs-title function_">annotations</span>();
  <span class="hljs-keyword">var</span> ids = annotations.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">annotation</span>) {
    <span class="hljs-keyword">return</span> annotation.<span class="hljs-title function_">id</span>();
  });
  <span class="hljs-keyword">var</span> present = [];
  $(<span class="hljs-string">&#x27;#annotationlist .entry&#x27;</span>).<span class="hljs-title function_">each</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-keyword">var</span> entry = $(<span class="hljs-variable language_">this</span>);
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>) === <span class="hljs-string">&#x27;sample&#x27;</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> id = entry.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-id&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p>Remove deleted annotations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!ids.<span class="hljs-title function_">includes</span>(id)) {
      entry.<span class="hljs-title function_">remove</span>();
      <span class="hljs-keyword">return</span>;
    }
    present.<span class="hljs-title function_">push</span>(id);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>update existing elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    entry.<span class="hljs-title function_">find</span>(<span class="hljs-string">&#x27;.entry-name&#x27;</span>).<span class="hljs-title function_">text</span>(layer.<span class="hljs-title function_">annotationById</span>(id).<span class="hljs-title function_">name</span>());
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p>Add if new and fully created</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.<span class="hljs-title function_">each</span>(ids, <span class="hljs-keyword">function</span> (<span class="hljs-params">idx, id</span>) {
    <span class="hljs-keyword">if</span> (present.<span class="hljs-title function_">includes</span>(id)) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> annotation = layer.<span class="hljs-title function_">annotationById</span>(id);
    <span class="hljs-keyword">if</span> (annotation.<span class="hljs-title function_">state</span>() === geo.<span class="hljs-property">annotation</span>.<span class="hljs-property">state</span>.<span class="hljs-property">create</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> entry = $(<span class="hljs-string">&#x27;#annotationlist .entry#sample&#x27;</span>).<span class="hljs-title function_">clone</span>();
    entry.<span class="hljs-title function_">attr</span>({<span class="hljs-attr">id</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;annotation-id&#x27;</span>: id});
    entry.<span class="hljs-title function_">find</span>(<span class="hljs-string">&#x27;.entry-name&#x27;</span>).<span class="hljs-title function_">text</span>(annotation.<span class="hljs-title function_">name</span>());
    $(<span class="hljs-string">&#x27;#annotationlist&#x27;</span>).<span class="hljs-title function_">append</span>(entry);
  });
  $(<span class="hljs-string">&#x27;#annotationheader&#x27;</span>).<span class="hljs-title function_">css</span>(
    <span class="hljs-string">&#x27;display&#x27;</span>, $(<span class="hljs-string">&#x27;#annotationlist .entry&#x27;</span>).<span class="hljs-property">length</span> &lt;= <span class="hljs-number">1</span> ? <span class="hljs-string">&#x27;none&#x27;</span> : <span class="hljs-string">&#x27;block&#x27;</span>);
  <span class="hljs-keyword">if</span> (!fromGeojsonUpdate) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>update the geojson textarea</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> geojson = layer.<span class="hljs-title function_">geojson</span>();
    $(<span class="hljs-string">&#x27;#geojson&#x27;</span>).<span class="hljs-title function_">val</span>(geojson ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(geojson, <span class="hljs-literal">undefined</span>, <span class="hljs-number">2</span>) : <span class="hljs-string">&#x27;&#x27;</span>);
    <span class="hljs-keyword">if</span> (query.<span class="hljs-property">save</span>) {
      query.<span class="hljs-property">geojson</span> = geojson ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(geojson) : <span class="hljs-literal">undefined</span>;
      utils.<span class="hljs-title function_">setQuery</span>(query);
    }
  }
}

<span class="hljs-comment">/**
 * Handle selecting a control.
 *
 * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">select_control</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">var</span> mode,
      ctl = $(evt.<span class="hljs-property">target</span>),
      action = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;action&#x27;</span>),
      id = ctl.<span class="hljs-title function_">closest</span>(<span class="hljs-string">&#x27;.entry&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-id&#x27;</span>),
      annotation = layer.<span class="hljs-title function_">annotationById</span>(id);
  <span class="hljs-keyword">switch</span> (action) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;adjust&#x27;</span>:
      layer.<span class="hljs-title function_">mode</span>(layer.<span class="hljs-property">modes</span>.<span class="hljs-property">edit</span>, annotation);
      layer.<span class="hljs-title function_">draw</span>();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;edit&#x27;</span>:
      <span class="hljs-title function_">show_edit_dialog</span>(id);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;remove&#x27;</span>:
      layer.<span class="hljs-title function_">removeAnnotation</span>(annotation);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;remove-all&#x27;</span>:
      fromButtonSelect = <span class="hljs-literal">true</span>;
      mode = layer.<span class="hljs-title function_">mode</span>();
      layer.<span class="hljs-title function_">mode</span>(<span class="hljs-literal">null</span>);
      layer.<span class="hljs-title function_">removeAllAnnotations</span>();
      layer.<span class="hljs-title function_">mode</span>(mode);
      fromButtonSelect = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">break</span>;
  }
}

<span class="hljs-comment">/**
 * Show the edit dialog for a particular annotation.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} id the annotation id to edit.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">show_edit_dialog</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">var</span> annotation = layer.<span class="hljs-title function_">annotationById</span>(id),
      type = annotation.<span class="hljs-title function_">type</span>(),
      typeMatch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">&#x27;(^| )(&#x27;</span> + type + <span class="hljs-string">&#x27;|all)( |$)&#x27;</span>),
      opt = annotation.<span class="hljs-title function_">options</span>(),
      dlg = $(<span class="hljs-string">&#x27;#editdialog&#x27;</span>);

  $(<span class="hljs-string">&#x27;#edit-validation-error&#x27;</span>, dlg).<span class="hljs-title function_">text</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  dlg.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-id&#x27;</span>, id);
  dlg.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-type&#x27;</span>, type);
  $(<span class="hljs-string">&#x27;[option=&quot;name&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>(annotation.<span class="hljs-title function_">name</span>());
  $(<span class="hljs-string">&#x27;[option=&quot;label&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>(annotation.<span class="hljs-title function_">label</span>(<span class="hljs-literal">undefined</span>, <span class="hljs-literal">true</span>));
  $(<span class="hljs-string">&#x27;[option=&quot;description&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>(annotation.<span class="hljs-title function_">description</span>());</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>populate each control with the current value of the annotation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">&#x27;.form-group[annotation-types]&#x27;</span>).<span class="hljs-title function_">each</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-keyword">var</span> ctl = $(<span class="hljs-variable language_">this</span>),
        key = $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;option&#x27;</span>),
        format = $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;format&#x27;</span>),
        value;
    <span class="hljs-keyword">if</span> (!ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-types&#x27;</span>).<span class="hljs-title function_">match</span>(typeMatch)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p>if a property doesn’t exist for the current annotation’s type, hide
the control</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ctl.<span class="hljs-title function_">hide</span>();
      <span class="hljs-keyword">return</span>;
    }
    ctl.<span class="hljs-title function_">show</span>();
    <span class="hljs-keyword">switch</span> ($(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;optiontype&#x27;</span>)) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;option&#x27;</span>:
        value = opt[key];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;label&#x27;</span>:
        value = (opt.<span class="hljs-property">labelStyle</span> || {})[key];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        value = opt.<span class="hljs-property">style</span>[key];
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">switch</span> (format) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;angle&#x27;</span>:
        <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span> &amp;&amp; value !== <span class="hljs-literal">null</span> &amp;&amp; value !== <span class="hljs-string">&#x27;&#x27;</span>) {
          value = <span class="hljs-string">&#x27;&#x27;</span> + +(+value * <span class="hljs-number">180.0</span> / <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">4</span>) + <span class="hljs-string">&#x27; deg&#x27;</span>;
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;color&#x27;</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p>always show colors as hex values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        value = geo.<span class="hljs-property">util</span>.<span class="hljs-title function_">convertColorToHex</span>(value || {<span class="hljs-attr">r</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">g</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">0</span>}, <span class="hljs-string">&#x27;needed&#x27;</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;coordinate2&#x27;</span>:
        <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span> &amp;&amp; value !== <span class="hljs-literal">null</span> &amp;&amp; value !== <span class="hljs-string">&#x27;&#x27;</span>) {
          value = <span class="hljs-string">&#x27;&#x27;</span> + value.<span class="hljs-property">x</span> + <span class="hljs-string">&#x27;, &#x27;</span> + value.<span class="hljs-property">y</span>;
        }
    }
    <span class="hljs-keyword">if</span> ((value === <span class="hljs-literal">undefined</span> || value === <span class="hljs-string">&#x27;&#x27;</span> || value === <span class="hljs-literal">null</span>) &amp;&amp; $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;select&#x27;</span>)) {
      value = $(<span class="hljs-string">&#x27;[option] option&#x27;</span>, ctl).<span class="hljs-title function_">eq</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">val</span>();
    }
    $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">val</span>(value === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;&#x27;</span> : <span class="hljs-string">&#x27;&#x27;</span> + value);
  });
  dlg.<span class="hljs-title function_">one</span>(<span class="hljs-string">&#x27;shown.bs.modal&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    $(<span class="hljs-string">&#x27;[option=&quot;name&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">focus</span>();
  });
  dlg.<span class="hljs-title function_">modal</span>();
}

<span class="hljs-comment">/**
 * Update an annotation from values in the edit dialog.
 *
 * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">edit_update</span>(<span class="hljs-params">evt</span>) {
  evt.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-keyword">var</span> dlg = $(<span class="hljs-string">&#x27;#editdialog&#x27;</span>),
      id = dlg.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-id&#x27;</span>),
      annotation = layer.<span class="hljs-title function_">annotationById</span>(id),
      opt = annotation.<span class="hljs-title function_">options</span>(),
      type = annotation.<span class="hljs-title function_">type</span>(),
      typeMatch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">&#x27;(^| )(&#x27;</span> + type + <span class="hljs-string">&#x27;|all)( |$)&#x27;</span>),
      newopt = {<span class="hljs-attr">style</span>: {}, <span class="hljs-attr">labelStyle</span>: {}},
      error;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p>validate form values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">&#x27;.form-group[annotation-types]&#x27;</span>).<span class="hljs-title function_">each</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-keyword">var</span> ctl = $(<span class="hljs-variable language_">this</span>),
        key = $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;option&#x27;</span>),
        format = $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;format&#x27;</span>),
        value, oldvalue;
    <span class="hljs-keyword">if</span> (!ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-types&#x27;</span>).<span class="hljs-title function_">match</span>(typeMatch)) {
      <span class="hljs-keyword">return</span>;
    }
    value = $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">val</span>();
    <span class="hljs-keyword">switch</span> (format) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;angle&#x27;</span>:
        <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^\s*[.0-9eE]+\s*$/</span>.<span class="hljs-title function_">exec</span>(value)) {
          value += <span class="hljs-string">&#x27;deg&#x27;</span>;
        }
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">switch</span> (key) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;textScaled&#x27;</span>:
        <span class="hljs-keyword">if</span> ([<span class="hljs-string">&#x27;true&#x27;</span>, <span class="hljs-string">&#x27;on&#x27;</span>, <span class="hljs-string">&#x27;yes&#x27;</span>].<span class="hljs-title function_">indexOf</span>(value.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">toLowerCase</span>()) &gt;= <span class="hljs-number">0</span>) {
          value = map.<span class="hljs-title function_">zoom</span>();
        }
        <span class="hljs-keyword">break</span>;
    }
    value = layer.<span class="hljs-title function_">validateAttribute</span>(value, format);
    <span class="hljs-keyword">switch</span> ($(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;optiontype&#x27;</span>)) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;option&#x27;</span>:
        oldvalue = opt[key];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;label&#x27;</span>:
        oldvalue = (opt.<span class="hljs-property">labelStyle</span> || {})[key];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        oldvalue = opt.<span class="hljs-property">style</span>[key];
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">if</span> (value === oldvalue || (oldvalue === <span class="hljs-literal">undefined</span> &amp;&amp; value === <span class="hljs-string">&#x27;&#x27;</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>don’t change anything</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {
      error = $(<span class="hljs-string">&#x27;label&#x27;</span>, ctl).<span class="hljs-title function_">text</span>() + <span class="hljs-string">&#x27; is not a valid value&#x27;</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">switch</span> ($(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;optiontype&#x27;</span>)) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;option&#x27;</span>:
          newopt[key] = value;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;label&#x27;</span>:
          newopt.<span class="hljs-property">labelStyle</span>[key] = value;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-attr">default</span>:
          newopt.<span class="hljs-property">style</span>[key] = value;
          <span class="hljs-keyword">break</span>;
      }
    }
  });
  <span class="hljs-keyword">if</span> (error) {
    $(<span class="hljs-string">&#x27;#edit-validation-error&#x27;</span>, dlg).<span class="hljs-title function_">text</span>(error);
    <span class="hljs-keyword">return</span>;
  }
  annotation.<span class="hljs-title function_">name</span>($(<span class="hljs-string">&#x27;[option=&quot;name&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>());
  annotation.<span class="hljs-title function_">label</span>($(<span class="hljs-string">&#x27;[option=&quot;label&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>() || <span class="hljs-literal">null</span>);
  annotation.<span class="hljs-title function_">description</span>($(<span class="hljs-string">&#x27;[option=&quot;description&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>() || <span class="hljs-string">&#x27;&#x27;</span>);
  annotation.<span class="hljs-title function_">options</span>(newopt).<span class="hljs-title function_">draw</span>();

  dlg.<span class="hljs-title function_">modal</span>(<span class="hljs-string">&#x27;hide&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p>refresh the annotation list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-title function_">handleAnnotationChange</span>();
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
