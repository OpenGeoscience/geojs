<!DOCTYPE html>

<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* globals $, geo, utils */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>This is extensively based on the Annotation example.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>Always positive modulo function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">modulo</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> ((a % b) + b) % b;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Get url query parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> query = utils.<span class="hljs-title function_">getQuery</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>If a flag is set, add some extra tile sources.  Make sure you have the
appropriate licenses before doing this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (query.<span class="hljs-property">extra</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>This is a proof of concept; it may require licensing, or at least
registering with Microsoft</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  geo.<span class="hljs-property">osmLayer</span>.<span class="hljs-property">tileSources</span>[<span class="hljs-string">&#x27;bing-satellite&#x27;</span>] = {
    <span class="hljs-attr">url</span>: <span class="hljs-function">(<span class="hljs-params">x, y, z, s</span>) =&gt;</span> {
      s = s[<span class="hljs-title function_">modulo</span>(x + y + z, s.<span class="hljs-property">length</span>)];
      <span class="hljs-keyword">let</span> tile = <span class="hljs-string">&#x27;&#x27;</span>;
      <span class="hljs-keyword">for</span> (; z &gt; <span class="hljs-number">0</span>; z -= <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">const</span> d = (x % <span class="hljs-number">2</span>) + (y % <span class="hljs-number">2</span>) * <span class="hljs-number">2</span>;
        tile = <span class="hljs-string">&#x27;&#x27;</span> + d + tile;
        x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(x / <span class="hljs-number">2</span>);
        y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(y / <span class="hljs-number">2</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-string">`http://ecn.t<span class="hljs-subst">${s}</span>.tiles.virtualearth.net/tiles/a<span class="hljs-subst">${tile}</span>.jpeg?g=5000`</span>;
    },
    <span class="hljs-attr">attribution</span>: <span class="hljs-string">&#x27;&lt;a href=&quot;https://www.microsoft.com/maps/product/terms.html&quot;&gt;Microsoft&lt;/a&gt; Virtual Earth&#x27;</span>,
    <span class="hljs-attr">subdomains</span>: <span class="hljs-string">&#x27;0123&#x27;</span>,
    <span class="hljs-attr">minLevel</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">maxLevel</span>: <span class="hljs-number">19</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Bing Satellite&#x27;</span>
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>This requires that you have an appropriate Esri ArcGIS license to use.  It
is possible that its use might be allowed in certain uses via
<a href="https://www.arcgis.com/home/item.html?id=10df2279f9684e4a9f6a7f08febac2a9">https://www.arcgis.com/home/item.html?id=10df2279f9684e4a9f6a7f08febac2a9</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  geo.<span class="hljs-property">osmLayer</span>.<span class="hljs-property">tileSources</span>[<span class="hljs-string">&#x27;arcgis-satellite&#x27;</span>] = {
    <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png&#x27;</span>,
    <span class="hljs-attr">attribution</span>: <span class="hljs-string">&#x27;&lt;a href=&quot;https://www.esri.com/en-us/search/?q=world%20imagery&quot;&gt;Esri World Imagery&lt;/a&gt;&#x27;</span>,
    <span class="hljs-attr">minLevel</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">maxLevel</span>: <span class="hljs-number">19</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;ArcGIS Satellite&#x27;</span>
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>Add a blank tile for removing the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>geo.<span class="hljs-property">osmLayer</span>.<span class="hljs-property">tileSources</span>.<span class="hljs-property">false</span> = {
  <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/data/white.jpg&#x27;</span>,
  <span class="hljs-attr">attribution</span>: <span class="hljs-string">&#x27;&#x27;</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;None&#x27;</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>Fill select drop down</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> options = geo.<span class="hljs-property">osmLayer</span>.<span class="hljs-property">tileSources</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> option <span class="hljs-keyword">in</span> options) {
  <span class="hljs-keyword">var</span> newOption = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;option&#x27;</span>);
  newOption.<span class="hljs-property">value</span> = option;
  newOption.<span class="hljs-property">text</span> = options[option].<span class="hljs-property">name</span> ? options[option].<span class="hljs-property">name</span> : option;
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;basemap&#x27;</span>).<span class="hljs-title function_">appendChild</span>(newOption);
}

<span class="hljs-keyword">var</span> map, mapLayer, layer, fromButtonSelect, fromGeojsonUpdate;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>Set controls based on query parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$(<span class="hljs-string">&#x27;#basemap&#x27;</span>).<span class="hljs-title function_">val</span>(query.<span class="hljs-property">basemap</span> || <span class="hljs-string">&#x27;osm&#x27;</span>);
$(<span class="hljs-string">&#x27;#mapurl&#x27;</span>).<span class="hljs-title function_">val</span>(query.<span class="hljs-property">mapurl</span> || <span class="hljs-string">&#x27;&#x27;</span>);
$(<span class="hljs-string">&#x27;#mapurl&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;hidden&#x27;</span>, $(<span class="hljs-string">&#x27;#basemap&#x27;</span>).<span class="hljs-title function_">val</span>() !== <span class="hljs-string">&#x27;custom&#x27;</span>);
$(<span class="hljs-string">&#x27;#distunit&#x27;</span>).<span class="hljs-title function_">val</span>(query.<span class="hljs-property">distunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>);
$(<span class="hljs-string">&#x27;#areaunit&#x27;</span>).<span class="hljs-title function_">val</span>(query.<span class="hljs-property">areaunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>);
$(<span class="hljs-string">&#x27;#clickmode&#x27;</span>).<span class="hljs-title function_">val</span>(query.<span class="hljs-property">clickmode</span> || <span class="hljs-string">&#x27;edit&#x27;</span>);
$(<span class="hljs-string">&#x27;#keepadding&#x27;</span>).<span class="hljs-title function_">prop</span>(<span class="hljs-string">&#x27;checked&#x27;</span>, query.<span class="hljs-property">keepadding</span> === <span class="hljs-string">&#x27;true&#x27;</span>);
$(<span class="hljs-string">&#x27;#showLabels&#x27;</span>).<span class="hljs-title function_">prop</span>(<span class="hljs-string">&#x27;checked&#x27;</span>, query.<span class="hljs-property">labels</span> !== <span class="hljs-string">&#x27;false&#x27;</span>);
<span class="hljs-keyword">if</span> (query.<span class="hljs-property">lastannotation</span>) {
  $(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;lastused&#x27;</span>);
  $(<span class="hljs-string">&#x27;.annotationtype button#&#x27;</span> + query.<span class="hljs-property">lastannotation</span>).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&#x27;lastused&#x27;</span>);
}
<span class="hljs-keyword">if</span> (query.<span class="hljs-property">hide</span>) {
  $(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&#x27;reduced&#x27;</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>You can set the initial annotations via a query parameter.  If the query
parameter ‘save=true’ is specified, the query will be updated with the
geojson.  This can become too long for some browsers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> initialGeoJSON = query.<span class="hljs-property">geojson</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>respond to changes in our controls</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;change&#x27;</span>, change_controls);
$(<span class="hljs-string">&#x27;#geojson[type=textarea]&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;input propertychange&#x27;</span>, change_geojson);
$(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, select_control);
$(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;click&#x27;</span>, select_annotation);
$(<span class="hljs-string">&#x27;#editdialog&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;submit&#x27;</span>, edit_update);
$(<span class="hljs-string">&#x27;#show,#hide&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;click&#x27;</span>, toggle_hide);

$(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;no-controls&#x27;</span>, query.<span class="hljs-property">controls</span> === <span class="hljs-string">&#x27;false&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>Default to near Fresno unless a position is specified.  If there is existing
data, we frame the available data instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>map = geo.<span class="hljs-title function_">map</span>({
  <span class="hljs-attr">node</span>: <span class="hljs-string">&#x27;#map&#x27;</span>,
  <span class="hljs-attr">center</span>: {
    <span class="hljs-attr">x</span>: query.<span class="hljs-property">x</span> !== <span class="hljs-literal">undefined</span> ? +query.<span class="hljs-property">x</span> : -<span class="hljs-number">119.150</span>,
    <span class="hljs-attr">y</span>: query.<span class="hljs-property">y</span> !== <span class="hljs-literal">undefined</span> ? +query.<span class="hljs-property">y</span> : <span class="hljs-number">36.712</span>
  },
  <span class="hljs-attr">max</span>: <span class="hljs-number">21</span>,
  <span class="hljs-attr">zoom</span>: query.<span class="hljs-property">zoom</span> ? +query.<span class="hljs-property">zoom</span> : <span class="hljs-number">10</span>,
  <span class="hljs-attr">rotation</span>: query.<span class="hljs-property">rotation</span> ? +query.<span class="hljs-property">rotation</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span> : <span class="hljs-number">0</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>Create a tile layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>mapLayer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;osm&#x27;</span>, {
  <span class="hljs-attr">url</span>: query.<span class="hljs-property">basemap</span> === <span class="hljs-string">&#x27;custom&#x27;</span> ? query.<span class="hljs-property">mapurl</span> || <span class="hljs-string">&#x27;&#x27;</span> : <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">source</span>: query.<span class="hljs-property">basemap</span> === <span class="hljs-string">&#x27;custom&#x27;</span> ? <span class="hljs-literal">undefined</span> : query.<span class="hljs-property">basemap</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p>Create an annotation layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>layer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;annotation&#x27;</span>, {
  <span class="hljs-attr">renderer</span>: query.<span class="hljs-property">renderer</span> ? (query.<span class="hljs-property">renderer</span> === <span class="hljs-string">&#x27;html&#x27;</span> ? <span class="hljs-literal">null</span> : query.<span class="hljs-property">renderer</span>) : <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">annotations</span>: query.<span class="hljs-property">renderer</span> ? <span class="hljs-literal">undefined</span> : geo.<span class="hljs-title function_">listAnnotations</span>(),
  <span class="hljs-attr">showLabels</span>: query.<span class="hljs-property">labels</span> === <span class="hljs-string">&#x27;false&#x27;</span> ? <span class="hljs-literal">false</span> : <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(geo.<span class="hljs-property">annotation</span>.<span class="hljs-property">state</span>),
  <span class="hljs-attr">clickToEdit</span>: !query.<span class="hljs-property">clickmode</span> || query.<span class="hljs-property">clickmode</span> === <span class="hljs-string">&#x27;edit&#x27;</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>We have to hook the internal _updateLabels method so we can label vertices
during editing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> s__updateLabels = layer.<span class="hljs-property">_updateLabels</span>;
layer.<span class="hljs-property">_updateLabels</span> = <span class="hljs-function">(<span class="hljs-params">labels</span>) =&gt;</span> {
  layer.<span class="hljs-title function_">annotations</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">annotation, idx</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> ([geo.<span class="hljs-property">annotation</span>.<span class="hljs-property">state</span>.<span class="hljs-property">create</span>, geo.<span class="hljs-property">annotation</span>.<span class="hljs-property">state</span>.<span class="hljs-property">edit</span>].<span class="hljs-title function_">indexOf</span>(annotation.<span class="hljs-title function_">state</span>()) &gt;= <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">labelVertices</span>(annotation, idx, labels);
    }
  });
  <span class="hljs-title function_">s__updateLabels</span>(labels);
  <span class="hljs-keyword">return</span> layer;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p>Bind to the mouse click and annotation mode events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">mouseclick</span>, mouseClickToStart);
layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">mode</span>, handleModeChange);
layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">add</span>, handleAnnotationChange);
layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">update</span>, handleAnnotationChange);
layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">remove</span>, handleAnnotationChange);
layer.<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">state</span>, handleAnnotationChange);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>Add a scale widget</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> uiLayer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;ui&#x27;</span>);
<span class="hljs-keyword">var</span> scaleWidget = uiLayer.<span class="hljs-title function_">createWidget</span>(<span class="hljs-string">&#x27;scale&#x27;</span>, {
  <span class="hljs-attr">position</span>: {<span class="hljs-attr">right</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span>},
  <span class="hljs-attr">units</span>: query.<span class="hljs-property">distunit</span> === <span class="hljs-string">&#x27;si&#x27;</span> ? <span class="hljs-string">&#x27;si&#x27;</span> : <span class="hljs-string">&#x27;miles&#x27;</span>
});

map.<span class="hljs-title function_">draw</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p>Pick which button is initially highlighted based on query parameters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (query.<span class="hljs-property">lastused</span> || query.<span class="hljs-property">active</span>) {
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">active</span>) {
    layer.<span class="hljs-title function_">mode</span>(query.<span class="hljs-property">active</span>);
  } <span class="hljs-keyword">else</span> {
    $(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;lastused active&#x27;</span>);
    $(<span class="hljs-string">&#x27;.annotationtype button#&#x27;</span> + query.<span class="hljs-property">lastused</span>).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&#x27;lastused&#x27;</span>);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>If we have geojson as a query parameter, populate our annotations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (initialGeoJSON) {
  layer.<span class="hljs-title function_">geojson</span>(initialGeoJSON, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">x</span> === <span class="hljs-literal">undefined</span> || query.<span class="hljs-property">y</span> === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">const</span> range = {};
    layer.<span class="hljs-title function_">annotations</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> ptlist = a.<span class="hljs-title function_">coordinates</span>();
      <span class="hljs-keyword">if</span> (ptlist.<span class="hljs-property">outer</span>) {
        ptlist = [ptlist.<span class="hljs-property">outer</span>.<span class="hljs-title function_">slice</span>()].<span class="hljs-title function_">concat</span>((ptlist.<span class="hljs-property">inner</span> || []).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">l</span>) =&gt;</span> l.<span class="hljs-title function_">slice</span>()));
      } <span class="hljs-keyword">else</span> {
        ptlist = [ptlist.<span class="hljs-title function_">slice</span>()];
      }
      ptlist.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">pts</span>) =&gt;</span> {
        pts.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">pt</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (range.<span class="hljs-property">left</span> === <span class="hljs-literal">undefined</span> || pt.<span class="hljs-property">x</span> &lt; range.<span class="hljs-property">left</span>) {
            range.<span class="hljs-property">left</span> = pt.<span class="hljs-property">x</span>;
          }
          <span class="hljs-keyword">if</span> (range.<span class="hljs-property">bottom</span> === <span class="hljs-literal">undefined</span> || pt.<span class="hljs-property">y</span> &lt; range.<span class="hljs-property">bottom</span>) {
            range.<span class="hljs-property">bottom</span> = pt.<span class="hljs-property">y</span>;
          }
          <span class="hljs-keyword">if</span> (range.<span class="hljs-property">right</span> === <span class="hljs-literal">undefined</span> || pt.<span class="hljs-property">x</span> &gt; range.<span class="hljs-property">right</span>) {
            range.<span class="hljs-property">right</span> = pt.<span class="hljs-property">x</span>;
          }
          <span class="hljs-keyword">if</span> (range.<span class="hljs-property">top</span> === <span class="hljs-literal">undefined</span> || pt.<span class="hljs-property">y</span> &gt; range.<span class="hljs-property">top</span>) {
            range.<span class="hljs-property">top</span> = pt.<span class="hljs-property">y</span>;
          }
        });
      });
    });
    map.<span class="hljs-title function_">bounds</span>(range);
    map.<span class="hljs-title function_">zoom</span>(map.<span class="hljs-title function_">zoom</span>() - <span class="hljs-number">0.25</span>);
  }
}

<span class="hljs-comment">/**
 * When the mouse is clicked, switch to adding an annotation if appropriate.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">geo.event</span>} evt geojs event.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">mouseClickToStart</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">if</span> (evt.<span class="hljs-property">handled</span> || query.<span class="hljs-property">clickmode</span> !== <span class="hljs-string">&#x27;add&#x27;</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (evt.<span class="hljs-property">buttonsDown</span>.<span class="hljs-property">left</span>) {
    <span class="hljs-keyword">if</span> ($(<span class="hljs-string">&#x27;.annotationtype button.lastused&#x27;</span>).<span class="hljs-title function_">hasClass</span>(<span class="hljs-string">&#x27;active&#x27;</span>) &amp;&amp; query.<span class="hljs-property">keepadding</span> === <span class="hljs-string">&#x27;true&#x27;</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-title function_">select_button</span>(<span class="hljs-string">&#x27;.annotationtype button.lastused&#x27;</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (evt.<span class="hljs-property">buttonsDown</span>.<span class="hljs-property">right</span>) {
    <span class="hljs-title function_">select_button</span>(<span class="hljs-string">&#x27;.annotationtype button#&#x27;</span> +
                  $(<span class="hljs-string">&#x27;.annotationtype button.lastused&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;next&#x27;</span>));
  }
}

<span class="hljs-comment">/**
 * Handle changes to our controls.
 *
 * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">change_controls</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">var</span> ctl = $(evt.<span class="hljs-property">target</span>),
      param = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;param-name&#x27;</span>),
      value = ctl.<span class="hljs-title function_">val</span>();
  <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>)) {
    value = ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;:checked&#x27;</span>) ? <span class="hljs-string">&#x27;true&#x27;</span> : <span class="hljs-string">&#x27;false&#x27;</span>;
  }
  <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;&#x27;</span> &amp;&amp; ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>)) {
    value = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>);
  }
  <span class="hljs-keyword">if</span> (!param || value === query[param]) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">switch</span> (param) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;basemap&#x27;</span>:
      <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;custom&#x27;</span>) {
        mapLayer.<span class="hljs-title function_">url</span>(query.<span class="hljs-property">mapurl</span> || <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">attribution</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">draw</span>();
      } <span class="hljs-keyword">else</span> {
        mapLayer.<span class="hljs-title function_">source</span>(value).<span class="hljs-title function_">draw</span>();
      }
      $(<span class="hljs-string">&#x27;#mapurl&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;hidden&#x27;</span>, value !== <span class="hljs-string">&#x27;custom&#x27;</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;mapurl&#x27;</span>:
      <span class="hljs-keyword">if</span> (query.<span class="hljs-property">basemap</span> === <span class="hljs-string">&#x27;custom&#x27;</span>) {
        mapLayer.<span class="hljs-title function_">url</span>(value || <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">attribution</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">draw</span>();
      }
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;distunit&#x27;</span>:
      query[param] = value;
      layer.<span class="hljs-title function_">annotations</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-title function_">modified</span>());
      layer.<span class="hljs-title function_">draw</span>();
      <span class="hljs-title function_">handleAnnotationChange</span>();
      scaleWidget.<span class="hljs-title function_">options</span>(<span class="hljs-string">&#x27;units&#x27;</span>, query.<span class="hljs-property">distunit</span> === <span class="hljs-string">&#x27;si&#x27;</span> ? <span class="hljs-string">&#x27;si&#x27;</span> : <span class="hljs-string">&#x27;miles&#x27;</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;areaunit&#x27;</span>:
      query[param] = value;
      layer.<span class="hljs-title function_">annotations</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-title function_">modified</span>());
      layer.<span class="hljs-title function_">draw</span>();
      <span class="hljs-title function_">handleAnnotationChange</span>();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;labels&#x27;</span>:
      layer.<span class="hljs-title function_">options</span>(<span class="hljs-string">&#x27;showLabels&#x27;</span>, value === <span class="hljs-string">&#x27;false&#x27;</span> ? <span class="hljs-literal">false</span> : <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(geo.<span class="hljs-property">annotation</span>.<span class="hljs-property">state</span>));
      layer.<span class="hljs-title function_">draw</span>();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;clickmode&#x27;</span>:
      layer.<span class="hljs-title function_">options</span>(<span class="hljs-string">&#x27;clickToEdit&#x27;</span>, value === <span class="hljs-string">&#x27;edit&#x27;</span>);
      layer.<span class="hljs-title function_">draw</span>();
      <span class="hljs-keyword">break</span>;
  }
  query[param] = value;
  <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;&#x27;</span> || (ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>) &amp;&amp;
      value === ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>))) {
    <span class="hljs-keyword">delete</span> query[param];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>Update our query parameters, os when you reload the page it is in the
same state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  utils.<span class="hljs-title function_">setQuery</span>(query);
}

<span class="hljs-comment">/**
 * Toggle showing the full controls.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">toggle_hide</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">hide</span>) {
    <span class="hljs-keyword">delete</span> query.<span class="hljs-property">hide</span>;
  } <span class="hljs-keyword">else</span> {
    query.<span class="hljs-property">hide</span> = <span class="hljs-string">&#x27;true&#x27;</span>;
  }
  $(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;reduced&#x27;</span>, query.<span class="hljs-property">hide</span>);
  utils.<span class="hljs-title function_">setQuery</span>(query);
}

<span class="hljs-comment">/**
 * Handle changes to the geojson.
 *
 * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">change_geojson</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">var</span> ctl = $(evt.<span class="hljs-property">target</span>),
      value = ctl.<span class="hljs-title function_">val</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p>When we update the geojson from the textarea control, raise a flag so we
(a) ignore bad geojson, and (b) don’t replace the user’s geojson with
the auto-generated geojson</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fromGeojsonUpdate = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> result = layer.<span class="hljs-title function_">geojson</span>(value, <span class="hljs-string">&#x27;update&#x27;</span>);
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">save</span> !== <span class="hljs-string">&#x27;false&#x27;</span> &amp;&amp; result !== <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">var</span> geojson = layer.<span class="hljs-title function_">geojson</span>();
    query.<span class="hljs-property">geojson</span> = geojson ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(geojson) : <span class="hljs-literal">undefined</span>;
    utils.<span class="hljs-title function_">setQuery</span>(query);
  }
  fromGeojsonUpdate = <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * Handle selecting an annotation button.
 *
 * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">select_annotation</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-title function_">select_button</span>(evt.<span class="hljs-property">target</span>);
}

<span class="hljs-comment">/**
 * Select an annotation button by jquery selector.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} ctl a jquery selector or element.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">select_button</span>(<span class="hljs-params">ctl</span>) {
  ctl = $(ctl);
  <span class="hljs-keyword">var</span> wasactive = ctl.<span class="hljs-title function_">hasClass</span>(<span class="hljs-string">&#x27;active&#x27;</span>),
      id = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>);
  fromButtonSelect = <span class="hljs-literal">true</span>;
  layer.<span class="hljs-title function_">mode</span>(wasactive ? <span class="hljs-literal">null</span> : id);
  fromButtonSelect = <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * When the annotation mode changes, update the controls to reflect it.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">geo.event</span>} evt a geojs mode change event.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleModeChange</span>(<span class="hljs-params">evt</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p>Highlight the current buttons based on the current mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> mode = layer.<span class="hljs-title function_">mode</span>();
  $(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;active&#x27;</span>);
  <span class="hljs-keyword">if</span> (mode) {
    $(<span class="hljs-string">&#x27;.annotationtype button&#x27;</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;lastused active&#x27;</span>);
    $(<span class="hljs-string">&#x27;.annotationtype button#&#x27;</span> + mode).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&#x27;lastused active&#x27;</span>);
  }
  $(<span class="hljs-string">&#x27;#instructions&#x27;</span>).<span class="hljs-title function_">attr</span>(
    <span class="hljs-string">&#x27;annotation&#x27;</span>, $(<span class="hljs-string">&#x27;.annotationtype button.active&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>) || <span class="hljs-string">&#x27;none&#x27;</span>);
  query.<span class="hljs-property">active</span> = $(<span class="hljs-string">&#x27;.annotationtype button.active&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>) || <span class="hljs-literal">undefined</span>;
  query.<span class="hljs-property">lastused</span> = query.<span class="hljs-property">active</span> ? <span class="hljs-literal">undefined</span> : $(<span class="hljs-string">&#x27;.annotationtype button.lastused&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>);
  utils.<span class="hljs-title function_">setQuery</span>(query);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p>If we are in keep-adding mode, and the mode changed to null, and that
wasn’t caused by clicking the button, reenable the annotation mode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!mode &amp;&amp; !fromButtonSelect &amp;&amp; query.<span class="hljs-property">keepadding</span> === <span class="hljs-string">&#x27;true&#x27;</span>) {
    layer.<span class="hljs-title function_">mode</span>($(<span class="hljs-string">&#x27;.annotationtype button.lastused&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>));
  }
}

<span class="hljs-comment">/**
 * Calculate the length of an annotation.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">geo.annotation</span>} annotation The annotation.
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} The length in meters or `undefined`.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">annotationLength</span>(<span class="hljs-params">annotation</span>) {
  <span class="hljs-keyword">let</span> dist = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> gcs = annotation.<span class="hljs-title function_">layer</span>().<span class="hljs-title function_">map</span>().<span class="hljs-title function_">ingcs</span>();
  <span class="hljs-keyword">let</span> ptlist = annotation.<span class="hljs-title function_">coordinates</span>(gcs);
  <span class="hljs-keyword">if</span> (ptlist.<span class="hljs-property">outer</span>) {
    ptlist = [ptlist.<span class="hljs-property">outer</span>.<span class="hljs-title function_">slice</span>()].<span class="hljs-title function_">concat</span>((ptlist.<span class="hljs-property">inner</span> || []).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">l</span>) =&gt;</span> l.<span class="hljs-title function_">slice</span>()));
  } <span class="hljs-keyword">else</span> {
    ptlist = [ptlist.<span class="hljs-title function_">slice</span>()];
  }
  ptlist.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">pts</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (pts.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">&#x27;polygon&#x27;</span>, <span class="hljs-string">&#x27;rectangle&#x27;</span>].<span class="hljs-title function_">indexOf</span>(annotation.<span class="hljs-title function_">type</span>()) &gt;= <span class="hljs-number">0</span>) {
      pts = pts.<span class="hljs-title function_">slice</span>();
      pts.<span class="hljs-title function_">push</span>(pts[<span class="hljs-number">0</span>]);
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; pts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">const</span> partial = geo.<span class="hljs-property">transform</span>.<span class="hljs-title function_">vincentyDistance</span>(pts[i], pts[i + <span class="hljs-number">1</span>], gcs);
      <span class="hljs-keyword">if</span> (partial) {
        dist += partial.<span class="hljs-property">distance</span>;
      }
    }
  });
  <span class="hljs-keyword">return</span> dist;
}

<span class="hljs-comment">/**
 * Calculate the area of an annotation.  Use an equal-area projection centered
 * on the first vertex and then a simple 2-D polygon area calculation.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">geo.annotation</span>} annotation The annotation.
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} The area in square meters or `undefined`.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">annotationArea</span>(<span class="hljs-params">annotation</span>) {
  <span class="hljs-keyword">let</span> area = <span class="hljs-number">0</span>,
      ptlist = annotation.<span class="hljs-title function_">coordinates</span>(<span class="hljs-string">&#x27;EPSG:4326&#x27;</span>);
  <span class="hljs-keyword">if</span> (ptlist.<span class="hljs-property">outer</span>) {
    ptlist = [ptlist.<span class="hljs-property">outer</span>];
  } <span class="hljs-keyword">else</span> {
    ptlist = [ptlist];
  }
  <span class="hljs-keyword">if</span> (ptlist[<span class="hljs-number">0</span>].<span class="hljs-property">length</span> &lt; <span class="hljs-number">3</span> || [<span class="hljs-string">&#x27;polygon&#x27;</span>, <span class="hljs-string">&#x27;rectangle&#x27;</span>].<span class="hljs-title function_">indexOf</span>(annotation.<span class="hljs-title function_">type</span>()) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>By using an equal-area projection centered at one of the vertices, the
area calculation can be done with a simple formula.  For polygons with
long edges, this won’t be accurate, however.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">const</span> gcs = <span class="hljs-string">`+proj=laea +lat_0=<span class="hljs-subst">${ptlist[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].y}</span> +lon_0=<span class="hljs-subst">${ptlist[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].x}</span> +x_0=0 +y_0=0 +a=6371007.181 +b=6371007.181 +units=m +no_defs`</span>;
  ptlist = annotation.<span class="hljs-title function_">coordinates</span>(gcs);
  <span class="hljs-keyword">if</span> (ptlist.<span class="hljs-property">outer</span>) {
    ptlist = [ptlist.<span class="hljs-property">outer</span>.<span class="hljs-title function_">slice</span>()].<span class="hljs-title function_">concat</span>((ptlist.<span class="hljs-property">inner</span> || []).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">l</span>) =&gt;</span> l.<span class="hljs-title function_">slice</span>()));
  } <span class="hljs-keyword">else</span> {
    ptlist = [ptlist.<span class="hljs-title function_">slice</span>()];
  }
  ptlist.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">pts, idx</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> looparea = <span class="hljs-number">0</span>;
    pts.<span class="hljs-title function_">push</span>(pts[<span class="hljs-number">0</span>]);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; pts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i += <span class="hljs-number">1</span>) {
      looparea += (pts[i + <span class="hljs-number">1</span>].<span class="hljs-property">y</span> - pts[i].<span class="hljs-property">y</span>) * (pts[i + <span class="hljs-number">1</span>].<span class="hljs-property">x</span> + pts[i].<span class="hljs-property">x</span>) / <span class="hljs-number">2</span>;
    }
    area += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(looparea) * (idx ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>);
  });
  <span class="hljs-keyword">return</span> area;
}

<span class="hljs-comment">/**
 * Add the units to the name of the annotation if appropriate.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">geo.annotation</span>} annotation The annotation.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">modifyAnnotation</span>(<span class="hljs-params">annotation</span>) {
  <span class="hljs-keyword">if</span> (annotation.<span class="hljs-property">_changed</span>) {
    <span class="hljs-keyword">return</span>;
  }
  annotation.<span class="hljs-property">_changed</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> s_labelRecord = annotation.<span class="hljs-property">labelRecord</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p>Hook into the labelRecord method to add the distance and area to the label</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  annotation.<span class="hljs-property">labelRecord</span> = <span class="hljs-function">() =&gt;</span> {
    annotation.<span class="hljs-title function_">options</span>(<span class="hljs-string">&#x27;showLabel&#x27;</span>, query.<span class="hljs-property">labels</span> === <span class="hljs-string">&#x27;false&#x27;</span> ? <span class="hljs-literal">false</span> : <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(geo.<span class="hljs-property">annotation</span>.<span class="hljs-property">state</span>));
    <span class="hljs-keyword">let</span> dist = <span class="hljs-title function_">annotationLength</span>(annotation),
        area = <span class="hljs-title function_">annotationArea</span>(annotation);
    <span class="hljs-keyword">var</span> result = <span class="hljs-title function_">s_labelRecord</span>();
    <span class="hljs-keyword">if</span> (result) {
      <span class="hljs-keyword">if</span> (dist) {
        dist = geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-title function_">formatUnit</span>(dist, query.<span class="hljs-property">distunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>);
        result.<span class="hljs-property">text</span> += <span class="hljs-string">&#x27; - &#x27;</span> + dist;
      }
      <span class="hljs-keyword">if</span> (area) {
        area = geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-title function_">formatUnit</span>(area, query.<span class="hljs-property">areaunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>, geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-property">areaUnitsTable</span>);
        result.<span class="hljs-property">text</span> += <span class="hljs-string">&#x27; - &#x27;</span> + area;
      }
    }
    <span class="hljs-keyword">if</span> (result &amp;&amp; result.<span class="hljs-property">text</span> !== annotation.<span class="hljs-property">_lastResultText</span>) {
      map.<span class="hljs-title function_">scheduleAnimationFrame</span>(handleAnnotationChange);
      annotation.<span class="hljs-property">_lastResultText</span> = result.<span class="hljs-property">text</span>;
    }
    <span class="hljs-keyword">return</span> result;
  };
}

<span class="hljs-comment">/**
 * Label all of the vertices and centers of edges of an annotation.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">geo.annotation</span>} annotation The annotation.
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} annotationIndex The position of the annotation.
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object[]</span>} labels The labels data array to extend.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">labelVertices</span>(<span class="hljs-params">annotation, annotationIndex, labels</span>) {
  <span class="hljs-keyword">const</span> gcs = annotation.<span class="hljs-title function_">layer</span>().<span class="hljs-title function_">map</span>().<span class="hljs-title function_">gcs</span>();
  <span class="hljs-keyword">let</span> ptlist = annotation.<span class="hljs-title function_">coordinates</span>(gcs);
  <span class="hljs-keyword">if</span> (ptlist.<span class="hljs-property">outer</span>) {
    ptlist = [ptlist.<span class="hljs-property">outer</span>.<span class="hljs-title function_">slice</span>()].<span class="hljs-title function_">concat</span>((ptlist.<span class="hljs-property">inner</span> || []).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">l</span>) =&gt;</span> l.<span class="hljs-title function_">slice</span>()));
  } <span class="hljs-keyword">else</span> {
    ptlist = [ptlist.<span class="hljs-title function_">slice</span>()];
  }
  ptlist.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">pts</span>) =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; pts.<span class="hljs-property">length</span>; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span> (pts[i].<span class="hljs-property">x</span> === pts[i - <span class="hljs-number">1</span>].<span class="hljs-property">x</span> &amp;&amp; pts[i].<span class="hljs-property">y</span> === pts[i - <span class="hljs-number">1</span>].<span class="hljs-property">y</span>) {
        pts.<span class="hljs-title function_">splice</span>(i, <span class="hljs-number">1</span>);
      }
    }
    <span class="hljs-keyword">if</span> (pts.<span class="hljs-property">length</span> &lt; <span class="hljs-number">3</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">&#x27;polygon&#x27;</span>, <span class="hljs-string">&#x27;rectangle&#x27;</span>].<span class="hljs-title function_">indexOf</span>(annotation.<span class="hljs-title function_">type</span>()) &gt;= <span class="hljs-number">0</span>) {
      pts.<span class="hljs-title function_">push</span>(pts[<span class="hljs-number">0</span>]);
    }
    <span class="hljs-keyword">var</span> style = labels[annotationIndex].<span class="hljs-property">style</span> || {};
    <span class="hljs-keyword">var</span> dist = [], tally = [<span class="hljs-number">0</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; pts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i += <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">const</span> value = geo.<span class="hljs-property">transform</span>.<span class="hljs-title function_">vincentyDistance</span>(pts[i], pts[i + <span class="hljs-number">1</span>], gcs);
      dist.<span class="hljs-title function_">push</span>(value ? value.<span class="hljs-property">distance</span> : <span class="hljs-number">0</span>);
    }
    dist.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> {
      tally.<span class="hljs-title function_">push</span>(tally[i] + d);
    });
    pts.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">p, i</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (i) {
        labels.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">text</span>: geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-title function_">formatUnit</span>(tally[i], query.<span class="hljs-property">distunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>) || <span class="hljs-string">&#x27;&#x27;</span>,
          <span class="hljs-attr">position</span>: p,
          <span class="hljs-attr">style</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, style, {<span class="hljs-attr">offset</span>: {<span class="hljs-attr">x</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}, <span class="hljs-attr">textAlign</span>: <span class="hljs-string">&#x27;left&#x27;</span>})
        });
      }
      <span class="hljs-keyword">if</span> (i !== pts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
        labels.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">text</span>: geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-title function_">formatUnit</span>(tally[tally.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] - tally[i], query.<span class="hljs-property">distunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>) || <span class="hljs-string">&#x27;&#x27;</span>,
          <span class="hljs-attr">position</span>: p,
          <span class="hljs-attr">style</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, style, {<span class="hljs-attr">offset</span>: {<span class="hljs-attr">x</span>: -<span class="hljs-number">12</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}, <span class="hljs-attr">textAlign</span>: <span class="hljs-string">&#x27;right&#x27;</span>})
        });
        <span class="hljs-keyword">const</span> p1 = {<span class="hljs-attr">x</span>: (pts[i + <span class="hljs-number">1</span>].<span class="hljs-property">x</span> + p.<span class="hljs-property">x</span>) / <span class="hljs-number">2</span>, <span class="hljs-attr">y</span>: (pts[i + <span class="hljs-number">1</span>].<span class="hljs-property">y</span> + p.<span class="hljs-property">y</span>) / <span class="hljs-number">2</span>};
        labels.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">text</span>: geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-title function_">formatUnit</span>(dist[i], query.<span class="hljs-property">distunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>) || <span class="hljs-string">&#x27;&#x27;</span>,
          <span class="hljs-attr">position</span>: p1,
          <span class="hljs-attr">style</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, style, {<span class="hljs-attr">offset</span>: {<span class="hljs-attr">x</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}, <span class="hljs-attr">textAlign</span>: <span class="hljs-string">&#x27;left&#x27;</span>})
        });
      }
    });
  });
}

<span class="hljs-comment">/**
 * When an annotation is created or removed, update our list of annotations.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">geo.event</span>} evt a geojs mode change event.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAnnotationChange</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">var</span> annotations = layer.<span class="hljs-title function_">annotations</span>();
  <span class="hljs-keyword">var</span> ids = annotations.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">annotation</span>) {
    <span class="hljs-keyword">return</span> annotation.<span class="hljs-title function_">id</span>();
  });
  <span class="hljs-keyword">var</span> present = [];
  $(<span class="hljs-string">&#x27;#annotationlist .entry&#x27;</span>).<span class="hljs-title function_">each</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-keyword">var</span> entry = $(<span class="hljs-variable language_">this</span>);
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>) === <span class="hljs-string">&#x27;sample&#x27;</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> id = entry.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-id&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <p>Remove deleted annotations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!ids.<span class="hljs-title function_">includes</span>(id)) {
      entry.<span class="hljs-title function_">remove</span>();
      <span class="hljs-keyword">return</span>;
    }
    present.<span class="hljs-title function_">push</span>(id);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <p>Update existing elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    entry.<span class="hljs-title function_">find</span>(<span class="hljs-string">&#x27;.entry-name&#x27;</span>).<span class="hljs-title function_">text</span>(layer.<span class="hljs-title function_">annotationById</span>(id).<span class="hljs-title function_">name</span>());
  });
  <span class="hljs-keyword">let</span> totaldist = <span class="hljs-number">0</span>, totalarea = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p>Add if new and fully created</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.<span class="hljs-title function_">each</span>(ids, <span class="hljs-keyword">function</span> (<span class="hljs-params">idx, id</span>) {
    <span class="hljs-keyword">var</span> annotation = layer.<span class="hljs-title function_">annotationById</span>(id);
    <span class="hljs-keyword">let</span> dist = <span class="hljs-title function_">annotationLength</span>(annotation),
        area = <span class="hljs-title function_">annotationArea</span>(annotation);
    <span class="hljs-keyword">if</span> (dist) { totaldist += dist; }
    <span class="hljs-keyword">if</span> (area) { totalarea += area; }
    dist = geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-title function_">formatUnit</span>(dist, query.<span class="hljs-property">distunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>) || <span class="hljs-string">&#x27;&#x27;</span>;
    area = geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-title function_">formatUnit</span>(area, query.<span class="hljs-property">areaunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>, geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-property">areaUnitsTable</span>);
    <span class="hljs-keyword">if</span> (area) {
      dist = (dist ? dist + <span class="hljs-string">&#x27; - &#x27;</span> : <span class="hljs-string">&#x27;&#x27;</span>) + area;
    }
    <span class="hljs-keyword">if</span> (present.<span class="hljs-title function_">includes</span>(id)) {
      $(<span class="hljs-string">&#x27;#annotationlist .entry[annotation-id=&quot;&#x27;</span> + id + <span class="hljs-string">&#x27;&quot;] .entry-dist&#x27;</span>).<span class="hljs-title function_">text</span>(dist);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!annotation.<span class="hljs-property">_changed</span>) {
      <span class="hljs-title function_">modifyAnnotation</span>(annotation);
    }
    <span class="hljs-keyword">if</span> (annotation.<span class="hljs-title function_">state</span>() === geo.<span class="hljs-property">annotation</span>.<span class="hljs-property">state</span>.<span class="hljs-property">create</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> entry = $(<span class="hljs-string">&#x27;#annotationlist .entry#sample&#x27;</span>).<span class="hljs-title function_">clone</span>();
    entry.<span class="hljs-title function_">attr</span>({<span class="hljs-attr">id</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;annotation-id&#x27;</span>: id});
    entry.<span class="hljs-title function_">find</span>(<span class="hljs-string">&#x27;.entry-name&#x27;</span>).<span class="hljs-title function_">text</span>(annotation.<span class="hljs-title function_">name</span>());
    entry.<span class="hljs-title function_">find</span>(<span class="hljs-string">&#x27;.entry-dist&#x27;</span>).<span class="hljs-title function_">text</span>(dist);
    $(<span class="hljs-string">&#x27;#annotationlist&#x27;</span>).<span class="hljs-title function_">append</span>(entry);
  });
  <span class="hljs-keyword">let</span> dist = geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-title function_">formatUnit</span>(totaldist || <span class="hljs-literal">undefined</span>, query.<span class="hljs-property">distunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>) || <span class="hljs-string">&#x27;&#x27;</span>;
  <span class="hljs-keyword">const</span> area = geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-title function_">formatUnit</span>(totalarea || <span class="hljs-literal">undefined</span>, query.<span class="hljs-property">areaunit</span> || <span class="hljs-string">&#x27;decmiles&#x27;</span>, geo.<span class="hljs-property">gui</span>.<span class="hljs-property">scaleWidget</span>.<span class="hljs-property">areaUnitsTable</span>);
  <span class="hljs-keyword">if</span> (area) {
    dist = (dist ? dist + <span class="hljs-string">&#x27; - &#x27;</span> : <span class="hljs-string">&#x27;&#x27;</span>) + area;
  }
  $(<span class="hljs-string">&#x27;#annotationheader .entry-dist&#x27;</span>).<span class="hljs-title function_">text</span>(dist);
  $(<span class="hljs-string">&#x27;#annotationheader&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;present&#x27;</span>, $(<span class="hljs-string">&#x27;#annotationlist .entry&#x27;</span>).<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (!fromGeojsonUpdate) {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p>Update the geojson textarea</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> geojson = layer.<span class="hljs-title function_">geojson</span>();
    $(<span class="hljs-string">&#x27;#geojson&#x27;</span>).<span class="hljs-title function_">val</span>(geojson ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(geojson, <span class="hljs-literal">undefined</span>, <span class="hljs-number">2</span>) : <span class="hljs-string">&#x27;&#x27;</span>);
    <span class="hljs-keyword">if</span> (query.<span class="hljs-property">save</span> !== <span class="hljs-string">&#x27;false&#x27;</span>) {
      query.<span class="hljs-property">geojson</span> = geojson ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(geojson) : <span class="hljs-literal">undefined</span>;
      utils.<span class="hljs-title function_">setQuery</span>(query);
    }
  }
}

<span class="hljs-comment">/**
 * Handle selecting a control.
 *
 * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">select_control</span>(<span class="hljs-params">evt</span>) {
  <span class="hljs-keyword">var</span> mode,
      ctl = $(evt.<span class="hljs-property">target</span>),
      action = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;action&#x27;</span>),
      id = ctl.<span class="hljs-title function_">closest</span>(<span class="hljs-string">&#x27;.entry&#x27;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-id&#x27;</span>),
      annotation = layer.<span class="hljs-title function_">annotationById</span>(id);
  <span class="hljs-keyword">switch</span> (action) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;adjust&#x27;</span>:
      layer.<span class="hljs-title function_">mode</span>(layer.<span class="hljs-property">modes</span>.<span class="hljs-property">edit</span>, annotation);
      layer.<span class="hljs-title function_">draw</span>();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;edit&#x27;</span>:
      <span class="hljs-title function_">show_edit_dialog</span>(id);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;remove&#x27;</span>:
      layer.<span class="hljs-title function_">removeAnnotation</span>(annotation);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;remove-all&#x27;</span>:
      fromButtonSelect = <span class="hljs-literal">true</span>;
      mode = layer.<span class="hljs-title function_">mode</span>();
      layer.<span class="hljs-title function_">mode</span>(<span class="hljs-literal">null</span>);
      layer.<span class="hljs-title function_">removeAllAnnotations</span>();
      layer.<span class="hljs-title function_">mode</span>(mode);
      fromButtonSelect = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">break</span>;
  }
}

<span class="hljs-comment">/**
 * Show the edit dialog for a particular annotation.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} id the annotation id to edit.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">show_edit_dialog</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">var</span> annotation = layer.<span class="hljs-title function_">annotationById</span>(id),
      type = annotation.<span class="hljs-title function_">type</span>(),
      typeMatch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">&#x27;(^| )(&#x27;</span> + type + <span class="hljs-string">&#x27;|all)( |$)&#x27;</span>),
      opt = annotation.<span class="hljs-title function_">options</span>(),
      dlg = $(<span class="hljs-string">&#x27;#editdialog&#x27;</span>);

  $(<span class="hljs-string">&#x27;#edit-validation-error&#x27;</span>, dlg).<span class="hljs-title function_">text</span>(<span class="hljs-string">&#x27;&#x27;</span>);
  dlg.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-id&#x27;</span>, id);
  dlg.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-type&#x27;</span>, type);
  $(<span class="hljs-string">&#x27;[option=&quot;name&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>(annotation.<span class="hljs-title function_">name</span>());
  $(<span class="hljs-string">&#x27;[option=&quot;label&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>(annotation.<span class="hljs-title function_">label</span>(<span class="hljs-literal">undefined</span>, <span class="hljs-literal">true</span>));
  $(<span class="hljs-string">&#x27;[option=&quot;description&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>(annotation.<span class="hljs-title function_">description</span>());</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-31">&#x00a7;</a>
              </div>
              <p>Populate each control with the current value of the annotation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">&#x27;.form-group[annotation-types]&#x27;</span>).<span class="hljs-title function_">each</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-keyword">var</span> ctl = $(<span class="hljs-variable language_">this</span>),
        key = $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;option&#x27;</span>),
        format = $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;format&#x27;</span>),
        value;
    <span class="hljs-keyword">if</span> (!ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-types&#x27;</span>).<span class="hljs-title function_">match</span>(typeMatch)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-32">&#x00a7;</a>
              </div>
              <p>If a property doesn’t exist for the current annotation’s type, hide
the control</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ctl.<span class="hljs-title function_">hide</span>();
      <span class="hljs-keyword">return</span>;
    }
    ctl.<span class="hljs-title function_">show</span>();
    <span class="hljs-keyword">switch</span> ($(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;optiontype&#x27;</span>)) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;option&#x27;</span>:
        value = opt[key];
        <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&#x27;showLabel&#x27;</span>) {
          value = <span class="hljs-string">&#x27;&#x27;</span> + !!opt.<span class="hljs-property">showLabel</span>;
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;label&#x27;</span>:
        value = (opt.<span class="hljs-property">labelStyle</span> || {})[key];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        value = opt.<span class="hljs-property">style</span>[key];
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">switch</span> (format) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;angle&#x27;</span>:
        <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span> &amp;&amp; value !== <span class="hljs-literal">null</span> &amp;&amp; value !== <span class="hljs-string">&#x27;&#x27;</span>) {
          value = <span class="hljs-string">&#x27;&#x27;</span> + +(+value * <span class="hljs-number">180.0</span> / <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">4</span>) + <span class="hljs-string">&#x27; deg&#x27;</span>;
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;color&#x27;</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-33">&#x00a7;</a>
              </div>
              <p>always show colors as hex values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        value = geo.<span class="hljs-property">util</span>.<span class="hljs-title function_">convertColorToHex</span>(value || {<span class="hljs-attr">r</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">g</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">0</span>}, <span class="hljs-string">&#x27;needed&#x27;</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;coordinate2&#x27;</span>:
        <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span> &amp;&amp; value !== <span class="hljs-literal">null</span> &amp;&amp; value !== <span class="hljs-string">&#x27;&#x27;</span>) {
          value = <span class="hljs-string">&#x27;&#x27;</span> + value.<span class="hljs-property">x</span> + <span class="hljs-string">&#x27;, &#x27;</span> + value.<span class="hljs-property">y</span>;
        }
    }
    <span class="hljs-keyword">if</span> ((value === <span class="hljs-literal">undefined</span> || value === <span class="hljs-string">&#x27;&#x27;</span> || value === <span class="hljs-literal">null</span>) &amp;&amp; $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;select&#x27;</span>)) {
      value = $(<span class="hljs-string">&#x27;[option] option&#x27;</span>, ctl).<span class="hljs-title function_">eq</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">val</span>();
    }
    $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">val</span>(value === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;&#x27;</span> : <span class="hljs-string">&#x27;&#x27;</span> + value);
  });
  dlg.<span class="hljs-title function_">one</span>(<span class="hljs-string">&#x27;shown.bs.modal&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    $(<span class="hljs-string">&#x27;[option=&quot;name&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">focus</span>();
  });
  dlg.<span class="hljs-title function_">modal</span>();
}

<span class="hljs-comment">/**
 * Update an annotation from values in the edit dialog.
 *
 * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">edit_update</span>(<span class="hljs-params">evt</span>) {
  evt.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-keyword">var</span> dlg = $(<span class="hljs-string">&#x27;#editdialog&#x27;</span>),
      id = dlg.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-id&#x27;</span>),
      annotation = layer.<span class="hljs-title function_">annotationById</span>(id),
      opt = annotation.<span class="hljs-title function_">options</span>(),
      type = annotation.<span class="hljs-title function_">type</span>(),
      typeMatch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">&#x27;(^| )(&#x27;</span> + type + <span class="hljs-string">&#x27;|all)( |$)&#x27;</span>),
      newopt = {<span class="hljs-attr">style</span>: {}, <span class="hljs-attr">labelStyle</span>: {}},
      error;</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-34">&#x00a7;</a>
              </div>
              <p>Validate form values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">&#x27;.form-group[annotation-types]&#x27;</span>).<span class="hljs-title function_">each</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-keyword">var</span> ctl = $(<span class="hljs-variable language_">this</span>),
        key = $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;option&#x27;</span>),
        format = $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;format&#x27;</span>),
        value, oldvalue;
    <span class="hljs-keyword">if</span> (!ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;annotation-types&#x27;</span>).<span class="hljs-title function_">match</span>(typeMatch)) {
      <span class="hljs-keyword">return</span>;
    }
    value = $(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">val</span>();
    <span class="hljs-keyword">switch</span> (format) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;angle&#x27;</span>:
        <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^\s*[.0-9eE]+\s*$/</span>.<span class="hljs-title function_">exec</span>(value)) {
          value += <span class="hljs-string">&#x27;deg&#x27;</span>;
        }
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">switch</span> (key) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;textScaled&#x27;</span>:
        <span class="hljs-keyword">if</span> ([<span class="hljs-string">&#x27;true&#x27;</span>, <span class="hljs-string">&#x27;on&#x27;</span>, <span class="hljs-string">&#x27;yes&#x27;</span>].<span class="hljs-title function_">indexOf</span>(value.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">toLowerCase</span>()) &gt;= <span class="hljs-number">0</span>) {
          value = map.<span class="hljs-title function_">zoom</span>();
        }
        <span class="hljs-keyword">break</span>;
    }
    value = layer.<span class="hljs-title function_">validateAttribute</span>(value, format);
    <span class="hljs-keyword">switch</span> ($(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;optiontype&#x27;</span>)) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;option&#x27;</span>:
        oldvalue = opt[key];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;label&#x27;</span>:
        oldvalue = (opt.<span class="hljs-property">labelStyle</span> || {})[key];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        oldvalue = opt.<span class="hljs-property">style</span>[key];
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">if</span> (value === oldvalue || (oldvalue === <span class="hljs-literal">undefined</span> &amp;&amp; value === <span class="hljs-string">&#x27;&#x27;</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-35">&#x00a7;</a>
              </div>
              <p>don’t change anything</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {
      error = $(<span class="hljs-string">&#x27;label&#x27;</span>, ctl).<span class="hljs-title function_">text</span>() + <span class="hljs-string">&#x27; is not a valid value&#x27;</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">switch</span> ($(<span class="hljs-string">&#x27;[option]&#x27;</span>, ctl).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;optiontype&#x27;</span>)) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;option&#x27;</span>:
          newopt[key] = value;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;label&#x27;</span>:
          newopt.<span class="hljs-property">labelStyle</span>[key] = value;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-attr">default</span>:
          newopt.<span class="hljs-property">style</span>[key] = value;
          <span class="hljs-keyword">break</span>;
      }
    }
  });
  <span class="hljs-keyword">if</span> (error) {
    $(<span class="hljs-string">&#x27;#edit-validation-error&#x27;</span>, dlg).<span class="hljs-title function_">text</span>(error);
    <span class="hljs-keyword">return</span>;
  }
  annotation.<span class="hljs-title function_">name</span>($(<span class="hljs-string">&#x27;[option=&quot;name&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>());
  annotation.<span class="hljs-title function_">label</span>($(<span class="hljs-string">&#x27;[option=&quot;label&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>() || <span class="hljs-literal">null</span>);
  annotation.<span class="hljs-title function_">description</span>($(<span class="hljs-string">&#x27;[option=&quot;description&quot;]&#x27;</span>, dlg).<span class="hljs-title function_">val</span>() || <span class="hljs-string">&#x27;&#x27;</span>);
  annotation.<span class="hljs-title function_">options</span>(newopt).<span class="hljs-title function_">draw</span>();

  dlg.<span class="hljs-title function_">modal</span>(<span class="hljs-string">&#x27;hide&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-36">&#x00a7;</a>
              </div>
              <p>Refresh the annotation list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-title function_">handleAnnotationChange</span>();
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
