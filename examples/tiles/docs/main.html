<!DOCTYPE html>

<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p>This example should be tried with different query strings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/* Many parameters can be adjusted via url query parameters:
 *  allowRotation: &#x27;true&#x27; to allow map rotation, &#x27;false&#x27; to prevent it, or
 *      allowable rotations in degrees.
 *  attribution: override the layer attribution text.
 *  clampBoundsX: &#x27;true&#x27; to clamp movement in the horizontal direction.
 *  clampBoundsY: &#x27;true&#x27; to clamp movement in the vertical direction.
 *  clampZoom: &#x27;true&#x27; to clamp zooming out smaller than the window.
 *  controls: &#x27;false&#x27; to hide controls.
 *  debug: &#x27;true&#x27; to show tile labels when using the html renderer.  &#x27;border&#x27;
 *      to draw borders on each tile when using the html renderer.  &#x27;all&#x27; to
 *      show both labels and borders.  These options just add a class to the
 *      #map element to invoke special css rules.
 *  discrete: &#x27;true&#x27; to use discrete zoom.
 *  fade: &#x27;true&#x27; to enable image fade in on the html renderer.
 *  h: height of a tiled image (at max zoom).
 *  lower: &#x27;true&#x27; (default) or &#x27;false&#x27;.  Keep all lower-level tiles if true.
 *      &#x27;false&#x27; was the old behavior where fewer tiles are rendered, and
 *      panning shows blank areas.
 *  min: minimum zoom level (default is 0).
 *  max: maximum zoom level (default is 16 for maps, or the entire image for
 *      images).
 *  maxBoundsBottom: maximum bounds bottom value.
 *  maxBoundsLeft: maximum bounds left value.
 *  maxBoundsRight: maximum bounds right value.
 *  maxBoundsTop: maximum bounds top value.
 *  opacity: a css opacity value (typically a float from 0 to 1).
 *  projection: &#x27;parallel&#x27; or &#x27;projection&#x27; for the camera projection.
 *  renderer: &#x27;webgl&#x27; (default), &#x27;canvas&#x27;, &#x27;svg&#x27;, &#x27;null&#x27;, or &#x27;html&#x27;.  This
 *      picks the renderer for map tiles.  null or html uses the html renderer.
 *      &#x27;default&#x27; uses the default renderer for the user&#x27;s platform.
 *  round: &#x27;round&#x27; (default), &#x27;floor&#x27;, &#x27;ceil&#x27;.
 *  subdomains: a comma-separated string of subdomains to use in the {s} part
 *      of the url parameter.  If there are no commas in the string, each letter
 *      is used by itself (e.g., &#x27;abc&#x27; is the same as &#x27;a,b,c&#x27;).
 *  unitsPerPixel: set the units per pixel at zoom level 0.
 *  url: url or source to use for the map files.  Placeholders are allowed.
 *    Exanples:
 *      https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png
 *      urls are are: /data/tilefancy.png
 *      http://tile.stamen.com/toner-lite/{z}/{x}/{y}.png
 *  w: width of a tiled image (at max zoom).  If w and h are specified, a
 *      variety of other changes are made to make this served in image
 *      coordinates.
 *  wrapX: &#x27;true&#x27; to wrap the tiles in the horizontal direction.
 *  wrapY: &#x27;true&#x27; to wrap the tiles in the vertical direction.
 *  x: map center x
 *  y: map center y
 *  zoom: starting zoom level
 */</span>

<span class="hljs-keyword">var</span> tileDebug = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>Run after the DOM loads</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
  <span class="hljs-string">&#x27;use strict&#x27;</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>Parse query parameters into an object for ease of access</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> query = <span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(^\?)/</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">split</span>(
    <span class="hljs-string">&#x27;&amp;&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">n</span>) {
    n = n.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;=&#x27;</span>);
    <span class="hljs-keyword">if</span> (n[<span class="hljs-number">0</span>]) {
      <span class="hljs-variable language_">this</span>[<span class="hljs-built_in">decodeURIComponent</span>(n[<span class="hljs-number">0</span>])] = <span class="hljs-built_in">decodeURIComponent</span>(n[<span class="hljs-number">1</span>]);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }.<span class="hljs-title function_">bind</span>({}))[<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>hide the controls if requested</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;no-controls&#x27;</span>, query.<span class="hljs-property">controls</span> === <span class="hljs-string">&#x27;false&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>populate the controls with the current settings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.<span class="hljs-title function_">each</span>(query, <span class="hljs-keyword">function</span> (<span class="hljs-params">key, value</span>) {
    <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;&quot;&#x27;</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> ctl = $(<span class="hljs-string">&#x27;#controls [param-name=&quot;&#x27;</span> + key + <span class="hljs-string">&#x27;&quot;]&#x27;</span>);
      <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>)) {
        ctl.<span class="hljs-title function_">prop</span>(<span class="hljs-string">&#x27;checked&#x27;</span>, value === <span class="hljs-string">&#x27;true&#x27;</span>);
      } <span class="hljs-keyword">else</span> {
        ctl.<span class="hljs-title function_">val</span>(value);
      }
    }
  });
  $(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;change&#x27;</span>, change_controls);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>When a text input is altered, wait a short time then process the change.
This allows the web page to be responsive without showing too many partial
values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> throttledInputEventTimer = <span class="hljs-literal">null</span>;
  $(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;input&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) {
    <span class="hljs-keyword">if</span> (throttledInputEventTimer) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">clearTimeout</span>(throttledInputEventTimer);
    }
    throttledInputEventTimer = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
      <span class="hljs-title function_">change_controls</span>(evt);
    }, <span class="hljs-number">1000</span>);
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Set map defaults to use our named node and have a reasonable center and
zoom level</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> mapParams = {
    <span class="hljs-attr">node</span>: <span class="hljs-string">&#x27;#map&#x27;</span>,
    <span class="hljs-attr">center</span>: {
      <span class="hljs-attr">x</span>: -<span class="hljs-number">98.0</span>,
      <span class="hljs-attr">y</span>: <span class="hljs-number">39.5</span>
    },
    <span class="hljs-attr">maxBounds</span>: {}
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>Set the tile layer defaults to use the specified renderer and opacity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> layerParams = {
    <span class="hljs-attr">renderer</span>: query.<span class="hljs-property">renderer</span> &amp;&amp; query.<span class="hljs-property">renderer</span> !== <span class="hljs-string">&#x27;default&#x27;</span> ? query.<span class="hljs-property">renderer</span> : <span class="hljs-literal">undefined</span>,
    <span class="hljs-attr">opacity</span>: query.<span class="hljs-property">opacity</span> || <span class="hljs-string">&#x27;1&#x27;</span>,
    <span class="hljs-comment">/* Always use a larger cache so if keepLower is changed, we still have a
     * big enough cache. */</span>
    <span class="hljs-attr">cacheSize</span>: <span class="hljs-number">600</span>
  };
  <span class="hljs-keyword">if</span> (layerParams.<span class="hljs-property">renderer</span> === <span class="hljs-string">&#x27;null&#x27;</span> || layerParams.<span class="hljs-property">renderer</span> === <span class="hljs-string">&#x27;html&#x27;</span>) {
    layerParams.<span class="hljs-property">renderer</span> = <span class="hljs-literal">null</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>Default values for spring-back</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> springEnabled = {<span class="hljs-attr">spring</span>: {<span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">springConstant</span>: <span class="hljs-number">0.00005</span>}},
      springDisabled = {<span class="hljs-attr">spring</span>: {<span class="hljs-attr">enabled</span>: <span class="hljs-literal">false</span>}};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>Allow a custom tile url, including subdomains.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">url</span>) {
    <span class="hljs-keyword">if</span> (query.<span class="hljs-property">url</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;/&#x27;</span>) &gt;= <span class="hljs-number">0</span>) {
      layerParams.<span class="hljs-property">url</span> = query.<span class="hljs-property">url</span>;
    } <span class="hljs-keyword">else</span> {
      layerParams.<span class="hljs-property">source</span> = query.<span class="hljs-property">url</span>;
    }
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">subdomains</span>) {
    <span class="hljs-keyword">if</span> (query.<span class="hljs-property">subdomains</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;,&#x27;</span>) &gt;= <span class="hljs-number">0</span>) {
      layerParams.<span class="hljs-property">subdomains</span> = query.<span class="hljs-property">subdomains</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;,&#x27;</span>);
    } <span class="hljs-keyword">else</span> {
      layerParams.<span class="hljs-property">subdomains</span> = query.<span class="hljs-property">subdomains</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>For image tile servers, where we know the maximum width and height, use
a pixel coordinate system.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">w</span> &amp;&amp; query.<span class="hljs-property">h</span>) {
    <span class="hljs-keyword">var</span> pixelParams = geo.<span class="hljs-property">util</span>.<span class="hljs-title function_">pixelCoordinateParams</span>(
      <span class="hljs-string">&#x27;#map&#x27;</span>, <span class="hljs-built_in">parseInt</span>(query.<span class="hljs-property">w</span>, <span class="hljs-number">10</span>), <span class="hljs-built_in">parseInt</span>(query.<span class="hljs-property">h</span>, <span class="hljs-number">10</span>),
      layerParams.<span class="hljs-property">tileWidth</span> || <span class="hljs-number">256</span>, layerParams.<span class="hljs-property">tileHeight</span> || <span class="hljs-number">256</span>);
    $.<span class="hljs-title function_">extend</span>(mapParams, pixelParams.<span class="hljs-property">map</span>);
    $.<span class="hljs-title function_">extend</span>(layerParams, pixelParams.<span class="hljs-property">layer</span>);
  }
  mapParams.<span class="hljs-property">zoom</span> = query.<span class="hljs-property">zoom</span> !== <span class="hljs-literal">undefined</span> ? <span class="hljs-built_in">parseFloat</span>(query.<span class="hljs-property">zoom</span>) : <span class="hljs-number">3</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>Parse additional query options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">x</span> !== <span class="hljs-literal">undefined</span>) {
    mapParams.<span class="hljs-property">center</span>.<span class="hljs-property">x</span> = <span class="hljs-built_in">parseFloat</span>(query.<span class="hljs-property">x</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">y</span> !== <span class="hljs-literal">undefined</span>) {
    mapParams.<span class="hljs-property">center</span>.<span class="hljs-property">y</span> = <span class="hljs-built_in">parseFloat</span>(query.<span class="hljs-property">y</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">min</span> !== <span class="hljs-literal">undefined</span>) {
    mapParams.<span class="hljs-property">min</span> = <span class="hljs-built_in">parseFloat</span>(query.<span class="hljs-property">min</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">maxBoundsLeft</span> !== <span class="hljs-literal">undefined</span>) {
    mapParams.<span class="hljs-property">maxBounds</span>.<span class="hljs-property">left</span> = <span class="hljs-built_in">parseFloat</span>(query.<span class="hljs-property">maxBoundsLeft</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">maxBoundsRight</span> !== <span class="hljs-literal">undefined</span>) {
    mapParams.<span class="hljs-property">maxBounds</span>.<span class="hljs-property">right</span> = <span class="hljs-built_in">parseFloat</span>(query.<span class="hljs-property">maxBoundsRight</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">maxBoundsTop</span> !== <span class="hljs-literal">undefined</span>) {
    mapParams.<span class="hljs-property">maxBounds</span>.<span class="hljs-property">top</span> = <span class="hljs-built_in">parseFloat</span>(query.<span class="hljs-property">maxBoundsTop</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">maxBoundsBottom</span> !== <span class="hljs-literal">undefined</span>) {
    mapParams.<span class="hljs-property">maxBounds</span>.<span class="hljs-property">bottom</span> = <span class="hljs-built_in">parseFloat</span>(query.<span class="hljs-property">maxBoundsBottom</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">allowRotation</span>) {
    mapParams.<span class="hljs-property">allowRotation</span> = <span class="hljs-title function_">get_allow_rotation</span>(query.<span class="hljs-property">allowRotation</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">attribution</span> !== <span class="hljs-literal">undefined</span>) {
    layerParams.<span class="hljs-property">attribution</span> = query.<span class="hljs-property">attribution</span>;
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">round</span>) {
    layerParams.<span class="hljs-property">tileRounding</span> = <span class="hljs-title class_">Math</span>[query.<span class="hljs-property">round</span>];
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">tileWidth</span>) {
    layerParams.<span class="hljs-property">tileWidth</span> = <span class="hljs-built_in">parseInt</span>(query.<span class="hljs-property">tileWidth</span>, <span class="hljs-number">10</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">tileHeight</span>) {
    layerParams.<span class="hljs-property">tileHeight</span> = <span class="hljs-built_in">parseInt</span>(query.<span class="hljs-property">tileHeight</span>, <span class="hljs-number">10</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">max</span> !== <span class="hljs-literal">undefined</span>) {
    mapParams.<span class="hljs-property">max</span> = <span class="hljs-built_in">parseFloat</span>(query.<span class="hljs-property">max</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">minLevel</span> !== <span class="hljs-literal">undefined</span>) {
    layerParams.<span class="hljs-property">minLevel</span> = <span class="hljs-built_in">parseInt</span>(query.<span class="hljs-property">minLevel</span>, <span class="hljs-number">10</span>);
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">maxLevel</span> !== <span class="hljs-literal">undefined</span>) {
    layerParams.<span class="hljs-property">maxLevel</span> = <span class="hljs-built_in">parseInt</span>(query.<span class="hljs-property">maxLevel</span>, <span class="hljs-number">10</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>allow a generous max tile level so it is never the limit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!layerParams.<span class="hljs-property">maxLevel</span>) {
    layerParams.<span class="hljs-property">maxLevel</span> = <span class="hljs-number">25</span>;
  }
  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">unitsPerPixel</span> !== <span class="hljs-literal">undefined</span>) {
    mapParams.<span class="hljs-property">unitsPerPixel</span> = <span class="hljs-built_in">parseFloat</span>(query.<span class="hljs-property">unitsPerPixel</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>Populate boolean flags for the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.<span class="hljs-title function_">each</span>({
    <span class="hljs-attr">clampBoundsX</span>: <span class="hljs-string">&#x27;clampBoundsX&#x27;</span>,
    <span class="hljs-attr">clampBoundsY</span>: <span class="hljs-string">&#x27;clampBoundsY&#x27;</span>,
    <span class="hljs-attr">clampZoom</span>: <span class="hljs-string">&#x27;clampZoom&#x27;</span>,
    <span class="hljs-attr">discrete</span>: <span class="hljs-string">&#x27;discreteZoom&#x27;</span>
  }, <span class="hljs-keyword">function</span> (<span class="hljs-params">qkey, mkey</span>) {
    <span class="hljs-keyword">if</span> (query[qkey] !== <span class="hljs-literal">undefined</span>) {
      mapParams[mkey] = query[qkey] === <span class="hljs-string">&#x27;true&#x27;</span>;
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p>Populate boolean flags for the tile layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.<span class="hljs-title function_">each</span>({
    <span class="hljs-attr">lower</span>: <span class="hljs-string">&#x27;keepLower&#x27;</span>,
    <span class="hljs-attr">wrapX</span>: <span class="hljs-string">&#x27;wrapX&#x27;</span>,
    <span class="hljs-attr">wrapY</span>: <span class="hljs-string">&#x27;wrapY&#x27;</span>
  }, <span class="hljs-keyword">function</span> (<span class="hljs-params">qkey, lkey</span>) {
    <span class="hljs-keyword">if</span> (query[qkey] !== <span class="hljs-literal">undefined</span>) {
      layerParams[lkey] = query[qkey] === <span class="hljs-string">&#x27;true&#x27;</span>;
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>Create a map object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> map = geo.<span class="hljs-title function_">map</span>(mapParams);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p>Set the projection.  This has to be set on the camera, not in the map
parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">projection</span>) {
    map.<span class="hljs-title function_">camera</span>().<span class="hljs-property">projection</span> = query.<span class="hljs-property">projection</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>Set the spring back.  This is set on the map interactor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">spring</span>) {
    map.<span class="hljs-title function_">interactor</span>().<span class="hljs-title function_">options</span>(springEnabled);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p>Compute default values for zoom animation, then set the map interactor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> zoomAnimationDefault = map.<span class="hljs-title function_">interactor</span>().<span class="hljs-title function_">options</span>().<span class="hljs-property">zoomAnimation</span>,
      zoomAnimationEnabled = {<span class="hljs-attr">zoomAnimation</span>: $.<span class="hljs-title function_">extend</span>(
        {}, zoomAnimationDefault, {<span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>})},
      zoomAnimationDisabled = {<span class="hljs-attr">zoomAnimation</span>: {<span class="hljs-attr">enabled</span>: <span class="hljs-literal">false</span>}};
  map.<span class="hljs-title function_">interactor</span>().<span class="hljs-title function_">options</span>(query.<span class="hljs-property">animateZoom</span> !== <span class="hljs-string">&#x27;false&#x27;</span> ?
    zoomAnimationEnabled : zoomAnimationDisabled);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>Enable debug classes, if requested.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">&#x27;#map&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;debug-label&#x27;</span>, (
    query.<span class="hljs-property">debug</span> === <span class="hljs-string">&#x27;true&#x27;</span> || query.<span class="hljs-property">debug</span> === <span class="hljs-string">&#x27;all&#x27;</span>))
  .<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;debug-border&#x27;</span>, (
    query.<span class="hljs-property">debug</span> === <span class="hljs-string">&#x27;border&#x27;</span> || query.<span class="hljs-property">debug</span> === <span class="hljs-string">&#x27;all&#x27;</span>))
  .<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;fade-image&#x27;</span>, (query.<span class="hljs-property">fade</span> === <span class="hljs-string">&#x27;true&#x27;</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>Add the tile layer with the specified parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> osmLayer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;osm&#x27;</span>, layerParams);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p>Make variables available as a global for easier debug</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  tileDebug.<span class="hljs-property">map</span> = map;
  tileDebug.<span class="hljs-property">mapParams</span> = mapParams;
  tileDebug.<span class="hljs-property">layerParams</span> = layerParams;
  tileDebug.<span class="hljs-property">osmLayer</span> = osmLayer;

  <span class="hljs-comment">/**
   * Handle changes to our controls.
   * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">change_controls</span>(<span class="hljs-params">evt</span>) {
    <span class="hljs-keyword">var</span> ctl = $(evt.<span class="hljs-property">target</span>),
        param = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;param-name&#x27;</span>),
        value = ctl.<span class="hljs-title function_">val</span>();
    <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>)) {
      value = ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;:checked&#x27;</span>) ? <span class="hljs-string">&#x27;true&#x27;</span> : <span class="hljs-string">&#x27;false&#x27;</span>;
    }
    <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;&#x27;</span> &amp;&amp; ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>)) {
      value = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>);
    }
    <span class="hljs-keyword">if</span> (!param || value === query[param]) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> processedValue = (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>) ?
      (value === <span class="hljs-string">&#x27;true&#x27;</span>) : value);
    <span class="hljs-keyword">switch</span> (param) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;allowRotation&#x27;</span>:
        mapParams.<span class="hljs-property">allowRotation</span> = <span class="hljs-title function_">get_allow_rotation</span>(value);
        map.<span class="hljs-title function_">allowRotation</span>(mapParams.<span class="hljs-property">allowRotation</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;animateZoom&#x27;</span>:
        map.<span class="hljs-title function_">interactor</span>().<span class="hljs-title function_">options</span>(
          value === <span class="hljs-string">&#x27;true&#x27;</span> ? zoomAnimationEnabled : zoomAnimationDisabled);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;debug&#x27;</span>:
        $(<span class="hljs-string">&#x27;#map&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;debug-label&#x27;</span>, (
          value === <span class="hljs-string">&#x27;true&#x27;</span> || value === <span class="hljs-string">&#x27;all&#x27;</span>))
        .<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;debug-border&#x27;</span>, (
          value === <span class="hljs-string">&#x27;border&#x27;</span> || value === <span class="hljs-string">&#x27;all&#x27;</span>));
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;discrete&#x27;</span>:
        mapParams.<span class="hljs-property">discreteZoom</span> = processedValue;
        map.<span class="hljs-title function_">discreteZoom</span>(processedValue);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;fade&#x27;</span>:
        $(<span class="hljs-string">&#x27;#map&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;fade-image&#x27;</span>, processedValue);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;lower&#x27;</span>:
        layerParams.<span class="hljs-property">keepLower</span> = (value === <span class="hljs-string">&#x27;true&#x27;</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;max&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;min&#x27;</span>:
        mapParams[param] = <span class="hljs-built_in">parseFloat</span>(value);
        map.<span class="hljs-title function_">zoomRange</span>(mapParams);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;projection&#x27;</span>:
        map.<span class="hljs-title function_">camera</span>().<span class="hljs-property">projection</span> = value;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;renderer&#x27;</span>:
        layerParams[param] = value;
        <span class="hljs-keyword">if</span> (layerParams.<span class="hljs-property">renderer</span> === <span class="hljs-string">&#x27;html&#x27;</span>) {
          layerParams.<span class="hljs-property">renderer</span> = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">if</span> (layerParams.<span class="hljs-property">renderer</span> === <span class="hljs-string">&#x27;default&#x27;</span>) {
          layerParams.<span class="hljs-property">renderer</span> = <span class="hljs-literal">undefined</span>;
        }
        map.<span class="hljs-title function_">deleteLayer</span>(osmLayer);
        osmLayer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;osm&#x27;</span>, layerParams);
        tileDebug.<span class="hljs-property">osmLayer</span> = osmLayer;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;round&#x27;</span>:
        layerParams.<span class="hljs-property">tileRounding</span> = <span class="hljs-title class_">Math</span>[value];
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;spring&#x27;</span>:
        map.<span class="hljs-title function_">interactor</span>().<span class="hljs-title function_">options</span>(
          value === <span class="hljs-string">&#x27;true&#x27;</span> ? springEnabled : springDisabled);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;url&#x27;</span>:
        <span class="hljs-keyword">var</span> url = processedValue;
        layerParams[param] = processedValue;
        <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;/&#x27;</span>) &gt;= <span class="hljs-number">0</span>) {
          osmLayer.<span class="hljs-title function_">url</span>(url);
          osmLayer.<span class="hljs-property">_options</span>.<span class="hljs-property">maxLevel</span> = query.<span class="hljs-property">maxLevel</span> ? <span class="hljs-built_in">parseInt</span>(query.<span class="hljs-property">maxLevel</span>, <span class="hljs-number">10</span>) : <span class="hljs-number">25</span>;
          osmLayer.<span class="hljs-property">_options</span>.<span class="hljs-property">minLevel</span> = query.<span class="hljs-property">minLevel</span> ? <span class="hljs-built_in">parseInt</span>(query.<span class="hljs-property">minLevel</span>, <span class="hljs-number">10</span>) : <span class="hljs-number">0</span>;

        } <span class="hljs-keyword">else</span> {
          osmLayer.<span class="hljs-title function_">source</span>(url);
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;x&#x27;</span>: <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;y&#x27;</span>:
        <span class="hljs-keyword">var</span> coord = map.<span class="hljs-title function_">center</span>();
        coord[param] = mapParams[param] = <span class="hljs-built_in">parseFloat</span>(value);
        map.<span class="hljs-title function_">center</span>(coord);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;zoom&#x27;</span>:
        mapParams[param] = processedValue = <span class="hljs-built_in">parseFloat</span>(value);
        map.<span class="hljs-title function_">zoom</span>(processedValue);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;.layerparam&#x27;</span>)) {
          layerParams[param] = processedValue;
          <span class="hljs-keyword">if</span> (osmLayer[param]) {
            osmLayer[param](processedValue);
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;.mapparam&#x27;</span>)) {
          mapParams[param] = processedValue;
          <span class="hljs-keyword">if</span> (map[param]) {
            map[param](processedValue);
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;.layerparam,.cameraparam&#x27;</span>) &amp;&amp; ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;reload&#x27;</span>) === <span class="hljs-string">&#x27;true&#x27;</span>) {
      map.<span class="hljs-title function_">deleteLayer</span>(osmLayer);
      osmLayer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;osm&#x27;</span>, layerParams);
      tileDebug.<span class="hljs-property">osmLayer</span> = osmLayer;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p>update the url to reflect the changes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    query[param] = value;
    <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;&#x27;</span> || (ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>) &amp;&amp;
        value === ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>))) {
      <span class="hljs-keyword">delete</span> query[param];
    }
    <span class="hljs-keyword">var</span> newurl = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">protocol</span> + <span class="hljs-string">&#x27;//&#x27;</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">host</span> +
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span> + <span class="hljs-string">&#x27;?&#x27;</span> + $.<span class="hljs-title function_">param</span>(query);
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">replaceState</span>(query, <span class="hljs-string">&#x27;&#x27;</span>, newurl);
  }

  <span class="hljs-comment">/* Return the value to set for the allowRotation parameter.
   * @param value the value in the query string.
   * @returns true, false, or a function.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">get_allow_rotation</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">parseFloat</span>(value)) {
      <span class="hljs-keyword">return</span> value !== <span class="hljs-string">&#x27;false&#x27;</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">rotation</span>) {
      <span class="hljs-keyword">var</span> factor = <span class="hljs-number">180</span> / <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-built_in">parseFloat</span>(value);
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(rotation * factor) / factor;
    };
  }
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
