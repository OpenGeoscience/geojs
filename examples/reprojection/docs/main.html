<!DOCTYPE html>

<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p>This example should be tried with different query strings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> exampleDebug = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>Most map tile servers use EPSG:3857 (Web Mercator).  Using a tile server
with a different projection works correctly in all renderers.  Using a
different projection for the tiles and the map can work in the webgl
renderer, but may have problems as the tile density is not uniform or
regular.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> gcsTable = {
  <span class="hljs-string">&#x27;EPSG:3857&#x27;</span>: <span class="hljs-string">&#x27;EPSG:3857&#x27;</span>
};
<span class="hljs-keyword">var</span> gcsBounds = {};
<span class="hljs-keyword">var</span> gcsList = [
  <span class="hljs-string">&#x27;EPSG:3857&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3031&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3032&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3033&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3294&#x27;</span>,
  <span class="hljs-string">&#x27;EPSG:3408&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3409&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3410&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3411&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3412&#x27;</span>,
  <span class="hljs-string">&#x27;EPSG:3413&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3571&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3572&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3573&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3574&#x27;</span>,
  <span class="hljs-string">&#x27;EPSG:3575&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3576&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3786&#x27;</span>, <span class="hljs-string">&#x27;EPSG:32661&#x27;</span>, <span class="hljs-string">&#x27;EPSG:32662&#x27;</span>,
  <span class="hljs-string">&#x27;ESRI:53002&#x27;</span>, <span class="hljs-string">&#x27;ESRI:53003&#x27;</span>, <span class="hljs-string">&#x27;ESRI:53008&#x27;</span>, <span class="hljs-string">&#x27;ESRI:53009&#x27;</span>, <span class="hljs-string">&#x27;ESRI:53021&#x27;</span>,
  <span class="hljs-string">&#x27;ESRI:53027&#x27;</span>, <span class="hljs-string">&#x27;ESRI:54002&#x27;</span>, <span class="hljs-string">&#x27;ESRI:54003&#x27;</span>, <span class="hljs-string">&#x27;ESRI:54009&#x27;</span>, <span class="hljs-string">&#x27;ESRI:54021&#x27;</span>,
  <span class="hljs-string">&#x27;ESRI:54026&#x27;</span>, <span class="hljs-string">&#x27;ESRI:54027&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102005&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102010&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102011&#x27;</span>,
  <span class="hljs-string">&#x27;ESRI:102016&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102017&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102018&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102019&#x27;</span>,
  <span class="hljs-string">&#x27;ESRI:102020&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102021&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102023&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102026&#x27;</span>,
  <span class="hljs-string">&#x27;ESRI:102029&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102031&#x27;</span>, <span class="hljs-string">&#x27;ESRI:102032&#x27;</span>, <span class="hljs-string">&#x27;IAU2000:39914&#x27;</span>,
  <span class="hljs-string">&#x27;IAU2000:39918&#x27;</span>, <span class="hljs-string">&#x27;IAU2000:39920&#x27;</span>, <span class="hljs-string">&#x27;IAU2000:39962&#x27;</span>, <span class="hljs-string">&#x27;IAU2000:39972&#x27;</span>,
  <span class="hljs-string">&#x27;SR-ORG:7&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:22&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:4695&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:6661&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:6842&#x27;</span>,
  <span class="hljs-string">&#x27;SR-ORG:6882&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:6888&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:6890&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:6891&#x27;</span>,
  <span class="hljs-string">&#x27;SR-ORG:6892&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:6893&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:6894&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:6895&#x27;</span>,
  <span class="hljs-string">&#x27;SR-ORG:6896&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:6897&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:6898&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:7250&#x27;</span>,
  <span class="hljs-string">&#x27;SR-ORG:8209&#x27;</span>, <span class="hljs-string">&#x27;SR-ORG:8287&#x27;</span>
];
<span class="hljs-keyword">var</span> capitals;

$.<span class="hljs-title function_">when</span>(
  <span class="hljs-comment">/* Fetch projections */</span>
  $.<span class="hljs-title function_">ajax</span>({<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;proj.json&#x27;</span>}).<span class="hljs-title function_">done</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">resp</span>) {
    $(<span class="hljs-string">&#x27;#map-gcs option&#x27;</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">remove</span>();
    resp.<span class="hljs-title function_">sort</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) {
      <span class="hljs-keyword">var</span> sa = a.<span class="hljs-property">name</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;:&#x27;</span>), sb = b.<span class="hljs-property">name</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;:&#x27;</span>);
      <span class="hljs-keyword">if</span> (sa[<span class="hljs-number">0</span>] !== sb[<span class="hljs-number">0</span>]) {
        <span class="hljs-keyword">return</span> sa[<span class="hljs-number">0</span>] &lt; sb[<span class="hljs-number">0</span>] ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">parseInt</span>(sb[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>) &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-built_in">parseInt</span>(sa[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>) &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(sa[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>) - <span class="hljs-built_in">parseInt</span>(sb[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>);
      }
      <span class="hljs-keyword">return</span> a.<span class="hljs-property">name</span> &lt; b.<span class="hljs-property">name</span> ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
    });
    $.<span class="hljs-title function_">each</span>(resp, <span class="hljs-keyword">function</span> (<span class="hljs-params">idx, proj</span>) {
      gcsTable[proj.<span class="hljs-property">name</span>] = proj.<span class="hljs-property">proj4</span>;
      <span class="hljs-keyword">if</span> (proj.<span class="hljs-property">bounds</span>) {
        gcsBounds[proj.<span class="hljs-property">name</span>] = proj.<span class="hljs-property">bounds</span>;
      }
      <span class="hljs-keyword">var</span> opt = $(<span class="hljs-string">&#x27;&lt;option/&gt;&#x27;</span>).<span class="hljs-title function_">attr</span>({<span class="hljs-attr">value</span>: proj.<span class="hljs-property">name</span>}).<span class="hljs-title function_">text</span>(
        proj.<span class="hljs-property">name</span> + <span class="hljs-string">&#x27; - &#x27;</span> + proj.<span class="hljs-property">desc</span>);
      $(<span class="hljs-string">&#x27;#map-gcs&#x27;</span>).<span class="hljs-title function_">append</span>(opt);
    });
    <span class="hljs-keyword">var</span> pos = <span class="hljs-number">0</span>;
    $.<span class="hljs-title function_">each</span>(gcsList, <span class="hljs-keyword">function</span> (<span class="hljs-params">idx, proj</span>) {
      <span class="hljs-keyword">var</span> opt = $(<span class="hljs-string">&#x27;#map-gcs option[value=&quot;&#x27;</span> + proj + <span class="hljs-string">&#x27;&quot;]&#x27;</span>);
      <span class="hljs-keyword">if</span> (opt.<span class="hljs-property">length</span>) {
        opt.<span class="hljs-title function_">remove</span>();
        $(<span class="hljs-string">&#x27;#map-gcs option&#x27;</span>).<span class="hljs-title function_">eq</span>(pos).<span class="hljs-title function_">before</span>(opt);
        pos += <span class="hljs-number">1</span>;
      }
    });
    $(<span class="hljs-string">&#x27;#map-gcs option&#x27;</span>).<span class="hljs-title function_">eq</span>(pos).<span class="hljs-title function_">before</span>($(<span class="hljs-string">&#x27;&lt;option/&gt;&#x27;</span>).<span class="hljs-title function_">attr</span>(
      {<span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;EPSG:3857&#x27;</span>}).<span class="hljs-title function_">text</span>(<span class="hljs-string">&#x27;--------&#x27;</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>select boxes with thousands of options cause performance issues.  To
see all of the projection options, disable the following line:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $(<span class="hljs-string">&#x27;#map-gcs option&#x27;</span>).<span class="hljs-title function_">slice</span>(pos).<span class="hljs-title function_">remove</span>();
  }),

  <span class="hljs-comment">/* Fetch cities */</span>
  $.<span class="hljs-title function_">ajax</span>({<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;capitals.json&#x27;</span>}).<span class="hljs-title function_">done</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">resp</span>) {
    capitals = resp;
  })

).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Parse query parameters into an object for ease of access</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> query = <span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(^\?)/</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">split</span>(
    <span class="hljs-string">&#x27;&amp;&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">n</span>) {
    n = n.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;=&#x27;</span>);
    <span class="hljs-keyword">if</span> (n[<span class="hljs-number">0</span>]) {
      <span class="hljs-variable language_">this</span>[<span class="hljs-built_in">decodeURIComponent</span>(n[<span class="hljs-number">0</span>])] = <span class="hljs-built_in">decodeURIComponent</span>(n[<span class="hljs-number">1</span>]);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }.<span class="hljs-title function_">bind</span>({}))[<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>hide the controls if requested</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">&#x27;no-controls&#x27;</span>, query.<span class="hljs-property">controls</span> === <span class="hljs-string">&#x27;false&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>populate the controls with the current settings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.<span class="hljs-title function_">each</span>(query, <span class="hljs-keyword">function</span> (<span class="hljs-params">key, value</span>) {
    <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;&quot;&#x27;</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> ctl = $(<span class="hljs-string">&#x27;#controls [param-name=&quot;&#x27;</span> + key + <span class="hljs-string">&#x27;&quot;]&#x27;</span>);
      <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>)) {
        ctl.<span class="hljs-title function_">prop</span>(<span class="hljs-string">&#x27;checked&#x27;</span>, value === <span class="hljs-string">&#x27;true&#x27;</span>);
      } <span class="hljs-keyword">else</span> {
        ctl.<span class="hljs-title function_">val</span>(value);
      }
    }
  });
  $(<span class="hljs-string">&#x27;#controls&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;change&#x27;</span>, change_controls);

  <span class="hljs-keyword">var</span> range = geo.<span class="hljs-property">transform</span>.<span class="hljs-title function_">transformCoordinates</span>(
    <span class="hljs-string">&#x27;EPSG:4326&#x27;</span>, <span class="hljs-string">&#x27;EPSG:3857&#x27;</span>, [{<span class="hljs-attr">x</span>: -<span class="hljs-number">180</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}, {<span class="hljs-attr">x</span>: <span class="hljs-number">180</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}]);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Set map defaults to use our named node and have a reasonable center and
zoom level</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> gcs = query.<span class="hljs-property">gcs</span> || <span class="hljs-string">&#x27;EPSG:3857&#x27;</span>;
  <span class="hljs-keyword">var</span> mapParams = {
    <span class="hljs-attr">node</span>: <span class="hljs-string">&#x27;#map&#x27;</span>,
    <span class="hljs-attr">center</span>: {<span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>},
    <span class="hljs-attr">zoom</span>: <span class="hljs-number">2.5</span>,
    <span class="hljs-attr">gcs</span>: gcsTable[gcs] || gcs,
    <span class="hljs-attr">unitsPerPixel</span>: (range[<span class="hljs-number">1</span>].<span class="hljs-property">x</span> - range[<span class="hljs-number">0</span>].<span class="hljs-property">x</span>) / <span class="hljs-number">256</span>,
    <span class="hljs-attr">clampBoundsX</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">clampBoundsY</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">clampZoom</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">discreteZoom</span>: <span class="hljs-literal">false</span>
  };
  <span class="hljs-keyword">if</span> (gcsBounds[gcs]) {
    mapParams.<span class="hljs-property">maxBounds</span> = gcsBounds[gcs];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>Set the tile layer defaults to use the specified renderer and opacity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> layerParams = {
    <span class="hljs-attr">features</span>: [geo.<span class="hljs-property">quadFeature</span>.<span class="hljs-property">capabilities</span>.<span class="hljs-property">imageFull</span>],
    <span class="hljs-attr">zIndex</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">gcs</span>: <span class="hljs-string">&#x27;EPSG:3857&#x27;</span>,
    <span class="hljs-attr">minLevel</span>: query.<span class="hljs-property">minLevel</span> ? <span class="hljs-built_in">parseInt</span>(query.<span class="hljs-property">minLevel</span>, <span class="hljs-number">10</span>) : <span class="hljs-number">4</span>,
    <span class="hljs-attr">keepLower</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">wrapX</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">wrapY</span>: <span class="hljs-literal">false</span>
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>Allow a custom tile url, including subdomains.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (query.<span class="hljs-property">url</span>) {
    <span class="hljs-keyword">if</span> (query.<span class="hljs-property">url</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;/&#x27;</span>) &gt;= <span class="hljs-number">0</span>) {
      layerParams.<span class="hljs-property">url</span> = query.<span class="hljs-property">url</span>;
      layerParams.<span class="hljs-property">attribution</span> = <span class="hljs-string">&#x27;&#x27;</span>;
    } <span class="hljs-keyword">else</span> {
      layerParams.<span class="hljs-property">source</span> = query.<span class="hljs-property">url</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>Create a map object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> map = geo.<span class="hljs-title function_">map</span>(mapParams);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>Add the tile layer with the specified parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> osmLayer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;osm&#x27;</span>, layerParams);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>create a tool-tip layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> uiLayer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;ui&#x27;</span>, {<span class="hljs-attr">zIndex</span>: <span class="hljs-number">2</span>});
  <span class="hljs-keyword">var</span> tooltip = uiLayer.<span class="hljs-title function_">createWidget</span>(<span class="hljs-string">&#x27;dom&#x27;</span>, {<span class="hljs-attr">position</span>: {<span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>}});
  <span class="hljs-keyword">var</span> tooltipElem = $(tooltip.<span class="hljs-title function_">canvas</span>()).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;tooltip&#x27;</span>).<span class="hljs-title function_">addClass</span>(
    <span class="hljs-string">&#x27;hidden&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>Create a layer with cities</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> pointLayer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;feature&#x27;</span>, {<span class="hljs-attr">zIndex</span>: <span class="hljs-number">1</span>});
  <span class="hljs-keyword">var</span> pointFeature = pointLayer
    .<span class="hljs-title function_">createFeature</span>(<span class="hljs-string">&#x27;point&#x27;</span>, {
      <span class="hljs-attr">selectionAPI</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">style</span>: {
        <span class="hljs-attr">fillColor</span>: <span class="hljs-string">&#x27;#8080FF&#x27;</span>,
        <span class="hljs-attr">fillOpacity</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) { <span class="hljs-keyword">return</span> d.<span class="hljs-property">opacity</span> ? d.<span class="hljs-property">opacity</span> : <span class="hljs-number">0.25</span>; },
        <span class="hljs-attr">strokeColor</span>: <span class="hljs-string">&#x27;black&#x27;</span>,
        <span class="hljs-attr">strokeOpacity</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) {
          <span class="hljs-keyword">return</span> d.<span class="hljs-property">strokeOpacity</span> ? d.<span class="hljs-property">strokeOpacity</span> : <span class="hljs-number">0.25</span>;
        }
      },
      <span class="hljs-attr">visible</span>: query.<span class="hljs-property">capitals</span> !== <span class="hljs-string">&#x27;false&#x27;</span>
    })
    .<span class="hljs-title function_">data</span>(capitals)
    .<span class="hljs-title function_">position</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) {
      <span class="hljs-keyword">return</span> {<span class="hljs-attr">x</span>: d.<span class="hljs-property">longitude</span>, <span class="hljs-attr">y</span>: d.<span class="hljs-property">latitude</span>};
    })
    .<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">feature</span>.<span class="hljs-property">mouseclick</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) {
      pointLayer.<span class="hljs-title function_">map</span>().<span class="hljs-title function_">center</span>({<span class="hljs-attr">x</span>: evt.<span class="hljs-property">data</span>.<span class="hljs-property">longitude</span>, <span class="hljs-attr">y</span>: evt.<span class="hljs-property">data</span>.<span class="hljs-property">latitude</span>});
    })
    .<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">feature</span>.<span class="hljs-property">mouseover</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) {
      evt.<span class="hljs-property">data</span>.<span class="hljs-property">opacity</span> = <span class="hljs-number">0.5</span>;
      evt.<span class="hljs-property">data</span>.<span class="hljs-property">strokeOpacity</span> = <span class="hljs-number">1</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">modified</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">draw</span>();
      tooltip.<span class="hljs-title function_">position</span>({<span class="hljs-attr">x</span>: evt.<span class="hljs-property">data</span>.<span class="hljs-property">longitude</span>, <span class="hljs-attr">y</span>: evt.<span class="hljs-property">data</span>.<span class="hljs-property">latitude</span>});
      tooltipElem.<span class="hljs-title function_">text</span>(evt.<span class="hljs-property">data</span>.<span class="hljs-property">city</span>);
      tooltipElem.<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">&#x27;hidden&#x27;</span>);
    })
    .<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">feature</span>.<span class="hljs-property">mouseout</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) {
      evt.<span class="hljs-property">data</span>.<span class="hljs-property">opacity</span> = <span class="hljs-literal">undefined</span>;
      evt.<span class="hljs-property">data</span>.<span class="hljs-property">strokeOpacity</span> = <span class="hljs-literal">undefined</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">modified</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">draw</span>();
      tooltipElem.<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&#x27;hidden&#x27;</span>);
    })
    .<span class="hljs-title function_">draw</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>Make variables available as a global for easier debug</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  exampleDebug.<span class="hljs-property">map</span> = map;
  exampleDebug.<span class="hljs-property">mapParams</span> = mapParams;
  exampleDebug.<span class="hljs-property">layerParams</span> = layerParams;
  exampleDebug.<span class="hljs-property">osmLayer</span> = osmLayer;
  exampleDebug.<span class="hljs-property">pointLayer</span> = pointLayer;
  exampleDebug.<span class="hljs-property">pointFeature</span> = pointFeature;
  exampleDebug.<span class="hljs-property">uiLayer</span> = uiLayer;
  exampleDebug.<span class="hljs-property">tooltip</span> = tooltip;
  exampleDebug.<span class="hljs-property">tooltipElem</span> = tooltipElem;
  exampleDebug.<span class="hljs-property">gcsTable</span> = gcsTable;
  exampleDebug.<span class="hljs-property">gcsBounds</span> = gcsBounds;
  exampleDebug.<span class="hljs-property">gcsName</span> = gcs;

  <span class="hljs-comment">/**
   * Handle changes to our controls.
   *
   * <span class="hljs-doctag">@param</span> evt jquery evt that triggered this call.
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">change_controls</span>(<span class="hljs-params">evt</span>) {
    <span class="hljs-keyword">var</span> ctl = $(evt.<span class="hljs-property">target</span>),
        param = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;param-name&#x27;</span>),
        value = ctl.<span class="hljs-title function_">val</span>();
    <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>)) {
      value = ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;:checked&#x27;</span>) ? <span class="hljs-string">&#x27;true&#x27;</span> : <span class="hljs-string">&#x27;false&#x27;</span>;
    }
    <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;&#x27;</span> &amp;&amp; ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>)) {
      value = ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>);
    }
    <span class="hljs-keyword">if</span> (!param || value === query[param]) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">var</span> processedValue = (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;[type=&quot;checkbox&quot;]&#x27;</span>) ?
      (value === <span class="hljs-string">&#x27;true&#x27;</span>) : value);
    <span class="hljs-keyword">switch</span> (param) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;capitals&#x27;</span>:
        pointFeature.<span class="hljs-title function_">visible</span>(processedValue);
        pointFeature.<span class="hljs-title function_">draw</span>();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;gcs&#x27;</span>:
        mapParams.<span class="hljs-property">gcs</span> = gcsTable[processedValue] || <span class="hljs-string">&#x27;EPSG:3857&#x27;</span>;
        map.<span class="hljs-title function_">gcs</span>(mapParams.<span class="hljs-property">gcs</span>);
        exampleDebug.<span class="hljs-property">gcsName</span> = processedValue;
        osmLayer.<span class="hljs-title function_">clear</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p>the locations of points can be cached by the renderer.  When we
change map gcs, we need to signal that updates may be needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        pointFeature.<span class="hljs-title function_">dataTime</span>().<span class="hljs-title function_">modified</span>();
        map.<span class="hljs-title function_">draw</span>();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;url&#x27;</span>:
        <span class="hljs-keyword">var</span> url = processedValue;
        <span class="hljs-keyword">if</span> (layerParams.<span class="hljs-property">baseUrl</span>) {
          <span class="hljs-keyword">delete</span> layerParams.<span class="hljs-property">baseUrl</span>;
        }
        layerParams[param] = processedValue;
        <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;/&#x27;</span>) &gt;= <span class="hljs-number">0</span>) {
          osmLayer.<span class="hljs-title function_">url</span>(url);
          osmLayer.<span class="hljs-title function_">attribution</span>(<span class="hljs-string">&#x27;&#x27;</span>);
        } <span class="hljs-keyword">else</span> {
          osmLayer.<span class="hljs-title function_">source</span>(url);
        }
        osmLayer.<span class="hljs-property">_options</span>.<span class="hljs-property">minLevel</span> = layerParams.<span class="hljs-property">minLevel</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;.layerparam&#x27;</span>)) {
          layerParams[param] = processedValue;
          <span class="hljs-keyword">if</span> (param === <span class="hljs-string">&#x27;url&#x27;</span> &amp;&amp; layerParams.<span class="hljs-property">baseUrl</span>) {
            <span class="hljs-keyword">delete</span> layerParams.<span class="hljs-property">baseUrl</span>;
          }
          <span class="hljs-keyword">if</span> (osmLayer[param]) {
            osmLayer[param](processedValue);
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;.mapparam&#x27;</span>)) {
          mapParams[param] = processedValue;
          <span class="hljs-keyword">if</span> (map[param]) {
            map[param](processedValue);
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">if</span> (ctl.<span class="hljs-title function_">is</span>(<span class="hljs-string">&#x27;.layerparam&#x27;</span>) &amp;&amp; ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;reload&#x27;</span>) === <span class="hljs-string">&#x27;true&#x27;</span>) {
      map.<span class="hljs-title function_">deleteLayer</span>(osmLayer);
      osmLayer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;osm&#x27;</span>, layerParams);
      exampleDebug.<span class="hljs-property">osmLayer</span> = osmLayer;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>update the url to reflect the changes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    query[param] = value;
    <span class="hljs-keyword">if</span> (value === <span class="hljs-string">&#x27;&#x27;</span> || (ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>) &amp;&amp;
        value === ctl.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>))) {
      <span class="hljs-keyword">delete</span> query[param];
    }
    <span class="hljs-keyword">var</span> newurl = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">protocol</span> + <span class="hljs-string">&#x27;//&#x27;</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">host</span> +
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span> + <span class="hljs-string">&#x27;?&#x27;</span> + $.<span class="hljs-title function_">param</span>(query);
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">replaceState</span>(query, <span class="hljs-string">&#x27;&#x27;</span>, newurl);
  }
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
