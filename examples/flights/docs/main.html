<!DOCTYPE html>

<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* globals colorbrewer, utils */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>Key:</p>
<ul>
<li>opacity: time (full opacity is recent, faded is old)</li>
<li>color: velocity (blue-yellow-red corresponds to slow-medium-fast)</li>
<li>width: altitude (thicker is higher)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/* Available query parameters:
 *
 * map: &#x27;dark&#x27; (default) or &#x27;light&#x27;.  &#x27;dark&#x27; is a low-opacity stamen map.
 *    &#x27;light&#x27; is a full-opacity OSM map.
 * select: &#x27;true&#x27; (default) or &#x27;false&#x27;.  If &#x27;false&#x27;, don&#x27;t highlight tracks on
 *    mouse-over.
 * scale: &#x27;true&#x27; (default) or &#x27;false&#x27;.  If &#x27;false&#x27;, all tracks are a solid
 *    color.  Otherwise, they are shaded blue-yellow-red based on velocity
 *    where blue is the slowest and red is the fastest, autoscaled for the
 *    available data.
 * opacity: &#x27;true&#x27; (default) or &#x27;false&#x27;.  If &#x27;false&#x27;, all tracks are the same
 *    opacity.  Otherwise, recent data is high opacity than older data.
 * data: undefined (default), &#x27;true&#x27;, or a url.  If &#x27;true&#x27;, load a file
 *    called &#x27;flightdata.json&#x27;.  If a url, load the flight data from that url.
 *    Otherwise, collect data live.
 * interval: a time in seconds, default 30.  When collecting live data, this is
 *    the polling and update interval.
 * keep: 3600 (default) or a time in seconds.  If specified and collecting live
 *    data, only keep this duration of data.  If 0, keep all data.
 * x: starting center longitude.  Default -75.
 * y: starting center latitude.  Default 40.
 * zoom: starting zoom level.  Default 7.
 */</span>

<span class="hljs-keyword">var</span> query = utils.<span class="hljs-title function_">getQuery</span>(),
    canSelect = query.<span class="hljs-property">select</span> !== <span class="hljs-string">&#x27;false&#x27;</span>,
    hasOpacity = query.<span class="hljs-property">opacity</span> !== <span class="hljs-string">&#x27;false&#x27;</span>,
    hasScale = query.<span class="hljs-property">scale</span> !== <span class="hljs-string">&#x27;false&#x27;</span>;

<span class="hljs-keyword">var</span> map, layer, feature, ranges, data;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>We use a d3 color scale, but getting colors from it is slow.  Since we use a
10-part piecewise linear scale (with 11 specification values), we can use a
10 * 256 + 1 size array to use pre-computed colors with surety that it has
all possible values for 8-bit color displays.  We can manually interpolate
to use the scale array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> d3Scale = d3.<span class="hljs-title function_">scaleLinear</span>()
      .<span class="hljs-title function_">range</span>(colorbrewer.<span class="hljs-property">RdYlBu</span>[<span class="hljs-number">11</span>])
      .<span class="hljs-title function_">domain</span>([<span class="hljs-number">1</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.0</span>]),
    d3ScaleParts = <span class="hljs-number">10</span> * <span class="hljs-number">256</span>,
    scale = [...<span class="hljs-title class_">Array</span>(d3ScaleParts + <span class="hljs-number">1</span>)].<span class="hljs-title function_">map</span>(
      <span class="hljs-function">(<span class="hljs-params">_, idx</span>) =&gt;</span> geo.<span class="hljs-property">util</span>.<span class="hljs-title function_">convertColor</span>(<span class="hljs-title function_">d3Scale</span>(idx / d3ScaleParts)));

<span class="hljs-comment">/**
 * Redraw the display, optionally updating the data.  If the data is updated
 * and does not have precomputed ranges, compute them.
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object[]</span>} drawData The data to plot.  This can have a `ranges`
 *    property.
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params">drawData</span>) {
  <span class="hljs-keyword">if</span> (drawData) {
    data = drawData;
    ranges = data.<span class="hljs-property">ranges</span>;
    <span class="hljs-keyword">if</span> (!ranges) {
      ranges = {};
      [<span class="hljs-string">&#x27;time&#x27;</span>, <span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-string">&#x27;v&#x27;</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) {
        ranges[key] = {<span class="hljs-attr">min</span>: data[<span class="hljs-number">0</span>][key][<span class="hljs-number">0</span>], <span class="hljs-attr">max</span>: data[<span class="hljs-number">0</span>][key][<span class="hljs-number">0</span>]};
        data.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">line</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; line[key].<span class="hljs-property">length</span>; i += <span class="hljs-number">1</span>) {
            ranges[key].<span class="hljs-property">min</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(ranges[key].<span class="hljs-property">min</span>, line[key][i]);
            ranges[key].<span class="hljs-property">max</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(ranges[key].<span class="hljs-property">max</span>, line[key][i]);
          }
        });
        ranges[key].<span class="hljs-property">range</span> = ranges[key].<span class="hljs-property">max</span> - ranges[key].<span class="hljs-property">min</span>;
      });
    }
    feature.<span class="hljs-title function_">data</span>(data);
  }
  map.<span class="hljs-title function_">scheduleAnimationFrame</span>(feature.<span class="hljs-property">draw</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Create a map object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>map = geo.<span class="hljs-title function_">map</span>({
  <span class="hljs-attr">node</span>: <span class="hljs-string">&#x27;#map&#x27;</span>,
  <span class="hljs-attr">center</span>: {
    <span class="hljs-attr">x</span>: query.<span class="hljs-property">x</span> !== <span class="hljs-literal">undefined</span> ? +query.<span class="hljs-property">x</span> : -<span class="hljs-number">75</span>,
    <span class="hljs-attr">y</span>: query.<span class="hljs-property">y</span> !== <span class="hljs-literal">undefined</span> ? +query.<span class="hljs-property">y</span> : <span class="hljs-number">40</span>
  },
  <span class="hljs-attr">zoom</span>: query.<span class="hljs-property">zoom</span> !== <span class="hljs-literal">undefined</span> ? +query.<span class="hljs-property">zoom</span> : <span class="hljs-number">7</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>Add the default osm layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;osm&#x27;</span>, {
  <span class="hljs-attr">source</span>: query.<span class="hljs-property">map</span> === <span class="hljs-string">&#x27;dark&#x27;</span> ? <span class="hljs-string">&#x27;stamen-toner-lite&#x27;</span> : <span class="hljs-string">&#x27;osm&#x27;</span>,
  <span class="hljs-attr">opacity</span>: query.<span class="hljs-property">map</span> === <span class="hljs-string">&#x27;dark&#x27;</span> ? <span class="hljs-number">0.25</span> : <span class="hljs-number">1</span>
});

<span class="hljs-keyword">if</span> (query.<span class="hljs-property">map</span> !== <span class="hljs-string">&#x27;light&#x27;</span>) {
  $(<span class="hljs-string">&#x27;#map&#x27;</span>).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">&#x27;dark&#x27;</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>Make sure our attribution reports on the data source.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>map.<span class="hljs-title function_">layers</span>()[<span class="hljs-number">0</span>].<span class="hljs-title function_">attribution</span>(map.<span class="hljs-title function_">layers</span>()[<span class="hljs-number">0</span>].<span class="hljs-title function_">attribution</span>() + <span class="hljs-string">&#x27;.  Flight data from &lt;a href=&quot;http://www.opensky-network.org&quot;&gt;The OpenSky Network&lt;/a&gt;&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Create a feature layer to draw on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>layer = map.<span class="hljs-title function_">createLayer</span>(<span class="hljs-string">&#x27;feature&#x27;</span>, {<span class="hljs-attr">features</span>: [geo.<span class="hljs-property">lineFeature</span>.<span class="hljs-property">capabilities</span>.<span class="hljs-property">multicolor</span>]});</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>Create a line feature</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>feature = layer.<span class="hljs-title function_">createFeature</span>(<span class="hljs-string">&#x27;line&#x27;</span>, {<span class="hljs-attr">selectionAPI</span>: canSelect})</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>For the line accessor, we can return any array that is the length of the
number of vertices in the line.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  .<span class="hljs-title function_">line</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) {
    <span class="hljs-keyword">return</span> d.<span class="hljs-property">time</span>;
  })
  .<span class="hljs-title function_">position</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">d, i, l</span>) {
    <span class="hljs-keyword">return</span> {<span class="hljs-attr">x</span>: l.<span class="hljs-property">lon</span>[i], <span class="hljs-attr">y</span>: l.<span class="hljs-property">lat</span>[i]};
  })
  .<span class="hljs-title function_">style</span>({
    <span class="hljs-attr">strokeColor</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">d, i, l</span>) {
      <span class="hljs-keyword">if</span> (!hasScale) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>d3 scales are slow; don’t do:
return d3Scale(0);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> scale[<span class="hljs-number">0</span>];
      }
      <span class="hljs-keyword">var</span> val = (l.<span class="hljs-property">v</span>[i] - ranges.<span class="hljs-property">v</span>.<span class="hljs-property">min</span>) / ranges.<span class="hljs-property">v</span>.<span class="hljs-property">range</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>d3 scales are slow, don’t do:
return d3Scale(val);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> val &lt; <span class="hljs-number">0</span> ? scale[<span class="hljs-number">0</span>] : val &gt; <span class="hljs-number">1</span> ? scale[d3ScaleParts] : scale[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(d3ScaleParts * val)];
    },
    <span class="hljs-attr">strokeWidth</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">d, i, l</span>) {
      <span class="hljs-keyword">var</span> width = <span class="hljs-number">0.5</span> + <span class="hljs-number">3.0</span> * (l.<span class="hljs-property">z</span>[i] - ranges.<span class="hljs-property">z</span>.<span class="hljs-property">min</span>) / ranges.<span class="hljs-property">z</span>.<span class="hljs-property">range</span>;
      <span class="hljs-keyword">if</span> (canSelect &amp;&amp; l.<span class="hljs-property">hover</span>) {
        width = width * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
      }
      <span class="hljs-keyword">return</span> width;
    },
    <span class="hljs-attr">strokeOpacity</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">d, i, l</span>) {
      <span class="hljs-keyword">if</span> (canSelect &amp;&amp; l.<span class="hljs-property">hover</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
      }
      <span class="hljs-keyword">if</span> (!hasOpacity) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.25</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-number">0.05</span> + <span class="hljs-number">0.70</span> * (d - ranges.<span class="hljs-property">time</span>.<span class="hljs-property">min</span>) / ranges.<span class="hljs-property">time</span>.<span class="hljs-property">range</span>;
    },
    <span class="hljs-attr">lineCap</span>: <span class="hljs-string">&#x27;round&#x27;</span>,
    <span class="hljs-attr">lineJoin</span>: <span class="hljs-string">&#x27;round&#x27;</span>
  })
  .<span class="hljs-title function_">geoOff</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">feature</span>.<span class="hljs-property">mouseover</span>)
  .<span class="hljs-title function_">geoOff</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">feature</span>.<span class="hljs-property">mouseout</span>)
  .<span class="hljs-title function_">geoOn</span>(geo.<span class="hljs-property">event</span>.<span class="hljs-property">feature</span>.<span class="hljs-property">mouseover</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) {
    <span class="hljs-keyword">if</span> (!evt.<span class="hljs-property">top</span> || evt.<span class="hljs-property">data</span>.<span class="hljs-property">hover</span>) { <span class="hljs-keyword">return</span>; }
    data.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) {
      d.<span class="hljs-property">hover</span> = <span class="hljs-literal">false</span>;
    });
    evt.<span class="hljs-property">data</span>.<span class="hljs-property">hover</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(evt.<span class="hljs-property">data</span>.<span class="hljs-property">id</span>, evt.<span class="hljs-property">data</span>.<span class="hljs-property">callsign</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">modified</span>();
    feature.<span class="hljs-title function_">draw</span>();
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>Override how we get the style function for strokeColor to avoid overwrapping
it with the convertColor function.  This is purely for speed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> originalStyleGet = feature.<span class="hljs-property">style</span>.<span class="hljs-property">get</span>;
feature.<span class="hljs-property">style</span>.<span class="hljs-property">get</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) {
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&#x27;strokeColor&#x27;</span>) {
    <span class="hljs-keyword">return</span> feature.<span class="hljs-title function_">style</span>(<span class="hljs-string">&#x27;strokeColor&#x27;</span>);
  }
  <span class="hljs-keyword">return</span> originalStyleGet.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
};

<span class="hljs-keyword">if</span> (query.<span class="hljs-property">data</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>Load fixed data.  If you show live data, you can save it for use as fixed
data by pasting the following into the console:
<code>var link = document.createElement(&#39;a&#39;); var url = URL.createObjectURL(new Blob([JSON.stringify(feature.data())])); link.setAttribute(&#39;href&#39;, url); link.setAttribute(&#39;download&#39;, &#39;flightdata.json&#39;); var event = document.createEvent(&#39;MouseEvents&#39;); event.initMouseEvent(&#39;click&#39;, true, true, window, 1, 0, 0, 0, 0, false, false, false, false, 0, null); link.dispatchEvent(event);</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.<span class="hljs-title function_">ajax</span>({
    <span class="hljs-attr">url</span>: query.<span class="hljs-property">data</span> === <span class="hljs-string">&#x27;true&#x27;</span> ? <span class="hljs-string">&#x27;flightdata.json&#x27;</span> : query.<span class="hljs-property">data</span>,
    <span class="hljs-attr">success</span>: draw
  });
} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>Ask a web worker to collect data.  See
<a href="worker.html">worker.html</a> for annotated source.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">&#x27;worker.js&#x27;</span>);
  worker.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) {
    <span class="hljs-title function_">draw</span>(evt.<span class="hljs-property">data</span>);
  };
  <span class="hljs-keyword">var</span> interval = <span class="hljs-built_in">parseInt</span>(query.<span class="hljs-property">interval</span>);
  worker.<span class="hljs-title function_">postMessage</span>({
    <span class="hljs-attr">interval</span>: interval &gt; <span class="hljs-number">0</span> ? interval * <span class="hljs-number">1000</span> : <span class="hljs-number">30000</span>,
    <span class="hljs-attr">keep</span>: (query.<span class="hljs-property">keep</span> === <span class="hljs-literal">undefined</span> ? <span class="hljs-number">3600</span> : query.<span class="hljs-property">keep</span>) * <span class="hljs-number">1000</span>
  });
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
