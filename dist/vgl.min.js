function inherit(C,P){"use strict";var F=function(){};F.prototype=P.prototype,C.prototype=new F,C.uber=P.prototype,C.prototype.constructor=C}if("undefined"==typeof ogs)var ogs={};ogs.namespace=function(ns_string){"use strict";var i,parts=ns_string.split("."),parent=ogs;for("ogs"===parts[0]&&(parts=parts.slice(1)),i=0;i<parts.length;i+=1)"undefined"==typeof parent[parts[i]]&&(parent[parts[i]]={}),parent=parent[parts[i]];return parent};var vgl=ogs.namespace("gl");Object.size=function(obj){"use strict";var size=0,key=null;for(key in obj)obj.hasOwnProperty(key)&&size++;return size},vgl.GL={ColorBufferBit:16384,DepthBufferBit:256};var m_globalModifiedTime=0;vgl.timestamp=function(){"use strict";if(!(this instanceof vgl.timestamp))return new vgl.timestamp;var m_modifiedTime=0;this.modified=function(){++m_globalModifiedTime,m_modifiedTime=m_globalModifiedTime},this.getMTime=function(){return m_modifiedTime}},vgl.object=function(){"use strict";if(!(this instanceof vgl.object))return new vgl.object;var m_modifiedTime=vgl.timestamp();return m_modifiedTime.modified(),this.modified=function(){m_modifiedTime.modified()},this.getMTime=function(){return m_modifiedTime.getMTime()},this},vgl.event=function(){"use strict";return this instanceof vgl.event?(vgl.object.call(this),this):new vgl.event},inherit(vgl.event,vgl.object),vgl.event.keyPress="vgl.event.keyPress",vgl.event.mousePress="vgl.event.mousePress",vgl.event.mouseRelease="vgl.event.mouseRelease",vgl.event.contextMenu="vgl.event.contextMenu",vgl.event.configure="vgl.event.configure",vgl.event.enable="vgl.event.enable",vgl.event.mouseWheel="vgl.event.mouseWheel",vgl.event.keyRelease="vgl.event.keyRelease",vgl.event.middleButtonPress="vgl.event.middleButtonPress",vgl.event.startInteraction="vgl.event.startInteraction",vgl.event.enter="vgl.event.enter",vgl.event.rightButtonPress="vgl.event.rightButtonPress",vgl.event.middleButtonRelease="vgl.event.middleButtonRelease",vgl.event.char="vgl.event.char",vgl.event.disable="vgl.event.disable",vgl.event.endInteraction="vgl.event.endInteraction",vgl.event.mouseMove="vgl.event.mouseMove",vgl.event.mouseOut="vgl.event.mouseOut",vgl.event.expose="vgl.event.expose",vgl.event.timer="vgl.event.timer",vgl.event.leftButtonPress="vgl.event.leftButtonPress",vgl.event.leave="vgl.event.leave",vgl.event.rightButtonRelease="vgl.event.rightButtonRelease",vgl.event.leftButtonRelease="vgl.event.leftButtonRelease",vgl.event.click="vgl.event.click",vgl.event.dblClick="vgl.event.dblClick",vgl.boundingObject=function(){"use strict";if(!(this instanceof vgl.boundingObject))return new vgl.boundingObject;vgl.object.call(this);var m_bounds=[0,0,0,0,0,0],m_computeBoundsTimestamp=vgl.timestamp(),m_boundsDirtyTimestamp=vgl.timestamp();return m_computeBoundsTimestamp.modified(),m_boundsDirtyTimestamp.modified(),this.bounds=function(){return m_bounds},this.hasValidBounds=function(bounds){return bounds[0]==Number.MAX_VALUE||bounds[1]==-Number.MAX_VALUE||bounds[2]==Number.MAX_VALUE||bounds[3]==-Number.MAX_VALUE||bounds[4]==Number.MAX_VALUE||bounds[5]==-Number.MAX_VALUE?!1:!0},this.setBounds=function(minX,maxX,minY,maxY,minZ,maxZ){return this.hasValidBounds([minX,maxX,minY,maxY,minZ,maxZ])?(m_bounds[0]=minX,m_bounds[1]=maxX,m_bounds[2]=minY,m_bounds[3]=maxY,m_bounds[4]=minZ,m_bounds[5]=maxZ,this.modified(),m_computeBoundsTimestamp.modified(),!0):void 0},this.resetBounds=function(){m_bounds[0]=Number.MAX_VALUE,m_bounds[1]=-Number.MAX_VALUE,m_bounds[2]=Number.MAX_VALUE,m_bounds[3]=-Number.MAX_VALUE,m_bounds[4]=Number.MAX_VALUE,m_bounds[5]=-Number.MAX_VALUE,this.modified()},this.computeBounds=function(){},this.computeBoundsTimestamp=function(){return m_computeBoundsTimestamp},this.boundsDirtyTimestamp=function(){return m_boundsDirtyTimestamp},this.resetBounds(),this},vgl.boundingObject.ReferenceFrame={Relative:0,Absolute:1},inherit(vgl.boundingObject,vgl.object),vgl.node=function(){"use strict";if(!(this instanceof vgl.node))return new vgl.node;vgl.boundingObject.call(this);var m_parent=null,m_material=null,m_visible=!0,m_overlay=!1;return this.accept=function(visitor){visitor.visit(this)},this.material=function(){return m_material},this.setMaterial=function(material){return material!==m_material?(m_material=material,this.modified(),!0):!1},this.visible=function(){return m_visible},this.setVisible=function(flag){return flag!==m_visible?(m_visible=flag,this.modified(),!0):!1},this.parent=function(){return m_parent},this.setParent=function(parent){return parent!==m_parent?(null!==m_parent&&m_parent.removeChild(this),m_parent=parent,this.modified(),!0):!1},this.overlay=function(){return m_overlay},this.setOverlay=function(flag){return m_overlay!==flag?(m_overlay=flag,this.modified(),!0):!1},this.ascend=function(){},this.traverse=function(){},this.boundsModified=function(){this.boundsDirtyTimestamp().modified(),null!==m_parent&&m_parent.boundsModified()},this},inherit(vgl.node,vgl.boundingObject),vgl.groupNode=function(){"use strict";if(!(this instanceof vgl.groupNode))return new vgl.groupNode;vgl.node.call(this);var m_children=[];return this.b_setVisible=this.setVisible,this.setVisible=function(flag){var i;if(this.b_setVisible(flag)!==!0)return!1;for(i=0;i<m_children.length;++i)m_children[i].setVisible(flag);return!0},this.addChild=function(childNode){return childNode instanceof vgl.node&&-1===m_children.indexOf(childNode)?(childNode.setParent(this),m_children.push(childNode),this.boundsDirtyTimestamp().modified(),!0):!1},this.removeChild=function(childNode){if(childNode.parent()===this){var index=m_children.indexOf(childNode);return m_children.splice(index,1),this.boundsDirtyTimestamp().modified(),!0}},this.removeChildren=function(){var i;for(i=0;i<m_children.length;++i)this.removeChild(m_children[i]);this.modified()},this.children=function(){return m_children},this.hasChild=function(node){var i=0,child=!1;for(i=0;i<m_children.length;i++)if(m_children[i]===node){child=!0;break}return child},this.accept=function(visitor){visitor.visit(this)},this.traverse=function(visitor){switch(visitor.type()){case visitor.UpdateVisitor:this.traverseChildrenAndUpdateBounds(visitor);break;case visitor.CullVisitor:this.traverseChildren(visitor)}},this.traverseChildrenAndUpdateBounds=function(visitor){var i;if(this.m_parent&&this.boundsDirtyTimestamp().getMTime()>this.computeBoundsTimestamp().getMTime()&&this.m_parent.boundsDirtyTimestamp.modified(),this.computeBounds(),visitor.mode()===visitor.TraverseAllChildren)for(i=0;i<m_children.length();++i)m_children[i].accept(visitor),this.updateBounds(m_children[i]);this.computeBoundsTimestamp().modified()},this.traverseChildren=function(visitor){var i;if(visitor.mode()===vgl.vesVisitor.TraverseAllChildren)for(i=0;i<m_children.length();++i)m_children[i].accept(visitor)},this.computeBounds=function(){var i=0;if(!(this.computeBoundsTimestamp().getMTime()>this.boundsDirtyTimestamp().getMTime()))for(i=0;i<m_children.length;++i)this.updateBounds(m_children[i])},this.updateBounds=function(child){if(!child.overlay()){child.computeBounds();var i,bounds=this.bounds(),childBounds=child.bounds(),istep=0,jstep=0;for(i=0;3>i;++i)istep=2*i,jstep=2*i+1,childBounds[istep]<bounds[istep]&&(bounds[istep]=childBounds[istep]),childBounds[jstep]>bounds[jstep]&&(bounds[jstep]=childBounds[jstep]);this.setBounds(bounds[0],bounds[1],bounds[2],bounds[3],bounds[4],bounds[5])}},this},inherit(vgl.groupNode,vgl.node),vgl.actor=function(){"use strict";if(!(this instanceof vgl.actor))return new vgl.actor;vgl.node.call(this);var m_transformMatrix=mat4.create(),m_referenceFrame=vgl.boundingObject.ReferenceFrame.Relative,m_mapper=null;return this.matrix=function(){return m_transformMatrix},this.setMatrix=function(tmatrix){tmatrix!==m_transformMatrix&&(m_transformMatrix=tmatrix,this.modified())},this.referenceFrame=function(){return m_referenceFrame},this.setReferenceFrame=function(referenceFrame){return referenceFrame!==m_referenceFrame?(m_referenceFrame=referenceFrame,this.modified(),!0):!1},this.mapper=function(){return m_mapper},this.setMapper=function(mapper){mapper!==m_mapper&&(m_mapper=mapper,this.boundsModified())},this.accept=function(){},this.ascend=function(){},this.computeLocalToWorldMatrix=function(){},this.computeWorldToLocalMatrix=function(){},this.computeBounds=function(){if(null===m_mapper||void 0===m_mapper)return void this.resetBounds();var mapperBounds,minPt,maxPt,newBounds,computeBoundsTimestamp=this.computeBoundsTimestamp();(this.boundsDirtyTimestamp().getMTime()>computeBoundsTimestamp.getMTime()||m_mapper.boundsDirtyTimestamp().getMTime()>computeBoundsTimestamp.getMTime())&&(m_mapper.computeBounds(),mapperBounds=m_mapper.bounds(),minPt=[mapperBounds[0],mapperBounds[2],mapperBounds[4]],maxPt=[mapperBounds[1],mapperBounds[3],mapperBounds[5]],vec3.transformMat4(minPt,minPt,m_transformMatrix),vec3.transformMat4(maxPt,maxPt,m_transformMatrix),newBounds=[minPt[0]>maxPt[0]?maxPt[0]:minPt[0],minPt[0]>maxPt[0]?minPt[0]:maxPt[0],minPt[1]>maxPt[1]?maxPt[1]:minPt[1],minPt[1]>maxPt[1]?minPt[1]:maxPt[1],minPt[2]>maxPt[2]?maxPt[2]:minPt[2],minPt[2]>maxPt[2]?minPt[2]:maxPt[2]],this.setBounds(newBounds[0],newBounds[1],newBounds[2],newBounds[3],newBounds[4],newBounds[5]),computeBoundsTimestamp.modified())},this},inherit(vgl.actor,vgl.node),vgl.freezeObject=function(obj){"use strict";var freezedObject=Object.freeze(obj);return"undefined"==typeof freezedObject&&(freezedObject=function(o){return o}),freezedObject},vgl.defaultValue=function(a,b){"use strict";return"undefined"!=typeof a?a:b},vgl.defaultValue.EMPTY_OBJECT=vgl.freezeObject({}),vgl.geojsonReader=function(){"use strict";if(!(this instanceof vgl.geojsonReader))return new vgl.geojsonReader;return this.readScalars=function(coordinates,geom,size_estimate,idx){var array=null,s=null,r=null,g=null,b=null;"values"===this.m_scalarFormat&&4===coordinates.length?(s=coordinates[3],array=geom.sourceData(vgl.vertexAttributeKeys.Scalar),array||(array=new vgl.sourceDataSf,this.m_scalarRange&&array.setScalarRange(this.m_scalarRange[0],this.m_scalarRange[1]),void 0!==size_estimate&&(array.data().length=size_estimate),geom.addSource(array)),void 0===size_estimate?array.pushBack(s):array.insertAt(idx,s)):"rgb"===this.m_scalarFormat&&6===coordinates.length&&(array=geom.sourceData(vgl.vertexAttributeKeys.Color),array||(array=new vgl.sourceDataC3fv,void 0!==size_estimate&&(array.length=3*size_estimate),geom.addSource(array)),r=coordinates[3],g=coordinates[4],b=coordinates[5],void 0===size_estimate?array.pushBack([r,g,b]):array.insertAt(idx,[r,g,b]))},this.readPoint=function(coordinates){var geom=new vgl.geometryData,vglpoints=new vgl.points,vglcoords=new vgl.sourceDataP3fv,indices=new Uint16Array(1),x=null,y=null,z=null,i=null;for(geom.addSource(vglcoords),i=0;1>i;i++)indices[i]=i,x=coordinates[0],y=coordinates[1],z=0,coordinates.length>2&&(z=coordinates[2]),vglcoords.pushBack([x,y,z]),this.readScalars(coordinates,geom);return vglpoints.setIndices(indices),geom.addPrimitive(vglpoints),geom.setName("aPoint"),geom},this.readMultiPoint=function(coordinates){var i,geom=new vgl.geometryData,vglpoints=new vgl.points,vglcoords=new vgl.sourceDataP3fv,indices=new Uint16Array(coordinates.length),pntcnt=0,estpntcnt=coordinates.length,x=null,y=null,z=null;for(vglcoords.data().length=3*estpntcnt,i=0;i<coordinates.length;i++)indices[i]=i,x=coordinates[i][0],y=coordinates[i][1],z=0,coordinates[i].length>2&&(z=coordinates[i][2]),vglcoords.insertAt(pntcnt,[x,y,z]),this.readScalars(coordinates[i],geom,estpntcnt,pntcnt),pntcnt++;return vglpoints.setIndices(indices),geom.addPrimitive(vglpoints),geom.addSource(vglcoords),geom.setName("manyPoints"),geom},this.readLineString=function(coordinates){var geom=new vgl.geometryData,vglline=new vgl.lineStrip,vglcoords=new vgl.sourceDataP3fv,indices=[],i=null,x=null,y=null,z=null;for(vglline.setIndicesPerPrimitive(coordinates.length),i=0;i<coordinates.length;i++)indices.push(i),x=coordinates[i][0],y=coordinates[i][1],z=0,coordinates[i].length>2&&(z=coordinates[i][2]),vglcoords.pushBack([x,y,z]),this.readScalars(coordinates[i],geom);return vglline.setIndices(indices),geom.addPrimitive(vglline),geom.addSource(vglcoords),geom.setName("aLineString"),geom},this.readMultiLineString=function(coordinates){var geom=new vgl.geometryData,vglcoords=new vgl.sourceDataP3fv,pntcnt=0,estpntcnt=2*coordinates.length,i=null,j=null,x=null,y=null,z=null,indices=null,vglline=null,thisLineLength=null;for(vglcoords.data().length=3*estpntcnt,j=0;j<coordinates.length;j++){for(indices=[],vglline=new vgl.lineStrip,thisLineLength=coordinates[j].length,vglline.setIndicesPerPrimitive(thisLineLength),i=0;thisLineLength>i;i++)indices.push(pntcnt),x=coordinates[j][i][0],y=coordinates[j][i][1],z=0,coordinates[j][i].length>2&&(z=coordinates[j][i][2]),vglcoords.insertAt(pntcnt,[x,y,z]),this.readScalars(coordinates[j][i],geom,2*estpntcnt,pntcnt),pntcnt++;vglline.setIndices(indices),geom.addPrimitive(vglline)}return geom.setName("aMultiLineString"),geom.addSource(vglcoords),geom},this.readPolygon=function(coordinates){var geom=new vgl.geometryData,vglcoords=new vgl.sourceDataP3fv,x=null,y=null,z=null,thisPolyLength=coordinates[0].length,vl=1,i=null,indices=null,vgltriangle=null;for(i=0;thisPolyLength>i;i++)x=coordinates[0][i][0],y=coordinates[0][i][1],z=0,coordinates[0][i].length>2&&(z=coordinates[0][i][2]),vglcoords.pushBack([x,y,z]),this.readScalars(coordinates[0][i],geom),i>1&&(indices=new Uint16Array([0,vl,i]),vgltriangle=new vgl.triangles,vgltriangle.setIndices(indices),geom.addPrimitive(vgltriangle),vl=i);return geom.setName("POLY"),geom.addSource(vglcoords),geom},this.readMultiPolygon=function(coordinates){var geom=new vgl.geometryData,vglcoords=new vgl.sourceDataP3fv,ccount=0,numPolys=coordinates.length,pntcnt=0,estpntcnt=3*numPolys,vgltriangle=new vgl.triangles,indexes=[],i=null,j=null,x=null,y=null,z=null,thisPolyLength=null,vf=null,vl=null,flip=null,flipped=!1,tcount=0;for(vglcoords.data().length=3*numPolys,j=0;numPolys>j;j++)for(thisPolyLength=coordinates[j][0].length,vf=ccount,vl=ccount+1,flip=[!1,!1,!1],i=0;thisPolyLength>i;i++)x=coordinates[j][0][i][0],y=coordinates[j][0][i][1],z=0,coordinates[j][0][i].length>2&&(z=coordinates[j][0][i][2]),flipped=!1,x>180&&(flipped=!0,x-=360),0===i?flip[0]=flipped:flip[1+(i-1)%2]=flipped,vglcoords.insertAt(pntcnt,[x,y,z]),this.readScalars(coordinates[j][0][i],geom,estpntcnt,pntcnt),pntcnt++,i>1&&(flip[0]===flip[1]&&flip[1]===flip[2]&&(indexes[3*tcount+0]=vf,indexes[3*tcount+1]=vl,indexes[3*tcount+2]=ccount,tcount++),vl=ccount),ccount++;return vgltriangle.setIndices(indexes),geom.addPrimitive(vgltriangle),geom.setName("aMultiPoly"),geom.addSource(vglcoords),geom},this.readGJObjectInt=function(object){if(!object.hasOwnProperty("type"))return null;object.properties&&object.properties.ScalarFormat&&"values"===object.properties.ScalarFormat&&(this.m_scalarFormat="values",object.properties.ScalarRange&&(this.m_scalarRange=object.properties.ScalarRange)),object.properties&&object.properties.ScalarFormat&&"rgb"===object.properties.ScalarFormat&&(this.m_scalarFormat="rgb");var ret,type=object.type,next=null,nextset=null,i=null;switch(type){case"Point":ret=this.readPoint(object.coordinates);break;case"MultiPoint":ret=this.readMultiPoint(object.coordinates);break;case"LineString":ret=this.readLineString(object.coordinates);break;case"MultiLineString":ret=this.readMultiLineString(object.coordinates);break;case"Polygon":ret=this.readPolygon(object.coordinates);break;case"MultiPolygon":ret=this.readMultiPolygon(object.coordinates);break;case"GeometryCollection":for(nextset=[],i=0;i<object.geometries.length;i++)next=this.readGJObject(object.geometries[i]),nextset.push(next);ret=nextset;break;case"Feature":next=this.readGJObject(object.geometry),ret=next;break;case"FeatureCollection":for(nextset=[],i=0;i<object.features.length;i++)next=this.readGJObject(object.features[i]),nextset.push(next);ret=nextset;break;default:console.log("Don't understand type "+type),ret=null}return ret},this.readGJObject=function(object){var ret;return ret=this.readGJObjectInt(object)},this.linearizeGeoms=function(geoms,geom){var i=null;if("[object Array]"===Object.prototype.toString.call(geom))for(i=0;i<geom.length;i++)this.linearizeGeoms(geoms,geom[i]);else geoms.push(geom)},this.readGeomObject=function(object){var geom,geoms=[];return geom=this.readGJObject(object),this.linearizeGeoms(geoms,geom),geoms},this.getPrimitives=function(buffer){if(!buffer)return[];var obj=JSON.parse(buffer),geom=this.readGJObject(obj),geoms=[];return this.m_scalarFormat="none",this.m_scalarRange=null,this.linearizeGeoms(geoms,geom),{geoms:geoms,scalarFormat:this.m_scalarFormat,scalarRange:this.m_scalarRange}},this},vgl.data=function(){"use strict";return this instanceof vgl.data?void(this.type=function(){}):new vgl.data},vgl.data.raster=0,vgl.data.point=1,vgl.data.lineString=2,vgl.data.polygon=3,vgl.data.geometry=10;var vertexAttributeKeys={Position:0,Normal:1,TextureCoordinate:2,Color:3,Scalar:4};vgl.primitive=function(){"use strict";if(!(this instanceof vgl.primitive))return new vgl.primitive;var m_indicesPerPrimitive=0,m_primitiveType=0,m_indicesValueType=0,m_indices=null;return this.indices=function(){return m_indices},this.createIndices=function(){m_indices=new Uint16Array},this.numberOfIndices=function(){return m_indices.length},this.sizeInBytes=function(){return m_indices.length*Uint16Array.BYTES_PER_ELEMENT},this.primitiveType=function(){return m_primitiveType},this.setPrimitiveType=function(type){m_primitiveType=type},this.indicesPerPrimitive=function(){return m_indicesPerPrimitive},this.setIndicesPerPrimitive=function(count){m_indicesPerPrimitive=count},this.indicesValueType=function(){return m_indicesValueType},this.setIndicesValueType=function(type){m_indicesValueType=type},this.setIndices=function(indicesArray){m_indices=new Uint16Array(indicesArray)},this},vgl.triangleStrip=function(){"use strict";return this instanceof vgl.triangleStrip?(vgl.primitive.call(this),this.setPrimitiveType(gl.TRIANGLE_STRIP),this.setIndicesValueType(gl.UNSIGNED_SHORT),this.setIndicesPerPrimitive(3),this):new vgl.triangleStrip},inherit(vgl.triangleStrip,vgl.primitive),vgl.triangles=function(){"use strict";return this instanceof vgl.triangles?(vgl.primitive.call(this),this.setPrimitiveType(gl.TRIANGLES),this.setIndicesValueType(gl.UNSIGNED_SHORT),this.setIndicesPerPrimitive(3),this):new vgl.triangles},inherit(vgl.triangles,vgl.primitive),vgl.lines=function(){"use strict";return this instanceof vgl.lines?(vgl.primitive.call(this),this.setPrimitiveType(gl.LINES),this.setIndicesValueType(gl.UNSIGNED_SHORT),this.setIndicesPerPrimitive(2),this):new vgl.lines},inherit(vgl.lines,vgl.primitive),vgl.lineStrip=function(){"use strict";return this instanceof vgl.lineStrip?(vgl.primitive.call(this),this.setPrimitiveType(gl.LINE_STRIP),this.setIndicesValueType(gl.UNSIGNED_SHORT),this.setIndicesPerPrimitive(2),this):new vgl.lineStrip},inherit(vgl.lineStrip,vgl.primitive),vgl.points=function(){"use strict";return this instanceof vgl.points?(vgl.primitive.call(this),this.setPrimitiveType(gl.POINTS),this.setIndicesValueType(gl.UNSIGNED_SHORT),this.setIndicesPerPrimitive(1),this):new vgl.points},inherit(vgl.points,vgl.primitive),vgl.vertexDataP3f=function(){"use strict";return this instanceof vgl.vertexDataP3f?(this.m_position=[],this):new vgl.vertexDataP3f},vgl.vertexDataP3N3f=function(){"use strict";return this instanceof vgl.vertexDataP3N3f?(this.m_position=[],this.m_normal=[],this):new vgl.vertexDataP3N3f},vgl.vertexDataP3T3f=function(){"use strict";return this instanceof vgl.vertexDataP3T3f?(this.m_position=[],this.m_texCoordinate=[],this):new vgl.vertexDataP3T3f},vgl.sourceData=function(){"use strict";if(!(this instanceof vgl.sourceData))return new vgl.sourceData;var m_attributesMap={},m_data=[],vglAttributeData=function(){this.m_numberOfComponents=0,this.m_dataType=0,this.m_dataTypeSize=0,this.m_normalized=!1,this.m_stride=0,this.m_offset=0};return this.data=function(){return m_data},this.getData=function(){return data()},this.setData=function(data){return data instanceof Array?void(m_data=data.slice(0)):void console.log("[error] Requires array")},this.addAttribute=function(key,dataType,sizeOfDataType,offset,stride,noOfComponents,normalized){if(!m_attributesMap.hasOwnProperty(key)){var newAttr=new vglAttributeData;newAttr.m_dataType=dataType,newAttr.m_dataTypeSize=sizeOfDataType,newAttr.m_offset=offset,newAttr.m_stride=stride,newAttr.m_numberOfComponents=noOfComponents,newAttr.m_normalized=normalized,m_attributesMap[key]=newAttr}},this.sizeOfArray=function(){return Object.size(m_data)},this.lengthOfArray=function(){return m_data.length},this.sizeInBytes=function(){var i,sizeInBytes=0,keys=this.keys();for(i=0;i<keys.length();++i)sizeInBytes+=this.numberOfComponents(keys[i])*this.sizeOfAttributeDataType(keys[i]);return sizeInBytes*=this.sizeOfArray()},this.hasKey=function(key){return m_attributesMap.hasOwnProperty(key)},this.keys=function(){return Object.keys(m_attributesMap)},this.numberOfAttributes=function(){return Object.size(m_attributesMap)},this.attributeNumberOfComponents=function(key){return m_attributesMap.hasOwnProperty(key)?m_attributesMap[key].m_numberOfComponents:0},this.normalized=function(key){return m_attributesMap.hasOwnProperty(key)?m_attributesMap[key].m_normalized:!1},this.sizeOfAttributeDataType=function(key){return m_attributesMap.hasOwnProperty(key)?m_attributesMap[key].m_dataTypeSize:0},this.attributeDataType=function(key){return m_attributesMap.hasOwnProperty(key)?m_attributesMap[key].m_dataType:void 0},this.attributeOffset=function(key){return m_attributesMap.hasOwnProperty(key)?m_attributesMap[key].m_offset:0},this.attributeStride=function(key){return m_attributesMap.hasOwnProperty(key)?m_attributesMap[key].m_stride:0},this.pushBack=function(){},this.insert=function(data){var i;if(data.length)for(i=0;i<data.length;i++)m_data[m_data.length]=data[i];else m_data[m_data.length]=data},this.insertAt=function(index,data){var i;if(data.length)for(i=0;i<data.length;i++)m_data[index*data.length+i]=data[i];else m_data[index]=data},this},vgl.sourceDataP3T3f=function(){"use strict";return this instanceof vgl.sourceDataP3T3f?(vgl.sourceData.call(this),this.addAttribute(vgl.vertexAttributeKeys.Position,gl.FLOAT,4,0,24,3,!1),this.addAttribute(vgl.vertexAttributeKeys.TextureCoordinate,gl.FLOAT,4,12,24,3,!1),this.pushBack=function(value){this.insert(value.m_position),this.insert(value.m_texCoordinate)},this):new vgl.sourceDataP3T3f},inherit(vgl.sourceDataP3T3f,vgl.sourceData),vgl.sourceDataP3N3f=function(){"use strict";return this instanceof vgl.sourceDataP3N3f?(vgl.sourceData.call(this),this.addAttribute(vgl.vertexAttributeKeys.Position,gl.FLOAT,4,0,24,3,!1),this.addAttribute(vgl.vertexAttributeKeys.Normal,gl.FLOAT,4,12,24,3,!1),this.pushBack=function(value){this.insert(value.m_position),this.insert(value.m_normal)},this):new vgl.sourceDataP3N3f},inherit(vgl.sourceDataP3N3f,vgl.sourceData),vgl.sourceDataP3fv=function(){"use strict";return this instanceof vgl.sourceDataP3fv?(vgl.sourceData.call(this),this.addAttribute(vgl.vertexAttributeKeys.Position,gl.FLOAT,4,0,12,3,!1),this.pushBack=function(value){this.insert(value)},this):new vgl.sourceDataP3fv},inherit(vgl.sourceDataP3fv,vgl.sourceData),vgl.sourceDataT2fv=function(){"use strict";return this instanceof vgl.sourceDataT2fv?(vgl.sourceData.call(this),this.addAttribute(vgl.vertexAttributeKeys.TextureCoordinate,gl.FLOAT,4,0,8,2,!1),this.pushBack=function(value){this.insert(value)},this):new vgl.sourceDataT2fv},inherit(vgl.sourceDataT2fv,vgl.sourceData),vgl.sourceDataC3fv=function(){"use strict";return this instanceof vgl.sourceDataC3fv?(vgl.sourceData.call(this),this.addAttribute(vgl.vertexAttributeKeys.Color,gl.FLOAT,4,0,12,3,!1),this.pushBack=function(value){this.insert(value)},this):new vgl.sourceDataC3fv},inherit(vgl.sourceDataC3fv,vgl.sourceData),vgl.sourceDataSf=function(){"use strict";if(!(this instanceof vgl.sourceDataSf))return new vgl.sourceDataSf;var m_min=null,m_max=null,m_fixedmin=null,m_fixedmax=null;return vgl.sourceData.call(this),this.addAttribute(vgl.vertexAttributeKeys.Scalar,gl.FLOAT,4,0,4,1,!1),this.pushBack=function(value){(null===m_max||value>m_max)&&(m_max=value),(null===m_min||m_min>value)&&(m_min=value),this.data()[this.data().length]=value},this.insertAt=function(index,value){(null===m_max||value>m_max)&&(m_max=value),(null===m_min||m_min>value)&&(m_min=value),this.data()[index]=value},this.scalarRange=function(){return null===m_fixedmin||null===m_fixedmax?[m_min,m_max]:[m_fixedmin,m_fixedmax]},this.setScalarRange=function(min,max){m_fixedmin=min,m_fixedmax=max},this},inherit(vgl.sourceDataSf,vgl.sourceData),vgl.sourceDataDf=function(){"use strict";if(!(this instanceof vgl.sourceDataDf))return new vgl.sourceDataDf;return vgl.sourceData.call(this),this.addAttribute(vgl.vertexAttributeKeys.Scalar,gl.FLOAT,4,0,4,1,!1),this.pushBack=function(value){this.data()[this.data().length]=value},this.insertAt=function(index,value){this.data()[index]=value},this},inherit(vgl.sourceDataDf,vgl.sourceData),vgl.geometryData=function(){"use strict";if(!(this instanceof vgl.geometryData))return vgl.geometryData();vgl.data.call(this);var m_name="",m_primitives=[],m_sources=[],m_bounds=[0,0,0,0,0,0],m_computeBoundsTimestamp=vgl.timestamp(),m_boundsDirtyTimestamp=vgl.timestamp();return this.type=function(){return vgl.data.geometry},this.name=function(){return m_name},this.setName=function(name){m_name=name},this.addSource=function(source){return-1===m_sources.indexOf(source)?(m_sources.push(source),source.hasKey(vgl.vertexAttributeKeys.Position)&&m_boundsDirtyTimestamp.modified(),!0):!1},this.source=function(index){return index<m_sources.length?m_sources[index]:0},this.numberOfSources=function(){return m_sources.length},this.sourceData=function(key){var i;for(i=0;i<m_sources.length;++i)if(m_sources[i].hasKey(key))return m_sources[i];return null},this.addPrimitive=function(primitive){return m_primitives.push(primitive),!0},this.primitive=function(index){return index<m_primitives.length?m_primitives[index]:null},this.numberOfPrimitives=function(){return m_primitives.length},this.bounds=function(){return m_boundsDirtyTimestamp.getMTime()>m_computeBoundsTimestamp.getMTime()&&this.computeBounds(),m_bounds},this.resetBounds=function(){m_bounds[0]=0,m_bounds[1]=0,m_bounds[2]=0,m_bounds[3]=0,m_bounds[4]=0,m_bounds[5]=0},this.setBounds=function(minX,maxX,minY,maxY,minZ,maxZ){return m_bounds[0]=minX,m_bounds[1]=maxX,m_bounds[2]=minY,m_bounds[3]=maxY,m_bounds[4]=minZ,m_bounds[5]=maxZ,m_computeBoundsTimestamp.modified(),!0},this.computeBounds=function(){if(m_boundsDirtyTimestamp.getMTime()>m_computeBoundsTimestamp.getMTime()){var vertexIndex,j,attr=vgl.vertexAttributeKeys.Position,sourceData=this.sourceData(attr),data=sourceData.data(),numberOfComponents=sourceData.attributeNumberOfComponents(attr),stride=sourceData.attributeStride(attr),offset=sourceData.attributeOffset(attr),sizeOfDataType=sourceData.sizeOfAttributeDataType(attr),count=data.length,ib=0,jb=0,value=null;for(stride/=sizeOfDataType,offset/=sizeOfDataType,this.resetBounds(),vertexIndex=offset;count>vertexIndex;vertexIndex+=stride)for(j=0;numberOfComponents>j;++j)value=data[vertexIndex+j],ib=2*j,jb=2*j+1,vertexIndex===offset?(m_bounds[ib]=value,m_bounds[jb]=value):(value>m_bounds[jb]&&(m_bounds[jb]=value),value<m_bounds[ib]&&(m_bounds[ib]=value));m_computeBoundsTimestamp.modified()}},this.findClosestVertex=function(point){var vi,vPos,dx,dy,dz,dist,i,attr=vgl.vertexAttributeKeys.Position,sourceData=this.sourceData(attr),sizeOfDataType=sourceData.sizeOfAttributeDataType(attr),numberOfComponents=sourceData.attributeNumberOfComponents(attr),data=sourceData.data(),stride=sourceData.attributeStride(attr)/sizeOfDataType,offset=sourceData.attributeOffset(attr)/sizeOfDataType,minDist=Number.MAX_VALUE,minIndex=null;for(3!==numberOfComponents&&console.log("[warning] Find closest vertex assumes threecomponent vertex "),point.z||(point={x:point.x,y:point.y,z:0}),vi=offset,i=0;vi<data.length;vi+=stride,i++)vPos=[data[vi],data[vi+1],data[vi+2]],dx=vPos[0]-point.x,dy=vPos[1]-point.y,dz=vPos[2]-point.z,dist=Math.sqrt(dx*dx+dy*dy+dz*dz),minDist>dist&&(minDist=dist,minIndex=i);return minIndex},this.getPosition=function(index){var attr=vgl.vertexAttributeKeys.Position,sourceData=this.sourceData(attr),sizeOfDataType=sourceData.sizeOfAttributeDataType(attr),numberOfComponents=sourceData.attributeNumberOfComponents(attr),data=sourceData.data(),stride=sourceData.attributeStride(attr)/sizeOfDataType,offset=sourceData.attributeOffset(attr)/sizeOfDataType;return 3!==numberOfComponents&&console.log("[warning] getPosition assumes three component data"),[data[offset+index*stride],data[offset+index*stride+1],data[offset+index*stride+2]]},this.getScalar=function(index){var numberOfComponents,sizeOfDataType,data,stride,offset,attr=vgl.vertexAttributeKeys.Scalar,sourceData=this.sourceData(attr);return sourceData?(numberOfComponents=sourceData.attributeNumberOfComponents(attr),sizeOfDataType=sourceData.sizeOfAttributeDataType(attr),data=sourceData.data(),stride=sourceData.attributeStride(attr)/sizeOfDataType,offset=sourceData.attributeOffset(attr)/sizeOfDataType,index*stride+offset>=data.length&&console.log("access out of bounds in getScalar"),data[index*stride+offset]):null},this},inherit(vgl.geometryData,vgl.data),vgl.mapper=function(){"use strict";function deleteVertexBufferObjects(){var i;for(i=0;i<m_buffers.length;++i)gl.deleteBuffer(m_buffers[i])}function createVertexBufferObjects(){if(m_geomData){var i,j,k,keys,ks,numberOfPrimitives,numberOfSources=m_geomData.numberOfSources(),bufferId=null;for(i=0;numberOfSources>i;++i){for(bufferId=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,bufferId),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(m_geomData.source(i).data()),gl.STATIC_DRAW),keys=m_geomData.source(i).keys(),ks=[],j=0;j<keys.length;++j)ks.push(keys[j]);m_bufferVertexAttributeMap[i]=ks,m_buffers[i]=bufferId}for(numberOfPrimitives=m_geomData.numberOfPrimitives(),k=0;numberOfPrimitives>k;++k)bufferId=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,bufferId),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,m_geomData.primitive(k).indices(),gl.STATIC_DRAW),m_buffers[i++]=bufferId;m_glCompileTimestamp.modified()}}function cleanUpDrawObjects(){m_bufferVertexAttributeMap={},m_buffers=[]}function setupDrawObjects(){deleteVertexBufferObjects(),cleanUpDrawObjects(),createVertexBufferObjects(),m_dirty=!1}if(!(this instanceof vgl.mapper))return new vgl.mapper;vgl.boundingObject.call(this);var m_dirty=!0,m_color=[0,1,1],m_geomData=null,m_buffers=[],m_bufferVertexAttributeMap={},m_glCompileTimestamp=vgl.timestamp();return this.computeBounds=function(){if(null===m_geomData||"undefined"==typeof m_geomData)return void this.resetBounds();var computeBoundsTimestamp=this.computeBoundsTimestamp(),boundsDirtyTimestamp=this.boundsDirtyTimestamp(),geomBounds=null;boundsDirtyTimestamp.getMTime()>computeBoundsTimestamp.getMTime()&&(geomBounds=m_geomData.bounds(),this.setBounds(geomBounds[0],geomBounds[1],geomBounds[2],geomBounds[3],geomBounds[4],geomBounds[5]),computeBoundsTimestamp.modified())},this.color=function(){return m_color},this.setColor=function(r,g,b){m_color[0]=r,m_color[1]=g,m_color[2]=b,this.modified()},this.geometryData=function(){return m_geomData},this.setGeometryData=function(geom){m_geomData!==geom&&(m_geomData=geom,this.modified(),this.boundsDirtyTimestamp().modified())},this.render=function(renderState){this.getMTime()>m_glCompileTimestamp.getMTime()&&setupDrawObjects(renderState),gl.vertexAttrib3fv(vgl.vertexAttributeKeys.Color,this.color());var i,bufferIndex=0,j=0,noOfPrimitives=null,primitive=null;for(i in m_bufferVertexAttributeMap)if(m_bufferVertexAttributeMap.hasOwnProperty(i)){for(gl.bindBuffer(gl.ARRAY_BUFFER,m_buffers[bufferIndex]),j=0;j<m_bufferVertexAttributeMap[i].length;++j)renderState.m_material.bindVertexData(renderState,m_bufferVertexAttributeMap[i][j]);++bufferIndex
}for(noOfPrimitives=m_geomData.numberOfPrimitives(),j=0;noOfPrimitives>j;++j)gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,m_buffers[bufferIndex++]),primitive=m_geomData.primitive(j),gl.drawElements(primitive.primitiveType(),primitive.numberOfIndices(),primitive.indicesValueType(),0)},this},inherit(vgl.mapper,vgl.boundingObject),vgl.groupMapper=function(){"use strict";if(!(this instanceof vgl.groupMapper))return new vgl.groupMapper;vgl.mapper.call(this);var m_createMappersTimestamp=vgl.timestamp(),m_mappers=[],m_geomDataArray=[];return this.geometryData=function(index){return void 0!==index&&index<m_geomDataArray.length?m_geomDataArray[index]:m_geomDataArray.length>0?m_geomDataArray[0]:null},this.setGeometryData=function(geom){(1!==m_geomDataArray.length||m_geomDataArray[0]!==geom)&&(m_geomDataArray=[],m_geomDataArray.push(geom),this.modified())},this.geometryDataArray=function(){return m_geomDataArray},this.setGeometryDataArray=function(geoms){if(geoms instanceof Array){if(m_geomDataArray!==geoms)return m_geomDataArray=[],m_geomDataArray=geoms,this.modified(),!0}else console.log("[error] Requies array of geometry data");return!1},this.computeBounds=function(){if(null===m_geomDataArray||void 0===m_geomDataArray)return void this.resetBounds();var computeBoundsTimestamp=this.computeBoundsTimestamp(),boundsDirtyTimestamp=this.boundsDirtyTimestamp(),m_bounds=this.bounds(),geomBounds=null,i=null;if(boundsDirtyTimestamp.getMTime()>computeBoundsTimestamp.getMTime()){for(i=0;i<m_geomDataArray.length;++i)geomBounds=m_geomDataArray[i].bounds(),m_bounds[0]>geomBounds[0]&&(m_bounds[0]=geomBounds[0]),m_bounds[1]<geomBounds[1]&&(m_bounds[1]=geomBounds[1]),m_bounds[2]>geomBounds[2]&&(m_bounds[2]=geomBounds[2]),m_bounds[3]<geomBounds[3]&&(m_bounds[3]=geomBounds[3]),m_bounds[4]>geomBounds[4]&&(m_bounds[4]=geomBounds[4]),m_bounds[5]<geomBounds[5]&&(m_bounds[5]=geomBounds[5]);this.modified(),computeBoundsTimestamp.modified()}},this.render=function(renderState){var i=null;if(this.getMTime()>m_createMappersTimestamp.getMTime()){for(i=0;i<m_geomDataArray.length;++i)m_mappers.push(vgl.mapper()),m_mappers[i].setGeometryData(m_geomDataArray[i]);m_createMappersTimestamp.modified()}for(i=0;i<m_mappers.length;++i)m_mappers[i].render(renderState)},this},inherit(vgl.groupMapper,vgl.mapper),vgl.materialAttributeType={Undefined:0,ShaderProgram:1,Texture:2,Blend:3,Depth:4},vgl.materialAttribute=function(type){"use strict";if(!(this instanceof vgl.materialAttribute))return new vgl.materialAttribute;vgl.object.call(this);var m_type=type,m_enabled=!0;return this.type=function(){return m_type},this.enabled=function(){return m_enabled},this.setup=function(){return!1},this.bind=function(){return!1},this.undoBind=function(){return!1},this.setupVertexData=function(){return!1},this.bindVertexData=function(){return!1},this.undoBindVertexData=function(){return!1},this},inherit(vgl.materialAttribute,vgl.object),vgl.blendFunction=function(source,destination){"use strict";if(!(this instanceof vgl.blendFunction))return new vgl.blendFunction(source,destination);var m_source=source,m_destination=destination;return this.apply=function(){gl.blendFuncSeparate(m_source,m_destination,gl.ONE,gl.ONE_MINUS_SRC_ALPHA)},this},vgl.blend=function(){"use strict";if(!(this instanceof vgl.blend))return new vgl.blend;vgl.materialAttribute.call(this,vgl.materialAttributeType.Blend);var m_wasEnabled=!1,m_blendFunction=vgl.blendFunction(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);return this.bind=function(renderState){return m_wasEnabled=gl.isEnabled(gl.BLEND),this.enabled()?(gl.enable(gl.BLEND),m_blendFunction.apply(renderState)):gl.disable(gl.BLEND),!0},this.undoBind=function(){return m_wasEnabled?gl.enable(gl.BLEND):gl.disable(gl.BLEND),!0},this},inherit(vgl.blend,vgl.materialAttribute),vgl.material=function(){"use strict";if(!(this instanceof vgl.material))return new vgl.material;vgl.object.call(this);var m_shaderProgram=new vgl.shaderProgram,m_binNumber=100,m_textureAttributes={},m_attributes={};return this.binNumber=function(){return m_binNumber},this.setBinNumber=function(binNo){m_binNumber=binNo,this.modified()},this.exists=function(attr){return attr.type()===vgl.materialAttribute.Texture?m_textureAttributes.hasOwnProperty(attr):m_attributes.hasOwnProperty(attr)},this.uniform=function(name){return m_shaderProgram?m_shaderProgram.uniform(name):null},this.attribute=function(name){return m_attributes.hasOwnProperty(name)?m_attributes[name]:m_textureAttributes.hasOwnProperty(name)?m_textureAttributes[name]:null},this.setAttribute=function(attr){return attr.type()===vgl.materialAttributeType.Texture&&m_textureAttributes[attr.textureUnit()]!==attr?(m_textureAttributes[attr.textureUnit()]=attr,this.modified(),!0):m_attributes[attr.type()]===attr?!1:(attr.type()===vgl.materialAttributeType.ShaderProgram&&(m_shaderProgram=attr),m_attributes[attr.type()]=attr,this.modified(),!0)},this.addAttribute=function(attr){return this.exists(attr)?!1:attr.type()===vgl.materialAttributeType.Texture?(m_textureAttributes[attr.textureUnit()]=attr,this.modified(),!0):(attr.type()===vgl.materialAttributeType.ShaderProgram&&(m_shaderProgram=attr),m_attributes[attr.type()]=attr,this.modified(),!0)},this.shaderProgram=function(){return m_shaderProgram},this.render=function(renderState){this.bind(renderState)},this.remove=function(renderState){this.undoBind(renderState)},this.bind=function(renderState){var key=null;for(key in m_attributes)m_attributes.hasOwnProperty(key)&&m_attributes[key].bind(renderState);for(key in m_textureAttributes)m_textureAttributes.hasOwnProperty(key)&&m_textureAttributes[key].bind(renderState)},this.undoBind=function(renderState){var key=null;for(key in m_attributes)m_attributes.hasOwnProperty(key)&&m_attributes[key].undoBind(renderState);for(key in m_textureAttributes)m_textureAttributes.hasOwnProperty(key)&&m_textureAttributes[key].undoBind(renderState)},this.bindVertexData=function(renderState,key){var i=null;for(i in m_attributes)m_attributes.hasOwnProperty(i)&&m_attributes[i].bindVertexData(renderState,key)},this.undoBindVertexData=function(renderState,key){var i=null;for(i in m_attributes)m_attributes.hasOwnProperty(i)&&m_attributes.undoBindVertexData(renderState,key)},this},vgl.material.RenderBin={Base:0,Default:100,Opaque:100,Transparent:1e3,Overlay:1e4},inherit(vgl.material,vgl.object),vgl.renderState=function(){"use strict";this.m_modelViewMatrix=mat4.create(),this.m_normalMatrix=mat4.create(),this.m_projectionMatrix=null,this.m_material=null,this.m_mapper=null},vgl.renderer=function(){"use strict";if(!(this instanceof vgl.renderer))return new vgl.renderer;vgl.object.call(this);var m_sceneRoot=new vgl.groupNode,m_camera=new vgl.camera,m_nearClippingPlaneTolerance=null,m_x=0,m_y=0,m_width=0,m_height=0,m_resizable=!0,m_resetScene=!0,m_layer=0,m_resetClippingRange=!0;return m_camera.addChild(m_sceneRoot),this.width=function(){return m_width},this.height=function(){return m_height},this.layer=function(){return m_layer},this.setLayer=function(layerNo){m_layer=layerNo,this.modified()},this.isResizable=function(){return m_resizable},this.setResizable=function(r){m_resizable=r},this.backgroundColor=function(){return m_camera.clearColor()},this.setBackgroundColor=function(r,g,b,a){m_camera.setClearColor(r,g,b,a),this.modified()},this.sceneRoot=function(){return m_sceneRoot},this.camera=function(){return m_camera},this.render=function(){var i,renSt,children,actor=null,sortedActors=[],mvMatrixInv=mat4.create(),clearColor=null;for(gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL),m_camera.clearMask()&vgl.GL.ColorBufferBit&&(clearColor=m_camera.clearColor(),gl.clearColor(clearColor[0],clearColor[1],clearColor[2],clearColor[3])),m_camera.clearMask()&vgl.GL.DepthBufferBit&&gl.clearDepth(m_camera.clearDepth()),gl.clear(m_camera.clearMask()),gl.viewport(m_x,m_y,m_width,m_height),renSt=new vgl.renderState,children=m_sceneRoot.children(),children.length>0&&m_resetScene&&(this.resetCamera(),m_resetScene=!1),i=0;i<children.length;++i)actor=children[i],actor.computeBounds(),actor.visible()&&sortedActors.push([actor.material().binNumber(),actor]);for(sortedActors.sort(function(a,b){return a[0]-b[0]}),i=0;i<sortedActors.length;++i)actor=sortedActors[i][1],actor.referenceFrame()===vgl.boundingObject.ReferenceFrame.Relative?(mat4.multiply(renSt.m_modelViewMatrix,m_camera.viewMatrix(),actor.matrix()),renSt.m_projectionMatrix=m_camera.projectionMatrix()):(renSt.m_modelViewMatrix=actor.matrix(),renSt.m_projectionMatrix=mat4.create(),mat4.ortho(renSt.m_projectionMatrix,0,m_width,0,m_height,-1,1)),mat4.invert(mvMatrixInv,renSt.m_modelViewMatrix),mat4.transpose(renSt.m_normalMatrix,mvMatrixInv),renSt.m_material=actor.material(),renSt.m_mapper=actor.mapper(),renSt.m_material.render(renSt),renSt.m_mapper.render(renSt),renSt.m_material.remove(renSt)},this.resetCamera=function(){m_camera.computeBounds();var vn=m_camera.directionOfProjection(),visibleBounds=m_camera.bounds(),center=[(visibleBounds[0]+visibleBounds[1])/2,(visibleBounds[2]+visibleBounds[3])/2,(visibleBounds[4]+visibleBounds[5])/2],diagonals=[visibleBounds[1]-visibleBounds[0],visibleBounds[3]-visibleBounds[2],visibleBounds[5]-visibleBounds[4]],radius=0,aspect=m_camera.viewAspect(),angle=m_camera.viewAngle(),distance=null,vup=null;radius=diagonals[0]>diagonals[1]?diagonals[0]>diagonals[2]?diagonals[0]/2:diagonals[2]/2:diagonals[1]>diagonals[2]?diagonals[1]/2:diagonals[2]/2,angle=aspect>=1?2*Math.atan(Math.tan(.5*angle)/aspect):2*Math.atan(Math.tan(.5*angle)*aspect),distance=radius/Math.sin(.5*angle),vup=m_camera.viewUpDirection(),Math.abs(vec3.dot(vup,vn))>.999&&m_camera.setViewUpDirection(-vup[2],vup[0],vup[1]),m_camera.setFocalPoint(center[0],center[1],center[2]),m_camera.setPosition(center[0]+distance*-vn[0],center[1]+distance*-vn[1],center[2]+distance*-vn[2]),this.resetCameraClippingRange(visibleBounds)},this.hasValidBounds=function(bounds){return bounds[0]==Number.MAX_VALUE||bounds[1]==-Number.MAX_VALUE||bounds[2]==Number.MAX_VALUE||bounds[3]==-Number.MAX_VALUE||bounds[4]==Number.MAX_VALUE||bounds[5]==-Number.MAX_VALUE?!1:!0},this.resetCameraClippingRange=function(bounds){if("undefined"==typeof bounds&&(m_camera.computeBounds(),bounds=m_camera.bounds()),this.hasValidBounds(bounds)){var vn=m_camera.viewPlaneNormal(),position=m_camera.position(),a=-vn[0],b=-vn[1],c=-vn[2],d=-(a*position[0]+b*position[1]+c*position[2]),range=vec2.create(),dist=null,i=null,j=null,k=null;if(m_resetClippingRange){for(range[0]=a*bounds[0]+b*bounds[2]+c*bounds[4]+d,range[1]=1e-18,k=0;2>k;k++)for(j=0;2>j;j++)for(i=0;2>i;i++)dist=a*bounds[i]+b*bounds[2+j]+c*bounds[4+k]+d,range[0]=dist<range[0]?dist:range[0],range[1]=dist>range[1]?dist:range[1];range[0]<0&&(range[0]=0),range[0]=.99*range[0]-.5*(range[1]-range[0]),range[1]=1.01*range[1]+.5*(range[1]-range[0]),range[0]=range[0]>=range[1]?.01*range[1]:range[0],m_nearClippingPlaneTolerance||(m_nearClippingPlaneTolerance=.01,null!==gl&&gl.getParameter(gl.DEPTH_BITS)>16&&(m_nearClippingPlaneTolerance=.001)),range[0]<m_nearClippingPlaneTolerance*range[1]&&(range[0]=m_nearClippingPlaneTolerance*range[1]),m_camera.setClippingRange(range[0],range[1])}}},this.resize=function(width,height){this.positionAndResize(m_x,m_y,width,height)},this.positionAndResize=function(x,y,width,height){(0>x||0>y||0>width||0>height)&&console.log("[error] Invalid position and resize values",x,y,width,height),m_resizable&&(m_width=width,m_height=height,m_camera.setViewAspect(m_width/m_height),this.modified())},this.addActor=function(actor){return actor instanceof vgl.actor?(m_sceneRoot.addChild(actor),this.modified(),!0):!1},this.hasActor=function(actor){return m_sceneRoot.hasChild(actor)},this.addActors=function(actors){var i=null;if(actors instanceof Array){for(i=0;i<actors.length;++i)m_sceneRoot.addChild(actors[i]);this.modified()}},this.removeActor=function(actor){return-1!==m_sceneRoot.children().indexOf(actor)?(m_sceneRoot.removeChild(actor),this.modified(),!0):!1},this.removeActors=function(actors){if(!(actors instanceof Array))return!1;var i;for(i=0;i<actors.length;++i)m_sceneRoot.removeChild(actors[i]);return this.modified(),!0},this.removeAllActors=function(){return m_sceneRoot.removeChildren()},this.worldToDisplay=function(worldPt,viewMatrix,projectionMatrix,width,height){var viewProjectionMatrix=mat4.create(),winX=null,winY=null,winZ=null,winW=null,clipPt=null;return mat4.multiply(viewProjectionMatrix,projectionMatrix,viewMatrix),clipPt=vec4.create(),vec4.transformMat4(clipPt,worldPt,viewProjectionMatrix),0!==clipPt[3]&&(clipPt[0]=clipPt[0]/clipPt[3],clipPt[1]=clipPt[1]/clipPt[3],clipPt[2]=clipPt[2]/clipPt[3],clipPt[3]=1),winX=(clipPt[0]+1)/2*width,winY=(1-clipPt[1])/2*height,winZ=clipPt[2],winW=clipPt[3],vec4.fromValues(winX,winY,winZ,winW)},this.displayToWorld=function(displayPt,viewMatrix,projectionMatrix,width,height){var x=2*displayPt[0]/width-1,y=-(2*displayPt[1]/height)+1,z=displayPt[2],viewProjectionInverse=mat4.create(),worldPt=null;return mat4.multiply(viewProjectionInverse,projectionMatrix,viewMatrix),mat4.invert(viewProjectionInverse,viewProjectionInverse),worldPt=vec4.fromValues(x,y,z,1),vec4.transformMat4(worldPt,worldPt,viewProjectionInverse),0!==worldPt[3]&&(worldPt[0]=worldPt[0]/worldPt[3],worldPt[1]=worldPt[1]/worldPt[3],worldPt[2]=worldPt[2]/worldPt[3],worldPt[3]=1),worldPt},this.focusDisplayPoint=function(){var focalPoint=m_camera.focalPoint(),focusWorldPt=vec4.fromValues(focalPoint[0],focalPoint[1],focalPoint[2],1);return this.worldToDisplay(focusWorldPt,m_camera.viewMatrix(),m_camera.projectionMatrix(),m_width,m_height)},this.resetScene=function(){return m_resetScene},this.setResetScene=function(reset){m_resetScene!==reset&&(m_resetScene=reset,this.modified())},this.resetClippingRange=function(){return m_resetClippingRange},this.setResetClippingRange=function(reset){m_resetClippingRange!==reset&&(m_resetClippingRange=reset,this.modified())},this},inherit(vgl.renderer,vgl.object);var gl=null;vgl.renderWindow=function(canvas){"use strict";if(!(this instanceof vgl.renderWindow))return new vgl.renderWindow(canvas);vgl.object.call(this);var m_x=0,m_y=0,m_width=400,m_height=400,m_canvas=canvas,m_activeRender=null,m_renderers=[];return this.windowSize=function(){return[m_width,m_height]},this.setWindowSize=function(width,height){return m_width!==width||m_height!==height?(m_width=width,m_height=height,this.modified(),!0):!1},this.windowPosition=function(){return[m_x,m_y]},this.setWindowPosition=function(x,y){return m_x!==x||m_y!==y?(m_x=x,m_y=y,this.modified(),!0):!1},this.renderers=function(){return m_renderers},this.activeRenderer=function(){return m_activeRender},this.addRenderer=function(ren){return this.hasRenderer(ren)===!1?(m_renderers.push(ren),null===m_activeRender&&(m_activeRender=ren),0!==ren.layer()&&ren.camera().setClearMask(vgl.GL.DepthBufferBit),this.modified(),!0):!1},this.removeRenderer=function(ren){var index=m_renderers.indexOf(ren);return-1!==index?(m_activeRender===ren&&(m_activeRender=null),m_renderers.splice(index,1),this.modified(),!0):!1},this.getRenderer=function(index){return index<m_renderers.length?m_renderers[index]:(console.log("[WARNING] Out of index array"),null)},this.hasRenderer=function(ren){var i;for(i=0;i<m_renderers.length;++i)if(ren===m_renderers[i])return!0;return!1},this.resize=function(width,height){this.positionAndResize(m_x,m_y,width,height),this.modified()},this.positionAndResize=function(x,y,width,height){m_x=x,m_y=y,m_width=width,m_height=height;var i;for(i=0;i<m_renderers.length;++i)m_renderers[i].positionAndResize(m_x,m_y,m_width,m_height);this.modified()},this.createWindow=function(){gl=null;try{gl=m_canvas.getContext("webgl")||m_canvas.getContext("experimental-webgl");var i;for(i=0;i<m_renderers.length;++i)(m_renderers[i].width()>m_width||0===m_renderers[i].width()||m_renderers[i].height()>m_height||0===m_renderers[i].height())&&m_renderers[i].resize(m_x,m_y,m_width,m_height);return!0}catch(e){}return gl||console("[ERROR] Unable to initialize WebGL. Your browser may not support it."),!1},this.deleteWindow=function(){},this.render=function(){var i;for(m_renderers.sort(function(a,b){return a.layer()-b.layer()}),i=0;i<m_renderers.length;++i)m_renderers[i].render()},this.focusDisplayPoint=function(){return m_activeRender.focusDisplayPoint()},this.displayToWorld=function(x,y,focusDisplayPoint,ren){ren=void 0===ren?ren=m_activeRender:ren;var camera=ren.camera();return focusDisplayPoint||(focusDisplayPoint=ren.focusDisplayPoint()),ren.displayToWorld(vec4.fromValues(x,y,focusDisplayPoint[2],1),camera.viewMatrix(),camera.projectionMatrix(),m_width,m_height)},this.worldToDisplay=function(x,y,z,ren){ren=void 0===ren?ren=m_activeRender:ren;var camera=ren.camera();return ren.worldToDisplay(vec4.fromValues(x,y,z,1),camera.viewMatrix(),camera.projectionMatrix(),m_width,m_height)},this},inherit(vgl.renderWindow,vgl.object),vgl.camera=function(){"use strict";if(!(this instanceof vgl.camera))return new vgl.camera;vgl.groupNode.call(this);var m_viewAngle=30*Math.PI/180,m_position=vec4.fromValues(0,0,1,1),m_focalPoint=vec4.fromValues(0,0,0,1),m_centerOfRotation=vec3.fromValues(0,0,0),m_viewUp=vec4.fromValues(0,1,0,0),m_rightDir=vec4.fromValues(1,0,0,0),m_near=.01,m_far=1e4,m_viewAspect=1,m_directionOfProjection=vec4.fromValues(0,0,-1,0),m_viewPlaneNormal=vec4.fromValues(0,0,1,0),m_viewMatrix=mat4.create(),m_projectionMatrix=mat4.create(),m_computeModelViewMatrixTime=vgl.timestamp(),m_computeProjectMatrixTime=vgl.timestamp(),m_left=-1,m_right=1,m_top=1,m_bottom=-1,m_enableTranslation=!0,m_enableRotation=!0,m_enableScale=!0,m_enableParallelProjection=!1,m_clearColor=[1,1,1,1],m_clearDepth=1,m_clearMask=vgl.GL.ColorBufferBit|vgl.GL.DepthBufferBit;return this.viewAngle=function(){return m_viewAngle},this.setViewAngleDegrees=function(a){m_viewAngle=Math.PI*a/180,this.modified()},this.setViewAngle=function(a){m_enableScale&&(m_viewAngle=a,this.modified())},this.position=function(){return m_position},this.setPosition=function(x,y,z){m_enableTranslation&&(m_position=vec4.fromValues(x,y,z,1),this.modified())},this.focalPoint=function(){return m_focalPoint},this.setFocalPoint=function(x,y,z){m_enableRotation&&m_enableTranslation&&(m_focalPoint=vec4.fromValues(x,y,z,1),this.modified())},this.viewUpDirection=function(){return m_viewUp},this.setViewUpDirection=function(x,y,z){m_viewUp=vec4.fromValues(x,y,z,0),this.modified()},this.centerOfRotation=function(){return m_centerOfRotation},this.setCenterOfRotation=function(centerOfRotation){m_centerOfRotation=centerOfRotation,this.modified()},this.clippingRange=function(){return[m_near,m_far]},this.setClippingRange=function(near,far){m_near=near,m_far=far,this.modified()},this.viewAspect=function(){return m_viewAspect},this.setViewAspect=function(aspect){m_viewAspect=aspect,this.modified()},this.enableScale=function(){return m_enableScale},this.setEnableScale=function(flag){return flag!==m_enableScale?(m_enableScale=flag,this.modified(),!0):m_enableScale},this.enableRotation=function(){return m_enableRotation},this.setEnableRotation=function(flag){return flag!==m_enableRotation?(m_enableRotation=flag,this.modified(),!0):m_enableRotation},this.enableTranslation=function(){return m_enableTranslation},this.setEnableTranslation=function(flag){return flag!==m_enableTranslation?(m_enableTranslation=flag,this.modified(),!0):m_enableTranslation},this.isEnabledParallelProjection=function(){return m_enableParallelProjection},this.enableParallelProjection=function(flag){return flag!==m_enableParallelProjection?(m_enableParallelProjection=flag,this.modified(),!0):m_enableParallelProjection},this.setEnnableParallelProjection=function(){return enableParallelProjection()},this.setParallelProjection=function(left,right,top,bottom){m_left=left,m_right=right,m_top=top,m_bottom=bottom,this.modified()},this.directionOfProjection=function(){return this.computeDirectionOfProjection(),m_directionOfProjection},this.viewPlaneNormal=function(){return this.computeViewPlaneNormal(),m_viewPlaneNormal},this.viewMatrix=function(){return this.computeViewMatrix()},this.projectionMatrix=function(){return this.computeProjectionMatrix()},this.clearMask=function(){return m_clearMask},this.setClearMask=function(mask){m_clearMask=mask,this.modified()},this.clearColor=function(){return m_clearColor},this.setClearColor=function(r,g,b,a){m_clearColor[0]=r,m_clearColor[1]=g,m_clearColor[2]=b,m_clearColor[3]=a,this.modified()},this.clearDepth=function(){return m_clearDepth},this.setClearDepth=function(depth){m_clearDepth=depth,this.modified()},this.computeDirectionOfProjection=function(){vec3.subtract(m_directionOfProjection,m_focalPoint,m_position),vec3.normalize(m_directionOfProjection,m_directionOfProjection),this.modified()},this.computeViewPlaneNormal=function(){m_viewPlaneNormal[0]=-m_directionOfProjection[0],m_viewPlaneNormal[1]=-m_directionOfProjection[1],m_viewPlaneNormal[2]=-m_directionOfProjection[2]},this.zoom=function(d,dir){0!==d&&m_enableTranslation&&(d*=vec3.distance(m_focalPoint,m_position),dir?(m_position[0]=m_position[0]+d*dir[0],m_position[1]=m_position[1]+d*dir[1],m_position[2]=m_position[2]+d*dir[2]):(dir=m_directionOfProjection,m_position[0]=m_focalPoint[0]-d*dir[0],m_position[1]=m_focalPoint[1]-d*dir[1],m_position[2]=m_focalPoint[2]-d*dir[2]),this.modified())},this.pan=function(dx,dy,dz){m_enableTranslation&&(m_position[0]+=dx,m_position[1]+=dy,m_position[2]+=dz,m_focalPoint[0]+=dx,m_focalPoint[1]+=dy,m_focalPoint[2]+=dz,this.modified())},this.computeOrthogonalAxes=function(){this.computeDirectionOfProjection(),vec3.cross(m_rightDir,m_directionOfProjection,m_viewUp),vec3.normalize(m_rightDir,m_rightDir),this.modified()},this.rotate=function(dx,dy){if(m_enableRotation){dx=.5*dx*(Math.PI/180),dy=.5*dy*(Math.PI/180);var mat=mat4.create(),inverseCenterOfRotation=new vec3.create;mat4.identity(mat),inverseCenterOfRotation[0]=-m_centerOfRotation[0],inverseCenterOfRotation[1]=-m_centerOfRotation[1],inverseCenterOfRotation[2]=-m_centerOfRotation[2],mat4.translate(mat,mat,m_centerOfRotation),mat4.rotate(mat,mat,dx,m_viewUp),mat4.rotate(mat,mat,dy,m_rightDir),mat4.translate(mat,mat,inverseCenterOfRotation),vec4.transformMat4(m_position,m_position,mat),vec4.transformMat4(m_focalPoint,m_focalPoint,mat),vec4.transformMat4(m_viewUp,m_viewUp,mat),vec4.normalize(m_viewUp,m_viewUp),this.computeOrthogonalAxes(),this.modified()}},this.computeViewMatrix=function(){return m_computeModelViewMatrixTime.getMTime()<this.getMTime()&&(mat4.lookAt(m_viewMatrix,m_position,m_focalPoint,m_viewUp),m_computeModelViewMatrixTime.modified()),m_viewMatrix},this.computeProjectionMatrix=function(){return m_computeProjectMatrixTime.getMTime()<this.getMTime()&&(m_enableParallelProjection?(console.log("paralle projection"),mat4.ortho(m_projectionMatrix,m_left,m_right,m_bottom,m_top,m_near,m_far)):mat4.perspective(m_projectionMatrix,m_viewAngle,m_viewAspect,m_near,m_far),m_computeProjectMatrixTime.modified()),m_projectionMatrix},this.computeDirectionOfProjection(),this},inherit(vgl.camera,vgl.groupNode),vgl.interactorStyle=function(){"use strict";if(!(this instanceof vgl.interactorStyle))return new vgl.interactorStyle;vgl.object.call(this);var m_that=this,m_viewer=null;return this.viewer=function(){return m_viewer},this.setViewer=function(viewer){viewer!==m_viewer&&(m_viewer=viewer,$(m_viewer).on(vgl.event.mousePress,m_that.handleMouseDown),$(m_viewer).on(vgl.event.mouseRelease,m_that.handleMouseUp),$(m_viewer).on(vgl.event.mouseMove,m_that.handleMouseMove),$(m_viewer).on(vgl.event.mouseOut,m_that.handleMouseOut),$(m_viewer).on(vgl.event.mouseWheel,m_that.handleMouseWheel),$(m_viewer).on(vgl.event.keyPress,m_that.handleKeyPress),$(m_viewer).on(vgl.event.mouseContextMenu,m_that.handleContextMenu),$(m_viewer).on(vgl.event.click,m_that.handleClick),$(m_viewer).on(vgl.event.dblClick,m_that.handleDoubleClick),this.modified())},this.handleMouseDown=function(){return!0},this.handleMouseUp=function(){return!0},this.handleMouseMove=function(){return!0},this.handleMouseOut=function(){return!0},this.handleMouseWheel=function(){return!0},this.handleClick=function(){return!0},this.handleDoubleClick=function(){return!0},this.handleKeyPress=function(){return!0},this.handleContextMenu=function(){return!0},this.reset=function(){return!0},this},inherit(vgl.interactorStyle,vgl.object),vgl.trackballInteractorStyle=function(){"use strict";if(!(this instanceof vgl.trackballInteractorStyle))return new vgl.trackballInteractorStyle;vgl.interactorStyle.call(this);var m_outsideCanvas,m_that=this,m_leftMouseBtnDown=!1,m_rightMouseBtnDown=!1,m_midMouseBtnDown=!1,m_currPos={x:0,y:0},m_lastPos={x:0,y:0};return this.handleMouseMove=function(event){var fp,fdp,fwp,dp1,dp2,wp1,wp2,coords,dx,dy,dz,coords,m_zTrans,width=(m_that.viewer().canvas(),m_that.viewer().renderWindow().windowSize()[0]),height=m_that.viewer().renderWindow().windowSize()[1],ren=m_that.viewer().renderWindow().activeRenderer(),cam=ren.camera(),coords=m_that.viewer().relMouseCoords(event);return m_outsideCanvas=!1,m_currPos={x:0,y:0},coords.x<0||coords.x>width?(m_currPos.x=0,m_outsideCanvas=!0):m_currPos.x=coords.x,coords.y<0||coords.y>height?(m_currPos.y=0,m_outsideCanvas=!0):m_currPos.y=coords.y,m_outsideCanvas!==!0?(fp=cam.focalPoint(),fwp=vec4.fromValues(fp[0],fp[1],fp[2],1),fdp=ren.worldToDisplay(fwp,cam.viewMatrix(),cam.projectionMatrix(),width,height),dp1=vec4.fromValues(m_currPos.x,m_currPos.y,fdp[2],1),dp2=vec4.fromValues(m_lastPos.x,m_lastPos.y,fdp[2],1),wp1=ren.displayToWorld(dp1,cam.viewMatrix(),cam.projectionMatrix(),width,height),wp2=ren.displayToWorld(dp2,cam.viewMatrix(),cam.projectionMatrix(),width,height),dx=wp1[0]-wp2[0],dy=wp1[1]-wp2[1],dz=wp1[2]-wp2[2],m_midMouseBtnDown&&(cam.pan(-dx,-dy,-dz),m_that.viewer().render()),m_leftMouseBtnDown&&(cam.rotate(m_lastPos.x-m_currPos.x,m_lastPos.y-m_currPos.y),ren.resetCameraClippingRange(),m_that.viewer().render()),m_rightMouseBtnDown&&(m_zTrans=2*(m_currPos.y-m_lastPos.y)/height,cam.zoom(m_zTrans>0?1-Math.abs(m_zTrans):1+Math.abs(m_zTrans)),ren.resetCameraClippingRange(),m_that.viewer().render()),m_lastPos.x=m_currPos.x,m_lastPos.y=m_currPos.y,!1):void 0},this.handleMouseDown=function(event){var coords;return 0===event.button&&(m_leftMouseBtnDown=!0),1===event.button&&(m_midMouseBtnDown=!0),2===event.button&&(m_rightMouseBtnDown=!0),coords=m_that.view.relMouseCoords(event),m_lastPos.x=coords.x<0?0:coords.x,m_lastPos.y=coords.y<0?0:coords.y,!1},this.handleMouseUp=function(event){return 0===event.button&&(m_leftMouseBtnDown=!1),1===event.button&&(m_midMouseBtnDown=!1),2===event.button&&(m_rightMouseBtnDown=!1),!1},this.handleMouseWheel=function(event){var ren=m_that.viewer().renderWindow().activeRenderer(),cam=ren.camera();return cam.zoom(event.originalEvent.wheelDelta<0?.9:1.1),ren.resetCameraClippingRange(),m_that.viewer().render(),!0},this},inherit(vgl.trackballInteractorStyle,vgl.interactorStyle),vgl.pvwInteractorStyle=function(){"use strict";function render(){m_renderer.resetCameraClippingRange(),m_that.viewer().render()}if(!(this instanceof vgl.pvwInteractorStyle))return new vgl.pvwInteractorStyle;vgl.trackballInteractorStyle.call(this);var m_width,m_height,m_renderer,m_camera,m_outsideCanvas,m_coords,m_currentMousePos,m_focalPoint,m_focusWorldPt,m_focusDisplayPt,m_displayPt1,m_displayPt2,m_worldPt1,m_worldPt2,m_dx,m_dy,m_dz,m_zTrans,m_that=this,m_leftMouseButtonDown=!1,m_rightMouseButtonDown=!1,m_middleMouseButtonDown=!1,m_mouseLastPos={x:0,y:0};return this.handleMouseMove=function(event){var rens=[],i=null,secCameras=[],deltaxy=null;for(m_width=m_that.viewer().renderWindow().windowSize()[0],m_height=m_that.viewer().renderWindow().windowSize()[1],m_renderer=m_that.viewer().renderWindow().activeRenderer(),m_camera=m_renderer.camera(),m_outsideCanvas=!1,m_coords=m_that.viewer().relMouseCoords(event),m_currentMousePos={x:0,y:0},rens=m_that.viewer().renderWindow().renderers(),i=0;i<rens.length;++i)m_renderer!==rens[i]&&secCameras.push(rens[i].camera());if(m_coords.x<0||m_coords.x>m_width?(m_currentMousePos.x=0,m_outsideCanvas=!0):m_currentMousePos.x=m_coords.x,m_coords.y<0||m_coords.y>m_height?(m_currentMousePos.y=0,m_outsideCanvas=!0):m_currentMousePos.y=m_coords.y,m_outsideCanvas!==!0){if(m_focalPoint=m_camera.focalPoint(),m_focusWorldPt=vec4.fromValues(m_focalPoint[0],m_focalPoint[1],m_focalPoint[2],1),m_focusDisplayPt=m_renderer.worldToDisplay(m_focusWorldPt,m_camera.viewMatrix(),m_camera.projectionMatrix(),m_width,m_height),m_displayPt1=vec4.fromValues(m_currentMousePos.x,m_currentMousePos.y,m_focusDisplayPt[2],1),m_displayPt2=vec4.fromValues(m_mouseLastPos.x,m_mouseLastPos.y,m_focusDisplayPt[2],1),m_worldPt1=m_renderer.displayToWorld(m_displayPt1,m_camera.viewMatrix(),m_camera.projectionMatrix(),m_width,m_height),m_worldPt2=m_renderer.displayToWorld(m_displayPt2,m_camera.viewMatrix(),m_camera.projectionMatrix(),m_width,m_height),m_dx=m_worldPt1[0]-m_worldPt2[0],m_dy=m_worldPt1[1]-m_worldPt2[1],m_dz=m_worldPt1[2]-m_worldPt2[2],m_middleMouseButtonDown&&(m_camera.pan(-m_dx,-m_dy,-m_dz),render()),m_leftMouseButtonDown){for(deltaxy=[m_mouseLastPos.x-m_currentMousePos.x,m_mouseLastPos.y-m_currentMousePos.y],m_camera.rotate(deltaxy[0],deltaxy[1]),i=0;i<secCameras.length;++i)secCameras[i].rotate(deltaxy[0],deltaxy[1]);for(i=0;i<rens.length;++i)rens[i].resetCameraClippingRange();render()}return m_rightMouseButtonDown&&(m_zTrans=2*(m_currentMousePos.y-m_mouseLastPos.y)/m_height,m_camera.zoom(m_zTrans>0?1-Math.abs(m_zTrans):1+Math.abs(m_zTrans)),render()),m_mouseLastPos.x=m_currentMousePos.x,m_mouseLastPos.y=m_currentMousePos.y,!1}},this.handleMouseDown=function(event){return 0===event.button&&(m_leftMouseButtonDown=!0),1===event.button&&(m_middleMouseButtonDown=!0),2===event.button&&(m_rightMouseButtonDown=!0),m_coords=m_that.viewer().relMouseCoords(event),m_mouseLastPos.x=m_coords.x<0?0:m_coords.x,m_mouseLastPos.y=m_coords.y<0?0:m_coords.y,!1},this.handleMouseUp=function(event){m_that.viewer().canvas();return 0===event.button&&(m_leftMouseButtonDown=!1),1===event.button&&(m_middleMouseButtonDown=!1),2===event.button&&(m_rightMouseButtonDown=!1),!1},this},inherit(vgl.pvwInteractorStyle,vgl.trackballInteractorStyle),vgl.viewer=function(canvas){"use strict";if(!(this instanceof vgl.viewer))return new vgl.viewer(canvas);vgl.object.call(this);var m_that=this,m_canvas=canvas,m_ready=!0,m_interactorStyle=null,m_renderer=vgl.renderer(),m_renderWindow=vgl.renderWindow(m_canvas);return this.canvas=function(){return m_canvas},this.renderWindow=function(){return m_renderWindow},this.init=function(){null!==m_renderWindow?m_renderWindow.createWindow():console.log("[ERROR] No render window attached")},this.interactorStyle=function(){return m_interactorStyle},this.setInteractorStyle=function(style){style!==m_interactorStyle&&(m_interactorStyle=style,m_interactorStyle.setViewer(this),this.modified())},this.handleMouseDown=function(event){if(m_ready===!0){var fixedEvent=$.event.fix(event||window.event);2===event.button&&fixedEvent.preventDefault(),fixedEvent.state="down",fixedEvent.type=vgl.event.mousePress,$(m_that).trigger(fixedEvent)}return!0},this.handleMouseUp=function(event){if(m_ready===!0){var fixedEvent=$.event.fix(event||window.event);fixedEvent.preventDefault(),fixedEvent.state="up",fixedEvent.type=vgl.event.mouseRelease,$(m_that).trigger(fixedEvent)}return!0},this.handleMouseMove=function(event){if(m_ready===!0){var fixedEvent=$.event.fix(event||window.event);fixedEvent.preventDefault(),fixedEvent.type=vgl.event.mouseMove,$(m_that).trigger(fixedEvent)}return!0},this.handleMouseWheel=function(event){if(m_ready===!0){var fixedEvent=$.event.fix(event||window.event);fixedEvent.preventDefault(),fixedEvent.type=vgl.event.mouseWheel,$(m_that).trigger(fixedEvent)}return!0},this.handleMouseOut=function(event){if(m_ready===!0){var fixedEvent=$.event.fix(event||window.event);fixedEvent.preventDefault(),fixedEvent.type=vgl.event.mouseOut,$(m_that).trigger(fixedEvent)}return!0},this.handleKeyPress=function(event){if(m_ready===!0){var fixedEvent=$.event.fix(event||window.event);
fixedEvent.preventDefault(),fixedEvent.type=vgl.event.keyPress,$(m_that).trigger(fixedEvent)}return!0},this.handleContextMenu=function(event){if(m_ready===!0){var fixedEvent=$.event.fix(event||window.event);fixedEvent.preventDefault(),fixedEvent.type=vgl.event.contextMenu,$(m_that).trigger(fixedEvent)}return!1},this.handleClick=function(event){if(m_ready===!0){var fixedEvent=$.event.fix(event||window.event);fixedEvent.preventDefault(),fixedEvent.type=vgl.event.click,$(m_that).trigger(fixedEvent)}return!1},this.handleDoubleClick=function(event){if(m_ready===!0){var fixedEvent=$.event.fix(event||window.event);fixedEvent.preventDefault(),fixedEvent.type=vgl.event.dblClick,$(m_that).trigger(fixedEvent)}return!1},this.relMouseCoords=function(event){if(void 0===event.pageX||void 0===event.pageY)throw"Missing attributes pageX and pageY on the event";var totalOffsetX=0,totalOffsetY=0,canvasX=0,canvasY=0,currentElement=m_canvas;do totalOffsetX+=currentElement.offsetLeft-currentElement.scrollLeft,totalOffsetY+=currentElement.offsetTop-currentElement.scrollTop;while(currentElement=currentElement.offsetParent);return canvasX=event.pageX-totalOffsetX,canvasY=event.pageY-totalOffsetY,{x:canvasX,y:canvasY}},this.render=function(){m_renderWindow.render()},this.bindEventHandlers=function(){$(m_canvas).on("mousedown",this.handleMouseDown),$(m_canvas).on("mouseup",this.handleMouseUp),$(m_canvas).on("mousemove",this.handleMouseMove),$(m_canvas).on("mousewheel",this.handleMouseWheel),$(m_canvas).on("contextmenu",this.handleContextMenu)},this.unbindEventHandlers=function(){$(m_canvas).off("mousedown",this.handleMouseDown),$(m_canvas).off("mouseup",this.handleMouseUp),$(m_canvas).off("mousemove",this.handleMouseMove),$(m_canvas).off("mousewheel",this.handleMouseWheel),$(m_canvas).off("contextmenu",this.handleContextMenu)},this._init=function(){this.bindEventHandlers(),m_renderWindow.addRenderer(m_renderer)},this._init(),this},inherit(vgl.viewer,vgl.object),vgl.shader=function(type){"use strict";if(!(this instanceof vgl.shader))return new vgl.shader(type);vgl.object.call(this);var m_shaderHandle=null,m_compileTimestamp=vgl.timestamp(),m_shaderType=type,m_shaderSource="";this.shaderHandle=function(){return m_shaderHandle},this.shaderType=function(){return m_shaderType},this.shaderSource=function(){return m_shaderSource},this.setShaderSource=function(source){m_shaderSource=source,this.modified()},this.compile=function(){return this.getMTime()<m_compileTimestamp.getMTime()?m_shaderHandle:(gl.deleteShader(m_shaderHandle),m_shaderHandle=gl.createShader(m_shaderType),gl.shaderSource(m_shaderHandle,m_shaderSource),gl.compileShader(m_shaderHandle),gl.getShaderParameter(m_shaderHandle,gl.COMPILE_STATUS)?(m_compileTimestamp.modified(),m_shaderHandle):(console.log("[ERROR] An error occurred compiling the shaders: "+gl.getShaderInfoLog(m_shaderHandle)),console.log(m_shaderSource),gl.deleteShader(m_shaderHandle),null))},this.attachShader=function(programHandle){gl.attachShader(programHandle,m_shaderHandle)}},inherit(vgl.shader,vgl.object),vgl.shaderProgram=function(){"use strict";if(!(this instanceof vgl.shaderProgram))return new vgl.shaderProgram;vgl.materialAttribute.call(this,vgl.materialAttributeType.ShaderProgram);var m_programHandle=0,m_compileTimestamp=vgl.timestamp(),m_shaders=[],m_uniforms=[],m_vertexAttributes={},m_uniformNameToLocation={},m_vertexAttributeNameToLocation={};return this.queryUniformLocation=function(name){return gl.getUniformLocation(m_programHandle,name)},this.queryAttributeLocation=function(name){return gl.getAttribLocation(m_programHandle,name)},this.addShader=function(shader){if(m_shaders.indexOf(shader)>-1)return!1;var i;for(i=0;i<m_shaders.length;++i)m_shaders[i].shaderType()===shader.shaderType()&&m_shaders.splice(m_shaders.indexOf(shader),1);return m_shaders.push(shader),this.modified(),!0},this.addUniform=function(uniform){return m_uniforms.indexOf(uniform)>-1?!1:(m_uniforms.push(uniform),void this.modified())},this.addVertexAttribute=function(attr,key){m_vertexAttributes[key]=attr,this.modified()},this.uniformLocation=function(name){return m_uniformNameToLocation[name]},this.attributeLocation=function(name){return m_vertexAttributeNameToLocation[name]},this.uniform=function(name){var i;for(i=0;i<m_uniforms.length;++i)if(m_uniforms[i].name()===name)return m_uniforms[i];return null},this.updateUniforms=function(){var i;for(i=0;i<m_uniforms.length;++i)m_uniforms[i].callGL(m_uniformNameToLocation[m_uniforms[i].name()])},this.link=function(){return gl.linkProgram(m_programHandle),gl.getProgramParameter(m_programHandle,gl.LINK_STATUS)?!0:(console.log("[ERROR] Unable to initialize the shader program."),!1)},this.use=function(){gl.useProgram(m_programHandle)},this.cleanUp=function(){this.deleteVertexAndFragment(),this.deleteProgram()},this.deleteProgram=function(){gl.deleteProgram(m_programHandle)},this.deleteVertexAndFragment=function(){var i;for(i=0;i<m_shaders.length;++i)gl.deleteShader(m_shaders[i].shaderHandle())},this.bind=function(renderState){var i=0;if(0===m_programHandle||m_compileTimestamp.getMTime()<this.getMTime()){if(m_programHandle=gl.createProgram(),0===m_programHandle)return console.log("[ERROR] Cannot create Program Object"),!1;for(i=0;i<m_shaders.length;++i)m_shaders[i].compile(),m_shaders[i].attachShader(m_programHandle);this.bindAttributes(),this.link()||(console.log("[ERROR] Failed to link Program"),this.cleanUp()),this.use(),this.bindUniforms(),m_compileTimestamp.modified()}else this.use();for(i=0;i<m_uniforms.length;++i)m_uniforms[i].update(renderState,this);this.updateUniforms()},this.undoBind=function(){},this.bindVertexData=function(renderState,key){m_vertexAttributes.hasOwnProperty(key)&&m_vertexAttributes[key].bindVertexData(renderState,key)},this.undoBindVertexData=function(renderState,key){m_vertexAttributes.hasOwnProperty(key)&&m_vertexAttributes[key].undoBindVertexData(renderState,key)},this.bindUniforms=function(){var i;for(i=0;i<m_uniforms.length;++i)m_uniformNameToLocation[m_uniforms[i].name()]=this.queryUniformLocation(m_uniforms[i].name())},this.bindAttributes=function(){var key,name;for(key in m_vertexAttributes)name=m_vertexAttributes[key].name(),gl.bindAttribLocation(m_programHandle,key,name),m_vertexAttributeNameToLocation[name]=key},this},inherit(vgl.shaderProgram,vgl.materialAttribute),vgl.texture=function(){"use strict";function activateTextureUnit(){switch(m_that.m_textureUnit){case 0:gl.activeTexture(gl.TEXTURE0);break;case 1:gl.activeTexture(gl.TEXTURE1);break;case 2:gl.activeTexture(gl.TEXTURE2);break;case 3:gl.activeTexture(gl.TEXTURE3);break;case 4:gl.activeTexture(gl.TEXTURE4);break;case 5:gl.activeTexture(gl.TEXTURE5);break;case 6:gl.activeTexture(gl.TEXTURE6);break;case 7:gl.activeTexture(gl.TEXTURE7);break;case 8:gl.activeTexture(gl.TEXTURE8);break;case 9:gl.activeTexture(gl.TEXTURE9);break;case 10:gl.activeTexture(gl.TEXTURE10);break;case 11:gl.activeTexture(gl.TEXTURE11);break;case 12:gl.activeTexture(gl.TEXTURE12);break;case 13:gl.activeTexture(gl.TEXTURE13);break;case 14:gl.activeTexture(gl.TEXTURE14);break;case 15:gl.activeTexture(gl.TEXTURE15);break;default:throw"[error] Texture unit "+this.m_textureUnit+" is not supported"}}if(!(this instanceof vgl.texture))return new vgl.texture;vgl.materialAttribute.call(this,vgl.materialAttributeType.Texture),this.m_width=0,this.m_height=0,this.m_depth=0,this.m_textureHandle=null,this.m_textureUnit=0,this.m_pixelFormat=null,this.m_pixelDataType=null,this.m_internalFormat=null,this.m_image=null;var m_setupTimestamp=vgl.timestamp(),m_that=this;return this.setup=function(){activateTextureUnit(),gl.deleteTexture(this.m_textureHandle),this.m_textureHandle=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,this.m_textureHandle),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),null!==this.m_image?(this.updateDimensions(),this.computeInternalFormatUsingImage(),gl.texImage2D(gl.TEXTURE_2D,0,this.m_internalFormat,this.m_pixelFormat,this.m_pixelDataType,this.m_image)):gl.texImage2D(gl.TEXTURE_2D,0,this.m_internalFormat,this.m_pixelFormat,this.m_pixelDataType,null),gl.bindTexture(gl.TEXTURE_2D,null),m_setupTimestamp.modified()},this.bind=function(renderState){this.getMTime()>m_setupTimestamp.getMTime()&&this.setup(renderState),activateTextureUnit(),gl.bindTexture(gl.TEXTURE_2D,this.m_textureHandle)},this.undoBind=function(){gl.bindTexture(gl.TEXTURE_2D,null)},this.image=function(){return this.m_image},this.setImage=function(image){return null!==image?(this.m_image=image,this.updateDimensions(),this.modified(),!0):!1},this.textureUnit=function(){return this.m_textureUnit},this.setTextureUnit=function(unit){return this.m_textureUnit===unit?!1:(this.m_textureUnit=unit,this.modified(),!0)},this.width=function(){return this.m_width},this.setWidth=function(width){return null===this.m_image?!1:(this.m_width=width,this.modified(),!0)},this.depth=function(){return this.m_depth},this.setDepth=function(depth){return null===this.m_image?!1:(this.m_depth=depth,this.modified(),!0)},this.textureHandle=function(){return this.m_textureHandle},this.internalFormat=function(){return this.m_internalFormat},this.setInternalFormat=function(internalFormat){return this.m_internalFormat!==internalFormat?(this.m_internalFormat=internalFormat,this.modified(),!0):!1},this.pixelFormat=function(){return this.m_pixelFormat},this.setPixelFormat=function(pixelFormat){return null===this.m_image?!1:(this.m_pixelFormat=pixelFormat,this.modified(),!0)},this.pixelDataType=function(){return this.m_pixelDataType},this.setPixelDataType=function(pixelDataType){return null===this.m_image?!1:(this.m_pixelDataType=pixelDataType,this.modified(),!0)},this.computeInternalFormatUsingImage=function(){this.m_internalFormat=gl.RGBA,this.m_pixelFormat=gl.RGBA,this.m_pixelDataType=gl.UNSIGNED_BYTE},this.updateDimensions=function(){null!==this.m_image&&(this.m_width=this.m_image.width,this.m_height=this.m_image.height,this.m_depth=0)},this},inherit(vgl.texture,vgl.materialAttribute),vgl.lookupTable=function(){"use strict";if(!(this instanceof vgl.lookupTable))return new vgl.lookupTable;vgl.texture.call(this);var m_setupTimestamp=vgl.timestamp(),m_range=[0,0];return this.m_colorTable=[.07514311,.468049805,1,1,.247872569,.498782363,1,1,.339526309,.528909511,1,1,.409505078,.558608486,1,1,.468487184,.588057293,1,1,.520796675,.617435078,1,1,.568724526,.646924167,1,1,.613686735,.676713218,1,1,.656658579,.707001303,1,1,.698372844,.738002964,1,1,.739424025,.769954435,1,1,.780330104,.803121429,1,1,.821573924,.837809045,1,1,.863634967,.874374691,1,1,.907017747,.913245283,1,1,.936129275,.938743558,.983038586,1,.943467973,.943498599,.943398095,1,.990146732,.928791426,.917447482,1,1,.88332677,.861943246,1,1,.833985467,.803839606,1,1,.788626485,.750707739,1,1,.746206642,.701389973,1,1,.70590052,.654994046,1,1,.667019783,.610806959,1,1,.6289553,.568237474,1,1,.591130233,.526775617,1,1,.552955184,.485962266,1,1,.513776083,.445364274,1,1,.472800903,.404551679,1,1,.428977855,.363073592,1,1,.380759558,.320428137,1,.961891484,.313155629,.265499262,1,.916482116,.236630659,.209939162,1].map(function(x){return 255*x}),this.setup=function(){0===this.textureUnit()?gl.activeTexture(gl.TEXTURE0):1===this.textureUnit()&&gl.activeTexture(gl.TEXTURE1),gl.deleteTexture(this.m_textureHandle),this.m_textureHandle=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,this.m_textureHandle),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),this.m_width=this.m_colorTable.length/4,this.m_height=1,this.m_depth=0,gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.m_width,this.m_height,this.m_depth,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(this.m_colorTable)),gl.bindTexture(gl.TEXTURE_2D,null),m_setupTimestamp.modified()},this.colorTable=function(){return this.m_colorTable},this.setColorTable=function(colors){return this.m_colorTable===colors?!1:(this.m_colorTable=colors,this.modified(),!0)},this.range=function(){return m_range},this.setRange=function(range){return m_range===range?!1:(m_range=range,this.modified(),!0)},this.updateRange=function(range){range instanceof Array||console.log("[error] Invalid data type for range. Requires array [min,max]"),range[0]<m_range[0]&&(m_range[0]=range[0],this.modified()),range[1]>m_range[1]&&(m_range[1]=range[1],this.modified())},this},inherit(vgl.lookupTable,vgl.texture),vgl.uniform=function(type,name){"use strict";if(!(this instanceof vgl.uniform))return new vgl.uniform;this.getTypeNumberOfComponents=function(type){switch(type){case gl.FLOAT:case gl.INT:case gl.BOOL:return 1;case gl.FLOAT_VEC2:case gl.INT_VEC2:case gl.BOOL_VEC2:return 2;case gl.FLOAT_VEC3:case gl.INT_VEC3:case gl.BOOLT_VEC3:return 3;case gl.FLOAT_VEC4:case gl.INT_VEC4:case gl.BOOL_VEC4:return 4;case gl.FLOAT_MAT3:return 9;case gl.FLOAT_MAT4:return 16;default:return 0}};var m_type=type,m_name=name,m_dataArray=[];return m_dataArray.length=this.getTypeNumberOfComponents(m_type),this.name=function(){return m_name},this.type=function(){return m_type},this.get=function(){return m_dataArray},this.set=function(value){var i=0;if(16===m_dataArray.length)for(i=0;16>i;++i)m_dataArray[i]=value[i];else if(9===m_dataArray.length)for(i=0;9>i;++i)m_dataArray[i]=value[i];else if(4===m_dataArray.length)for(i=0;4>i;++i)m_dataArray[i]=value[i];else if(3===m_dataArray.length)for(i=0;3>i;++i)m_dataArray[i]=value[i];else if(2===m_dataArray.length)for(i=0;2>i;++i)m_dataArray[i]=value[i];else m_dataArray[0]=value},this.callGL=function(location){if(!(this.m_numberElements<1))switch(m_type){case gl.BOOL:case gl.INT:gl.uniform1iv(location,m_dataArray);break;case gl.FLOAT:gl.uniform1fv(location,m_dataArray);break;case gl.FLOAT_VEC2:gl.uniform2fv(location,m_dataArray);break;case gl.FLOAT_VEC3:gl.uniform3fv(location,m_dataArray);break;case gl.FLOAT_VEC4:gl.uniform4fv(location,m_dataArray);break;case gl.FLOAT_MAT3:gl.uniformMatrix3fv(location,gl.FALSE,m_dataArray);break;case gl.FLOAT_MAT4:gl.uniformMatrix4fv(location,gl.FALSE,m_dataArray)}},this.update=function(){},this},vgl.modelViewUniform=function(name){"use strict";return this instanceof vgl.modelViewUniform?(0===name.length&&(name="modelViewMatrix"),vgl.uniform.call(this,gl.FLOAT_MAT4,name),this.set(mat4.create()),this.update=function(renderState){this.set(renderState.m_modelViewMatrix)},this):new vgl.modelViewUniform(name)},inherit(vgl.modelViewUniform,vgl.uniform),vgl.projectionUniform=function(name){"use strict";return this instanceof vgl.projectionUniform?(0===name.length&&(name="projectionMatrix"),vgl.uniform.call(this,gl.FLOAT_MAT4,name),this.set(mat4.create()),this.update=function(renderState){this.set(renderState.m_projectionMatrix)},this):new vgl.projectionUniform(name)},inherit(vgl.projectionUniform,vgl.uniform),vgl.floatUniform=function(name,value){"use strict";return this instanceof vgl.floatUniform?(0===name.length&&(name="floatUniform"),value=void 0===value?1:value,vgl.uniform.call(this,gl.FLOAT,name),void this.set(value)):new vgl.floatUniform(name,value)},inherit(vgl.floatUniform,vgl.uniform),vgl.normalMatrixUniform=function(name){"use strict";return this instanceof vgl.normalMatrixUniform?(0===name.length&&(name="normalMatrix"),vgl.uniform.call(this,gl.FLOAT_MAT4,name),this.set(mat4.create()),this.update=function(renderState){this.set(renderState.m_normalMatrix)},this):new vgl.normalMatrixUniform(name)},inherit(vgl.normalMatrixUniform,vgl.uniform),vgl.vertexAttributeKeys={Position:0,Normal:1,TextureCoordinate:2,Color:3,Scalar:4,Scalar2:5,Scalar3:6,Scalar4:7,Scalar5:8,Scalar6:9,Scalar7:10,CountAttributeIndex:11},vgl.vertexAttribute=function(name){"use strict";if(!(this instanceof vgl.vertexAttribute))return new vgl.vertexAttribute(name);var m_name=name;this.name=function(){return m_name},this.bindVertexData=function(renderState,key){var geometryData=renderState.m_mapper.geometryData(),sourceData=geometryData.sourceData(key),program=renderState.m_material.shaderProgram();gl.vertexAttribPointer(program.attributeLocation(m_name),sourceData.attributeNumberOfComponents(key),sourceData.attributeDataType(key),sourceData.normalized(key),sourceData.attributeStride(key),sourceData.attributeOffset(key)),gl.enableVertexAttribArray(program.attributeLocation(m_name))},this.undoBindVertexData=function(renderState){var program=renderState.m_material.shaderProgram();gl.disableVertexAttribArray(program.attributeLocation(m_name))}},vgl.source=function(){"use strict";return this instanceof vgl.source?(vgl.object.call(this),this.create=function(){},this):new vgl.source},inherit(vgl.source,vgl.object),vgl.planeSource=function(){"use strict";if(!(this instanceof vgl.planeSource))return new vgl.planeSource;vgl.source.call(this);var m_origin=[0,0,0],m_point1=[1,0,0],m_point2=[0,1,0],m_normal=[0,0,1],m_xresolution=1,m_yresolution=1,m_geom=null;this.setOrigin=function(x,y,z){m_origin[0]=x,m_origin[1]=y,m_origin[2]=z},this.setPoint1=function(x,y,z){m_point1[0]=x,m_point1[1]=y,m_point1[2]=z},this.setPoint2=function(x,y,z){m_point2[0]=x,m_point2[1]=y,m_point2[2]=z},this.create=function(){m_geom=new vgl.geometryData;var i,j,k,ii,numPts,numPolys,sourceTexCoords,x=[],tc=[],v1=[],v2=[],pts=[],posIndex=0,normIndex=0,colorIndex=0,texCoordIndex=0,positions=[],normals=[],colors=[],texCoords=[],indices=[],tristrip=null,sourcePositions=null,sourceColors=null;for(x.length=3,tc.length=2,v1.length=3,v2.length=3,pts.length=3,i=0;3>i;i++)v1[i]=m_point1[i]-m_origin[i],v2[i]=m_point2[i]-m_origin[i];for(numPts=(m_xresolution+1)*(m_yresolution+1),numPolys=m_xresolution*m_yresolution*2,positions.length=3*numPts,normals.length=3*numPts,texCoords.length=2*numPts,indices.length=numPts,k=0,i=0;m_yresolution+1>i;i++)for(tc[1]=i/m_yresolution,j=0;m_xresolution+1>j;j++){for(tc[0]=j/m_xresolution,ii=0;3>ii;ii++)x[ii]=m_origin[ii]+tc[0]*v1[ii]+tc[1]*v2[ii];positions[posIndex++]=x[0],positions[posIndex++]=x[1],positions[posIndex++]=x[2],colors[colorIndex++]=1,colors[colorIndex++]=1,colors[colorIndex++]=1,normals[normIndex++]=m_normal[0],normals[normIndex++]=m_normal[1],normals[normIndex++]=m_normal[2],texCoords[texCoordIndex++]=tc[0],texCoords[texCoordIndex++]=tc[1]}for(i=0;m_yresolution>i;i++)for(j=0;m_xresolution>j;j++)pts[0]=j+i*(m_xresolution+1),pts[1]=pts[0]+1,pts[2]=pts[0]+m_xresolution+2,pts[3]=pts[0]+m_xresolution+1;for(i=0;numPts>i;++i)indices[i]=i;return tristrip=new vgl.triangleStrip,tristrip.setIndices(indices),sourcePositions=vgl.sourceDataP3fv(),sourcePositions.pushBack(positions),sourceColors=vgl.sourceDataC3fv(),sourceColors.pushBack(colors),sourceTexCoords=vgl.sourceDataT2fv(),sourceTexCoords.pushBack(texCoords),m_geom.addSource(sourcePositions),m_geom.addSource(sourceColors),m_geom.addSource(sourceTexCoords),m_geom.addPrimitive(tristrip),m_geom}},inherit(vgl.planeSource,vgl.source),vgl.pointSource=function(){"use strict";if(!(this instanceof vgl.pointSource))return new vgl.pointSource;vgl.source.call(this);var m_this=this,m_positions=[],m_colors=[],m_textureCoords=[],m_size=[],m_geom=null;this.getPositions=function(){return m_positions},this.setPositions=function(positions){positions instanceof Array?m_positions=positions:console.log("[ERROR] Invalid data type for positions. Array is required."),m_this.modified()},this.getColors=function(){return m_colors},this.setColors=function(colors){colors instanceof Array?m_colors=colors:console.log("[ERROR] Invalid data type for colors. Array is required."),m_this.modified()},this.getSize=function(){return m_size},this.setSize=function(size){m_size=size,this.modified()},this.setTextureCoordinates=function(texcoords){texcoords instanceof Array?m_textureCoords=texcoords:console.log("[ERROR] Invalid data type for texture coordinates. Array is required."),m_this.modified()},this.create=function(){if(m_geom=new vgl.geometryData,m_positions.length%3!==0)return void console.log("[ERROR] Invalid length of the points array");var pointsPrimitive,sourcePositions,sourceColors,sourceTexCoords,sourceSize,numPts=m_positions.length/3,i=0,indices=[];for(indices.length=numPts,i=0;numPts>i;++i)indices[i]=i;if(sourceSize=vgl.sourceDataDf(),numPts!==m_size.length)for(i=0;numPts>i;++i)sourceSize.pushBack(m_size);else sourceSize.setData(m_size);return m_geom.addSource(sourceSize),pointsPrimitive=new vgl.points,pointsPrimitive.setIndices(indices),sourcePositions=vgl.sourceDataP3fv(),sourcePositions.pushBack(m_positions),m_geom.addSource(sourcePositions),m_colors.length>0&&m_colors.length===m_positions.length?(sourceColors=vgl.sourceDataC3fv(),sourceColors.pushBack(m_colors),m_geom.addSource(sourceColors)):m_colors.length>0&&m_colors.length!==m_positions.length&&console.log("[ERROR] Number of colors are different than number of points"),m_textureCoords.length>0&&m_textureCoords.length===m_positions.length?(sourceTexCoords=vgl.sourceDataT2fv(),sourceTexCoords.pushBack(m_textureCoords),m_geom.addSource(sourceTexCoords)):m_textureCoords.length>0&&m_textureCoords.length/2!==m_positions.length/3&&console.log("[ERROR] Number of texture coordinates are different than number of points"),m_geom.addPrimitive(pointsPrimitive),m_geom}},inherit(vgl.pointSource,vgl.source),vgl.lineSource=function(positions,colors){"use strict";if(!(this instanceof vgl.lineSource))return new vgl.lineSource;vgl.source.call(this);var m_positions=positions,m_colors=colors;this.setPositions=function(positions){return positions instanceof Array?(m_positions=positions,this.modified(),!0):(console.log("[ERROR] Invalid data type for positions. Array is required."),!1)},this.setColors=function(colors){return colors instanceof Array?(m_colors=colors,this.modified(),!0):(console.log("[ERROR] Invalid data type for colors. Array is required."),!1)},this.create=function(){if(!m_positions)return void console.log("[error] Invalid positions");if(m_positions.length%3!==0)return void console.log("[error] Line source requires 3d points");if(m_positions.length%3!==0)return void console.log("[ERROR] Invalid length of the points array");var i,linesPrimitive,sourcePositions,sourceColors,m_geom=new vgl.geometryData,numPts=m_positions.length/3,indices=[];for(indices.length=numPts,i=0;numPts>i;++i)indices[i]=i;return linesPrimitive=new vgl.lines,linesPrimitive.setIndices(indices),sourcePositions=vgl.sourceDataP3fv(),sourcePositions.pushBack(m_positions),m_geom.addSource(sourcePositions),m_colors&&m_colors.length>0&&m_colors.length===m_positions.length?(sourceColors=vgl.sourceDataC3fv(),sourceColors.pushBack(m_colors),m_geom.addSource(sourceColors)):m_colors&&m_colors.length>0&&m_colors.length!==m_positions.length&&console.log("[error] Number of colors are different than number of points"),m_geom.addPrimitive(linesPrimitive),m_geom}},inherit(vgl.lineSource,vgl.source),vgl.utils=function(){"use strict";return this instanceof vgl.utils?(vgl.object.call(this),this):new vgl.utils},inherit(vgl.utils,vgl.object),vgl.utils.computePowerOfTwo=function(value,pow){"use strict";for(pow=pow||1;value>pow;)pow*=2;return pow},vgl.utils.createTextureVertexShader=function(){"use strict";var vertexShaderSource=["attribute vec3 vertexPosition;","attribute vec3 textureCoord;","uniform mediump float pointSize;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","varying highp vec3 iTextureCoord;","void main(void)","{","gl_PointSize = pointSize;","gl_Position = projectionMatrix * modelViewMatrix * vec4(vertexPosition, 1.0);"," iTextureCoord = textureCoord;","}"].join("\n"),shader=new vgl.shader(gl.VERTEX_SHADER);return shader.setShaderSource(vertexShaderSource),shader},vgl.utils.createTextureFragmentShader=function(){"use strict";var fragmentShaderSource=["varying highp vec3 iTextureCoord;","uniform sampler2D sampler2d;","uniform mediump float opacity;","void main(void) {","gl_FragColor = vec4(texture2D(sampler2d, vec2(iTextureCoord.s, iTextureCoord.t)).xyz, opacity);","}"].join("\n"),shader=new vgl.shader(gl.FRAGMENT_SHADER);return shader.setShaderSource(fragmentShaderSource),shader},vgl.utils.createRgbaTextureFragmentShader=function(){"use strict";var fragmentShaderSource=["varying highp vec3 iTextureCoord;","uniform sampler2D sampler2d;","void main(void) {","gl_FragColor = vec4(texture2D(sampler2d, vec2(iTextureCoord.s, iTextureCoord.t)).xyzw);","}"].join("\n"),shader=new vgl.shader(gl.FRAGMENT_SHADER);return shader.setShaderSource(fragmentShaderSource),shader},vgl.utils.createVertexShader=function(){"use strict";var vertexShaderSource=["attribute vec3 vertexPosition;","attribute vec3 vertexColor;","uniform mediump float pointSize;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","varying mediump vec3 iVertexColor;","varying highp vec3 iTextureCoord;","void main(void)","{","gl_PointSize = pointSize;","gl_Position = projectionMatrix * modelViewMatrix * vec4(vertexPosition, 1.0);"," iVertexColor = vertexColor;","}"].join("\n"),shader=new vgl.shader(gl.VERTEX_SHADER);return shader.setShaderSource(vertexShaderSource),shader},vgl.utils.createPointVertexShader=function(){"use strict";var vertexShaderSource=["attribute vec3 vertexPosition;","attribute vec3 vertexColor;","attribute float vertexSize;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","varying mediump vec3 iVertexColor;","varying highp vec3 iTextureCoord;","void main(void)","{","gl_PointSize =  vertexSize;","gl_Position = projectionMatrix * modelViewMatrix * vec4(vertexPosition, 1.0);"," iVertexColor = vertexColor;","}"].join("\n"),shader=new vgl.shader(gl.VERTEX_SHADER);return shader.setShaderSource(vertexShaderSource),shader},vgl.utils.createVertexShaderSolidColor=function(){"use strict";var vertexShaderSource=["attribute vec3 vertexPosition;","uniform mediump float pointSize;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","void main(void)","{","gl_PointSize = pointSize;","gl_Position = projectionMatrix * modelViewMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),shader=new vgl.shader(gl.VERTEX_SHADER);return shader.setShaderSource(vertexShaderSource),shader},vgl.utils.createVertexShaderColorMap=function(){"use strict";var vertexShaderSource=["attribute vec3 vertexPosition;","attribute float vertexScalar;","uniform mediump float pointSize;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float lutMin;","uniform float lutMax;","varying mediump float iVertexScalar;","void main(void)","{","gl_PointSize = pointSize;","gl_Position = projectionMatrix * modelViewMatrix * vec4(vertexPosition, 1.0);","iVertexScalar = (vertexScalar-lutMin)/(lutMax-lutMin);","}"].join("\n"),shader=new vgl.shader(gl.VERTEX_SHADER);return shader.setShaderSource(vertexShaderSource),shader},vgl.utils.createFragmentShader=function(){"use strict";var fragmentShaderSource=["varying mediump vec3 iVertexColor;","uniform mediump float opacity;","void main(void) {","gl_FragColor = vec4(iVertexColor, opacity);","}"].join("\n"),shader=new vgl.shader(gl.FRAGMENT_SHADER);return shader.setShaderSource(fragmentShaderSource),shader},vgl.utils.createPhongVertexShader=function(){"use strict";var vertexShaderSource=["attribute highp vec3 vertexPosition;","attribute mediump vec3 vertexNormal;","attribute mediump vec3 vertexColor;","uniform highp mat4 projectionMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 normalMatrix;","varying highp vec4 varPosition;","varying mediump vec3 varNormal;","varying mediump vec3 iVertexColor;","void main(void)","{","varPosition = modelViewMatrix * vec4(vertexPosition, 1.0);","gl_Position = projectionMatrix * varPosition;","varNormal = vec3(normalMatrix * vec4(vertexNormal, 0.0));","iVertexColor = vertexColor;","}"].join("\n"),shader=new vgl.shader(gl.VERTEX_SHADER);return shader.setShaderSource(vertexShaderSource),shader},vgl.utils.createPhongFragmentShader=function(){"use strict";var fragmentShaderSource=["precision mediump float;","varying vec3 varNormal;","varying vec4 varPosition;","varying mediump vec3 iVertexColor;","const vec3 lightPos = vec3(0.0, 0.0,10000.0);","const vec3 ambientColor = vec3(0.01, 0.01, 0.01);","const vec3 specColor = vec3(1.0, 1.0, 1.0);","void main() {","vec3 normal = normalize(varNormal);","vec3 lightDir = normalize(lightPos);","vec3 reflectDir = -reflect(lightDir, normal);","vec3 viewDir = normalize(-varPosition.xyz);","float lambertian = max(dot(lightDir,normal), 0.0);","float specular = 0.0;","if(lambertian > 0.0) {","float specAngle = max(dot(reflectDir, viewDir), 0.0);","specular = pow(specAngle, 64.0);","}","gl_FragColor = vec4(ambientColor +","lambertian*iVertexColor +","specular*specColor, 1.0);","}"].join("\n"),shader=new vgl.shader(gl.FRAGMENT_SHADER);return shader.setShaderSource(fragmentShaderSource),shader},vgl.utils.createFragmentShaderSolidColor=function(context,color){"use strict";var fragmentShaderSource=["uniform mediump float opacity;","void main(void) {","gl_FragColor = vec4("+color[0]+","+color[1]+","+color[2]+", opacity);","}"].join("\n"),shader=new vgl.shader(gl.FRAGMENT_SHADER);return shader.setShaderSource(fragmentShaderSource),shader},vgl.utils.createFragmentShaderColorMap=function(){"use strict";var fragmentShaderSource=["varying mediump float iVertexScalar;","uniform sampler2D sampler2d;","uniform mediump float opacity;","void main(void) {","gl_FragColor = vec4(texture2D(sampler2d, vec2(iVertexScalar, 0.0)).xyz, opacity);","}"].join("\n"),shader=new vgl.shader(gl.FRAGMENT_SHADER);return shader.setShaderSource(fragmentShaderSource),shader},vgl.utils.createPointSpritesVertexShader=function(){"use strict";var vertexShaderSource=["attribute vec3 vertexPosition;","attribute vec3 vertexColor;","uniform mediump vec2 pointSize;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float height;","varying mediump vec3 iVertexColor;","varying highp float iVertexScalar;","void main(void)","{","mediump float realPointSize = pointSize.y;","if (pointSize.x > pointSize.y) {","  realPointSize = pointSize.x;}","gl_PointSize = realPointSize ;","iVertexScalar = vertexPosition.z;","gl_Position = projectionMatrix * modelViewMatrix * vec4(vertexPosition.xy, height, 1.0);"," iVertexColor = vertexColor;","}"].join("\n"),shader=new vgl.shader(gl.VERTEX_SHADER);return shader.setShaderSource(vertexShaderSource),shader},vgl.utils.createPointSpritesFragmentShader=function(){"use strict";var fragmentShaderSource=["varying mediump vec3 iVertexColor;","varying highp float iVertexScalar;","uniform sampler2D opacityLookup;","uniform highp float lutMin;","uniform highp float lutMax;","uniform sampler2D scalarsToColors;","uniform int useScalarsToColors;","uniform int useVertexColors;","uniform mediump vec2 pointSize;","uniform mediump float vertexColorWeight;","void main(void) {","mediump vec2 realTexCoord;","if (pointSize.x > pointSize.y) {","  realTexCoord = vec2(1.0, pointSize.y/pointSize.x) * gl_PointCoord;","} else {","  realTexCoord = vec2(pointSize.x/pointSize.y, 1.0) * gl_PointCoord;","}","highp float texOpacity = texture2D(opacityLookup, realTexCoord).w;","if (useScalarsToColors == 1) {","  gl_FragColor = vec4(texture2D(scalarsToColors, vec2((iVertexScalar - lutMin)/(lutMax - lutMin), 0.0)).xyz, texOpacity);","} else if (useVertexColors == 1) {","  gl_FragColor = vec4(iVertexColor, texOpacity);","} else {","  gl_FragColor = vec4(texture2D(opacityLookup, realTexCoord).xyz, texOpacity);","}}"].join("\n"),shader=new vgl.shader(gl.FRAGMENT_SHADER);return shader.setShaderSource(fragmentShaderSource),shader},vgl.utils.createTextureMaterial=function(isRgba){"use strict";var mat=new vgl.material,blend=new vgl.blend,prog=new vgl.shaderProgram,vertexShader=vgl.utils.createTextureVertexShader(gl),fragmentShader=null,posVertAttr=new vgl.vertexAttribute("vertexPosition"),texCoordVertAttr=new vgl.vertexAttribute("textureCoord"),pointsizeUniform=new vgl.floatUniform("pointSize",5),modelViewUniform=new vgl.modelViewUniform("modelViewMatrix"),projectionUniform=new vgl.projectionUniform("projectionMatrix"),samplerUniform=new vgl.uniform(gl.INT,"sampler2d"),opacityUniform=null;
return samplerUniform.set(0),prog.addVertexAttribute(posVertAttr,vgl.vertexAttributeKeys.Position),prog.addVertexAttribute(texCoordVertAttr,vgl.vertexAttributeKeys.TextureCoordinate),prog.addUniform(pointsizeUniform),prog.addUniform(modelViewUniform),prog.addUniform(projectionUniform),isRgba?fragmentShader=vgl.utils.createRgbaTextureFragmentShader(gl):(fragmentShader=vgl.utils.createTextureFragmentShader(gl),opacityUniform=new vgl.floatUniform("opacity",1),prog.addUniform(opacityUniform)),prog.addShader(fragmentShader),prog.addShader(vertexShader),mat.addAttribute(prog),mat.addAttribute(blend),mat},vgl.utils.createGeometryMaterial=function(){"use strict";var mat=new vgl.material,blend=new vgl.blend,prog=new vgl.shaderProgram,pointSize=5,opacity=.5,vertexShader=vgl.utils.createVertexShader(gl),fragmentShader=vgl.utils.createFragmentShader(gl),posVertAttr=new vgl.vertexAttribute("vertexPosition"),colorVertAttr=new vgl.vertexAttribute("vertexColor"),pointsizeUniform=new vgl.floatUniform("pointSize",pointSize),opacityUniform=new vgl.floatUniform("opacity",opacity),modelViewUniform=new vgl.modelViewUniform("modelViewMatrix"),projectionUniform=new vgl.projectionUniform("projectionMatrix");return prog.addVertexAttribute(posVertAttr,vgl.vertexAttributeKeys.Position),prog.addVertexAttribute(colorVertAttr,vgl.vertexAttributeKeys.Color),prog.addUniform(pointsizeUniform),prog.addUniform(opacityUniform),prog.addUniform(modelViewUniform),prog.addUniform(projectionUniform),prog.addShader(fragmentShader),prog.addShader(vertexShader),mat.addAttribute(prog),mat.addAttribute(blend),mat},vgl.utils.createPointGeometryMaterial=function(opacity){"use strict";var mat=new vgl.material,blend=new vgl.blend,prog=new vgl.shaderProgram,opacity=void 0===opacity?1:opacity,vertexShader=vgl.utils.createPointVertexShader(gl),fragmentShader=vgl.utils.createFragmentShader(gl),posVertAttr=new vgl.vertexAttribute("vertexPosition"),colorVertAttr=new vgl.vertexAttribute("vertexColor"),sizeVertAttr=new vgl.vertexAttribute("vertexSize"),opacityUniform=new vgl.floatUniform("opacity",opacity),modelViewUniform=new vgl.modelViewUniform("modelViewMatrix"),projectionUniform=new vgl.projectionUniform("projectionMatrix");return prog.addVertexAttribute(posVertAttr,vgl.vertexAttributeKeys.Position),prog.addVertexAttribute(colorVertAttr,vgl.vertexAttributeKeys.Color),prog.addVertexAttribute(sizeVertAttr,vgl.vertexAttributeKeys.Scalar),prog.addUniform(opacityUniform),prog.addUniform(modelViewUniform),prog.addUniform(projectionUniform),prog.addShader(fragmentShader),prog.addShader(vertexShader),mat.addAttribute(prog),mat.addAttribute(blend),mat},vgl.utils.createPhongMaterial=function(){"use strict";var mat=new vgl.material,blend=new vgl.blend,prog=new vgl.shaderProgram,vertexShader=vgl.utils.createPhongVertexShader(gl),fragmentShader=vgl.utils.createPhongFragmentShader(gl),posVertAttr=new vgl.vertexAttribute("vertexPosition"),normalVertAttr=new vgl.vertexAttribute("vertexNormal"),colorVertAttr=new vgl.vertexAttribute("vertexColor"),opacityUniform=new vgl.floatUniform("opacity",1),modelViewUniform=new vgl.modelViewUniform("modelViewMatrix"),normalUniform=new vgl.normalMatrixUniform("normalMatrix"),projectionUniform=new vgl.projectionUniform("projectionMatrix");return prog.addVertexAttribute(posVertAttr,vgl.vertexAttributeKeys.Position),prog.addVertexAttribute(normalVertAttr,vgl.vertexAttributeKeys.Normal),prog.addVertexAttribute(colorVertAttr,vgl.vertexAttributeKeys.Color),prog.addUniform(opacityUniform),prog.addUniform(modelViewUniform),prog.addUniform(projectionUniform),prog.addUniform(normalUniform),prog.addShader(fragmentShader),prog.addShader(vertexShader),mat.addAttribute(prog),mat.addAttribute(blend),mat},vgl.utils.createColorMaterial=function(){"use strict";var mat=new vgl.material,blend=new vgl.blend,prog=new vgl.shaderProgram,vertexShader=vgl.utils.createVertexShader(gl),fragmentShader=vgl.utils.createFragmentShader(gl),posVertAttr=new vgl.vertexAttribute("vertexPosition"),texCoordVertAttr=new vgl.vertexAttribute("textureCoord"),colorVertAttr=new vgl.vertexAttribute("vertexColor"),pointsizeUniform=new vgl.floatUniform("pointSize",5),opacityUniform=new vgl.floatUniform("opacity",.5),modelViewUniform=new vgl.modelViewUniform("modelViewMatrix"),projectionUniform=new vgl.projectionUniform("projectionMatrix");return prog.addVertexAttribute(posVertAttr,vgl.vertexAttributeKeys.Position),prog.addVertexAttribute(colorVertAttr,vgl.vertexAttributeKeys.Color),prog.addVertexAttribute(texCoordVertAttr,vgl.vertexAttributeKeys.TextureCoordinate),prog.addUniform(pointsizeUniform),prog.addUniform(opacityUniform),prog.addUniform(modelViewUniform),prog.addUniform(projectionUniform),prog.addShader(fragmentShader),prog.addShader(vertexShader),mat.addAttribute(prog),mat.addAttribute(blend),mat},vgl.utils.createColorMappedMaterial=function(lut){"use strict";lut||(lut=new vgl.lookupTable);var scalarRange=lut.range(),mat=new vgl.material,blend=new vgl.blend,prog=new vgl.shaderProgram,vertexShader=vgl.utils.createVertexShaderColorMap(gl,scalarRange[0],scalarRange[1]),fragmentShader=vgl.utils.createFragmentShaderColorMap(gl),posVertAttr=new vgl.vertexAttribute("vertexPosition"),scalarVertAttr=new vgl.vertexAttribute("vertexScalar"),pointsizeUniform=new vgl.floatUniform("pointSize",5),opacityUniform=new vgl.floatUniform("opacity",.5),lutMinUniform=new vgl.floatUniform("lutMin",scalarRange[0]),lutMaxUniform=new vgl.floatUniform("lutMax",scalarRange[1]),modelViewUniform=new vgl.modelViewUniform("modelViewMatrix"),projectionUniform=new vgl.projectionUniform("projectionMatrix"),samplerUniform=new vgl.uniform(gl.FLOAT,"sampler2d"),lookupTable=lut;return samplerUniform.set(0),prog.addVertexAttribute(posVertAttr,vgl.vertexAttributeKeys.Position),prog.addVertexAttribute(scalarVertAttr,vgl.vertexAttributeKeys.Scalar),prog.addUniform(pointsizeUniform),prog.addUniform(opacityUniform),prog.addUniform(lutMinUniform),prog.addUniform(lutMaxUniform),prog.addUniform(modelViewUniform),prog.addUniform(projectionUniform),prog.addShader(fragmentShader),prog.addShader(vertexShader),mat.addAttribute(prog),mat.addAttribute(blend),mat.addAttribute(lookupTable),mat},vgl.utils.updateColorMappedMaterial=function(mat,lut){"use strict";if(!mat)return void console.log("[warning] Invalid material. Nothing to update.");if(!lut)return void console.log("[warning] Invalid lookup table. Nothing to update.");var lutMin=mat.shaderProgram().uniform("lutMin"),lutMax=mat.shaderProgram().uniform("lutMax");lutMin.set(lut.range()[0]),lutMax.set(lut.range()[1]),mat.setAttribute(lut)},vgl.utils.createSolidColorMaterial=function(color){"use strict";color||(color=[1,1,1]);var mat=new vgl.material,blend=new vgl.blend,prog=new vgl.shaderProgram,vertexShader=vgl.utils.createVertexShaderSolidColor(gl),fragmentShader=vgl.utils.createFragmentShaderSolidColor(gl,color),posVertAttr=new vgl.vertexAttribute("vertexPosition"),pointsizeUniform=new vgl.floatUniform("pointSize",5),opacityUniform=new vgl.floatUniform("opacity",1),modelViewUniform=new vgl.modelViewUniform("modelViewMatrix"),projectionUniform=new vgl.projectionUniform("projectionMatrix");return prog.addVertexAttribute(posVertAttr,vgl.vertexAttributeKeys.Position),prog.addUniform(pointsizeUniform),prog.addUniform(opacityUniform),prog.addUniform(modelViewUniform),prog.addUniform(projectionUniform),prog.addShader(fragmentShader),prog.addShader(vertexShader),mat.addAttribute(prog),mat.addAttribute(blend),mat},vgl.utils.createPointSpritesMaterial=function(image,lut){"use strict";var scalarRange=void 0===lut?[0,1]:lut.range(),mat=new vgl.material,blend=new vgl.blend,prog=new vgl.shaderProgram,vertexShader=vgl.utils.createPointSpritesVertexShader(gl),fragmentShader=vgl.utils.createPointSpritesFragmentShader(gl),posVertAttr=new vgl.vertexAttribute("vertexPosition"),colorVertAttr=new vgl.vertexAttribute("vertexColor"),heightUniform=new vgl.floatUniform("height",0),vertexColorWeightUniform=new vgl.floatUniform("vertexColorWeight",0),lutMinUniform=new vgl.floatUniform("lutMin",scalarRange[0]),lutMaxUniform=new vgl.floatUniform("lutMax",scalarRange[1]),modelViewUniform=new vgl.modelViewUniform("modelViewMatrix"),projectionUniform=new vgl.projectionUniform("projectionMatrix"),samplerUniform=new vgl.uniform(gl.INT,"opacityLookup"),scalarsToColors=new vgl.uniform(gl.INT,"scalarsToColors"),useScalarsToColors=new vgl.uniform(gl.INT,"useScalarsToColors"),useVertexColors=new vgl.uniform(gl.INT,"useVertexColors"),pointSize=new vgl.uniform(gl.FLOAT_VEC2,"pointSize"),texture=new vgl.texture;return samplerUniform.set(0),scalarsToColors.set(1),useScalarsToColors.set(0),useVertexColors.set(0),pointSize.set([1,1]),prog.addVertexAttribute(posVertAttr,vgl.vertexAttributeKeys.Position),prog.addVertexAttribute(colorVertAttr,vgl.vertexAttributeKeys.Color),prog.addUniform(heightUniform),prog.addUniform(vertexColorWeightUniform),prog.addUniform(modelViewUniform),prog.addUniform(projectionUniform),prog.addUniform(samplerUniform),prog.addUniform(useVertexColors),prog.addUniform(useScalarsToColors),prog.addUniform(pointSize),prog.addShader(fragmentShader),prog.addShader(vertexShader),mat.addAttribute(prog),mat.addAttribute(blend),lut&&(prog.addUniform(scalarsToColors),useScalarsToColors.set(1),prog.addUniform(lutMinUniform),prog.addUniform(lutMaxUniform),lut.setTextureUnit(1),mat.addAttribute(lut)),texture.setImage(image),texture.setTextureUnit(0),mat.addAttribute(texture),mat},vgl.utils.createPlane=function(originX,originY,originZ,point1X,point1Y,point1Z,point2X,point2Y,point2Z){"use strict";var mapper=new vgl.mapper,planeSource=new vgl.planeSource,mat=vgl.utils.createGeometryMaterial(),actor=new vgl.actor;return planeSource.setOrigin(originX,originY,originZ),planeSource.setPoint1(point1X,point1Y,point1Z),planeSource.setPoint2(point2X,point2Y,point2Z),mapper.setGeometryData(planeSource.create()),actor.setMapper(mapper),actor.setMaterial(mat),actor},vgl.utils.createTexturePlane=function(originX,originY,originZ,point1X,point1Y,point1Z,point2X,point2Y,point2Z,isRgba){"use strict";var mapper=new vgl.mapper,planeSource=new vgl.planeSource,mat=vgl.utils.createTextureMaterial(isRgba),actor=new vgl.actor;return planeSource.setOrigin(originX,originY,originZ),planeSource.setPoint1(point1X,point1Y,point1Z),planeSource.setPoint2(point2X,point2Y,point2Z),mapper.setGeometryData(planeSource.create()),actor.setMapper(mapper),actor.setMaterial(mat),actor},vgl.utils.createPoints=function(positions,size,colors,texcoords,opacity){"use strict";if(!positions)return console.log("[ERROR] Cannot create points without positions"),null;var opacity=void 0===opacity?1:opacity,mapper=new vgl.mapper,pointSource=new vgl.pointSource,mat=vgl.utils.createPointGeometryMaterial(opacity),actor=new vgl.actor;return pointSource.setPositions(positions),colors&&pointSource.setColors(colors),texcoords&&pointSource.setTextureCoordinates(texcoords),pointSource.setSize(size?size:1),mapper.setGeometryData(pointSource.create()),actor.setMapper(mapper),actor.setMaterial(mat),actor},vgl.utils.createPointSprites=function(image,positions,colors,texcoords){"use strict";if(!image)return console.log("[ERROR] Point sprites requires an image"),null;if(!positions)return console.log("[ERROR] Cannot create points without positions"),null;var mapper=new vgl.mapper,pointSource=new vgl.pointSource,mat=vgl.utils.createPointSpritesMaterial(image),actor=new vgl.actor;return pointSource.setPositions(positions),colors&&pointSource.setColors(colors),texcoords&&pointSource.setTextureCoordinates(texcoords),mapper.setGeometryData(pointSource.create()),actor.setMapper(mapper),actor.setMaterial(mat),actor},vgl.utils.createLines=function(positions,colors){"use strict";if(!positions)return console.log("[ERROR] Cannot create points without positions"),null;var mapper=new vgl.mapper,lineSource=new vgl.lineSource,mat=vgl.utils.createGeometryMaterial(),actor=new vgl.actor;return lineSource.setPositions(positions),colors&&lineSource.setColors(colors),mapper.setGeometryData(lineSource.create()),actor.setMapper(mapper),actor.setMaterial(mat),actor},vgl.utils.createColorLegend=function(varname,lookupTable,origin,width,height,countMajor,countMinor){"use strict";function createLabels(varname,positions,range){if(!positions)return void console.log("[error] Create labels requires positions (x,y,z) array");if(positions.length%3!==0)return void console.log("[error] Create labels require positions array contain 3d points");if(!range)return void console.log("[error] Create labels requires Valid range");var i,actor=null,size=vgl.utils.computePowerOfTwo(48),index=0,actors=[],origin=[],pt1=[],pt2=[],delta=positions[6]-positions[0],axisLabelOffset=4;for(origin.length=3,pt1.length=3,pt2.length=3,i=0;2>i;++i)index=i*(positions.length-3),origin[0]=positions[index]-delta,origin[1]=positions[index+1]-2*delta,origin[2]=positions[index+2],pt1[0]=positions[index]+delta,pt1[1]=origin[1],pt1[2]=origin[2],pt2[0]=origin[0],pt2[1]=positions[1],pt2[2]=origin[2],actor=vgl.utils.createTexturePlane(origin[0],origin[1],origin[2],pt1[0],pt1[1],pt1[2],pt2[0],pt2[1],pt2[2],!0),actor.setReferenceFrame(vgl.boundingObject.ReferenceFrame.Absolute),actor.material().setBinNumber(vgl.material.RenderBin.Overlay),actor.material().addAttribute(vgl.utils.create2DTexture(range[i].toFixed(2).toString(),12,null)),actors.push(actor);return origin[0]=.5*(positions[0]+positions[positions.length-3]-size),origin[1]=positions[1]+axisLabelOffset,origin[2]=positions[2],pt1[0]=origin[0]+size,pt1[1]=origin[1],pt1[2]=origin[2],pt2[0]=origin[0],pt2[1]=origin[1]+size,pt2[2]=origin[2],actor=vgl.utils.createTexturePlane(origin[0],origin[1],origin[2],pt1[0],pt1[1],pt1[2],pt2[0],pt2[1],pt2[2],!0),actor.setReferenceFrame(vgl.boundingObject.ReferenceFrame.Absolute),actor.material().setBinNumber(vgl.material.RenderBin.Overlay),actor.material().addAttribute(vgl.utils.create2DTexture(varname,24,null)),actors.push(actor),actors}function createTicksAndLabels(varname,lut,originX,originY,originZ,pt1X,pt1Y,pt1Z,pt2X,pt2Y,pt2Z,countMajor,countMinor,heightMajor){var width=pt2X-pt1X,index=null,delta=width/countMajor,positions=[],actor=null,actors=[];for(index=0;countMajor>=index;++index)positions.push(pt1X+delta*index),positions.push(pt1Y),positions.push(pt1Z),positions.push(pt1X+delta*index),positions.push(pt1Y+heightMajor),positions.push(pt1Z);return actor=vgl.utils.createLines(positions,null),actor.setReferenceFrame(vgl.boundingObject.ReferenceFrame.Absolute),actor.material().setBinNumber(vgl.material.RenderBin.Overlay),actors.push(actor),actors=actors.concat(createLabels(varname,positions,lut.range()))}if(!lookupTable)return console.log("[error] Invalid lookup table"),[];var pt1X=origin[0]+width,pt1Y=origin[1],pt1Z=0,pt2X=origin[0],pt2Y=origin[1]+height,pt2Z=0,actors=[],actor=null,mat=null,group=vgl.groupNode();return actor=vgl.utils.createTexturePlane(origin[0],origin[1],origin[2],pt1X,pt1Y,pt1Z,pt2X,pt2Y,pt2Z),mat=actor.material(),mat.addAttribute(lookupTable),actor.setMaterial(mat),group.addChild(actor),actor.setReferenceFrame(vgl.boundingObject.ReferenceFrame.Absolute),actors.push(actor),actors=actors.concat(createTicksAndLabels(varname,lookupTable,origin[0],origin[1],origin[1],pt2X,pt1Y,pt1Z,pt1X,pt1Y,pt1Z,countMajor,countMinor,5,3))},vgl.utils.create2DTexture=function(textToWrite,textSize,color,font,alignment,baseline,bold){"use strict";var canvas=document.getElementById("textRendering"),ctx=null,texture=vgl.texture();return font=font||"sans-serif",alignment=alignment||"center",baseline=baseline||"bottom","undefined"==typeof bold&&(bold=!0),canvas||(canvas=document.createElement("canvas")),ctx=canvas.getContext("2d"),canvas.setAttribute("id","textRendering"),canvas.style.display="none",canvas.height=vgl.utils.computePowerOfTwo(8*textSize),canvas.width=canvas.height,ctx.fillStyle="rgba(0, 0, 0, 0)",ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height),ctx.fillStyle="rgba(200, 85, 10, 1.0)",ctx.textAlign=alignment,ctx.textBaseline=baseline,ctx.font=4*textSize+"px "+font,bold&&(ctx.font="bold "+ctx.font),ctx.fillText(textToWrite,canvas.width/2,canvas.height/2,canvas.width),texture.setImage(canvas),texture.updateDimensions(),texture},vgl.picker=function(){"use strict";if(!(this instanceof vgl.picker))return new vgl.picker;vgl.object.call(this);var m_actors=[];return this.getActors=function(){return m_actors},this.pick=function(selectionX,selectionY,renderer){if("undefined"==typeof selectionX)return 0;if("undefined"==typeof selectionY)return 0;if("undefined"==typeof renderer)return 0;m_actors=[];var actors,count,i,bb,tmin,tmax,tymin,tymax,tzmin,tzmax,actor,camera=renderer.camera(),width=renderer.width(),height=renderer.height(),fpoint=camera.focalPoint(),focusWorldPt=vec4.fromValues(fpoint[0],fpoint[1],fpoint[2],1),focusDisplayPt=renderer.worldToDisplay(focusWorldPt,camera.viewMatrix(),camera.projectionMatrix(),width,height),displayPt=vec4.fromValues(selectionX,selectionY,focusDisplayPt[2],1),worldPt=renderer.displayToWorld(displayPt,camera.viewMatrix(),camera.projectionMatrix(),width,height),cameraPos=camera.position(),ray=[];for(i=0;3>i;++i)ray[i]=worldPt[i]-cameraPos[i];for(actors=renderer.sceneRoot().children(),count=0,i=0;i<actors.length;++i)if(actor=actors[i],actor.visible()===!0){if(bb=actor.bounds(),ray[0]>=0?(tmin=(bb[0]-cameraPos[0])/ray[0],tmax=(bb[1]-cameraPos[0])/ray[0]):(tmin=(bb[1]-cameraPos[0])/ray[0],tmax=(bb[0]-cameraPos[0])/ray[0]),ray[1]>=0?(tymin=(bb[2]-cameraPos[1])/ray[1],tymax=(bb[3]-cameraPos[1])/ray[1]):(tymin=(bb[3]-cameraPos[1])/ray[1],tymax=(bb[2]-cameraPos[1])/ray[1]),tmin>tymax||tymin>tmax)continue;if(tymin>tmin&&(tmin=tymin),tmax>tymax&&(tmax=tymax),ray[2]>=0?(tzmin=(bb[4]-cameraPos[2])/ray[2],tzmax=(bb[5]-cameraPos[2])/ray[2]):(tzmin=(bb[5]-cameraPos[2])/ray[2],tzmax=(bb[4]-cameraPos[2])/ray[2]),tmin>tzmax||tzmin>tmax)continue;tzmin>tmin&&(tmin=tzmin),tmax>tzmax&&(tmax=tzmax),m_actors[count++]=actor}return count},this},inherit(vgl.picker,vgl.object),vgl.shapefileReader=function(){"use strict";if(!(this instanceof vgl.shapefileReader))return new vgl.shapefileReader;var m_that=this,SHP_NULL=0,SHP_POINT=1,SHP_POLYGON=5,SHP_POLYLINE=3;return this.int8=function(data,offset){return data.charCodeAt(offset)},this.bint32=function(data,offset){return((255&data.charCodeAt(offset))<<24)+((255&data.charCodeAt(offset+1))<<16)+((255&data.charCodeAt(offset+2))<<8)+(255&data.charCodeAt(offset+3))},this.lint32=function(data,offset){return((255&data.charCodeAt(offset+3))<<24)+((255&data.charCodeAt(offset+2))<<16)+((255&data.charCodeAt(offset+1))<<8)+(255&data.charCodeAt(offset))},this.bint16=function(data,offset){return((255&data.charCodeAt(offset))<<8)+(255&data.charCodeAt(offset+1))},this.lint16=function(data,offset){return((255&data.charCodeAt(offset+1))<<8)+(255&data.charCodeAt(offset))},this.ldbl64=function(data,offset){var b0=255&data.charCodeAt(offset),b1=255&data.charCodeAt(offset+1),b2=255&data.charCodeAt(offset+2),b3=255&data.charCodeAt(offset+3),b4=255&data.charCodeAt(offset+4),b5=255&data.charCodeAt(offset+5),b6=255&data.charCodeAt(offset+6),b7=255&data.charCodeAt(offset+7),sign=1-2*(b7>>7),exp=((127&b7)<<4)+((240&b6)>>4)-1023,frac=(15&b6)*Math.pow(2,48)+b5*Math.pow(2,40)+b4*Math.pow(2,32)+b3*Math.pow(2,24)+b2*Math.pow(2,16)+b1*Math.pow(2,8)+b0;return sign*(1+frac*Math.pow(2,-52))*Math.pow(2,exp)},this.lfloat32=function(data,offset){var b0=255&data.charCodeAt(offset),b1=255&data.charCodeAt(offset+1),b2=255&data.charCodeAt(offset+2),b3=255&data.charCodeAt(offset+3),sign=1-2*(b3>>7),exp=((127&b3)<<1)+((254&b2)>>7)-127,frac=(127&b2)*Math.pow(2,16)+b1*Math.pow(2,8)+b0;return sign*(1+frac*Math.pow(2,-23))*Math.pow(2,exp)},this.str=function(data,offset,length){for(var chars=[],index=offset;offset+length>index;){var c=data[index];if(0===c.charCodeAt(0))break;chars.push(c),index++}return chars.join("")},this.readHeader=function(data){var code=this.bint32(data,0),length=this.bint32(data,24),version=this.lint32(data,28),shapetype=this.lint32(data,32),xmin=this.ldbl64(data,36),ymin=this.ldbl64(data,44),xmax=this.ldbl64(data,52),ymax=this.ldbl64(data,60);return{code:code,length:length,version:version,shapetype:shapetype,bounds:new Box(vect(xmin,ymin),vect(xmax,ymax))}},this.loadShx=function(data){for(var indices=[],appendIndex=function(offset){return indices.push(2*m_that.bint32(data,offset)),offset+8},offset=100;offset<data.length;)offset=appendIndex(offset);return indices},this.Shapefile=function(options){var path=options.path;$.ajax({url:path+".shx",mimeType:"text/plain; charset=x-user-defined",success:function(data){var indices=this.loadShx(data);$.ajax({url:path+".shp",mimeType:"text/plain; charset=x-user-defined",success:function(data){$.ajax({url:path+".dbf",mimeType:"text/plain; charset=x-user-defined",success:function(dbf_data){var layer=this.loadShp(data,dbf_data,indices,options);options.success(layer)}})}})}})},this.localShapefile=function(options){var shxFile=options.shx,shpFile=options.shp,dbfFile=options.dbf,shxReader=new FileReader;shxReader.onloadend=function(){var indices=m_that.loadShx(shxReader.result),shpReader=new FileReader;shpReader.onloadend=function(){var shpData=shpReader.result,dbfReader=new FileReader;dbfReader.onloadend=function(){var dbfData=dbfReader.result,layer=m_that.loadShp(shpData,dbfData,indices,options);options.success(layer)},dbfReader.readAsBinaryString(dbfFile)},shpReader.readAsBinaryString(shpFile)},shxReader.readAsBinaryString(shxFile)},this.loadDBF=function(data){var readHeader=function(offset){var name=m_that.str(data,offset,10),type=m_that.str(data,offset+11,1),length=m_that.int8(data,offset+16);return{name:name,type:type,length:length}},level=m_that.int8(data,0);if(4==level)throw"Level 7 dBASE not supported";for(var num_entries=(m_that.int8(data,1),m_that.int8(data,2),m_that.int8(data,3),m_that.lint32(data,4)),header_size=m_that.lint16(data,8),record_size=m_that.lint16(data,10),FIELDS_START=32,HEADER_LENGTH=32,header_offset=FIELDS_START,headers=[];header_size-1>header_offset;)headers.push(readHeader(header_offset)),header_offset+=HEADER_LENGTH;for(var records=[],record_offset=header_size;header_size+num_entries*record_size>record_offset;){var declare=m_that.str(data,record_offset,1);if("*"==declare)record_offset+=record_size;else{record_offset++;for(var record={},i=0;i<headers.length;i++){var value,header=headers[i];"C"==header.type?value=m_that.str(data,record_offset,header.length).trim():"N"==header.type&&(value=parseFloat(m_that.str(data,record_offset,header.length))),record_offset+=header.length,record[header.name]=value}records.push(record)}}return records},this.loadShp=function(data,dbf_data,indices){for(var features=[],readRing=function(offset,start,end){for(var ring=[],i=end-1;i>=start;i--){var x=m_that.ldbl64(data,offset+16*i),y=m_that.ldbl64(data,offset+16*i+8);ring.push([x,y])}return ring},readRecord=function(offset){var record_offset=(m_that.bint32(data,offset),m_that.bint32(data,offset+4),offset+8),geom_type=m_that.lint32(data,record_offset);if(geom_type==SHP_NULL)console.log("NULL Shape");else if(geom_type==SHP_POINT){var x=m_that.ldbl64(data,record_offset+4),y=m_that.ldbl64(data,record_offset+12);features.push({type:"Point",attr:{},geom:[[x,y]]})}else if(geom_type==SHP_POLYGON){for(var num_parts=m_that.lint32(data,record_offset+36),num_points=m_that.lint32(data,record_offset+40),parts_start=offset+52,points_start=offset+52+4*num_parts,rings=[],i=0;num_parts>i;i++){var end,start=m_that.lint32(data,parts_start+4*i);end=num_parts>i+1?m_that.lint32(data,parts_start+4*(i+1)):num_points;var ring=readRing(points_start,start,end);rings.push(ring)}features.push({type:"Polygon",attr:{},geom:[rings]})}else{if(geom_type!=SHP_POLYLINE)throw"Not Implemented: "+geom_type;for(var num_parts=m_that.lint32(data,record_offset+36),num_points=m_that.lint32(data,record_offset+40),parts_start=offset+52,points_start=offset+52+4*num_parts,rings=[],i=0;num_parts>i;i++){var end,start=m_that.lint32(data,parts_start+4*i);end=num_parts>i+1?m_that.lint32(data,parts_start+4*(i+1)):num_points;var ring=readRing(points_start,start,end);rings.push(ring)}features.push({type:"Polyline",attr:{},geom:[rings]})}},attr=this.loadDBF(dbf_data),i=0;i<indices.length;i++){var offset=indices[i];readRecord(offset)}for(var layer=[],i=0;i<features.length;i++){var feature=features[i];feature.attr=attr[i],layer.push(feature)}return layer},this},vgl.vtkReader=function(){"use strict";if(!(this instanceof vgl.vtkReader))return new vgl.vtkReader;var m_base64Chars=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],m_reverseBase64Chars=[],m_vtkRenderedList={},m_vtkObjectCount=0,m_vtkScene=null,m_node=null,END_OF_INPUT=-1,m_base64Str="",m_base64Count=0,m_pos=0,m_viewer=null,i=0;if(0===m_reverseBase64Chars.length)for(i=0;i<m_base64Chars.length;i++)m_reverseBase64Chars[m_base64Chars[i]]=i;return this.ntos=function(n){var unN;return unN=n.toString(16),1===unN.length&&(unN="0"+unN),unN="%"+unN,unescape(unN)},this.readReverseBase64=function(){var nextCharacter;if(!m_base64Str)return END_OF_INPUT;for(;;){if(m_base64Count>=m_base64Str.length)return END_OF_INPUT;if(nextCharacter=m_base64Str.charAt(m_base64Count),m_base64Count++,m_reverseBase64Chars[nextCharacter])return m_reverseBase64Chars[nextCharacter];if("A"===nextCharacter)return 0}return END_OF_INPUT},this.decode64=function(str){var result="",inBuffer=new Array(4),done=!1;for(m_base64Str=str,m_base64Count=0;!done&&(inBuffer[0]=this.readReverseBase64())!==END_OF_INPUT&&(inBuffer[1]=this.readReverseBase64())!==END_OF_INPUT;)inBuffer[2]=this.readReverseBase64(),inBuffer[3]=this.readReverseBase64(),result+=this.ntos(inBuffer[0]<<2&255|inBuffer[1]>>4),inBuffer[2]!==END_OF_INPUT?(result+=this.ntos(inBuffer[1]<<4&255|inBuffer[2]>>2),inBuffer[3]!==END_OF_INPUT?result+=this.ntos(inBuffer[2]<<6&255|inBuffer[3]):done=!0):done=!0;return result},this.readNumber=function(ss){var v=ss[m_pos++]+(ss[m_pos++]<<8)+(ss[m_pos++]<<16)+(ss[m_pos++]<<24);return v},this.readF3Array=function(numberOfPoints,ss){var i,size=4*numberOfPoints*3,test=new Int8Array(size),points=null;for(i=0;size>i;i++)test[i]=ss[m_pos++];return points=new Float32Array(test.buffer)},this.readColorArray=function(numberOfPoints,ss,vglcolors){var i,idx=0,tmp=new Array(3*numberOfPoints);for(i=0;numberOfPoints>i;i++)tmp[idx++]=ss[m_pos++]/255,tmp[idx++]=ss[m_pos++]/255,tmp[idx++]=ss[m_pos++]/255,m_pos++;vglcolors.insert(tmp)},this.parseObject=function(vtkObject){var size,shaderProg,opacityUniform,geom=new vgl.geometryData,mapper=vgl.mapper(),ss=[],type=null,data=null,matrix=null,material=null,actor=null;for(data=atob(vtkObject.data),i=0;i<data.length;i++)ss[i]=255&data.charCodeAt(i);return m_pos=0,size=this.readNumber(ss),type=String.fromCharCode(ss[m_pos++]),geom.setName(type),"L"===type?(matrix=this.parseLineData(geom,ss),material=vgl.utils.createGeometryMaterial()):"M"===type?(matrix=this.parseMeshData(geom,ss),material=vgl.utils.createPhongMaterial()):"P"===type?(matrix=this.parsePointData(geom,ss),material=vgl.utils.createGeometryMaterial()):"C"===type?(matrix=this.parseColorMapData(geom,ss,size),material=vgl.utils.createGeometryMaterial()):console.log("Ignoring unrecognized encoded data type "+type),mapper.setGeometryData(geom),vtkObject.hasTransparency&&(shaderProg=material.shaderProgram(),opacityUniform=shaderProg.uniform("opacity"),shaderProg.addUniform(new vgl.floatUniform("opacity",.5)),material.setBinNumber(1e3)),actor=vgl.actor(),actor.setMapper(mapper),actor.setMaterial(material),actor.setMatrix(mat4.transpose(mat4.create(),matrix)),actor},this.parseLineData=function(geom,ss){var numberOfIndex,numberOfPoints,points,temp,index,size,m,i,vglpoints=null,vglcolors=null,vgllines=null,matrix=mat4.create(),p=null,idx=0;for(numberOfPoints=this.readNumber(ss),p=new Array(3*numberOfPoints),vglpoints=new vgl.sourceDataP3fv,points=this.readF3Array(numberOfPoints,ss),i=0;numberOfPoints>i;i++)p[idx++]=points[3*i],p[idx++]=points[3*i+1],p[idx++]=points[3*i+2];for(vglpoints.insert(p),geom.addSource(vglpoints),vglcolors=new vgl.sourceDataC3fv,this.readColorArray(numberOfPoints,ss,vglcolors),geom.addSource(vglcolors),vgllines=new vgl.lines,geom.addPrimitive(vgllines),numberOfIndex=this.readNumber(ss),temp=new Int8Array(2*numberOfIndex),i=0;2*numberOfIndex>i;i++)temp[i]=ss[m_pos++];for(index=new Uint16Array(temp.buffer),vgllines.setIndices(index),vgllines.setPrimitiveType(gl.LINES),size=64,temp=new Int8Array(size),i=0;size>i;i++)temp[i]=ss[m_pos++];return m=new Float32Array(temp.buffer),mat4.copy(matrix,m),matrix},this.parseMeshData=function(geom,ss){var numberOfIndex,numberOfPoints,points,temp,index,size,m,i,tcoord,vglpoints=null,vglcolors=null,normals=null,matrix=mat4.create(),vgltriangles=null,pn=null,idx=0;for(numberOfPoints=this.readNumber(ss),pn=new Array(6*numberOfPoints),vglpoints=new vgl.sourceDataP3N3f,points=this.readF3Array(numberOfPoints,ss),normals=this.readF3Array(numberOfPoints,ss),i=0;numberOfPoints>i;i++)pn[idx++]=points[3*i],pn[idx++]=points[3*i+1],pn[idx++]=points[3*i+2],pn[idx++]=normals[3*i],pn[idx++]=normals[3*i+1],pn[idx++]=normals[3*i+2];for(vglpoints.insert(pn),geom.addSource(vglpoints),vglcolors=new vgl.sourceDataC3fv,this.readColorArray(numberOfPoints,ss,vglcolors),geom.addSource(vglcolors),temp=[],vgltriangles=new vgl.triangles,numberOfIndex=this.readNumber(ss),temp=new Int8Array(2*numberOfIndex),i=0;2*numberOfIndex>i;i++)temp[i]=ss[m_pos++];for(index=new Uint16Array(temp.buffer),vgltriangles.setIndices(index),geom.addPrimitive(vgltriangles),size=64,temp=new Int8Array(size),i=0;size>i;i++)temp[i]=ss[m_pos++];return m=new Float32Array(temp.buffer),mat4.copy(matrix,m),tcoord=null,matrix},this.parsePointData=function(geom,ss){var numberOfPoints,points,indices,temp,size,m,matrix=mat4.create(),vglpoints=null,vglcolors=null,vglVertexes=null,p=null,idx=0;for(numberOfPoints=this.readNumber(ss),p=new Array(3*numberOfPoints),vglpoints=new vgl.sourceDataP3fv,points=this.readF3Array(numberOfPoints,ss),indices=new Uint16Array(numberOfPoints),i=0;numberOfPoints>i;i++)indices[i]=i,p[idx++]=points[3*i],p[idx++]=points[3*i+1],p[idx++]=points[3*i+2];for(vglpoints.insert(p),geom.addSource(vglpoints),vglcolors=new vgl.sourceDataC3fv,this.readColorArray(numberOfPoints,ss,vglcolors),geom.addSource(vglcolors),vglVertexes=new vgl.points,vglVertexes.setIndices(indices),geom.addPrimitive(vglVertexes),size=64,temp=new Int8Array(size),i=0;size>i;i++)temp[i]=ss[m_pos++];return m=new Float32Array(temp.buffer),mat4.copy(matrix,m),matrix},this.parseColorMapData=function(){return null},this.parseSceneMetadata=function(renderer,layer){var bgc,localWidth,localHeight,sceneRenderer=m_vtkScene.Renderers[layer],camera=renderer.camera();localWidth=(sceneRenderer.size[0]-sceneRenderer.origin[0])*m_node.width,localHeight=(sceneRenderer.size[1]-sceneRenderer.origin[1])*m_node.height,renderer.resize(localWidth,localHeight),camera.setCenterOfRotation([sceneRenderer.LookAt[1],sceneRenderer.LookAt[2],sceneRenderer.LookAt[3]]),camera.setViewAngleDegrees(sceneRenderer.LookAt[0]),camera.setPosition(sceneRenderer.LookAt[7],sceneRenderer.LookAt[8],sceneRenderer.LookAt[9]),camera.setFocalPoint(sceneRenderer.LookAt[1],sceneRenderer.LookAt[2],sceneRenderer.LookAt[3]),camera.setViewUpDirection(sceneRenderer.LookAt[4],sceneRenderer.LookAt[5],sceneRenderer.LookAt[6]),0===layer?(bgc=sceneRenderer.Background1,renderer.setBackgroundColor(bgc[0],bgc[1],bgc[2],1)):renderer.setResizable(!1),renderer.setLayer(layer)},this.initScene=function(){var renderer,layer;if(null===m_vtkScene)return m_viewer;for(layer=m_vtkScene.Renderers.length-1;layer>=0;layer--)renderer=this.getRenderer(layer),this.parseSceneMetadata(renderer,layer);return m_viewer},this.createViewer=function(node){var interactorStyle;return null===m_viewer&&(m_node=node,m_viewer=vgl.viewer(node),m_viewer.init(),m_vtkRenderedList[0]=m_viewer.renderWindow().activeRenderer(),m_viewer.renderWindow().resize(node.width,node.height),interactorStyle=vgl.pvwInteractorStyle(),m_viewer.setInteractorStyle(interactorStyle)),m_viewer
},this.deleteViewer=function(){m_vtkRenderedList={},m_viewer=null},this.updateCanvas=function(node){return m_node=node,m_viewer.renderWindow().resize(node.width,node.height),m_viewer},this.numObjects=function(){return m_vtkObjectCount},this.getRenderer=function(layer){var renderer;return renderer=m_vtkRenderedList[layer],(null===renderer||"undefined"==typeof renderer)&&(renderer=new vgl.renderer,renderer.setResetScene(!1),renderer.setResetClippingRange(!1),m_viewer.renderWindow().addRenderer(renderer),0!==layer&&renderer.camera().setClearMask(vgl.GL.DepthBufferBit),m_vtkRenderedList[layer]=renderer),renderer},this.setVtkScene=function(scene){m_vtkScene=scene},this};