var ogs;ogs=window&&void 0!==window.ogs?window.ogs:{},ogs.namespace=function(e){"use strict";var t,i=e.split("."),r=ogs;for("ogs"===i[0]&&(i=i.slice(1)),t=0;t<i.length;t+=1)void 0===r[i[t]]&&(r[i[t]]={}),r=r[i[t]];return r};var geo=ogs.namespace("geo");window.geo=geo,geo.renderers={},geo.features={},inherit=function(e,t){"use strict";var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.uber=t.prototype,e.prototype.constructor=e},Object.size=function(e){"use strict";var t=0,i=null;for(i in e)e.hasOwnProperty(i)&&(t+=1);return t},geo.registerRenderer=function(e,t){"use strict";void 0===geo.renderers&&(geo.renderers={}),geo.renderers[e]=t},geo.createRenderer=function(e,t,i){"use strict";if(geo.renderers.hasOwnProperty(e)){var r=geo.renderers[e]({layer:t,canvas:i});return r._init(),r}return null},geo.registerFeature=function(e,t,i){"use strict";void 0===geo.features&&(geo.features={}),e in geo.features||(geo.features[e]={}),geo.features[e][t]=i},geo.createFeature=function(e,t,i,r){"use strict";var n=i.api(),o={layer:t,renderer:i};return n in geo.features&&e in geo.features[n]?(void 0!==r&&$.extend(!0,o,r),geo.features[n][e](o)):null},geo.registerLayer=function(e,t){"use strict";void 0===geo.layers&&(geo.layers={}),geo.layers[e]=t},geo.createLayer=function(e,t,i){"use strict";var r={map:t,renderer:"vglRenderer"},n=null;return e in geo.layers?(void 0!==i&&$.extend(!0,r,i),n=geo.layers[e](r),n._init(),n):null},geo.object=function(){"use strict";if(!(this instanceof geo.object))return new geo.object;var e=this,t={};return this.on=function(i,r){return Array.isArray(i)?(i.forEach(function(t){e.on(t,r)}),e):(t.hasOwnProperty(i)||(t[i]=[]),t[i].push(r),e)},this.trigger=function(i,r){return Array.isArray(i)?(i.forEach(function(t){e.trigger(t,r)}),e):(t.hasOwnProperty(i)&&t[i].forEach(function(e){e(r)}),e)},this.off=function(i,r){if(Array.isArray(i))return i.forEach(function(t){e.off(t,r)}),e;if(r){if(Array.isArray(r))return r.forEach(function(t){e.off(i,t)}),e}else t[i]=[];return t.hasOwnProperty(i)&&(t[i]=t[i].filter(function(e){return e!==r})),e},vgl.object.call(this),this},inherit(geo.object,vgl.object),geo.sceneObject=function(e){"use strict";if(!(this instanceof geo.sceneObject))return new geo.sceneObject;geo.object.call(this,e);var t=this,i=null,r=[],n=this.trigger;return this.parent=function(e){return void 0===e?i:(i=e,t)},this.addChild=function(e){return Array.isArray(e)?(e.forEach(t.addChild),t):(e.parent(t),r.push(e),t)},this.removeChild=function(e){return Array.isArray(e)?(e.forEach(t.removeChild),t):(r=r.filter(function(t){return t!==e}),t)},this.children=function(){return r.slice()},this.trigger=function(e,o,a){var s;return o=o||{},s=o.geo||{},o.geo=s,!a&&i&&s._triggeredBy!==i?(s._triggeredBy=t,i.trigger(e,o),t):(n.call(t,e,o),s.stopPropagation?t:(r.forEach(function(i){s._triggeredBy=t,i.trigger(e,o)}),t))},this},inherit(geo.sceneObject,geo.object),geo.timestamp=function(){"use strict";return this instanceof geo.timestamp?void vgl.timestamp.call(this):new geo.timestamp},inherit(geo.timestamp,vgl.timestamp),geo.ellipsoid=function(e,t,i){"use strict";if(!(this instanceof geo.ellipsoid))return new geo.ellipsoid(e,t,i);if(e=vgl.defaultValue(e,0),t=vgl.defaultValue(t,0),i=vgl.defaultValue(i,0),0>e||0>t||0>i)return console.log("[error] Al radii components must be greater than zero");var r=this,n=new vec3.fromValues(e,t,i),o=new vec3.fromValues(e*e,t*t,i*i),a=Math.min(e,t,i),s=Math.max(e,t,i);return this.radii=function(){return n},this.radiiSquared=function(){return o},this.maximumRadius=function(){return s},this.minimumRadius=function(){return a},this.computeGeodeticSurfaceNormal=function(e,t){if("undefined"==typeof e||"undefined"==typeof t)throw"[error] Valid latitude and longitude is required";var i=Math.cos(e),r=vec3.create();return r[0]=i*Math.cos(t),r[1]=i*Math.sin(t),r[2]=Math.sin(e),vec3.normalize(r,r),r},this.transformPoint=function(e,t,i){e*=Math.PI/180,t*=Math.PI/180;var n=r.computeGeodeticSurfaceNormal(e,t),a=vec3.create(),s=Math.sqrt(vec3.dot(n,a)),l=vec3.create();return vec3.multiply(a,o,n),vec3.scale(a,a,1/s),vec3.scale(n,n,i),vec3.add(l,n,a),l},this.transformGeometry=function(e){if(!e)throw"[error] Failed to transform to cartesian. Invalid geometry.";var t=e.sourceData(vgl.vertexAttributeKeys.Position),i=t.data(),n=t.attributeNumberOfComponents(vgl.vertexAttributeKeys.Position),a=t.attributeStride(vgl.vertexAttributeKeys.Position),s=t.attributeOffset(vgl.vertexAttributeKeys.Position),l=t.sizeOfAttributeDataType(vgl.vertexAttributeKeys.Position),u=null,c=i.length*(1/n),d=null,g=null,h=0,f=vec3.create(),p=vec3.create();if(a/=l,s/=l,3!==n)throw"[error] Requires positions with three components";for(h=0;c>h;h+=1)u=h*a+s,i[u]=i[u]*(Math.PI/180),i[u+1]=i[u+1]*(Math.PI/180),g=r.computeGeodeticSurfaceNormal(i[u+1],i[u]),vec3.multiply(f,o,g),d=Math.sqrt(vec3.dot(g,f)),vec3.scale(f,f,1/d),vec3.scale(g,g,i[u+2]),vec3.add(p,g,f),i[u]=p[0],i[u+1]=p[1],i[u+2]=p[2]},r},geo.ellipsoid.WGS84=vgl.freezeObject(geo.ellipsoid(6378137,6378137,6356752.314245179)),geo.ellipsoid.UNIT_SPHERE=vgl.freezeObject(geo.ellipsoid(1,1,1)),geo.mercator={r_major:6378137},geo.mercator.r_minor=function(e){"use strict";var t;return e=void 0!==e?e:!1,t=e?6378137:6356752.314245179},geo.mercator.f=function(e){"use strict";return(geo.mercator.r_major-geo.mercator.r_minor(e))/geo.mercator.r_major},geo.mercator.long2tilex=function(e,t){"use strict";var i=(e+180)/360,r=Math.floor(i*Math.pow(2,t));return r},geo.mercator.lat2tiley=function(e,t){"use strict";var i=e*Math.PI/180;return Math.floor((1-i/Math.PI)/2*Math.pow(2,t))},geo.mercator.long2tilex2=function(e,t){"use strict";var i=(e+180)/360,r=i*Math.pow(2,t),n=Math.floor(r),o=r-n;return[n,o]},geo.mercator.lat2tiley2=function(e,t){"use strict";var i=e*Math.PI/180,r=(1-Math.log(Math.tan(i)+1/Math.cos(i))/Math.PI)/2*Math.pow(2,t),n=Math.floor(r),o=r-n;return[n,o]},geo.mercator.tilex2long=function(e,t){"use strict";return e/Math.pow(2,t)*360-180},geo.mercator.tiley2lat=function(e,t){"use strict";var i=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))},geo.mercator.y2lat=function(e){"use strict";return 180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2)},geo.mercator.lat2y=function(e){"use strict";return 180/Math.PI*Math.log(Math.tan(Math.PI/4+e*(Math.PI/180)/2))},geo.mercator.deg2rad=function(e){"use strict";var t=e*(Math.PI/180);return t},geo.mercator.rad2deg=function(e){"use strict";var t=e/(Math.PI/180);return t},geo.mercator.ll2m=function(e,t,i){"use strict";t>89.5&&(t=89.5),-89.5>t&&(t=-89.5);var r=this.r_major*this.deg2rad(e),n=this.r_minor(i)/this.r_major,o=1-n*n,a=Math.sqrt(o),s=this.deg2rad(t),l=Math.sin(s),u=a*l,c=.5*a,d=Math.pow((1-u)/(1+u),c),g=Math.tan(.5*(.5*Math.PI-s))/d,h=-this.r_major*Math.log(g),f={x:r,y:h};return f},geo.mercator.m2ll=function(e,t,i){"use strict";var r=this.rad2deg(e/this.r_major),n=this.r_minor(i)/this.r_major,o=Math.sqrt(1-n*n),a=this.rad2deg(this.pjPhi2(Math.exp(-(t/this.r_major)),o)),s={lon:r,lat:a};return s},geo.mercator.pjPhi2=function(e,t){"use strict";var i,r,n=15,o=Math.PI/2,a=1e-10,s=n,l=.5*t,u=o-2*Math.atan(e);do i=t*Math.sin(u),r=o-2*Math.atan(e*Math.pow((1-i)/(1+i),l))-u,u+=r,s-=1;while(Math.abs(r)>a&&s);return u},geo.latlng=function(e,t){"use strict";if(!(this instanceof geo.latlng))return new geo.latlng(e,t);var i=this,r=void 0===t?e.lat():e,n=void 0===t?e.lng():t;return this.lat=function(e){return void 0===e?r:void(r=e)},this.lng=function(e){return void 0===e?n:void(n=e)},this.x=function(e){return void 0===e?i.lng():void(n=e)},this.y=function(e){return void 0===e?i.lat():void(r=e)},this},geo.layerOptions=function(){"use strict";return this instanceof geo.layerOptions?(this.opacity=.5,this.showAttribution=!0,this.visible=!0,this.binNumber=vgl.material.RenderBin.Default,this):new geo.layerOptions},geo.newLayerId=function(){"use strict";var e=1;return function(){var t=e;return e+=1,t}}(),geo.layer=function(e){"use strict";if(!(this instanceof geo.layer))return new geo.layer(e);e=e||{},geo.sceneObject.call(this,e);var t=this,i=void 0===e.style?{opacity:.5,color:[.8,.8,.8],visible:!0,bin:100}:e.style,r=void 0===e.id?geo.newLayerId():e.id,n="",o="EPSG:4326",a=null,s=e.source||null,l=void 0===e.map?null:e.map,u=!1,c=0,d=0,g=0,h=0,f=null,p=null,m=null,v=!1,y=void 0===e.renderer?"vglRenderer":e.renderer,w=geo.timestamp(),_=geo.timestamp(),M=geo.timestamp(),x=void 0===e.sticky?!0:e.sticky;return this.sticky=function(){return x},this.node=function(){return f},this.id=function(e){return void 0===e?r:(r=geo.newLayerId(),t.modified(),t)},this.name=function(e){return void 0===e?n:(n=e,t.modified(),t)},this.opacity=function(e){return void 0===e?i.opacity:(i.opacity=e,t.modified(),t)},this.visible=function(e){return void 0===e?i.visible:(i.visible=e,t.modified(),t)},this.bin=function(e){return void 0===e?i.bin:(i.bin=e,t.modified(),t)},this.gcs=function(e){return void 0===e?o:(o=e,t.modified(),t)},this.transform=function(e){return geo.transform.transformLayer(e,t,l.baseLayer()),t},this.timeRange=function(e){return void 0===e?a:(a=e,t.modified(),t)},this.source=function(e){return void 0===e?s:(s=e,t.modified(),t)},this.map=function(e){return void 0===e?l:(l=e,l.node().append(f),t.modified(),t)},this.renderer=function(){return m},this.canvas=function(){return p},this.viewport=function(){return[c,d,g,h]},this.dataTime=function(){return w},this.updateTime=function(){return _},this.drawTime=function(){return M},this.query=function(){},this.referenceLayer=function(e){return void 0!==e?(u=e,t.modified(),t):u},this.initialized=function(e){return void 0!==e?(v=e,t):v},this.toLocal=function(e){return e},this.fromLocal=function(e){return e},this._init=function(){return v?t:(f=$(document.createElement("div")),f.attr("id",n),f.css("position","absolute"),l&&l.node().append(f),p?m=geo.createRenderer(y,t,p):(m=geo.createRenderer(y,t),p=m.canvas()),t.addChild(m),v=!0,t)},this._exit=function(){},this._update=function(){},this._resize=function(e,i,r,n){return c=e,d=i,g=r,h=n,f.width(r),f.height(n),t.modified(),t.trigger(geo.event.resize,{x:e,y:i,width:g,height:h}),t},this.width=function(){return g},this.height=function(){return h},this._draw=function(){},this},inherit(geo.layer,geo.sceneObject),geo.featureLayer=function(e){"use strict";if(!(this instanceof geo.featureLayer))return new geo.featureLayer(e);geo.layer.call(this,e);var t=this,i=null,r=this._init,n=this._update;return this.createFeature=function(e,r){var n=geo.createFeature(e,t,t.renderer(),r);return i||(i=[]),t.addChild(n),i.push(n),t.features(i),t.modified(),n},this.deleteFeature=function(e){return t._delete(e)},this.features=function(e){return t._features(e)},this._features=function(e){return void 0===e?i||[]:(i=e.slice(0),t.dataTime().modified(),t.modified(),void 0)},this._delete=function(e){var r;for(r=0;r<i.length;r+=1)if(i[r]===e)return i[r]._exit(),t.dataTime().modified(),t.modified(),i.splice(r,1);return t.removeChild(e),t},this._init=function(){return t.initialized()?t:(r.call(t),t.on(geo.event.resize,function(e){t.renderer()._resize(e.x,e.y,e.width,e.height),t._update({}),t.renderer()._render()}),t.on(geo.event.pan,function(e){t._update({event:e}),t.renderer()._render()}),t.on(geo.event.zoom,function(e){t.map()&&t.map().zoom(e.curr_zoom),t._update({event:e}),t.renderer()._render()}),t)},this._update=function(e){var r;if(!i)return t;if(n.call(t,e),!t.source()&&i&&0===i.length)return void console.log("[info] No valid data source found.");if(t.dataTime().getMTime()>t.updateTime().getMTime())for(r=0;r<i.length;r+=1)i[r].renderer(t.renderer());for(r=0;r<i.length;r+=1)i[r]._update();return t.updateTime().modified(),t},this._draw=function(){return t.renderer()._render(),t},this.clear=function(){var e;if(!i)return t;for(e=0;e<i.length;e+=1)i[e]._exit();return t.dataTime().modified(),t.modified(),i=[],t},t},inherit(geo.featureLayer,geo.layer),geo.registerLayer("feature",geo.featureLayer),geo.event=function(){"use strict";return this instanceof geo.event?(vgl.event.call(this),this):new geo.event},inherit(geo.event,vgl.event),geo.event.update="geo.update",geo.event.opacityUpdate="geo.opacityUpdate",geo.event.layerAdd="geo.layerAdd",geo.event.layerRemove="geo.layerRemove",geo.event.layerToggle="geo.layerToggle",geo.event.layerSelect="geo.layerSelect",geo.event.layerUnselect="geo.layerUnselect",geo.event.zoom="geo.zoom",geo.event.center="geo.center",geo.event.pan="geo.pan",geo.event.rotate="geo.rotate",geo.event.resize="geo.resize",geo.event.animate="geo.animate",geo.event.query="geo.query",geo.event.draw="geo.draw",geo.event.drawEnd="geo.drawEnd",geo.event.animationPause="geo.animationPause",geo.event.animationStop="geo.animationStop",geo.event.animationComplete="geo.animationComplete",geo.time={},geo.time.incrementTime=function(e,t,i){"use strict";return"days"===t?e.setDate(e.getDate()+i):"months"===t?e.setMonth(e.getMonth()+i):"years"===t?e.setYear(e.getYear()+i):"index"===t&&(e+=i),e},geo.map=function(e){"use strict";if(!(this instanceof geo.map))return new geo.map(e);e=e||{},geo.sceneObject.call(this,e),e.layers=void 0===e.layers?[]:e.layers;var t,i,r,n,o,a=this,s=0,l=0,u=$(e.node),c=e.width||u.width(),d=e.height||u.height(),g=void 0===e.gcs?"EPSG:4326":e.gcs,h=void 0===e.uigcs?"EPSG:4326":e.uigcs,f=void 0===e.center?[0,0]:e.center,p=void 0===e.zoom?10:e.zoom,m=null,v={range:null,timestep:null,layers:null},y={};return y.milliseconds=1,y.seconds=1e3*y.milliseconds,y.minutes=60*y.seconds,y.hours=60*y.minutes,y.days=24*y.hours,y.weeks=7*y.days,y.months=4*y.weeks,y.years=12*y.months,this.on(geo.event.animationPause,function(){n=!0}),this.on(geo.event.animationStop,function(){o=!0}),t=function(e){var t=e.toLowerCase();return y[t]},i=function(e){var i,r,n,o,a,s=null,l=null,u=!1,c=Number.MAX_VALUE;for(a=0;a<e.length;a+=1)if(n=e[a].timeRange()){if("index"===n.deltaUnits)u=!0,o=n.delta;else{if(u)throw"Can't mix index timesteps with time based timesteps";o=t(n.deltaUnits)*n.delta}c>o&&(i=n.delta,r=n.deltaUnits,c=o),(null===s||n.start<s)&&(s=n.start),(null===l||n.end<l)&&(l=n.end)}return{start:s,end:l,delta:i,deltaUnits:r}},r=function(e){return e instanceof Date&&(e=new Date(e.getTime())),e},this.gcs=function(e){return void 0===e?g:(g=e,a)},this.uigcs=function(){return h},this.node=function(){return u},this.zoom=function(e){return void 0===e?p:(p=e,a.modified(),a)},this.center=function(e){return void 0===e?f:(f=e.slice,a.modified(),a)},this.createLayer=function(e,t){var i=geo.createLayer(e,a,t);return null===i&&void 0===i?null:(i._resize(s,l,c,d),(i.referenceLayer()||0===a.children().length)&&a.baseLayer(i),a.addChild(i),a.modified(),a.trigger(geo.event.layerAdd,{type:geo.event.layerAdd,target:a,layer:i}),i)},this.deleteLayer=function(e){return null!==e&&void 0!==e&&(e._exit(),a.removeChild(e),a.modified(),a.trigger(geo.event.layerRemove,{type:geo.event.layerRemove,target:a,layer:e})),e},this.toggle=function(e){return null!==e&&void 0!==e&&(e.visible(!e.visible()),a.modified(),a.trigger(geo.event.layerToggle,{type:geo.event.layerToggle,target:a,layer:e})),a},this.resize=function(e,t,i,r){var n,o=a.children();for(s=e,l=t,c=i,d=r,n=0;n<o.length;n+=1)o[n]._resize(e,t,i,r);return a.trigger(geo.event.resize,{type:geo.event.resize,target:a,x:s,y:l,width:i,height:r}),a.modified(),a},this.gcsToDisplay=function(e){var t,i;if(!(e instanceof Array&&e.length>0||e instanceof Object))throw"Conversion method latLonToDisplay does not handle "+e;return t=m.toLocal(e),i=m.renderer().worldToDisplay(t)},this.displayToGcs=function(e){var t;if(!(e instanceof Array&&e.length>0||e instanceof Object))throw"Conversion method latLonToDisplay does not handle "+e;return t=m.renderer().displayToWorld(e),t=m.fromLocal(t)},this.query=function(){},this.baseLayer=function(e){return void 0!==e?(g!==e.gcs()&&a.gcs(e.gcs()),m=e,m.referenceLayer(!0),a):m},this.draw=function(){var e,t=a.children();for(a.trigger(geo.event.draw,{type:geo.event.draw,target:a}),a._update(),e=0;e<t.length;e+=1)t[e]._draw();return a.trigger(geo.event.drawEnd,{type:geo.event.drawEnd,target:a}),a},this.animate=function(e){var t;if(e=void 0===e?a.children():e,null===v.timestep){if(t=i(e),!t.start||!t.end)throw"Animation range could not be calculated. Check that layers have ranges associated with them";v={range:t,timestep:r(t.start),layers:e}}return a._animate(),a},this.pauseAnimation=function(){return a.trigger(geo.event.animationPause),a},this.stopAnimation=function(){return a.trigger(geo.event.animationStop),v.timestep=null,a},this.stepAnimationForward=function(e){var t;return e=void 0===e?v.layers:e,null===e&&(e=a.children()),null===v.timestep&&(t=i(e),v={range:t,timestep:r(t.start),layers:e}),a._stepAnimationForward(),a},this.stepAnimationBackward=function(e){var t;return e=void 0===e?v.layers:e,null===e&&(e=a.children()),null===v.timestep&&(t=i(e),v={range:t,timestep:r(t.end),layers:e}),a._stepAnimationBackward(),a},this._animate=function(){function e(){v.timestep>t.end||o?(clearInterval(s),v.timestep=null,a.trigger(geo.event.animationComplete)):n?clearInterval(s):(a._animateTimestep(),v.timestep=geo.time.incrementTime(v.timestep,v.range.deltaUnits,v.range.delta))}var t,i,s;if(t=v.range,i=r(t.start),o=!1,n=!1,i=geo.time.incrementTime(i,t.deltaUnits,t.delta),i>t.end)throw"Invalid time range";return s=setInterval(e,10),a},this._animateTimestep=function(){return v&&($.each(v.layers,function(e,t){var i=v.timestep;i instanceof Date&&(i=i.getTime()),t._update({timestep:i})}),a.trigger(geo.event.animate,{timestep:v.timestep}),a.draw()),a},this._stepAnimationForward=function(){var e;return null===v.timestep&&(v.timestep=r(v.range.start)),e=r(v.timestep),e=geo.time.incrementTime(e,v.range.deltaUnits,v.range.delta),e<=v.range.end&&(v.timestep=e,a._animateTimestep()),a},this._stepAnimationBackward=function(){var e;return null===v.timestep&&(v.timestep=r(v.range.end)),e=r(v.timestep),e=geo.time.incrementTime(e,v.range.deltaUnits,-v.range.delta),e<v.range.start?void 0:(v.timestep=e,a._animateTimestep(),a)},this._init=function(e){var t;if(void 0===u||null===u)throw"Map require DIV node";if(void 0!==e&&void 0!==e.layers)for(t=0;t<e.layers.length;t+=1)0===t&&a.baseLayer(e.layers[t]),a.addLayer(e.layers[t]);return a},this._update=function(e){var t,i=a.children();for(t=0;t<i.length;t+=1)i[t]._update(e);return a},this._exit=function(){var e,t=a.children();for(e=0;e<t.length;e+=1)t[e]._exit()},this._init(e),this},inherit(geo.map,geo.sceneObject),geo.feature=function(e){"use strict";if(!(this instanceof geo.feature))return new geo.feature(e);geo.sceneObject.call(this),e=e||{};var t=this,i={},r=void 0===e.layer?null:e.layer,n=void 0===e.gcs?"EPSG:4326":e.gcs,o=void 0===e.visible?!0:e.visible,a=void 0===e.bin?0:e.bin,s=void 0===e.renderer?null:e.renderer,l=geo.timestamp(),u=geo.timestamp(),c=geo.timestamp();return this.style=function(e,r){return void 0===e?i:void 0===r?(i=$.extend({},i,e),t.modified(),t):(i[e]=r,t.modified(),t)},this.layer=function(){return r},this.renderer=function(){return s},this.drawables=function(){return t._drawables()},this.gcs=function(e){return void 0===e?n:(n=e,t.modified(),t)},this.visible=function(e){return void 0===e?o:(o=e,t.modified(),t)},this.bin=function(e){return void 0===e?a:(a=e,t.modified(),t)},this.dataTime=function(e){return void 0===e?l:(l=e,t.modified(),t)},this.buildTime=function(e){return void 0===e?u:(u=e,t.modified(),t)},this.updateTime=function(e){return void 0===e?c:(c=e,t.modified(),t)},this._init=function(e){if(!r)throw"Feature requires a valid layer";i=$.extend({},{opacity:1},void 0===e.style?{}:e.style)},this._build=function(){},this._drawables=function(){},this._update=function(){},this._exit=function(){},this._init(e),this},inherit(geo.feature,geo.sceneObject),geo.pointFeature=function(e){"use strict";if(!(this instanceof geo.pointFeature))return new geo.pointFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=void 0===e.positions?null:e.positions,r=this._init;return this.positions=function(e){return void 0===e?i:(i=e.slice(0),t.dataTime().modified(),t.modified(),t)},this._init=function(e){r.call(t,e);var n=$.extend({},{size:1,width:1,height:1,color:[1,1,1],point_sprites:!1,point_sprites_image:null},void 0===e.style?{}:e.style);t.style(n),i&&t.dataTime().modified()},t._init(e),t},inherit(geo.pointFeature,geo.feature),geo.lineFeature=function(e){"use strict";if(!(this instanceof geo.lineFeature))return new geo.lineFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=void 0===e.positions?[]:e.positions,r=this._init;return this.positions=function(e){return void 0===e?i:(i=e.slice(0),t.dataTime().modified(),t.modified(),t)},this._init=function(e){r.call(t,e);var n=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===e.style?{}:e.style);t.style(n),i&&t.dataTime().modified()},this._init(e),this},inherit(geo.lineFeature,geo.feature),geo.pathFeature=function(e){"use strict";if(!(this instanceof geo.pathFeature))return new geo.pathFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=void 0===e.positions?[]:e.positions,r=this._init;return this.positions=function(e){return void 0===e?i:(i=e.slice(0),t.dataTime().modified(),t.modified(),t)},this._init=function(e){r.call(t,e);var n=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===e.style?{}:e.style);t.style(n),i&&t.dataTime().modified()},this._init(e),this},inherit(geo.pathFeature,geo.feature),geo.polygonFeature=function(e){"use strict";if(!(this instanceof geo.polygonFeature))return new geo.polygonFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=this._init;return this._init=function(e){i.call(t,e);var r=$.extend({},{color:[1,1,1],fill_color:[1,1,1],fill:!0},void 0===e.style?{}:e.style);t.style(r)},t._init(e),t},inherit(geo.polygonFeature,geo.feature),geo.planeFeature=function(e){"use strict";if(!(this instanceof geo.planeFeature))return new geo.planeFeature(e);e=e||{},e.ul=void 0===e.ul?[0,1,0]:e.ul,e.lr=void 0===e.lr?[1,0,0]:e.lr,e.depth=void 0===e.depth?0:e.depth,geo.polygonFeature.call(this,e);var t=this,i=[e.ul.x,e.lr.y,e.depth],r=[e.ul.x,e.ul.y,e.depth],n=[e.lr.x,e.lr.y,e.depth],o=e.depth,a=void 0===e.drawOnAsyncResourceLoad?!0:!1,s=this._init;return this.origin=function(e){if(void 0===e)return i;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";i=e.slice(0),2===i.length&&(i[2]=o)}else e instanceof geo.latlng&&(i=[e.x(),e.y(),o]);return t.dataTime().modified(),t.modified(),t},this.upperLeft=function(e){if(void 0===e)return r;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";r=e.slice(0),2===r.length&&(r[2]=o)}else e instanceof geo.latlng&&(r=[e.x(),e.y(),o]);return t.dataTime().modified(),t.modified(),t},this.lowerRight=function(e){if(void 0===e)return n;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";n=e.slice(0),2===n.length&&(n[2]=o),t.dataTime().modified()}else e instanceof geo.latlng&&(n=[e.x(),e.y(),o]);return t.dataTime().modified(),t.modified(),t},this.drawOnAsyncResourceLoad=function(e){return void 0===e?a:(a=e,t)},this._init=function(e){var i=null;s.call(t,e),i=t.style(),void 0===i.image&&(i.image=null),t.style(i)},this._init(e),this},inherit(geo.planeFeature,geo.polygonFeature),geo.geomFeature=function(e){"use strict";return this instanceof geo.geomFeature?(e=e||{},geo.feature.call(this,e),e.style=void 0===e.style?$.extend({},{color:[1,1,1],point_sprites:!1,point_sprites_image:null},e.style):e.style,this.style(e.style),this):new geo.geomFeature(e)},inherit(geo.geomFeature,geo.feature),geo.graphFeature=function(e){"use strict";if(!(this instanceof geo.graphFeature))return new geo.graphFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=this.style,r=null,n=null,o=[],a=this._init;return this._init=function(e){a.call(t,e);var i=$.extend(!0,{},{nodes:{size:5,color:[0,0,1]},links:{color:[1,1,1]},linkType:"path"},void 0===e.style?{}:e.style);t.style(i),r&&t.dataTime().modified()},this.style=function(e){var r=i.call(t,e);return r!==t?r:(n.style(e.nodes),o.forEach(function(t){t.style(e.links)}),t)},this.nodes=function(e){var i,a=t.layer(),s=0;return void 0===e?r:(i=t.style(),r=e.slice(0),n.positions(r),r.forEach(function(e){(e.children||[]).forEach(function(t){s+=1,o.length<s&&o.push(a.createFeature(i.linkType).style(i.links)),o[s-1].positions([e,t])})}),o.splice(s,o.length-s).forEach(function(e){a._delete(e)}),t.dataTime().modified(),t.modified(),t)},this.nodeFeature=function(){return n},this.linkFeatures=function(){return o},n=this.layer().createFeature("point"),e.nodes&&this.nodes(e.nodes),this._init(e),this},inherit(geo.graphFeature,geo.feature),geo.transform={},geo.transform.osmTransformFeature=function(e,t,i){"use strict";if(!t)return void console.log("[warning] Invalid (null) feature");if(t.gcs()!==e){if(!(t instanceof geo.pointFeature||t instanceof geo.lineFeature))throw"Supports only point or line feature";var r,n,o=null,a=0,s=null,l=null,u=null,c=t.gcs();if(i=!!i,t instanceof geo.pointFeature||t instanceof geo.lineFeature){if("EPSG:4326"!==c&&geo.transform.transformFeature("EPSG:4326",t,!0),l=t.positions(),s=l.length,!(l instanceof Array))throw"Supports Array of 2D and 3D points";if(l.length>0&&l[0]instanceof geo.latlng?(o=2,a=1):(o=s%2===0?2:s%3===0?3:null,a=o),2!==o&&3!==o)throw"Transform points require points in 2D or 3D";for(u=i?l:l.slice(0),r=0;s>r;r+=a)n=l[r]instanceof geo.latlng?l[r].lat():l[r+1],n>85.0511&&(n=85.0511),-85.0511>n&&(n=-85.0511),l[r]instanceof geo.latlng?u[r]=geo.latlng(geo.mercator.lat2y(n),u[r].lng()):u[r+1]=geo.mercator.lat2y(n);return i&&(t.positions(u),t.gcs(e)),u}return null}},geo.transform.transformFeature=function(e,t,i){"use strict";if(!t)throw"Invalid (null) feature";if(!(t instanceof geo.pointFeature||t instanceof geo.lineFeature))throw"Supports only point or line feature";if(t.gcs()===e)return t.positions();if("EPSG:3857"===e)return geo.transform.osmTransformFeature(e,t,i);var r,n=null,o=0,a=null,s=null,l=null,u=null,c=t.gcs(),d=new proj4.Proj(c),g=new proj4.Proj(e);if(i=!!i,t instanceof geo.pointFeature||t instanceof geo.lineFeature){if(s=t.positions(),a=s.length,!(s instanceof Array))throw"Supports Array of 2D and 3D points";if(s.length>0&&s[0]instanceof geo.latlng?(n=2,o=1):(n=a%2===0?2:a%3===0?3:null,o=n),2!==n&&3!==n)throw"Transform points require points in 2D or 3D";for(i?l=s:(l=[],l.length=s.length),r=0;a>r;r+=o)u=2===n?new proj4.Point(s[r],s[r+1],0):new proj4.Point(s[r],s[r+1],s[r+2]),proj4.transform(d,g,u),2===n?(l[r]=u.x,l[r+1]=u.y):(l[r]=u.x,l[r+1]=u.y,l[r+2]=u.z);return i&&(t.positions(l),t.gcs(e)),l}return null},geo.transform.transformLayer=function(e,t,i){"use strict";var r,n,o;if(!t)throw"Requires valid layer for tranformation";if(!i)throw"Requires baseLayer used by the map";if(t!==i){if(!(t instanceof geo.featureLayer))throw"Only feature layer transformation is supported";for(r=t.features(),n=r.length,o=0,o=0;n>o;o+=1)"EPSG:3857"===e&&i instanceof geo.osmLayer?geo.transform.osmTransformFeature(e,r[o],!0):geo.transform.transformFeature(e,r[o],!0);t.gcs(e)}},geo.renderer=function(e){"use strict";if(!(this instanceof geo.renderer))return new geo.renderer(e);geo.sceneObject.call(this),e=e||{};var t=this,i=void 0===e.layer?null:e.layer,r=void 0===e.canvas?null:e.canvas,n=!1;return this.layer=function(){return i},this.canvas=function(e){return void 0===e?r:(r=e,void t.modified())},this.map=function(){return i?i.map():null},this.baseLayer=function(){return t.map()?t.map().baseLayer():void 0},this.initialized=function(e){return void 0===e?n:(n=e,t)},this.api=function(){throw"Should be implemented by derivied classes"},this.reset=function(){return!0},this.worldToGcs=function(){throw"Should be implemented by derivied classes"},this.displayToGcs=function(){throw"Should be implemented by derivied classes"},this.gcsToDisplay=function(){throw"Should be implemented by derivied classes"},this.worldToDisplay=function(){throw"Should be implemented by derivied classes"},this.displayToWorld=function(){throw"Should be implemented by derivied classes"},this.relMouseCoords=function(e){var i=0,r=0,n=0,o=0,a=t.canvas();do i+=a.offsetLeft-a.scrollLeft,r+=a.offsetTop-a.scrollTop,a=a.offsetParent;while(a);return n=e.pageX-i,o=e.pageY-r,{x:n,y:o}},this._init=function(){},this._resize=function(){},this._render=function(){},this._exit=function(){},this._connectMouseEvents=function(){},this},inherit(geo.renderer,geo.sceneObject),geo.osmLayer=function(e){"use strict";function t(){return r.map().zoom()<19?r.map().zoom()+1:r.map().zoom()}function i(e){void 0===e&&(e={}),r._addTiles(e),r._removeTiles(e),r._draw(),r.updateTime().modified()}if(!(this instanceof geo.osmLayer))return new geo.osmLayer(e);geo.featureLayer.call(this,e);var r=this,n={},o=0,a=1e3,s=[],l=[],u=0,c=150,d=null,g="http://tile.openstreetmap.org/",h="png",f=null,p=this._init,m=this._update;return e&&void 0!==e.baseUrl&&(g=e.baseUrl),e&&void 0!==e.imageFormat&&(h=e.imageFormat),this.tileCacheSize=function(e){return void 0===e?c:(c=e,void r.modified())},this.toLocal=function(e){var t,i,r;if(e instanceof Array&&e.length>0)if(i=[],i.length=e.length,e[0]instanceof geo.latlng)for(t=0;t<e.length;t+=1)i[t]=geo.latlng(e[t]),i[t].lat(geo.mercator.lat2y(i[t].lat()));else if(e[0]instanceof Array)if(r=e%3===0?3:2,2===r)for(t=0;t<e.length;t+=r)i[t]=e[t],i[t+1]=geo.mercator.lat2y(e[t+1]);else for(t=0;t<e.length;t+=r)i[t]=e[t],i[t+1]=geo.mercator.lat2y(e[t+1]),i[t+2]=e[t+2];else"x"in e[0]&&"y"in e[0]&&"z"in e[0]?i[t]={x:e[t].x,y:geo.mercator.lat2y(e[t].y),z:e[t].z}:"x"in e[0]&&"y"in e[0]&&"z"in e[0]&&(i[t]={x:e[t].x,y:geo.mercator.lat2y(e[t].y)});else e instanceof geo.latlng?(i={},i.x=e.x(),i.y=geo.mercator.lat2y(e.y())):(i={},i.x=e.x,i.y=geo.mercator.lat2y(e.y));return i},this.fromLocal=function(e){var t,i;if(e instanceof Array&&e.length>0)if(i=[],i.length=e.length,e[0]instanceof Object)for(t=0;t<e.length;t+=1)i[t]={},i[t].x=e[t].x,i[t].y=geo.mercator.y2lat(e[t].y);else if(e[0]instanceof Array)for(t=0;t<e.length;t+=1)i[t]=e[t],i[t][1]=geo.mercator.y2lat(e[t][1]);else for(t=0;t<e.length;t+=1)i[t]=e[t],i[t+1]=geo.mercator.y2lat(e[t+1]);else i={},i.x=e.x,i.y=geo.mercator.y2lat(e.y);return i},this._hasTile=function(e,t,i){return n[e]&&n[e][t]&&n[e][t][i]?!0:!1},this._addTile=function(e,t,i,r){if(n[t]||(n[t]={}),n[t][i]||(n[t][i]={}),!n[t][i][r]){var o=Math.max(1,Math.pow(2,t)),a=Math.max(1,Math.pow(2,t)),l=360,c=360/o,d=l/a,f=-180+i*c,p=.5*-l+r*d,m=-180+(i+1)*c,v=.5*-l+(r+1)*d,y=new Image;return y.LOADING=!0,y.LOADED=!1,y.REMOVED=!1,y.REMOVING=!1,y.crossOrigin="anonymous",y.zoom=t,y.index_x=i,y.index_y=r,y.llx=f,y.lly=p,y.urx=m,y.ury=v,y.lastused=new Date,y.src=g+t+"/"+i+"/"+(Math.pow(2,t)-1-r)+"."+h,n[t][i][r]=y,s.push(y),u+=1,y}},this._removeTiles=function(){var e,i,s,g,h=t();if(!n)return r;if(d===h)return r;d=h;for(g in n)if(h!==g)for(e in n[g])for(i in n[g][e])s=n[g][e][i],s&&(s.REMOVING=!0,l.push(s));return setTimeout(function(){var e,i;for(l.sort(function(e,t){return e.lastused-t.lastused}),i=0;u>c&&i<l.length;)e=l[i],e.zoom!==t()&&(r._delete(e.feature),delete n[e.zoom][e.index_x][e.index_y],l.splice(i,1),u-=1),i+=1;for(i=0;i<l.length;i+=1)e=l[i],e.zoom!==t()?(e.REMOVING=!1,e.REMOVED=!0,e.feature.bin(o)):(e.REMOVING=!1,e.REMOVED=!1,e.lastused=new Date,e.feature.bin(a)),e.feature._update();l=[],r._draw()},100),r},this._addTiles=function(e){function i(e){return function(){e.LOADING=!1,e.LOADED=!0,(e.REMOVING||e.REMOVED)&&e.feature&&e.zoom!==t()?(e.feature.bin(o),e.REMOVING=!1,e.REMOVED=!0):(e.REMOVED=!1,e.lastused=new Date,e.feature.bin(a)),e.feature._update(),r._draw()}}var l,u=r.renderer(),c=t(),d=0,g=r.height(),h=r.width(),f=0,p=null,m=null,v=null,y=null,w=null,_=null,M=null,x=0,b=0,T=u.displayToWorld([d,g]),F=u.displayToWorld([h,f]);for(T[0]=Math.max(T[0],-180),T[0]=Math.min(T[0],180),T[1]=Math.max(T[1],-180),T[1]=Math.min(T[1],180),F[0]=Math.max(F[0],-180),F[0]=Math.min(F[0],180),F[1]=Math.max(F[1],-180),F[1]=Math.min(F[1],180),v=geo.mercator.long2tilex(T[0],c),y=geo.mercator.lat2tiley(T[1],c),w=geo.mercator.long2tilex(F[0],c),_=geo.mercator.lat2tiley(F[1],c),v=Math.max(v,0),v=Math.min(Math.pow(2,c)-1,v),y=Math.max(y,0),y=Math.min(Math.pow(2,c)-1,y),w=Math.max(w,0),w=Math.min(Math.pow(2,c)-1,w),_=Math.max(_,0),_=Math.min(Math.pow(2,c)-1,_),v>w&&(p=v,v=w,w=p),_>y&&(p=y,v=_,_=p),x=v;w>=x;x+=1)for(b=_;y>=b;b+=1)M=Math.pow(2,c)-1-b,r._hasTile(c,x,M)?(m=n[c][x][M],m.feature.bin(a),m.lastused=new Date,m.feature._update()):r._addTile(e,c,x,M);
for(x=0;x<s.length;x+=1)m=s[x],m.onload=i(m),l=r.createFeature("plane",{drawOnAsyncResourceLoad:!1}).origin([m.llx,m.lly]).upperLeft([m.llx,m.ury]).lowerRight([m.urx,m.lly]).gcs('"EPSG:3857"').style("image",m),m.feature=l;s=[]},this._updateTiles=function(e){return null!==f?(clearTimeout(f),f=null,f=setTimeout(function(){i(e)},300)):f=setTimeout(function(){i(e)},0),r},this._init=function(){return p.call(r),this.gcs("EPSG:3857"),r},this._update=function(e){r._updateTiles(e),m.call(r,e)},this},inherit(geo.osmLayer,geo.featureLayer),geo.registerLayer("osm",geo.osmLayer),ggl=ogs.namespace("geo.gl"),ggl.renderer=function(e){"use strict";return this instanceof ggl.renderer?(geo.renderer.call(this,e),this.contextRenderer=function(){throw"Should be implemented by derived classes"},this):new ggl.renderer(e)},inherit(ggl.renderer,geo.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),ggl.lineFeature=function(e){"use strict";if(!(this instanceof ggl.lineFeature))return new ggl.lineFeature(e);e=e||{},geo.lineFeature.call(this,e);var t=this,i=null,r=this._init,n=this._update;return this._init=function(e){r.call(this,e)},this._build=function(){var e=t.style();i&&this.renderer().contextRenderer().removeActor(i),i=vgl.utils.createLines(this.positions(),e.colors),this.renderer().contextRenderer().addActor(i),this.buildTime().modified()},this._update=function(){var e=t.style();n.call(this),this.dataTime().getMTime()>=this.buildTime().getMTime()&&this._build(),this.updateTime().getMTime()<=this.getMTime()&&(this.style.color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(this.material(),this.style.color),i.setVisible(this.visible()),i.material().setBinNumber(this.bin()),console.log(i.material().binNumber()),e.size&&i.material().shaderProgram().uniform("pointSize").set(e.size)),this.updateTime().modified()},this._exit=function(){t.renderer().contextRenderer().removeActor(i)},this._init(e),this},inherit(ggl.lineFeature,geo.lineFeature),geo.registerFeature("vgl","line",ggl.lineFeature),ggl.pointFeature=function(e){"use strict";if(!(this instanceof ggl.pointFeature))return new ggl.pointFeature(e);e=e||{},geo.pointFeature.call(this,e);var t=this,i=null,r=this._init,n=this._update;return this._init=function(e){r.call(this,e)},this._build=function(){var e=t.style(),r=geo.transform.transformFeature(t.renderer().map().gcs(),this,!1);if(i&&this.renderer().contextRenderer().removeActor(i),e.point_sprites===!0){if(null===e.point_sprites_image)throw"[error] Invalid image for point sprites";i=vgl.utils.createPointSprites(e.point_sprites_image,r,e.colors)}else i=vgl.utils.createPoints(r,e.colors);this.renderer().contextRenderer().addActor(i),this.buildTime().modified()},this._update=function(){var e=t.style();if(n.call(this),this.dataTime().getMTime()>=this.buildTime().getMTime()&&this._build(),this.updateTime().getMTime()<=this.getMTime())if(this.style.color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(this.material(),this.style.color),e.point_sprites===!0){if(null===e.point_sprites_image)throw"[error] Invalid image for point sprites";e.width&&e.height?i.material().shaderProgram().uniform("pointSize").set([e.width,e.height]):e.size&&i.material().shaderProgram().uniform("pointSize").set([e.size,e.size])}else e.size&&i.material().shaderProgram().uniform("pointSize").set(e.size);this.updateTime().modified()},this._exit=function(){t.renderer().contextRenderer().removeActor(i)},this._init(e),this},inherit(ggl.pointFeature,geo.pointFeature),geo.registerFeature("vgl","point",ggl.pointFeature),ggl.geomFeature=function(e){"use strict";if(!(this instanceof ggl.geomFeature))return new ggl.geomFeature(e);e=e||{},geo.geomFeature.call(this,e);var t=this,i=e.geom||null,r=vgl.actor(),n=vgl.mapper(),o=null,a=null,s=e.color||[1,1,1],l=null,u=0;return this._build=function(){var e=t.style();null!==i&&(a=i.sourceData(vgl.vertexAttributeKeys.Scalar),s=i.sourceData(vgl.vertexAttributeKeys.Color),n.setGeometryData(i)),this.setMapper(n),void 0!==e.point_sprites&&e.point_sprites&&void 0!==e.point_sprites_image&&null!==e.point_sprites_image&&1===u&&i.primitive(0).primitiveType()===gl.POINTS?o=vgl.utils.createPointSpritesMaterial(e.point_sprites_image):a?s instanceof vgl.lookupTable?(s.updateRange(a.scalarRange()),o=vgl.utils.createColorMappedMaterial(s)):(s=vgl.lookupTable(),s.updateRange(a.scalarRange()),o=vgl.utils.createColorMappedMaterial(s)):o=s?vgl.utils.createColorMaterial():vgl.utils.createSolidColorMaterial(),r.setMaterial(o)},this._update=function(){l&&l.getMTime()<this.getMTime()?s instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(this.material(),this.style.color):(l=vgl.timestamp(),l.modified())},this.geometry=function(e){return void 0===e?i:(i=e,this.modified(),this)},this},inherit(ggl.geomFeature,geo.geomFeature),ggl.planeFeature=function(e){"use strict";if(!(this instanceof ggl.planeFeature))return new ggl.planeFeature(e);geo.planeFeature.call(this,e);var t=this,i=null;return this.coords=function(){return[this.origin(),this.upperLeft(),this.lowerRight()]},this._build=function(){var e=this.origin(),r=this.upperLeft(),n=this.lowerRight(),o=this.style().image,a=null,s=null,l=null;this.buildTime().modified(),i&&this.renderer().contextRenderer().removeActor(i),o&&o instanceof Image?(a=o,s=o.onload):o&&(a=new Image,a.src=o),a?(i=vgl.utils.createTexturePlane(e[0],e[1],e[2],n[0],n[1],n[2],r[0],r[1],r[2],!0),l=vgl.texture(),t.visible(!1),a.complete?(l.setImage(a),i.material().addAttribute(l),t.visible(!0),s&&s.call(this)):a.onload=function(){l.setImage(a),i.material().addAttribute(l),t.visible(!0),s&&s.call(this),t.drawOnAsyncResourceLoad()&&(t._update(),t.layer()._draw())}):i=vgl.utils.createPlane(e[0],e[1],e[2],r[0],r[1],r[2],n[0],n[1],n[2]),t.renderer().contextRenderer().addActor(i)},this._update=function(){this.buildTime().getMTime()<=this.dataTime().getMTime()&&this._build(),this.updateTime().getMTime()<=this.getMTime()&&(i.setVisible(this.visible()),i.material().setBinNumber(this.bin())),this.updateTime().modified()},this._exit=function(){t.renderer().contextRenderer().removeActor(i)},this},inherit(ggl.planeFeature,geo.planeFeature),geo.registerFeature("vgl","plane",ggl.planeFeature),ggl.mapInteractorStyle=function(){"use strict";function e(){var e,t=u.position(),i=t[2]*Math.sin(u.viewAngle());for(e=0;20>e;e+=1)if(i>=360/Math.pow(2,e))return e}function t(e){var t=360/Math.pow(2,e);return t/Math.sin(u.viewAngle())}if(!(this instanceof ggl.mapInteractorStyle))return new ggl.mapInteractorStyle;vgl.interactorStyle.call(this);var i,r,n,o,a,s,l,u,c,d,g,h,f=this,p=!1,m=!1,v=!1,y=!1,w=!1,_={x:0,y:0},M={x:0,y:0},x=!1,b=null,T=new vgl.picker,F=vgl.timestamp();return this.map=function(e){return void 0!==e?(i=e,f):i},this.drawRegionMode=function(e){return void 0!==e?(w=e,r&&r.setVisible(e),i.draw(),f):w},this._panCamera=function(e){var t,i,r,n,o,a=e.focusDisplayPoint();t=l.displayToWorld(_.x,_.y,a,e),i=l.displayToWorld(M.x,M.y,a,e),r=t[0]-i[0],n=t[1]-i[1],o=t[2]-i[2],e.camera().pan(-r,-n,-o)},this.handleMouseMove=function(e){var t,r,o,s,d,g;if(f.updateRenderParams(),f._computeCurrentMousePos(e),c===!0)return!0;if(p)if(w)t=i.displayToMap(_.x,_.y),f.setDrawRegion(n.lat(),n.lng(),t.y,t.x);else{for(r=u.position(),g=l.renderers(),d=0;d<g.length;d+=1)f._panCamera(g[d]);o=u.position(),s={type:geo.event.pan,last_display_pos:M,curr_display_pos:_,last_world_pos:r,curr_world_pos:o},$(f).trigger(s)}return m&&a>0&&(null!==b&&(x=!0),f.zoom()),M.x=_.x,M.y=_.y,!1},this.handleMouseDown=function(e){var t;return f.updateRenderParams(),f._computeCurrentMousePos(e),0===e.button&&(p=!0),1===e.button&&(v=!0),2===e.button&&(m=!0),h=f.viewer().relMouseCoords(e),M.x=h.x<0?0:h.x,M.y=h.y<0?0:h.y,w&&p&&(t=i.displayToMap(M.x,M.y),n=geo.latlng(t.y,t.x),f.setDrawRegion(t.y,t.x,t.y,t.x)),M.x=_.x,M.y=_.y,!1},this.handleMouseUp=function(e){var t=null,i=null,r=null;return f.updateRenderParams(),0===e.button&&(p=!1,t=f.viewer().renderWindow().windowSize()[0],i=f.viewer().renderWindow().windowSize()[1],s=f.viewer().renderWindow().activeRenderer(),M.x>=0&&M.x<=t&&M.y>=0&&M.y<=i&&(r=T.pick(M.x,M.y,s))),1===e.button&&(v=!1),2===e.button&&(m=!1,y=!1,x=!1,b=null,f._computeCurrentMousePos(e)),!1},this.handleMouseOut=function(){return f.updateRenderParams(),p?p=!1:v&&(v=!1),m&&(m=!1,y=!1,f.zoom()),!1},this.handleMouseWheel=function(e){f.updateRenderParams();var t,i=e.originalEvent.wheelDeltaY/120,r=.05;return t=i>=0?!0:!1,i=Math.pow(1+Math.abs(i)/2,i>0?-1:1),i*=r,f._computeCurrentMousePos(e),f.zoom(i,!t),!1},this.handleDoubleClick=function(){return f.zoom(.5,!1),!1},this._syncZoom=function(e,t){var i,r,n,o,a,c,d,g=.01;for(f.updateRenderParams(),e&&(u.zoom(e,t),t&&(n=u.position(),o=u.focalPoint(),u.setFocalPoint(n[0],n[1],o[2])),s.resetCameraClippingRange()),n=u.position(),o=u.focalPoint(),d=vec3.distance(n,o),t||(t=u.directionOfProjection()),c=u.clippingRange(),vec3.dot(t,u.directionOfProjection())>0&&(Math.abs(d)<g||c[0]<g)&&(n[0]=o[0]+g*t[0],n[1]=o[1]+g*t[1],n[2]=o[2]-g*t[2],u.setPosition(n[0],n[1],n[2]),u.setFocalPoint(n[0],n[1],o[2]),s.resetCameraClippingRange()),n=u.position(),o=u.focalPoint(),r=l.renderers(),i=0;i<r.length;i+=1)a=r[i].camera(),a!==u&&(a.setPosition(n[0],n[1],n[2]),a.setFocalPoint(o[0],o[1],o[2]),r[i].resetCameraClippingRange(),r[i].render())},this._syncReset=function(){var e,r,n,o,a,c,d,g;f.updateRenderParams(),a=i.zoom(),c=i.center(),o=u.focalPoint(),c=i.baseLayer().toLocal(geo.latlng(c[0],c[1])),c instanceof Object&&"x"in c&&"y"in c&&i.baseLayer()instanceof geo.osmLayer&&(u.setPosition(c.x,c.y,t(a)),u.setFocalPoint(c.x,c.y,o[2]),s.resetCameraClippingRange()),o=u.focalPoint(),n=u.position(),g=u.clippingRange(),r=l.renderers();for(e=0;e<r.length;e+=1)d=r[e].camera(),d!==u&&(d.setPosition(n[0],n[1],n[2]),d.setFocalPoint(o[0],o[1],o[2]),d.setClippingRange(g[0],g[1]),r[e].render())},this._syncPan=function(){},this.zoom=function(i,r){var n,o,c,d,h,p,m,v,y,w=0,T=!1;f.updateRenderParams(),g=(_.y-M.y)/a,void 0===i&&(i=2*Math.abs(g)),c=e(),y=s.focusDisplayPoint(),m=l.displayToWorld(_.x,_.y,y,s),d=u.position(),h=u.focalPoint(),v=[m[0]-d[0],m[1]-d[1],m[2]-d[2]],vec3.normalize(v,v),x?v=b.slice(0):b=v.slice(0),(M.y-_.y<0||r)&&(v[0]=-v[0],v[1]=-v[1],v[2]=-v[2]),d[2]*Math.sin(u.viewAngle())>=360&&r?T=!0:(this._syncZoom(i,v),o=e()),d=u.position(),h=u.focalPoint(),(T||d[2]*Math.sin(u.viewAngle())>=360)&&(T=!1,w=t(0),p=[(w-d[2])*v[0]/v[2],(w-d[2])*v[1]/v[2]],u.setPosition(d[0]+p[0],d[1]+p[1],w),u.setFocalPoint(d[0]+p[0],d[1]+p[1],h[2]),s.resetCameraClippingRange(),o=0,this._syncZoom()),n={type:geo.event.zoom,curr_zoom:o,last_zoom:c},$(f).trigger(n)},this.lastMousePosition=function(e){return void 0!==e?(M=e,f):M},this.leftMouseDown=function(e){return void 0!==e?(p=e,f):p},this.setDrawRegion=function(e,t,n,o){var a,s=geo.planeFeature(geo.latlng(e,t),geo.latlng(n,o),99);return i.removeLayer(r),r=geo.featureLayer({opacity:.5,showAttribution:1},s),i.addLayer(r),a=jQuery.Event(geo.event.updateDrawRegionEvent),$(f).trigger(geo.command.updateDrawRegionEvent,a),f},this.getDrawRegion=function(){return r.features()[0].getCoords()},this._computeCurrentMousePos=function(e){void 0!==e.pageX&&void 0!==e.pageY&&(f.updateRenderParams(),c=!1,h=f.viewer().relMouseCoords(e),h.x<0||h.x>o?(_.x=0,c=!0):_.x=h.x,h.y<0||h.y>a?(_.y=0,c=!0):_.y=h.y)},this.updateRenderParams=function(){l=f.viewer().renderWindow(),o=l.windowSize()[0],a=l.windowSize()[1],s=f.viewer().renderWindow().activeRenderer(),u=s.camera(),d=l.focusDisplayPoint(),F.modified()},this.reset=function(){var e,t;i&&(t=i.zoom(),f._syncReset(),e={type:geo.event.zoom,curr_zoom:t,last_zoom:t},$(f).trigger(e))},this},inherit(ggl.mapInteractorStyle,vgl.interactorStyle),ggl._vglViewerInstance=null,ggl.vglViewerInstance=function(){"use strict";var e;return null===ggl._vglViewerInstance&&(e=$(document.createElement("canvas")),e.attr("class",".webgl-canvas"),ggl._vglViewerInstance=vgl.viewer(e.get(0)),ggl._vglViewerInstance.renderWindow().removeRenderer(ggl._vglViewerInstance.renderWindow().activeRenderer()),ggl._vglViewerInstance.setInteractorStyle(ggl.mapInteractorStyle()),ggl._vglViewerInstance.init()),ggl._vglViewerInstance},ggl.vglRenderer=function(e){"use strict";if(!(this instanceof ggl.vglRenderer))return new ggl.vglRenderer(e);ggl.renderer.call(this,e);var t=this,i=ggl.vglViewerInstance(),r=vgl.renderer(),n=0,o=0,a=this._init;return r.setResetScene(!1),this.displayToWorld=function(e){var i,r,a,s,l,u=t.contextRenderer(),c=u.camera(),d=u.focusDisplayPoint();if(e instanceof Array&&e.length>0)if(a=[],e[0]instanceof Object)for(r=1,i=0;i<e.length;i+=r)l=e[i],s=u.displayToWorld(vec4.fromValues(l.x,l.y,d[2],1),c.viewMatrix(),c.projectionMatrix(),n,o),a.push({x:s[0],y:s[1],z:s[2],w:s[3]});else if(e[0]instanceof Array)for(r=1,i=0;i<e.length;i+=r)l=e[i],s=u.displayToWorld(vec4.fromValues(l[0],l[1],d[2],1),c.viewMatrix(),c.projectionMatrix(),n,o),a.push(s);else for(r=e.length%3===0?3:2,i=0;i<e.length;i+=r)s=u.displayToWorld(vec4.fromValues(e[i],e[i+1],d[2],1),c.viewMatrix(),c.projectionMatrix(),n,o),a.push(s[0]),a.push(s[1]),a.push(s[2]),a.push(s[3]);else{if(!(e instanceof Object))throw"Display to world conversion requires array of 2D/3D points";a={},s=u.displayToWorld(vec4.fromValues(e.x,e.y,d[2],1),c.viewMatrix(),c.projectionMatrix(),n,o),a={x:s[0],y:s[1],z:s[2],w:s[3]}}return a},this.worldToDisplay=function(e){var t,i,r,a=this.contextRenderer(),s=a.camera(),l=s.focalPoint(),u=[];if(e instanceof Array&&e.length>0)if(u=[],e[0]instanceof Object)for(r=1,t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t].x,e[t].y,l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u[t]={x:i[0],y:i[1],z:i[2]};else if(e[0]instanceof Array)for(r=1,t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t][0],e[t][1],l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u[t].push(i);else if(r=e.length%3===0?3:2,2===r)for(t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t],e[t+1],l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u.push(i[0]),u.push(i[1]),u.push(i[2]);else for(t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t],e[t+1],e[t+2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u.push(i[0]),u.push(i[1]),u.push(i[2]);else{if(!(e instanceof Object))throw"World to display conversion requires array of 2D/3D points";i=a.worldToDisplay(vec4.fromValues(e.x,e.y,l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u={x:i[0],y:i[1],z:i[2]}}return u},this.contextRenderer=function(){return r},this.api=function(){return"vgl"},this.reset=function(){i.interactorStyle().reset()},this._init=function(){return this.initialized()?this:(a.call(this),this.canvas($(i.canvas())),i.renderWindow().renderers().length>0&&(r.setLayer(i.renderWindow().renderers().length),r.setResetScene(!1)),i.renderWindow().addRenderer(r),this.layer().node().append(this.canvas()),$(i.interactorStyle()).on(geo.event.pan,function(e){t.trigger(geo.event.pan,e)}),$(i.interactorStyle()).on(geo.event.zoom,function(e){t.trigger(geo.event.zoom,e)}),this)},this._connectMapEvents=function(){if(t.layer().referenceLayer()){var e=$(t.layer().map().node()),r="onwheel"in e?"wheel":void 0!==document.onmousewheel?"mousewheel":"MozMousePixelScroll",n="wheel"===r?function(e){return e.originalEvent.deltaY*(e.originalEvent.deltaMode?120:1)}:"mousewheel"===r?function(e){return e.originalEvent.wheelDelta}:function(e){return-e.originalEvent.detail};i.unbindEventHandlers(),e.on(r,function(e){e.originalEvent.wheelDeltaY=n(e),e.originalEvent.wheelDelta=e.originalEvent.wheelDeltaY,i.handleMouseWheel(e)}),e.on("mousemove",function(e){i.handleMouseMove(e)}),e.on("mouseup",function(e){i.handleMouseUp(e)}),e.on("mousedown",function(e){i.handleMouseDown(e)}),e.on("mouseout",function(t){var r=$(e),n=r.offset(),o=r.width(),a=r.height(),s=t.pageX-n.left,l=t.pageY-n.top;(0>s||s>=o||0>l||l>=a)&&i.handleMouseOut(t)}),e.on("keypress",function(e){i.handleKeyPress(e)}),e.on("contextmenu",function(e){i.handleContextMenu(e)}),e.on("click",function(e){i.handleClick(e)}),e.on("dblclick",function(e){i.handleDoubleClick(e)})}i.interactorStyle().map(this.layer().map()),i.interactorStyle().reset()},this.on(geo.event.layerAdd,function(e){e.layer===t.layer()&&t._connectMapEvents()}),this._resize=function(e,t,r,a){return n=r,o=a,this.canvas().attr("width",r),this.canvas().attr("height",a),i.renderWindow().positionAndResize(e,t,r,a),this._render(),this},this._render=function(){return i.render(),this},this._exit=function(){},this},inherit(ggl.vglRenderer,ggl.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),gd3=ogs.namespace("geo.d3"),function(e){"use strict";var t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",i=8;e.uniqueID=function(){var e,r=[];for(r.length=i,e=0;i>e;e+=1)r[e]=t.charAt(Math.floor(Math.random()*t.length));return r.join("")},geo.event.d3Rescale="geo.d3.rescale"}(gd3),gd3.object=function(e){"use strict";if(!(this instanceof geo.object))return new gd3.object(e);var t="d3-"+gd3.uniqueID(),i=this;return this._d3id=function(){return t},this.select=function(){return i.renderer().select(i._d3id())},geo.sceneObject.call(this),this},inherit(gd3.object,geo.sceneObject),gd3.pointFeature=function(e){"use strict";if(!(this instanceof gd3.pointFeature))return new gd3.pointFeature(e);e=e||{},geo.pointFeature.call(this,e),gd3.object.call(this);var t,i,r,n=this,o=this._init,a=this._update,s=geo.timestamp(),l={};return t={cx:function(e){return e.x},cy:function(e){return e.y},r:1},i={fill:"black",stroke:"none"},l={attributes:t,style:i},this._init=function(e){return o.call(n,e),r=n.layer().sticky(),n},this._build=function(){var e=n.positions()||[],r=n.style(),o=n.renderer();return e=o.worldToDisplay(e),a.call(n),e||(e=[]),l.id=n._d3id(),l.data=e,l.append="circle",l.style=$.extend({},i),l.attributes=$.extend({},t),l.classes=["d3PointFeature"],l.style.fill=d3.rgb(255*r.color[0],255*r.color[1],255*r.color[2]),l.attributes.r=function(){var e=o.scaleFactor();return(r.size/e).toString()+"px"},l.style["fill-opacity"]=r.opacity,n.renderer().drawFeatures(l),s.modified(),n.updateTime().modified(),n},this._update=function(){return a.call(n),n.dataTime().getMTime()>=s.getMTime()&&n._build(),n},n.on(geo.event.d3Rescale,function(){n.renderer().select(n._d3id()).attr("r",l.attributes.r)}),this._init(e),this},inherit(gd3.pointFeature,geo.pointFeature),geo.registerFeature("d3","point",gd3.pointFeature),gd3.lineFeature=function(e){"use strict";if(!(this instanceof gd3.lineFeature))return new gd3.lineFeature(e);e=e||{},geo.lineFeature.call(this,e),gd3.object.call(this);var t=this,i=this._init,r=geo.timestamp(),n=this._update,o={};return o.style={},this._init=function(e){return i.call(t,e),t},this._build=function(){var e=t.positions()||[],i=t.style(),a=t.renderer(),s=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y});return n.call(t),e=a.worldToDisplay(e),o.data=[e],o.attributes={d:s},o.id=t._d3id(),o.append="path",o.classes=["d3LineFeature"],o.style={fill:"none",stroke:d3.rgb(255*i.color[0],255*i.color[1],255*i.color[2]),"stroke-width":function(){var e=a.scaleFactor();return(i.width[0]/e).toString()+"px"},"stroke-opacity":i.opacity},a.drawFeatures(o),r.modified(),t.updateTime().modified(),t},this._update=function(){return n.call(t),t.dataTime().getMTime()>=r.getMTime()&&t._build(),t},t.on(geo.event.d3Rescale,function(){t.renderer().select(t._d3id()).style("stroke-width",o.style["stroke-width"])}),this._init(e),this},inherit(gd3.lineFeature,geo.lineFeature),geo.registerFeature("d3","line",gd3.lineFeature),gd3.pathFeature=function(e){"use strict";if(!(this instanceof gd3.pathFeature))return new gd3.pathFeature(e);e=e||{},geo.pathFeature.call(this,e),gd3.object.call(this);var t=this,i=this._init,r=geo.timestamp(),n=this._update,o={};return o.style={},this._init=function(e){return i.call(t,e),t},this._build=function(){var e,i,a=t.positions()||[],s=t.style(),l=t.renderer();return n.call(t),i=function(e){var t={source:e.source,target:e.target};return d3.svg.diagonal()(t)},e=[],a.forEach(function(t,i){var r,n;i<a.length-1&&(r=t,n=a[i+1],e.push({source:l.worldToDisplay(r),target:l.worldToDisplay(n)}))}),o.data=e,o.attributes={d:i},o.id=t._d3id(),o.append="path",o.classes=["d3PathFeature"],o.style={fill:"none",stroke:d3.rgb(255*s.color[0],255*s.color[1],255*s.color[2]),"stroke-width":function(){var e=l.scaleFactor();return(s.width[0]/e).toString()+"px"},"stroke-opacity":s.opacity},t.renderer().drawFeatures(o),r.modified(),t.updateTime().modified(),t},this._update=function(){return n.call(t),t.dataTime().getMTime()>=r.getMTime()&&t._build(),t},t.on(geo.event.d3Rescale,function(){t.renderer().select(t._d3id()).style("stroke-width",o.style["stroke-width"])}),this._init(e),this},inherit(gd3.pathFeature,geo.pathFeature),geo.registerFeature("d3","path",gd3.pathFeature),gd3.graphFeature=function(e){"use strict";var t=this;return this instanceof gd3.graphFeature?(geo.graphFeature.call(this,e),this.select=function(){var e=t.renderer(),i={},r=t.nodeFeature(),n=t.linkFeatures();return i.nodes=e.select(r._d3id()),i.links=n.map(function(t){return e.select(t._d3id())}),i},this):new gd3.graphFeature(e)},inherit(gd3.graphFeature,geo.graphFeature),geo.registerFeature("d3","graph",gd3.graphFeature),gd3.d3Renderer=function(e){"use strict";function t(e,t){var i;for(i in t)t.hasOwnProperty(i)&&e.attr(i,t[i])}function i(){var e=l.layer();return e?e.map():null}function r(){return v.select(".group-"+l._d3id())}function n(){var e=l.layer(),t=e.map(),i=l.layer().width(),r=l.layer().height();if(g=i,h=r,!g||!h)throw"Map layer has size 0";d={upperLeft:t.displayToGcs({x:0,y:0}),lowerRight:t.displayToGcs({x:i,y:r})}}function o(){if(d||n(),u){var e,t,i,o=l.layer(),a=o.map(),s=a.gcsToDisplay(d.upperLeft),c=a.gcsToDisplay(d.lowerRight),g=r();e=s.x,t=s.y,i=(c.y-s.y)/h,g.attr("transform","matrix("+[i,0,0,i,e,t].join()+")"),f=i,p=e,m=t}}function a(e){return{x:(e.x-p)/f,y:(e.y-m)/f}}function s(e){return{x:e.x*f+p,y:e.y*f+m}}if(!(this instanceof gd3.d3Renderer))return new gd3.d3Renderer(e);geo.renderer.call(this,e),gd3.object.call(this),e=e||{};var l=this,u=null,c={},d=null,g=null,h=null,f=1,p=0,m=0,v=null;return this._init=function(){if(!l.canvas()){var e;v=d3.select(l.layer().node().get(0)).append("svg"),e=v.append("g"),u=l.layer().sticky(),v.attr("class",l._d3id()),v.attr("width",l.layer().node().width()),v.attr("height",l.layer().node().height()),e.attr("class","group-"+l._d3id()),l.canvas(e)}},this.displayToWorld=function(e){var t=i();if(!t)throw"Cannot project until this layer is connected to a map.";return e=Array.isArray(e)?e.map(function(e){return t.displayToGcs(s(e))}):t.displayToGcs(s(e))},this.worldToDisplay=function(e){var t=i();if(!t)throw"Cannot project until this layer is connected to a map.";var r;return r=Array.isArray(e)?e.map(function(e){return a(t.gcsToDisplay(e))}):a(t.gcsToDisplay(e))},this.api=function(){return"d3"},this.scaleFactor=function(){return f},this._resize=function(e,t,i,r){d||n(),v.attr("width",i),v.attr("height",r),o(),l.layer().trigger(geo.event.d3Rescale,{scale:f},!0)},this._render=function(){},this._exit=function(){c={},l.canvas().remove()},this.drawFeatures=function(e){return c[e.id]={data:e.data,index:e.dataIndex,style:e.style,attributes:e.attributes,classes:e.classes,append:e.append},l.updateFeatures(e.id)},this.updateFeatures=function(e){var i;if(void 0===e){for(i in c)c.hasOwnProperty(i)&&l.updateFeatures(i);return l}var r=c[e].data,n=c[e].index,o=c[e].style,a=c[e].attributes,s=c[e].classes,u=c[e].append,d=l.select(e).data(r,n);return d.enter().append(u),d.exit().remove(),t(d,a),d.attr("class",s.concat([e]).join(" ")),d.style(o),l},this.select=function(e){return r().selectAll("."+e)},this.on(geo.event.pan,o),this.on(geo.event.zoom,function(){o(),l.layer().trigger(geo.event.d3Rescale,{scale:f},!0)}),this.on(geo.event.resize,function(e){l._resize(e.x,e.y,e.width,e.height)}),this._init(e),this},inherit(gd3.d3Renderer,geo.renderer),geo.registerRenderer("d3Renderer",gd3.d3Renderer),geo.version="0.1.0";var ogs;ogs=window&&void 0!==window.ogs?window.ogs:{},ogs.namespace=function(e){"use strict";var t,i=e.split("."),r=ogs;for("ogs"===i[0]&&(i=i.slice(1)),t=0;t<i.length;t+=1)void 0===r[i[t]]&&(r[i[t]]={}),r=r[i[t]];return r};var geo=ogs.namespace("geo");window.geo=geo,geo.renderers={},geo.features={},inherit=function(e,t){"use strict";var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.uber=t.prototype,e.prototype.constructor=e},Object.size=function(e){"use strict";var t=0,i=null;for(i in e)e.hasOwnProperty(i)&&(t+=1);return t},geo.registerRenderer=function(e,t){"use strict";void 0===geo.renderers&&(geo.renderers={}),geo.renderers[e]=t},geo.createRenderer=function(e,t,i){"use strict";if(geo.renderers.hasOwnProperty(e)){var r=geo.renderers[e]({layer:t,canvas:i});return r._init(),r}return null},geo.registerFeature=function(e,t,i){"use strict";void 0===geo.features&&(geo.features={}),e in geo.features||(geo.features[e]={}),geo.features[e][t]=i},geo.createFeature=function(e,t,i,r){"use strict";var n=i.api(),o={layer:t,renderer:i};return n in geo.features&&e in geo.features[n]?(void 0!==r&&$.extend(!0,o,r),geo.features[n][e](o)):null},geo.registerLayer=function(e,t){"use strict";void 0===geo.layers&&(geo.layers={}),geo.layers[e]=t},geo.createLayer=function(e,t,i){"use strict";var r={map:t,renderer:"vglRenderer"},n=null;return e in geo.layers?(void 0!==i&&$.extend(!0,r,i),n=geo.layers[e](r),n._init(),n):null},geo.object=function(){"use strict";if(!(this instanceof geo.object))return new geo.object;var e=this,t={};return this.on=function(i,r){return Array.isArray(i)?(i.forEach(function(t){e.on(t,r)}),e):(t.hasOwnProperty(i)||(t[i]=[]),t[i].push(r),e)},this.trigger=function(i,r){return Array.isArray(i)?(i.forEach(function(t){e.trigger(t,r)}),e):(t.hasOwnProperty(i)&&t[i].forEach(function(e){e(r)}),e)},this.off=function(i,r){if(Array.isArray(i))return i.forEach(function(t){e.off(t,r)}),e;if(r){if(Array.isArray(r))return r.forEach(function(t){e.off(i,t)}),e}else t[i]=[];return t.hasOwnProperty(i)&&(t[i]=t[i].filter(function(e){return e!==r})),e},vgl.object.call(this),this},inherit(geo.object,vgl.object),geo.sceneObject=function(e){"use strict";if(!(this instanceof geo.sceneObject))return new geo.sceneObject;geo.object.call(this,e);var t=this,i=null,r=[],n=this.trigger;return this.parent=function(e){return void 0===e?i:(i=e,t)},this.addChild=function(e){return Array.isArray(e)?(e.forEach(t.addChild),t):(e.parent(t),r.push(e),t)},this.removeChild=function(e){return Array.isArray(e)?(e.forEach(t.removeChild),t):(r=r.filter(function(t){return t!==e}),t)},this.children=function(){return r.slice()},this.trigger=function(e,o,a){var s;return o=o||{},s=o.geo||{},o.geo=s,!a&&i&&s._triggeredBy!==i?(s._triggeredBy=t,i.trigger(e,o),t):(n.call(t,e,o),s.stopPropagation?t:(r.forEach(function(i){s._triggeredBy=t,i.trigger(e,o)}),t))},this},inherit(geo.sceneObject,geo.object),geo.timestamp=function(){"use strict";return this instanceof geo.timestamp?void vgl.timestamp.call(this):new geo.timestamp},inherit(geo.timestamp,vgl.timestamp),geo.ellipsoid=function(e,t,i){"use strict";if(!(this instanceof geo.ellipsoid))return new geo.ellipsoid(e,t,i);if(e=vgl.defaultValue(e,0),t=vgl.defaultValue(t,0),i=vgl.defaultValue(i,0),0>e||0>t||0>i)return console.log("[error] Al radii components must be greater than zero");var r=this,n=new vec3.fromValues(e,t,i),o=new vec3.fromValues(e*e,t*t,i*i),a=Math.min(e,t,i),s=Math.max(e,t,i);return this.radii=function(){return n},this.radiiSquared=function(){return o},this.maximumRadius=function(){return s},this.minimumRadius=function(){return a},this.computeGeodeticSurfaceNormal=function(e,t){if("undefined"==typeof e||"undefined"==typeof t)throw"[error] Valid latitude and longitude is required";var i=Math.cos(e),r=vec3.create();return r[0]=i*Math.cos(t),r[1]=i*Math.sin(t),r[2]=Math.sin(e),vec3.normalize(r,r),r},this.transformPoint=function(e,t,i){e*=Math.PI/180,t*=Math.PI/180;var n=r.computeGeodeticSurfaceNormal(e,t),a=vec3.create(),s=Math.sqrt(vec3.dot(n,a)),l=vec3.create();return vec3.multiply(a,o,n),vec3.scale(a,a,1/s),vec3.scale(n,n,i),vec3.add(l,n,a),l},this.transformGeometry=function(e){if(!e)throw"[error] Failed to transform to cartesian. Invalid geometry.";var t=e.sourceData(vgl.vertexAttributeKeys.Position),i=t.data(),n=t.attributeNumberOfComponents(vgl.vertexAttributeKeys.Position),a=t.attributeStride(vgl.vertexAttributeKeys.Position),s=t.attributeOffset(vgl.vertexAttributeKeys.Position),l=t.sizeOfAttributeDataType(vgl.vertexAttributeKeys.Position),u=null,c=i.length*(1/n),d=null,g=null,h=0,f=vec3.create(),p=vec3.create();if(a/=l,s/=l,3!==n)throw"[error] Requires positions with three components";for(h=0;c>h;h+=1)u=h*a+s,i[u]=i[u]*(Math.PI/180),i[u+1]=i[u+1]*(Math.PI/180),g=r.computeGeodeticSurfaceNormal(i[u+1],i[u]),vec3.multiply(f,o,g),d=Math.sqrt(vec3.dot(g,f)),vec3.scale(f,f,1/d),vec3.scale(g,g,i[u+2]),vec3.add(p,g,f),i[u]=p[0],i[u+1]=p[1],i[u+2]=p[2]},r},geo.ellipsoid.WGS84=vgl.freezeObject(geo.ellipsoid(6378137,6378137,6356752.314245179)),geo.ellipsoid.UNIT_SPHERE=vgl.freezeObject(geo.ellipsoid(1,1,1)),geo.mercator={r_major:6378137},geo.mercator.r_minor=function(e){"use strict";var t;return e=void 0!==e?e:!1,t=e?6378137:6356752.314245179},geo.mercator.f=function(e){"use strict";return(geo.mercator.r_major-geo.mercator.r_minor(e))/geo.mercator.r_major},geo.mercator.long2tilex=function(e,t){"use strict";var i=(e+180)/360,r=Math.floor(i*Math.pow(2,t));return r},geo.mercator.lat2tiley=function(e,t){"use strict";var i=e*Math.PI/180;return Math.floor((1-i/Math.PI)/2*Math.pow(2,t))},geo.mercator.long2tilex2=function(e,t){"use strict";var i=(e+180)/360,r=i*Math.pow(2,t),n=Math.floor(r),o=r-n;return[n,o]},geo.mercator.lat2tiley2=function(e,t){"use strict";var i=e*Math.PI/180,r=(1-Math.log(Math.tan(i)+1/Math.cos(i))/Math.PI)/2*Math.pow(2,t),n=Math.floor(r),o=r-n;return[n,o]},geo.mercator.tilex2long=function(e,t){"use strict";return e/Math.pow(2,t)*360-180},geo.mercator.tiley2lat=function(e,t){"use strict";var i=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))},geo.mercator.y2lat=function(e){"use strict";return 180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2)},geo.mercator.lat2y=function(e){"use strict";return 180/Math.PI*Math.log(Math.tan(Math.PI/4+e*(Math.PI/180)/2))},geo.mercator.deg2rad=function(e){"use strict";var t=e*(Math.PI/180);return t},geo.mercator.rad2deg=function(e){"use strict";var t=e/(Math.PI/180);return t},geo.mercator.ll2m=function(e,t,i){"use strict";t>89.5&&(t=89.5),-89.5>t&&(t=-89.5);var r=this.r_major*this.deg2rad(e),n=this.r_minor(i)/this.r_major,o=1-n*n,a=Math.sqrt(o),s=this.deg2rad(t),l=Math.sin(s),u=a*l,c=.5*a,d=Math.pow((1-u)/(1+u),c),g=Math.tan(.5*(.5*Math.PI-s))/d,h=-this.r_major*Math.log(g),f={x:r,y:h};return f},geo.mercator.m2ll=function(e,t,i){"use strict";var r=this.rad2deg(e/this.r_major),n=this.r_minor(i)/this.r_major,o=Math.sqrt(1-n*n),a=this.rad2deg(this.pjPhi2(Math.exp(-(t/this.r_major)),o)),s={lon:r,lat:a};return s},geo.mercator.pjPhi2=function(e,t){"use strict";var i,r,n=15,o=Math.PI/2,a=1e-10,s=n,l=.5*t,u=o-2*Math.atan(e);do i=t*Math.sin(u),r=o-2*Math.atan(e*Math.pow((1-i)/(1+i),l))-u,u+=r,s-=1;while(Math.abs(r)>a&&s);return u},geo.latlng=function(e,t){"use strict";if(!(this instanceof geo.latlng))return new geo.latlng(e,t);var i=this,r=void 0===t?e.lat():e,n=void 0===t?e.lng():t;return this.lat=function(e){return void 0===e?r:void(r=e)},this.lng=function(e){return void 0===e?n:void(n=e)},this.x=function(e){return void 0===e?i.lng():void(n=e)},this.y=function(e){return void 0===e?i.lat():void(r=e)},this},geo.layerOptions=function(){"use strict";return this instanceof geo.layerOptions?(this.opacity=.5,this.showAttribution=!0,this.visible=!0,this.binNumber=vgl.material.RenderBin.Default,this):new geo.layerOptions},geo.newLayerId=function(){"use strict";var e=1;return function(){var t=e;return e+=1,t}}(),geo.layer=function(e){"use strict";if(!(this instanceof geo.layer))return new geo.layer(e);
e=e||{},geo.sceneObject.call(this,e);var t=this,i=void 0===e.style?{opacity:.5,color:[.8,.8,.8],visible:!0,bin:100}:e.style,r=void 0===e.id?geo.newLayerId():e.id,n="",o="EPSG:4326",a=null,s=e.source||null,l=void 0===e.map?null:e.map,u=!1,c=0,d=0,g=0,h=0,f=null,p=null,m=null,v=!1,y=void 0===e.renderer?"vglRenderer":e.renderer,w=geo.timestamp(),_=geo.timestamp(),M=geo.timestamp(),x=void 0===e.sticky?!0:e.sticky;return this.sticky=function(){return x},this.node=function(){return f},this.id=function(e){return void 0===e?r:(r=geo.newLayerId(),t.modified(),t)},this.name=function(e){return void 0===e?n:(n=e,t.modified(),t)},this.opacity=function(e){return void 0===e?i.opacity:(i.opacity=e,t.modified(),t)},this.visible=function(e){return void 0===e?i.visible:(i.visible=e,t.modified(),t)},this.bin=function(e){return void 0===e?i.bin:(i.bin=e,t.modified(),t)},this.gcs=function(e){return void 0===e?o:(o=e,t.modified(),t)},this.transform=function(e){return geo.transform.transformLayer(e,t,l.baseLayer()),t},this.timeRange=function(e){return void 0===e?a:(a=e,t.modified(),t)},this.source=function(e){return void 0===e?s:(s=e,t.modified(),t)},this.map=function(e){return void 0===e?l:(l=e,l.node().append(f),t.modified(),t)},this.renderer=function(){return m},this.canvas=function(){return p},this.viewport=function(){return[c,d,g,h]},this.dataTime=function(){return w},this.updateTime=function(){return _},this.drawTime=function(){return M},this.query=function(){},this.referenceLayer=function(e){return void 0!==e?(u=e,t.modified(),t):u},this.initialized=function(e){return void 0!==e?(v=e,t):v},this.toLocal=function(e){return e},this.fromLocal=function(e){return e},this._init=function(){return v?t:(f=$(document.createElement("div")),f.attr("id",n),f.css("position","absolute"),l&&l.node().append(f),p?m=geo.createRenderer(y,t,p):(m=geo.createRenderer(y,t),p=m.canvas()),t.addChild(m),v=!0,t)},this._exit=function(){},this._update=function(){},this._resize=function(e,i,r,n){return c=e,d=i,g=r,h=n,f.width(r),f.height(n),t.modified(),t.trigger(geo.event.resize,{x:e,y:i,width:g,height:h}),t},this.width=function(){return g},this.height=function(){return h},this._draw=function(){},this},inherit(geo.layer,geo.sceneObject),geo.featureLayer=function(e){"use strict";if(!(this instanceof geo.featureLayer))return new geo.featureLayer(e);geo.layer.call(this,e);var t=this,i=null,r=this._init,n=this._update;return this.createFeature=function(e,r){var n=geo.createFeature(e,t,t.renderer(),r);return i||(i=[]),t.addChild(n),i.push(n),t.features(i),t.modified(),n},this.deleteFeature=function(e){return t._delete(e)},this.features=function(e){return t._features(e)},this._features=function(e){return void 0===e?i||[]:(i=e.slice(0),t.dataTime().modified(),t.modified(),void 0)},this._delete=function(e){var r;for(r=0;r<i.length;r+=1)if(i[r]===e)return i[r]._exit(),t.dataTime().modified(),t.modified(),i.splice(r,1);return t.removeChild(e),t},this._init=function(){return t.initialized()?t:(r.call(t),t.on(geo.event.resize,function(e){t.renderer()._resize(e.x,e.y,e.width,e.height),t._update({}),t.renderer()._render()}),t.on(geo.event.pan,function(e){t._update({event:e}),t.renderer()._render()}),t.on(geo.event.zoom,function(e){t.map()&&t.map().zoom(e.curr_zoom),t._update({event:e}),t.renderer()._render()}),t)},this._update=function(e){var r;if(!i)return t;if(n.call(t,e),!t.source()&&i&&0===i.length)return void console.log("[info] No valid data source found.");if(t.dataTime().getMTime()>t.updateTime().getMTime())for(r=0;r<i.length;r+=1)i[r].renderer(t.renderer());for(r=0;r<i.length;r+=1)i[r]._update();return t.updateTime().modified(),t},this._draw=function(){return t.renderer()._render(),t},this.clear=function(){var e;if(!i)return t;for(e=0;e<i.length;e+=1)i[e]._exit();return t.dataTime().modified(),t.modified(),i=[],t},t},inherit(geo.featureLayer,geo.layer),geo.registerLayer("feature",geo.featureLayer),geo.event=function(){"use strict";return this instanceof geo.event?(vgl.event.call(this),this):new geo.event},inherit(geo.event,vgl.event),geo.event.update="geo.update",geo.event.opacityUpdate="geo.opacityUpdate",geo.event.layerAdd="geo.layerAdd",geo.event.layerRemove="geo.layerRemove",geo.event.layerToggle="geo.layerToggle",geo.event.layerSelect="geo.layerSelect",geo.event.layerUnselect="geo.layerUnselect",geo.event.zoom="geo.zoom",geo.event.center="geo.center",geo.event.pan="geo.pan",geo.event.rotate="geo.rotate",geo.event.resize="geo.resize",geo.event.animate="geo.animate",geo.event.query="geo.query",geo.event.draw="geo.draw",geo.event.drawEnd="geo.drawEnd",geo.event.animationPause="geo.animationPause",geo.event.animationStop="geo.animationStop",geo.event.animationComplete="geo.animationComplete",geo.time={},geo.time.incrementTime=function(e,t,i){"use strict";return"days"===t?e.setDate(e.getDate()+i):"months"===t?e.setMonth(e.getMonth()+i):"years"===t?e.setYear(e.getYear()+i):"index"===t&&(e+=i),e},geo.map=function(e){"use strict";if(!(this instanceof geo.map))return new geo.map(e);e=e||{},geo.sceneObject.call(this,e),e.layers=void 0===e.layers?[]:e.layers;var t,i,r,n,o,a=this,s=0,l=0,u=$(e.node),c=e.width||u.width(),d=e.height||u.height(),g=void 0===e.gcs?"EPSG:4326":e.gcs,h=void 0===e.uigcs?"EPSG:4326":e.uigcs,f=void 0===e.center?[0,0]:e.center,p=void 0===e.zoom?10:e.zoom,m=null,v={range:null,timestep:null,layers:null},y={};return y.milliseconds=1,y.seconds=1e3*y.milliseconds,y.minutes=60*y.seconds,y.hours=60*y.minutes,y.days=24*y.hours,y.weeks=7*y.days,y.months=4*y.weeks,y.years=12*y.months,this.on(geo.event.animationPause,function(){n=!0}),this.on(geo.event.animationStop,function(){o=!0}),t=function(e){var t=e.toLowerCase();return y[t]},i=function(e){var i,r,n,o,a,s=null,l=null,u=!1,c=Number.MAX_VALUE;for(a=0;a<e.length;a+=1)if(n=e[a].timeRange()){if("index"===n.deltaUnits)u=!0,o=n.delta;else{if(u)throw"Can't mix index timesteps with time based timesteps";o=t(n.deltaUnits)*n.delta}c>o&&(i=n.delta,r=n.deltaUnits,c=o),(null===s||n.start<s)&&(s=n.start),(null===l||n.end<l)&&(l=n.end)}return{start:s,end:l,delta:i,deltaUnits:r}},r=function(e){return e instanceof Date&&(e=new Date(e.getTime())),e},this.gcs=function(e){return void 0===e?g:(g=e,a)},this.uigcs=function(){return h},this.node=function(){return u},this.zoom=function(e){return void 0===e?p:(p=e,a.modified(),a)},this.center=function(e){return void 0===e?f:(f=e.slice,a.modified(),a)},this.createLayer=function(e,t){var i=geo.createLayer(e,a,t);return null===i&&void 0===i?null:(i._resize(s,l,c,d),(i.referenceLayer()||0===a.children().length)&&a.baseLayer(i),a.addChild(i),a.modified(),a.trigger(geo.event.layerAdd,{type:geo.event.layerAdd,target:a,layer:i}),i)},this.deleteLayer=function(e){return null!==e&&void 0!==e&&(e._exit(),a.removeChild(e),a.modified(),a.trigger(geo.event.layerRemove,{type:geo.event.layerRemove,target:a,layer:e})),e},this.toggle=function(e){return null!==e&&void 0!==e&&(e.visible(!e.visible()),a.modified(),a.trigger(geo.event.layerToggle,{type:geo.event.layerToggle,target:a,layer:e})),a},this.resize=function(e,t,i,r){var n,o=a.children();for(s=e,l=t,c=i,d=r,n=0;n<o.length;n+=1)o[n]._resize(e,t,i,r);return a.trigger(geo.event.resize,{type:geo.event.resize,target:a,x:s,y:l,width:i,height:r}),a.modified(),a},this.gcsToDisplay=function(e){var t,i;if(!(e instanceof Array&&e.length>0||e instanceof Object))throw"Conversion method latLonToDisplay does not handle "+e;return t=m.toLocal(e),i=m.renderer().worldToDisplay(t)},this.displayToGcs=function(e){var t;if(!(e instanceof Array&&e.length>0||e instanceof Object))throw"Conversion method latLonToDisplay does not handle "+e;return t=m.renderer().displayToWorld(e),t=m.fromLocal(t)},this.query=function(){},this.baseLayer=function(e){return void 0!==e?(g!==e.gcs()&&a.gcs(e.gcs()),m=e,m.referenceLayer(!0),a):m},this.draw=function(){var e,t=a.children();for(a.trigger(geo.event.draw,{type:geo.event.draw,target:a}),a._update(),e=0;e<t.length;e+=1)t[e]._draw();return a.trigger(geo.event.drawEnd,{type:geo.event.drawEnd,target:a}),a},this.animate=function(e){var t;if(e=void 0===e?a.children():e,null===v.timestep){if(t=i(e),!t.start||!t.end)throw"Animation range could not be calculated. Check that layers have ranges associated with them";v={range:t,timestep:r(t.start),layers:e}}return a._animate(),a},this.pauseAnimation=function(){return a.trigger(geo.event.animationPause),a},this.stopAnimation=function(){return a.trigger(geo.event.animationStop),v.timestep=null,a},this.stepAnimationForward=function(e){var t;return e=void 0===e?v.layers:e,null===e&&(e=a.children()),null===v.timestep&&(t=i(e),v={range:t,timestep:r(t.start),layers:e}),a._stepAnimationForward(),a},this.stepAnimationBackward=function(e){var t;return e=void 0===e?v.layers:e,null===e&&(e=a.children()),null===v.timestep&&(t=i(e),v={range:t,timestep:r(t.end),layers:e}),a._stepAnimationBackward(),a},this._animate=function(){function e(){v.timestep>t.end||o?(clearInterval(s),v.timestep=null,a.trigger(geo.event.animationComplete)):n?clearInterval(s):(a._animateTimestep(),v.timestep=geo.time.incrementTime(v.timestep,v.range.deltaUnits,v.range.delta))}var t,i,s;if(t=v.range,i=r(t.start),o=!1,n=!1,i=geo.time.incrementTime(i,t.deltaUnits,t.delta),i>t.end)throw"Invalid time range";return s=setInterval(e,10),a},this._animateTimestep=function(){return v&&($.each(v.layers,function(e,t){var i=v.timestep;i instanceof Date&&(i=i.getTime()),t._update({timestep:i})}),a.trigger(geo.event.animate,{timestep:v.timestep}),a.draw()),a},this._stepAnimationForward=function(){var e;return null===v.timestep&&(v.timestep=r(v.range.start)),e=r(v.timestep),e=geo.time.incrementTime(e,v.range.deltaUnits,v.range.delta),e<=v.range.end&&(v.timestep=e,a._animateTimestep()),a},this._stepAnimationBackward=function(){var e;return null===v.timestep&&(v.timestep=r(v.range.end)),e=r(v.timestep),e=geo.time.incrementTime(e,v.range.deltaUnits,-v.range.delta),e<v.range.start?void 0:(v.timestep=e,a._animateTimestep(),a)},this._init=function(e){var t;if(void 0===u||null===u)throw"Map require DIV node";if(void 0!==e&&void 0!==e.layers)for(t=0;t<e.layers.length;t+=1)0===t&&a.baseLayer(e.layers[t]),a.addLayer(e.layers[t]);return a},this._update=function(e){var t,i=a.children();for(t=0;t<i.length;t+=1)i[t]._update(e);return a},this._exit=function(){var e,t=a.children();for(e=0;e<t.length;e+=1)t[e]._exit()},this._init(e),this},inherit(geo.map,geo.sceneObject),geo.feature=function(e){"use strict";if(!(this instanceof geo.feature))return new geo.feature(e);geo.sceneObject.call(this),e=e||{};var t=this,i={},r=void 0===e.layer?null:e.layer,n=void 0===e.gcs?"EPSG:4326":e.gcs,o=void 0===e.visible?!0:e.visible,a=void 0===e.bin?0:e.bin,s=void 0===e.renderer?null:e.renderer,l=geo.timestamp(),u=geo.timestamp(),c=geo.timestamp();return this.style=function(e,r){return void 0===e?i:void 0===r?(i=$.extend({},i,e),t.modified(),t):(i[e]=r,t.modified(),t)},this.layer=function(){return r},this.renderer=function(){return s},this.drawables=function(){return t._drawables()},this.gcs=function(e){return void 0===e?n:(n=e,t.modified(),t)},this.visible=function(e){return void 0===e?o:(o=e,t.modified(),t)},this.bin=function(e){return void 0===e?a:(a=e,t.modified(),t)},this.dataTime=function(e){return void 0===e?l:(l=e,t.modified(),t)},this.buildTime=function(e){return void 0===e?u:(u=e,t.modified(),t)},this.updateTime=function(e){return void 0===e?c:(c=e,t.modified(),t)},this._init=function(e){if(!r)throw"Feature requires a valid layer";i=$.extend({},{opacity:1},void 0===e.style?{}:e.style)},this._build=function(){},this._drawables=function(){},this._update=function(){},this._exit=function(){},this._init(e),this},inherit(geo.feature,geo.sceneObject),geo.pointFeature=function(e){"use strict";if(!(this instanceof geo.pointFeature))return new geo.pointFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=void 0===e.positions?null:e.positions,r=this._init;return this.positions=function(e){return void 0===e?i:(i=e.slice(0),t.dataTime().modified(),t.modified(),t)},this._init=function(e){r.call(t,e);var n=$.extend({},{size:1,width:1,height:1,color:[1,1,1],point_sprites:!1,point_sprites_image:null},void 0===e.style?{}:e.style);t.style(n),i&&t.dataTime().modified()},t._init(e),t},inherit(geo.pointFeature,geo.feature),geo.lineFeature=function(e){"use strict";if(!(this instanceof geo.lineFeature))return new geo.lineFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=void 0===e.positions?[]:e.positions,r=this._init;return this.positions=function(e){return void 0===e?i:(i=e.slice(0),t.dataTime().modified(),t.modified(),t)},this._init=function(e){r.call(t,e);var n=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===e.style?{}:e.style);t.style(n),i&&t.dataTime().modified()},this._init(e),this},inherit(geo.lineFeature,geo.feature),geo.pathFeature=function(e){"use strict";if(!(this instanceof geo.pathFeature))return new geo.pathFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=void 0===e.positions?[]:e.positions,r=this._init;return this.positions=function(e){return void 0===e?i:(i=e.slice(0),t.dataTime().modified(),t.modified(),t)},this._init=function(e){r.call(t,e);var n=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===e.style?{}:e.style);t.style(n),i&&t.dataTime().modified()},this._init(e),this},inherit(geo.pathFeature,geo.feature),geo.polygonFeature=function(e){"use strict";if(!(this instanceof geo.polygonFeature))return new geo.polygonFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=this._init;return this._init=function(e){i.call(t,e);var r=$.extend({},{color:[1,1,1],fill_color:[1,1,1],fill:!0},void 0===e.style?{}:e.style);t.style(r)},t._init(e),t},inherit(geo.polygonFeature,geo.feature),geo.planeFeature=function(e){"use strict";if(!(this instanceof geo.planeFeature))return new geo.planeFeature(e);e=e||{},e.ul=void 0===e.ul?[0,1,0]:e.ul,e.lr=void 0===e.lr?[1,0,0]:e.lr,e.depth=void 0===e.depth?0:e.depth,geo.polygonFeature.call(this,e);var t=this,i=[e.ul.x,e.lr.y,e.depth],r=[e.ul.x,e.ul.y,e.depth],n=[e.lr.x,e.lr.y,e.depth],o=e.depth,a=void 0===e.drawOnAsyncResourceLoad?!0:!1,s=this._init;return this.origin=function(e){if(void 0===e)return i;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";i=e.slice(0),2===i.length&&(i[2]=o)}else e instanceof geo.latlng&&(i=[e.x(),e.y(),o]);return t.dataTime().modified(),t.modified(),t},this.upperLeft=function(e){if(void 0===e)return r;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";r=e.slice(0),2===r.length&&(r[2]=o)}else e instanceof geo.latlng&&(r=[e.x(),e.y(),o]);return t.dataTime().modified(),t.modified(),t},this.lowerRight=function(e){if(void 0===e)return n;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";n=e.slice(0),2===n.length&&(n[2]=o),t.dataTime().modified()}else e instanceof geo.latlng&&(n=[e.x(),e.y(),o]);return t.dataTime().modified(),t.modified(),t},this.drawOnAsyncResourceLoad=function(e){return void 0===e?a:(a=e,t)},this._init=function(e){var i=null;s.call(t,e),i=t.style(),void 0===i.image&&(i.image=null),t.style(i)},this._init(e),this},inherit(geo.planeFeature,geo.polygonFeature),geo.geomFeature=function(e){"use strict";return this instanceof geo.geomFeature?(e=e||{},geo.feature.call(this,e),e.style=void 0===e.style?$.extend({},{color:[1,1,1],point_sprites:!1,point_sprites_image:null},e.style):e.style,this.style(e.style),this):new geo.geomFeature(e)},inherit(geo.geomFeature,geo.feature),geo.graphFeature=function(e){"use strict";if(!(this instanceof geo.graphFeature))return new geo.graphFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=this.style,r=null,n=null,o=[],a=this._init;return this._init=function(e){a.call(t,e);var i=$.extend(!0,{},{nodes:{size:5,color:[0,0,1]},links:{color:[1,1,1]},linkType:"path"},void 0===e.style?{}:e.style);t.style(i),r&&t.dataTime().modified()},this.style=function(e){var r=i.call(t,e);return r!==t?r:(n.style(e.nodes),o.forEach(function(t){t.style(e.links)}),t)},this.nodes=function(e){var i,a=t.layer(),s=0;return void 0===e?r:(i=t.style(),r=e.slice(0),n.positions(r),r.forEach(function(e){(e.children||[]).forEach(function(t){s+=1,o.length<s&&o.push(a.createFeature(i.linkType).style(i.links)),o[s-1].positions([e,t])})}),o.splice(s,o.length-s).forEach(function(e){a._delete(e)}),t.dataTime().modified(),t.modified(),t)},this.nodeFeature=function(){return n},this.linkFeatures=function(){return o},n=this.layer().createFeature("point"),e.nodes&&this.nodes(e.nodes),this._init(e),this},inherit(geo.graphFeature,geo.feature),geo.transform={},geo.transform.osmTransformFeature=function(e,t,i){"use strict";if(!t)return void console.log("[warning] Invalid (null) feature");if(t.gcs()!==e){if(!(t instanceof geo.pointFeature||t instanceof geo.lineFeature))throw"Supports only point or line feature";var r,n,o=null,a=0,s=null,l=null,u=null,c=t.gcs();if(i=!!i,t instanceof geo.pointFeature||t instanceof geo.lineFeature){if("EPSG:4326"!==c&&geo.transform.transformFeature("EPSG:4326",t,!0),l=t.positions(),s=l.length,!(l instanceof Array))throw"Supports Array of 2D and 3D points";if(l.length>0&&l[0]instanceof geo.latlng?(o=2,a=1):(o=s%2===0?2:s%3===0?3:null,a=o),2!==o&&3!==o)throw"Transform points require points in 2D or 3D";for(u=i?l:l.slice(0),r=0;s>r;r+=a)n=l[r]instanceof geo.latlng?l[r].lat():l[r+1],n>85.0511&&(n=85.0511),-85.0511>n&&(n=-85.0511),l[r]instanceof geo.latlng?u[r]=geo.latlng(geo.mercator.lat2y(n),u[r].lng()):u[r+1]=geo.mercator.lat2y(n);return i&&(t.positions(u),t.gcs(e)),u}return null}},geo.transform.transformFeature=function(e,t,i){"use strict";if(!t)throw"Invalid (null) feature";if(!(t instanceof geo.pointFeature||t instanceof geo.lineFeature))throw"Supports only point or line feature";if(t.gcs()===e)return t.positions();if("EPSG:3857"===e)return geo.transform.osmTransformFeature(e,t,i);var r,n=null,o=0,a=null,s=null,l=null,u=null,c=t.gcs(),d=new proj4.Proj(c),g=new proj4.Proj(e);if(i=!!i,t instanceof geo.pointFeature||t instanceof geo.lineFeature){if(s=t.positions(),a=s.length,!(s instanceof Array))throw"Supports Array of 2D and 3D points";if(s.length>0&&s[0]instanceof geo.latlng?(n=2,o=1):(n=a%2===0?2:a%3===0?3:null,o=n),2!==n&&3!==n)throw"Transform points require points in 2D or 3D";for(i?l=s:(l=[],l.length=s.length),r=0;a>r;r+=o)u=2===n?new proj4.Point(s[r],s[r+1],0):new proj4.Point(s[r],s[r+1],s[r+2]),proj4.transform(d,g,u),2===n?(l[r]=u.x,l[r+1]=u.y):(l[r]=u.x,l[r+1]=u.y,l[r+2]=u.z);return i&&(t.positions(l),t.gcs(e)),l}return null},geo.transform.transformLayer=function(e,t,i){"use strict";var r,n,o;if(!t)throw"Requires valid layer for tranformation";if(!i)throw"Requires baseLayer used by the map";if(t!==i){if(!(t instanceof geo.featureLayer))throw"Only feature layer transformation is supported";for(r=t.features(),n=r.length,o=0,o=0;n>o;o+=1)"EPSG:3857"===e&&i instanceof geo.osmLayer?geo.transform.osmTransformFeature(e,r[o],!0):geo.transform.transformFeature(e,r[o],!0);t.gcs(e)}},geo.renderer=function(e){"use strict";if(!(this instanceof geo.renderer))return new geo.renderer(e);geo.sceneObject.call(this),e=e||{};var t=this,i=void 0===e.layer?null:e.layer,r=void 0===e.canvas?null:e.canvas,n=!1;return this.layer=function(){return i},this.canvas=function(e){return void 0===e?r:(r=e,void t.modified())},this.map=function(){return i?i.map():null},this.baseLayer=function(){return t.map()?t.map().baseLayer():void 0},this.initialized=function(e){return void 0===e?n:(n=e,t)},this.api=function(){throw"Should be implemented by derivied classes"},this.reset=function(){return!0},this.worldToGcs=function(){throw"Should be implemented by derivied classes"},this.displayToGcs=function(){throw"Should be implemented by derivied classes"},this.gcsToDisplay=function(){throw"Should be implemented by derivied classes"},this.worldToDisplay=function(){throw"Should be implemented by derivied classes"},this.displayToWorld=function(){throw"Should be implemented by derivied classes"},this.relMouseCoords=function(e){var i=0,r=0,n=0,o=0,a=t.canvas();do i+=a.offsetLeft-a.scrollLeft,r+=a.offsetTop-a.scrollTop,a=a.offsetParent;while(a);return n=e.pageX-i,o=e.pageY-r,{x:n,y:o}},this._init=function(){},this._resize=function(){},this._render=function(){},this._exit=function(){},this._connectMouseEvents=function(){},this},inherit(geo.renderer,geo.sceneObject),geo.osmLayer=function(e){"use strict";function t(){return r.map().zoom()<19?r.map().zoom()+1:r.map().zoom()}function i(e){void 0===e&&(e={}),r._addTiles(e),r._removeTiles(e),r._draw(),r.updateTime().modified()}if(!(this instanceof geo.osmLayer))return new geo.osmLayer(e);geo.featureLayer.call(this,e);var r=this,n={},o=0,a=1e3,s=[],l=[],u=0,c=150,d=null,g="http://tile.openstreetmap.org/",h="png",f=null,p=this._init,m=this._update;return e&&void 0!==e.baseUrl&&(g=e.baseUrl),e&&void 0!==e.imageFormat&&(h=e.imageFormat),this.tileCacheSize=function(e){return void 0===e?c:(c=e,void r.modified())},this.toLocal=function(e){var t,i,r;if(e instanceof Array&&e.length>0)if(i=[],i.length=e.length,e[0]instanceof geo.latlng)for(t=0;t<e.length;t+=1)i[t]=geo.latlng(e[t]),i[t].lat(geo.mercator.lat2y(i[t].lat()));else if(e[0]instanceof Array)if(r=e%3===0?3:2,2===r)for(t=0;t<e.length;t+=r)i[t]=e[t],i[t+1]=geo.mercator.lat2y(e[t+1]);else for(t=0;t<e.length;t+=r)i[t]=e[t],i[t+1]=geo.mercator.lat2y(e[t+1]),i[t+2]=e[t+2];else"x"in e[0]&&"y"in e[0]&&"z"in e[0]?i[t]={x:e[t].x,y:geo.mercator.lat2y(e[t].y),z:e[t].z}:"x"in e[0]&&"y"in e[0]&&"z"in e[0]&&(i[t]={x:e[t].x,y:geo.mercator.lat2y(e[t].y)});else e instanceof geo.latlng?(i={},i.x=e.x(),i.y=geo.mercator.lat2y(e.y())):(i={},i.x=e.x,i.y=geo.mercator.lat2y(e.y));return i},this.fromLocal=function(e){var t,i;if(e instanceof Array&&e.length>0)if(i=[],i.length=e.length,e[0]instanceof Object)for(t=0;t<e.length;t+=1)i[t]={},i[t].x=e[t].x,i[t].y=geo.mercator.y2lat(e[t].y);else if(e[0]instanceof Array)for(t=0;t<e.length;t+=1)i[t]=e[t],i[t][1]=geo.mercator.y2lat(e[t][1]);else for(t=0;t<e.length;t+=1)i[t]=e[t],i[t+1]=geo.mercator.y2lat(e[t+1]);else i={},i.x=e.x,i.y=geo.mercator.y2lat(e.y);return i},this._hasTile=function(e,t,i){return n[e]&&n[e][t]&&n[e][t][i]?!0:!1},this._addTile=function(e,t,i,r){if(n[t]||(n[t]={}),n[t][i]||(n[t][i]={}),!n[t][i][r]){var o=Math.max(1,Math.pow(2,t)),a=Math.max(1,Math.pow(2,t)),l=360,c=360/o,d=l/a,f=-180+i*c,p=.5*-l+r*d,m=-180+(i+1)*c,v=.5*-l+(r+1)*d,y=new Image;return y.LOADING=!0,y.LOADED=!1,y.REMOVED=!1,y.REMOVING=!1,y.crossOrigin="anonymous",y.zoom=t,y.index_x=i,y.index_y=r,y.llx=f,y.lly=p,y.urx=m,y.ury=v,y.lastused=new Date,y.src=g+t+"/"+i+"/"+(Math.pow(2,t)-1-r)+"."+h,n[t][i][r]=y,s.push(y),u+=1,y}},this._removeTiles=function(){var e,i,s,g,h=t();if(!n)return r;if(d===h)return r;d=h;for(g in n)if(h!==g)for(e in n[g])for(i in n[g][e])s=n[g][e][i],s&&(s.REMOVING=!0,l.push(s));return setTimeout(function(){var e,i;for(l.sort(function(e,t){return e.lastused-t.lastused}),i=0;u>c&&i<l.length;)e=l[i],e.zoom!==t()&&(r._delete(e.feature),delete n[e.zoom][e.index_x][e.index_y],l.splice(i,1),u-=1),i+=1;for(i=0;i<l.length;i+=1)e=l[i],e.zoom!==t()?(e.REMOVING=!1,e.REMOVED=!0,e.feature.bin(o)):(e.REMOVING=!1,e.REMOVED=!1,e.lastused=new Date,e.feature.bin(a)),e.feature._update();l=[],r._draw()},100),r},this._addTiles=function(e){function i(e){return function(){e.LOADING=!1,e.LOADED=!0,(e.REMOVING||e.REMOVED)&&e.feature&&e.zoom!==t()?(e.feature.bin(o),e.REMOVING=!1,e.REMOVED=!0):(e.REMOVED=!1,e.lastused=new Date,e.feature.bin(a)),e.feature._update(),r._draw()}}var l,u=r.renderer(),c=t(),d=0,g=r.height(),h=r.width(),f=0,p=null,m=null,v=null,y=null,w=null,_=null,M=null,x=0,b=0,T=u.displayToWorld([d,g]),F=u.displayToWorld([h,f]);for(T[0]=Math.max(T[0],-180),T[0]=Math.min(T[0],180),T[1]=Math.max(T[1],-180),T[1]=Math.min(T[1],180),F[0]=Math.max(F[0],-180),F[0]=Math.min(F[0],180),F[1]=Math.max(F[1],-180),F[1]=Math.min(F[1],180),v=geo.mercator.long2tilex(T[0],c),y=geo.mercator.lat2tiley(T[1],c),w=geo.mercator.long2tilex(F[0],c),_=geo.mercator.lat2tiley(F[1],c),v=Math.max(v,0),v=Math.min(Math.pow(2,c)-1,v),y=Math.max(y,0),y=Math.min(Math.pow(2,c)-1,y),w=Math.max(w,0),w=Math.min(Math.pow(2,c)-1,w),_=Math.max(_,0),_=Math.min(Math.pow(2,c)-1,_),v>w&&(p=v,v=w,w=p),_>y&&(p=y,v=_,_=p),x=v;w>=x;x+=1)for(b=_;y>=b;b+=1)M=Math.pow(2,c)-1-b,r._hasTile(c,x,M)?(m=n[c][x][M],m.feature.bin(a),m.lastused=new Date,m.feature._update()):r._addTile(e,c,x,M);for(x=0;x<s.length;x+=1)m=s[x],m.onload=i(m),l=r.createFeature("plane",{drawOnAsyncResourceLoad:!1}).origin([m.llx,m.lly]).upperLeft([m.llx,m.ury]).lowerRight([m.urx,m.lly]).gcs('"EPSG:3857"').style("image",m),m.feature=l;s=[]},this._updateTiles=function(e){return null!==f?(clearTimeout(f),f=null,f=setTimeout(function(){i(e)},300)):f=setTimeout(function(){i(e)},0),r},this._init=function(){return p.call(r),this.gcs("EPSG:3857"),r},this._update=function(e){r._updateTiles(e),m.call(r,e)},this},inherit(geo.osmLayer,geo.featureLayer),geo.registerLayer("osm",geo.osmLayer),ggl=ogs.namespace("geo.gl"),ggl.renderer=function(e){"use strict";return this instanceof ggl.renderer?(geo.renderer.call(this,e),this.contextRenderer=function(){throw"Should be implemented by derived classes"},this):new ggl.renderer(e)},inherit(ggl.renderer,geo.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),ggl.lineFeature=function(e){"use strict";if(!(this instanceof ggl.lineFeature))return new ggl.lineFeature(e);e=e||{},geo.lineFeature.call(this,e);var t=this,i=null,r=this._init,n=this._update;return this._init=function(e){r.call(this,e)},this._build=function(){var e=t.style();i&&this.renderer().contextRenderer().removeActor(i),i=vgl.utils.createLines(this.positions(),e.colors),this.renderer().contextRenderer().addActor(i),this.buildTime().modified()},this._update=function(){var e=t.style();n.call(this),this.dataTime().getMTime()>=this.buildTime().getMTime()&&this._build(),this.updateTime().getMTime()<=this.getMTime()&&(this.style.color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(this.material(),this.style.color),i.setVisible(this.visible()),i.material().setBinNumber(this.bin()),console.log(i.material().binNumber()),e.size&&i.material().shaderProgram().uniform("pointSize").set(e.size)),this.updateTime().modified()},this._exit=function(){t.renderer().contextRenderer().removeActor(i)},this._init(e),this},inherit(ggl.lineFeature,geo.lineFeature),geo.registerFeature("vgl","line",ggl.lineFeature),ggl.pointFeature=function(e){"use strict";if(!(this instanceof ggl.pointFeature))return new ggl.pointFeature(e);e=e||{},geo.pointFeature.call(this,e);var t=this,i=null,r=this._init,n=this._update;return this._init=function(e){r.call(this,e)},this._build=function(){var e=t.style(),r=geo.transform.transformFeature(t.renderer().map().gcs(),this,!1);if(i&&this.renderer().contextRenderer().removeActor(i),e.point_sprites===!0){if(null===e.point_sprites_image)throw"[error] Invalid image for point sprites";i=vgl.utils.createPointSprites(e.point_sprites_image,r,e.colors)}else i=vgl.utils.createPoints(r,e.colors);this.renderer().contextRenderer().addActor(i),this.buildTime().modified()},this._update=function(){var e=t.style();if(n.call(this),this.dataTime().getMTime()>=this.buildTime().getMTime()&&this._build(),this.updateTime().getMTime()<=this.getMTime())if(this.style.color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(this.material(),this.style.color),e.point_sprites===!0){if(null===e.point_sprites_image)throw"[error] Invalid image for point sprites";e.width&&e.height?i.material().shaderProgram().uniform("pointSize").set([e.width,e.height]):e.size&&i.material().shaderProgram().uniform("pointSize").set([e.size,e.size])}else e.size&&i.material().shaderProgram().uniform("pointSize").set(e.size);this.updateTime().modified()},this._exit=function(){t.renderer().contextRenderer().removeActor(i)},this._init(e),this},inherit(ggl.pointFeature,geo.pointFeature),geo.registerFeature("vgl","point",ggl.pointFeature),ggl.geomFeature=function(e){"use strict";if(!(this instanceof ggl.geomFeature))return new ggl.geomFeature(e);e=e||{},geo.geomFeature.call(this,e);var t=this,i=e.geom||null,r=vgl.actor(),n=vgl.mapper(),o=null,a=null,s=e.color||[1,1,1],l=null,u=0;return this._build=function(){var e=t.style();null!==i&&(a=i.sourceData(vgl.vertexAttributeKeys.Scalar),s=i.sourceData(vgl.vertexAttributeKeys.Color),n.setGeometryData(i)),this.setMapper(n),void 0!==e.point_sprites&&e.point_sprites&&void 0!==e.point_sprites_image&&null!==e.point_sprites_image&&1===u&&i.primitive(0).primitiveType()===gl.POINTS?o=vgl.utils.createPointSpritesMaterial(e.point_sprites_image):a?s instanceof vgl.lookupTable?(s.updateRange(a.scalarRange()),o=vgl.utils.createColorMappedMaterial(s)):(s=vgl.lookupTable(),s.updateRange(a.scalarRange()),o=vgl.utils.createColorMappedMaterial(s)):o=s?vgl.utils.createColorMaterial():vgl.utils.createSolidColorMaterial(),r.setMaterial(o)},this._update=function(){l&&l.getMTime()<this.getMTime()?s instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(this.material(),this.style.color):(l=vgl.timestamp(),l.modified())},this.geometry=function(e){return void 0===e?i:(i=e,this.modified(),this)},this},inherit(ggl.geomFeature,geo.geomFeature),ggl.planeFeature=function(e){"use strict";if(!(this instanceof ggl.planeFeature))return new ggl.planeFeature(e);geo.planeFeature.call(this,e);var t=this,i=null;return this.coords=function(){return[this.origin(),this.upperLeft(),this.lowerRight()]},this._build=function(){var e=this.origin(),r=this.upperLeft(),n=this.lowerRight(),o=this.style().image,a=null,s=null,l=null;this.buildTime().modified(),i&&this.renderer().contextRenderer().removeActor(i),o&&o instanceof Image?(a=o,s=o.onload):o&&(a=new Image,a.src=o),a?(i=vgl.utils.createTexturePlane(e[0],e[1],e[2],n[0],n[1],n[2],r[0],r[1],r[2],!0),l=vgl.texture(),t.visible(!1),a.complete?(l.setImage(a),i.material().addAttribute(l),t.visible(!0),s&&s.call(this)):a.onload=function(){l.setImage(a),i.material().addAttribute(l),t.visible(!0),s&&s.call(this),t.drawOnAsyncResourceLoad()&&(t._update(),t.layer()._draw())}):i=vgl.utils.createPlane(e[0],e[1],e[2],r[0],r[1],r[2],n[0],n[1],n[2]),t.renderer().contextRenderer().addActor(i)},this._update=function(){this.buildTime().getMTime()<=this.dataTime().getMTime()&&this._build(),this.updateTime().getMTime()<=this.getMTime()&&(i.setVisible(this.visible()),i.material().setBinNumber(this.bin())),this.updateTime().modified()},this._exit=function(){t.renderer().contextRenderer().removeActor(i)},this},inherit(ggl.planeFeature,geo.planeFeature),geo.registerFeature("vgl","plane",ggl.planeFeature),ggl.mapInteractorStyle=function(){"use strict";function e(){var e,t=u.position(),i=t[2]*Math.sin(u.viewAngle());for(e=0;20>e;e+=1)if(i>=360/Math.pow(2,e))return e}function t(e){var t=360/Math.pow(2,e);return t/Math.sin(u.viewAngle())}if(!(this instanceof ggl.mapInteractorStyle))return new ggl.mapInteractorStyle;vgl.interactorStyle.call(this);var i,r,n,o,a,s,l,u,c,d,g,h,f=this,p=!1,m=!1,v=!1,y=!1,w=!1,_={x:0,y:0},M={x:0,y:0},x=!1,b=null,T=new vgl.picker,F=vgl.timestamp();return this.map=function(e){return void 0!==e?(i=e,f):i},this.drawRegionMode=function(e){return void 0!==e?(w=e,r&&r.setVisible(e),i.draw(),f):w},this._panCamera=function(e){var t,i,r,n,o,a=e.focusDisplayPoint();t=l.displayToWorld(_.x,_.y,a,e),i=l.displayToWorld(M.x,M.y,a,e),r=t[0]-i[0],n=t[1]-i[1],o=t[2]-i[2],e.camera().pan(-r,-n,-o)},this.handleMouseMove=function(e){var t,r,o,s,d,g;if(f.updateRenderParams(),f._computeCurrentMousePos(e),c===!0)return!0;if(p)if(w)t=i.displayToMap(_.x,_.y),f.setDrawRegion(n.lat(),n.lng(),t.y,t.x);else{for(r=u.position(),g=l.renderers(),d=0;d<g.length;d+=1)f._panCamera(g[d]);o=u.position(),s={type:geo.event.pan,last_display_pos:M,curr_display_pos:_,last_world_pos:r,curr_world_pos:o},$(f).trigger(s)}return m&&a>0&&(null!==b&&(x=!0),f.zoom()),M.x=_.x,M.y=_.y,!1},this.handleMouseDown=function(e){var t;
return f.updateRenderParams(),f._computeCurrentMousePos(e),0===e.button&&(p=!0),1===e.button&&(v=!0),2===e.button&&(m=!0),h=f.viewer().relMouseCoords(e),M.x=h.x<0?0:h.x,M.y=h.y<0?0:h.y,w&&p&&(t=i.displayToMap(M.x,M.y),n=geo.latlng(t.y,t.x),f.setDrawRegion(t.y,t.x,t.y,t.x)),M.x=_.x,M.y=_.y,!1},this.handleMouseUp=function(e){var t=null,i=null,r=null;return f.updateRenderParams(),0===e.button&&(p=!1,t=f.viewer().renderWindow().windowSize()[0],i=f.viewer().renderWindow().windowSize()[1],s=f.viewer().renderWindow().activeRenderer(),M.x>=0&&M.x<=t&&M.y>=0&&M.y<=i&&(r=T.pick(M.x,M.y,s))),1===e.button&&(v=!1),2===e.button&&(m=!1,y=!1,x=!1,b=null,f._computeCurrentMousePos(e)),!1},this.handleMouseOut=function(){return f.updateRenderParams(),p?p=!1:v&&(v=!1),m&&(m=!1,y=!1,f.zoom()),!1},this.handleMouseWheel=function(e){f.updateRenderParams();var t,i=e.originalEvent.wheelDeltaY/120,r=.05;return t=i>=0?!0:!1,i=Math.pow(1+Math.abs(i)/2,i>0?-1:1),i*=r,f._computeCurrentMousePos(e),f.zoom(i,!t),!1},this.handleDoubleClick=function(){return f.zoom(.5,!1),!1},this._syncZoom=function(e,t){var i,r,n,o,a,c,d,g=.01;for(f.updateRenderParams(),e&&(u.zoom(e,t),t&&(n=u.position(),o=u.focalPoint(),u.setFocalPoint(n[0],n[1],o[2])),s.resetCameraClippingRange()),n=u.position(),o=u.focalPoint(),d=vec3.distance(n,o),t||(t=u.directionOfProjection()),c=u.clippingRange(),vec3.dot(t,u.directionOfProjection())>0&&(Math.abs(d)<g||c[0]<g)&&(n[0]=o[0]+g*t[0],n[1]=o[1]+g*t[1],n[2]=o[2]-g*t[2],u.setPosition(n[0],n[1],n[2]),u.setFocalPoint(n[0],n[1],o[2]),s.resetCameraClippingRange()),n=u.position(),o=u.focalPoint(),r=l.renderers(),i=0;i<r.length;i+=1)a=r[i].camera(),a!==u&&(a.setPosition(n[0],n[1],n[2]),a.setFocalPoint(o[0],o[1],o[2]),r[i].resetCameraClippingRange(),r[i].render())},this._syncReset=function(){var e,r,n,o,a,c,d,g;f.updateRenderParams(),a=i.zoom(),c=i.center(),o=u.focalPoint(),c=i.baseLayer().toLocal(geo.latlng(c[0],c[1])),c instanceof Object&&"x"in c&&"y"in c&&i.baseLayer()instanceof geo.osmLayer&&(u.setPosition(c.x,c.y,t(a)),u.setFocalPoint(c.x,c.y,o[2]),s.resetCameraClippingRange()),o=u.focalPoint(),n=u.position(),g=u.clippingRange(),r=l.renderers();for(e=0;e<r.length;e+=1)d=r[e].camera(),d!==u&&(d.setPosition(n[0],n[1],n[2]),d.setFocalPoint(o[0],o[1],o[2]),d.setClippingRange(g[0],g[1]),r[e].render())},this._syncPan=function(){},this.zoom=function(i,r){var n,o,c,d,h,p,m,v,y,w=0,T=!1;f.updateRenderParams(),g=(_.y-M.y)/a,void 0===i&&(i=2*Math.abs(g)),c=e(),y=s.focusDisplayPoint(),m=l.displayToWorld(_.x,_.y,y,s),d=u.position(),h=u.focalPoint(),v=[m[0]-d[0],m[1]-d[1],m[2]-d[2]],vec3.normalize(v,v),x?v=b.slice(0):b=v.slice(0),(M.y-_.y<0||r)&&(v[0]=-v[0],v[1]=-v[1],v[2]=-v[2]),d[2]*Math.sin(u.viewAngle())>=360&&r?T=!0:(this._syncZoom(i,v),o=e()),d=u.position(),h=u.focalPoint(),(T||d[2]*Math.sin(u.viewAngle())>=360)&&(T=!1,w=t(0),p=[(w-d[2])*v[0]/v[2],(w-d[2])*v[1]/v[2]],u.setPosition(d[0]+p[0],d[1]+p[1],w),u.setFocalPoint(d[0]+p[0],d[1]+p[1],h[2]),s.resetCameraClippingRange(),o=0,this._syncZoom()),n={type:geo.event.zoom,curr_zoom:o,last_zoom:c},$(f).trigger(n)},this.lastMousePosition=function(e){return void 0!==e?(M=e,f):M},this.leftMouseDown=function(e){return void 0!==e?(p=e,f):p},this.setDrawRegion=function(e,t,n,o){var a,s=geo.planeFeature(geo.latlng(e,t),geo.latlng(n,o),99);return i.removeLayer(r),r=geo.featureLayer({opacity:.5,showAttribution:1},s),i.addLayer(r),a=jQuery.Event(geo.event.updateDrawRegionEvent),$(f).trigger(geo.command.updateDrawRegionEvent,a),f},this.getDrawRegion=function(){return r.features()[0].getCoords()},this._computeCurrentMousePos=function(e){void 0!==e.pageX&&void 0!==e.pageY&&(f.updateRenderParams(),c=!1,h=f.viewer().relMouseCoords(e),h.x<0||h.x>o?(_.x=0,c=!0):_.x=h.x,h.y<0||h.y>a?(_.y=0,c=!0):_.y=h.y)},this.updateRenderParams=function(){l=f.viewer().renderWindow(),o=l.windowSize()[0],a=l.windowSize()[1],s=f.viewer().renderWindow().activeRenderer(),u=s.camera(),d=l.focusDisplayPoint(),F.modified()},this.reset=function(){var e,t;i&&(t=i.zoom(),f._syncReset(),e={type:geo.event.zoom,curr_zoom:t,last_zoom:t},$(f).trigger(e))},this},inherit(ggl.mapInteractorStyle,vgl.interactorStyle),ggl._vglViewerInstance=null,ggl.vglViewerInstance=function(){"use strict";var e;return null===ggl._vglViewerInstance&&(e=$(document.createElement("canvas")),e.attr("class",".webgl-canvas"),ggl._vglViewerInstance=vgl.viewer(e.get(0)),ggl._vglViewerInstance.renderWindow().removeRenderer(ggl._vglViewerInstance.renderWindow().activeRenderer()),ggl._vglViewerInstance.setInteractorStyle(ggl.mapInteractorStyle()),ggl._vglViewerInstance.init()),ggl._vglViewerInstance},ggl.vglRenderer=function(e){"use strict";if(!(this instanceof ggl.vglRenderer))return new ggl.vglRenderer(e);ggl.renderer.call(this,e);var t=this,i=ggl.vglViewerInstance(),r=vgl.renderer(),n=0,o=0,a=this._init;return r.setResetScene(!1),this.displayToWorld=function(e){var i,r,a,s,l,u=t.contextRenderer(),c=u.camera(),d=u.focusDisplayPoint();if(e instanceof Array&&e.length>0)if(a=[],e[0]instanceof Object)for(r=1,i=0;i<e.length;i+=r)l=e[i],s=u.displayToWorld(vec4.fromValues(l.x,l.y,d[2],1),c.viewMatrix(),c.projectionMatrix(),n,o),a.push({x:s[0],y:s[1],z:s[2],w:s[3]});else if(e[0]instanceof Array)for(r=1,i=0;i<e.length;i+=r)l=e[i],s=u.displayToWorld(vec4.fromValues(l[0],l[1],d[2],1),c.viewMatrix(),c.projectionMatrix(),n,o),a.push(s);else for(r=e.length%3===0?3:2,i=0;i<e.length;i+=r)s=u.displayToWorld(vec4.fromValues(e[i],e[i+1],d[2],1),c.viewMatrix(),c.projectionMatrix(),n,o),a.push(s[0]),a.push(s[1]),a.push(s[2]),a.push(s[3]);else{if(!(e instanceof Object))throw"Display to world conversion requires array of 2D/3D points";a={},s=u.displayToWorld(vec4.fromValues(e.x,e.y,d[2],1),c.viewMatrix(),c.projectionMatrix(),n,o),a={x:s[0],y:s[1],z:s[2],w:s[3]}}return a},this.worldToDisplay=function(e){var t,i,r,a=this.contextRenderer(),s=a.camera(),l=s.focalPoint(),u=[];if(e instanceof Array&&e.length>0)if(u=[],e[0]instanceof Object)for(r=1,t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t].x,e[t].y,l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u[t]={x:i[0],y:i[1],z:i[2]};else if(e[0]instanceof Array)for(r=1,t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t][0],e[t][1],l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u[t].push(i);else if(r=e.length%3===0?3:2,2===r)for(t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t],e[t+1],l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u.push(i[0]),u.push(i[1]),u.push(i[2]);else for(t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t],e[t+1],e[t+2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u.push(i[0]),u.push(i[1]),u.push(i[2]);else{if(!(e instanceof Object))throw"World to display conversion requires array of 2D/3D points";i=a.worldToDisplay(vec4.fromValues(e.x,e.y,l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u={x:i[0],y:i[1],z:i[2]}}return u},this.contextRenderer=function(){return r},this.api=function(){return"vgl"},this.reset=function(){i.interactorStyle().reset()},this._init=function(){return this.initialized()?this:(a.call(this),this.canvas($(i.canvas())),i.renderWindow().renderers().length>0&&(r.setLayer(i.renderWindow().renderers().length),r.setResetScene(!1)),i.renderWindow().addRenderer(r),this.layer().node().append(this.canvas()),$(i.interactorStyle()).on(geo.event.pan,function(e){t.trigger(geo.event.pan,e)}),$(i.interactorStyle()).on(geo.event.zoom,function(e){t.trigger(geo.event.zoom,e)}),this)},this._connectMapEvents=function(){if(t.layer().referenceLayer()){var e=$(t.layer().map().node()),r="onwheel"in e?"wheel":void 0!==document.onmousewheel?"mousewheel":"MozMousePixelScroll",n="wheel"===r?function(e){return e.originalEvent.deltaY*(e.originalEvent.deltaMode?120:1)}:"mousewheel"===r?function(e){return e.originalEvent.wheelDelta}:function(e){return-e.originalEvent.detail};i.unbindEventHandlers(),e.on(r,function(e){e.originalEvent.wheelDeltaY=n(e),e.originalEvent.wheelDelta=e.originalEvent.wheelDeltaY,i.handleMouseWheel(e)}),e.on("mousemove",function(e){i.handleMouseMove(e)}),e.on("mouseup",function(e){i.handleMouseUp(e)}),e.on("mousedown",function(e){i.handleMouseDown(e)}),e.on("mouseout",function(t){var r=$(e),n=r.offset(),o=r.width(),a=r.height(),s=t.pageX-n.left,l=t.pageY-n.top;(0>s||s>=o||0>l||l>=a)&&i.handleMouseOut(t)}),e.on("keypress",function(e){i.handleKeyPress(e)}),e.on("contextmenu",function(e){i.handleContextMenu(e)}),e.on("click",function(e){i.handleClick(e)}),e.on("dblclick",function(e){i.handleDoubleClick(e)})}i.interactorStyle().map(this.layer().map()),i.interactorStyle().reset()},this.on(geo.event.layerAdd,function(e){e.layer===t.layer()&&t._connectMapEvents()}),this._resize=function(e,t,r,a){return n=r,o=a,this.canvas().attr("width",r),this.canvas().attr("height",a),i.renderWindow().positionAndResize(e,t,r,a),this._render(),this},this._render=function(){return i.render(),this},this._exit=function(){},this},inherit(ggl.vglRenderer,ggl.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),gd3=ogs.namespace("geo.d3"),function(e){"use strict";var t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",i=8;e.uniqueID=function(){var e,r=[];for(r.length=i,e=0;i>e;e+=1)r[e]=t.charAt(Math.floor(Math.random()*t.length));return r.join("")},geo.event.d3Rescale="geo.d3.rescale"}(gd3),gd3.object=function(e){"use strict";if(!(this instanceof geo.object))return new gd3.object(e);var t="d3-"+gd3.uniqueID(),i=this;return this._d3id=function(){return t},this.select=function(){return i.renderer().select(i._d3id())},geo.sceneObject.call(this),this},inherit(gd3.object,geo.sceneObject),gd3.pointFeature=function(e){"use strict";if(!(this instanceof gd3.pointFeature))return new gd3.pointFeature(e);e=e||{},geo.pointFeature.call(this,e),gd3.object.call(this);var t,i,r,n=this,o=this._init,a=this._update,s=geo.timestamp(),l={};return t={cx:function(e){return e.x},cy:function(e){return e.y},r:1},i={fill:"black",stroke:"none"},l={attributes:t,style:i},this._init=function(e){return o.call(n,e),r=n.layer().sticky(),n},this._build=function(){var e=n.positions()||[],r=n.style(),o=n.renderer();return e=o.worldToDisplay(e),a.call(n),e||(e=[]),l.id=n._d3id(),l.data=e,l.append="circle",l.style=$.extend({},i),l.attributes=$.extend({},t),l.classes=["d3PointFeature"],l.style.fill=d3.rgb(255*r.color[0],255*r.color[1],255*r.color[2]),l.attributes.r=function(){var e=o.scaleFactor();return(r.size/e).toString()+"px"},l.style["fill-opacity"]=r.opacity,n.renderer().drawFeatures(l),s.modified(),n.updateTime().modified(),n},this._update=function(){return a.call(n),n.dataTime().getMTime()>=s.getMTime()&&n._build(),n},n.on(geo.event.d3Rescale,function(){n.renderer().select(n._d3id()).attr("r",l.attributes.r)}),this._init(e),this},inherit(gd3.pointFeature,geo.pointFeature),geo.registerFeature("d3","point",gd3.pointFeature),gd3.lineFeature=function(e){"use strict";if(!(this instanceof gd3.lineFeature))return new gd3.lineFeature(e);e=e||{},geo.lineFeature.call(this,e),gd3.object.call(this);var t=this,i=this._init,r=geo.timestamp(),n=this._update,o={};return o.style={},this._init=function(e){return i.call(t,e),t},this._build=function(){var e=t.positions()||[],i=t.style(),a=t.renderer(),s=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y});return n.call(t),e=a.worldToDisplay(e),o.data=[e],o.attributes={d:s},o.id=t._d3id(),o.append="path",o.classes=["d3LineFeature"],o.style={fill:"none",stroke:d3.rgb(255*i.color[0],255*i.color[1],255*i.color[2]),"stroke-width":function(){var e=a.scaleFactor();return(i.width[0]/e).toString()+"px"},"stroke-opacity":i.opacity},a.drawFeatures(o),r.modified(),t.updateTime().modified(),t},this._update=function(){return n.call(t),t.dataTime().getMTime()>=r.getMTime()&&t._build(),t},t.on(geo.event.d3Rescale,function(){t.renderer().select(t._d3id()).style("stroke-width",o.style["stroke-width"])}),this._init(e),this},inherit(gd3.lineFeature,geo.lineFeature),geo.registerFeature("d3","line",gd3.lineFeature),gd3.pathFeature=function(e){"use strict";if(!(this instanceof gd3.pathFeature))return new gd3.pathFeature(e);e=e||{},geo.pathFeature.call(this,e),gd3.object.call(this);var t=this,i=this._init,r=geo.timestamp(),n=this._update,o={};return o.style={},this._init=function(e){return i.call(t,e),t},this._build=function(){var e,i,a=t.positions()||[],s=t.style(),l=t.renderer();return n.call(t),i=function(e){var t={source:e.source,target:e.target};return d3.svg.diagonal()(t)},e=[],a.forEach(function(t,i){var r,n;i<a.length-1&&(r=t,n=a[i+1],e.push({source:l.worldToDisplay(r),target:l.worldToDisplay(n)}))}),o.data=e,o.attributes={d:i},o.id=t._d3id(),o.append="path",o.classes=["d3PathFeature"],o.style={fill:"none",stroke:d3.rgb(255*s.color[0],255*s.color[1],255*s.color[2]),"stroke-width":function(){var e=l.scaleFactor();return(s.width[0]/e).toString()+"px"},"stroke-opacity":s.opacity},t.renderer().drawFeatures(o),r.modified(),t.updateTime().modified(),t},this._update=function(){return n.call(t),t.dataTime().getMTime()>=r.getMTime()&&t._build(),t},t.on(geo.event.d3Rescale,function(){t.renderer().select(t._d3id()).style("stroke-width",o.style["stroke-width"])}),this._init(e),this},inherit(gd3.pathFeature,geo.pathFeature),geo.registerFeature("d3","path",gd3.pathFeature),gd3.graphFeature=function(e){"use strict";var t=this;return this instanceof gd3.graphFeature?(geo.graphFeature.call(this,e),this.select=function(){var e=t.renderer(),i={},r=t.nodeFeature(),n=t.linkFeatures();return i.nodes=e.select(r._d3id()),i.links=n.map(function(t){return e.select(t._d3id())}),i},this):new gd3.graphFeature(e)},inherit(gd3.graphFeature,geo.graphFeature),geo.registerFeature("d3","graph",gd3.graphFeature),gd3.d3Renderer=function(e){"use strict";function t(e,t){var i;for(i in t)t.hasOwnProperty(i)&&e.attr(i,t[i])}function i(){var e=l.layer();return e?e.map():null}function r(){return v.select(".group-"+l._d3id())}function n(){var e=l.layer(),t=e.map(),i=l.layer().width(),r=l.layer().height();if(g=i,h=r,!g||!h)throw"Map layer has size 0";d={upperLeft:t.displayToGcs({x:0,y:0}),lowerRight:t.displayToGcs({x:i,y:r})}}function o(){if(d||n(),u){var e,t,i,o=l.layer(),a=o.map(),s=a.gcsToDisplay(d.upperLeft),c=a.gcsToDisplay(d.lowerRight),g=r();e=s.x,t=s.y,i=(c.y-s.y)/h,g.attr("transform","matrix("+[i,0,0,i,e,t].join()+")"),f=i,p=e,m=t}}function a(e){return{x:(e.x-p)/f,y:(e.y-m)/f}}function s(e){return{x:e.x*f+p,y:e.y*f+m}}if(!(this instanceof gd3.d3Renderer))return new gd3.d3Renderer(e);geo.renderer.call(this,e),gd3.object.call(this),e=e||{};var l=this,u=null,c={},d=null,g=null,h=null,f=1,p=0,m=0,v=null;return this._init=function(){if(!l.canvas()){var e;v=d3.select(l.layer().node().get(0)).append("svg"),e=v.append("g"),u=l.layer().sticky(),v.attr("class",l._d3id()),v.attr("width",l.layer().node().width()),v.attr("height",l.layer().node().height()),e.attr("class","group-"+l._d3id()),l.canvas(e)}},this.displayToWorld=function(e){var t=i();if(!t)throw"Cannot project until this layer is connected to a map.";return e=Array.isArray(e)?e.map(function(e){return t.displayToGcs(s(e))}):t.displayToGcs(s(e))},this.worldToDisplay=function(e){var t=i();if(!t)throw"Cannot project until this layer is connected to a map.";var r;return r=Array.isArray(e)?e.map(function(e){return a(t.gcsToDisplay(e))}):a(t.gcsToDisplay(e))},this.api=function(){return"d3"},this.scaleFactor=function(){return f},this._resize=function(e,t,i,r){d||n(),v.attr("width",i),v.attr("height",r),o(),l.layer().trigger(geo.event.d3Rescale,{scale:f},!0)},this._render=function(){},this._exit=function(){c={},l.canvas().remove()},this.drawFeatures=function(e){return c[e.id]={data:e.data,index:e.dataIndex,style:e.style,attributes:e.attributes,classes:e.classes,append:e.append},l.updateFeatures(e.id)},this.updateFeatures=function(e){var i;if(void 0===e){for(i in c)c.hasOwnProperty(i)&&l.updateFeatures(i);return l}var r=c[e].data,n=c[e].index,o=c[e].style,a=c[e].attributes,s=c[e].classes,u=c[e].append,d=l.select(e).data(r,n);return d.enter().append(u),d.exit().remove(),t(d,a),d.attr("class",s.concat([e]).join(" ")),d.style(o),l},this.select=function(e){return r().selectAll("."+e)},this.on(geo.event.pan,o),this.on(geo.event.zoom,function(){o(),l.layer().trigger(geo.event.d3Rescale,{scale:f},!0)}),this.on(geo.event.resize,function(e){l._resize(e.x,e.y,e.width,e.height)}),this._init(e),this},inherit(gd3.d3Renderer,geo.renderer),geo.registerRenderer("d3Renderer",gd3.d3Renderer),geo.version="0.1.0";